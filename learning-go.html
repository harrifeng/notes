<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-12-28 Wed 21:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tic</title>
<meta name="author" content="harrifeng@outlook.com" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">tic</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org754abd8">1. Setting Up Your Go Environment</a>
<ul>
<li><a href="#org587d697">1.1. Installing the Go Tools</a></li>
<li><a href="#orgae49492">1.2. The Go Workspace</a></li>
<li><a href="#org207bddc">1.3. The go Command</a>
<ul>
<li><a href="#org6c3c24f">1.3.1. go run and go build</a></li>
<li><a href="#orgd131416">1.3.2. Getting Third-Party Go Tools</a></li>
<li><a href="#org5033151">1.3.3. Formating Your Code</a></li>
</ul>
</li>
<li><a href="#org3796214">1.4. Linting and Vetting</a></li>
<li><a href="#orgbed372d">1.5. Choose Your Tools</a>
<ul>
<li><a href="#orge4edd9c">1.5.1. Visual Studio Code</a></li>
<li><a href="#org334e372">1.5.2. GoLand</a></li>
<li><a href="#orgf722161">1.5.3. The Go Playground</a></li>
</ul>
</li>
<li><a href="#org9f3960f">1.6. Makefile</a></li>
<li><a href="#org41c06cc">1.7. Staying Up to Date</a></li>
</ul>
</li>
<li><a href="#org9c4e63d">2. Primitive Types and Declarations</a>
<ul>
<li><a href="#orgef11719">2.1. Built-in Types</a>
<ul>
<li><a href="#org2914851">2.1.1. The Zero Value</a></li>
<li><a href="#orgcbfc24a">2.1.2. Literals</a></li>
<li><a href="#orgf1ce4ba">2.1.3. Booleans</a></li>
<li><a href="#orgfb0c8d4">2.1.4. Numeric Types</a></li>
<li><a href="#org19a1806">2.1.5. A Taste of Strings and Runes</a></li>
<li><a href="#orgc2e0069">2.1.6. Explicit Type Conversion</a></li>
</ul>
</li>
<li><a href="#org2ab92a7">2.2. var Versus :=</a></li>
<li><a href="#orga584761">2.3. Using const</a></li>
<li><a href="#orgca70899">2.4. Typed and Untyped Constants</a></li>
<li><a href="#orgaa1147a">2.5. Unused Variables</a></li>
<li><a href="#org31bbcc1">2.6. Naming Variables and Constrants</a></li>
</ul>
</li>
<li><a href="#orgb5f97a7">3. Composite Types</a>
<ul>
<li><a href="#org541e8d5">3.1. Arrays-Too Rigid to Use Directly</a></li>
<li><a href="#org2a5a350">3.2. Slices</a>
<ul>
<li><a href="#org1c520b5">3.2.1. len</a></li>
<li><a href="#orgb9e78d0">3.2.2. append</a></li>
<li><a href="#org47eceaf">3.2.3. Capacity</a></li>
<li><a href="#orgc4257da">3.2.4. make</a></li>
<li><a href="#org16c9e1e">3.2.5. Declaring Your Slice</a></li>
<li><a href="#orgcbe258e">3.2.6. Slicing Slices</a></li>
<li><a href="#orgcc58ab1">3.2.7. Converting Arrays to Slices</a></li>
<li><a href="#orgf1d6272">3.2.8. copy</a></li>
</ul>
</li>
<li><a href="#org9368834">3.3. Strings and Runes and Bytes</a></li>
<li><a href="#org846cf20">3.4. Maps</a>
<ul>
<li><a href="#org7e7184d">3.4.1. Reading and Writing a Map</a></li>
<li><a href="#org0bc39b8">3.4.2. The comma ok idiom</a></li>
<li><a href="#orgfbc0f62">3.4.3. Deleting from Maps</a></li>
<li><a href="#org67f8312">3.4.4. Using Maps as Sets</a></li>
</ul>
</li>
<li><a href="#org830f047">3.5. Structs</a>
<ul>
<li><a href="#orgcc7ed57">3.5.1. Anoymous Structs</a></li>
<li><a href="#orgf951678">3.5.2. Comparing and Converting Structs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8766fc6">4. Chapter 5: Functions</a>
<ul>
<li><a href="#org107e34b">4.1. Declaring and Calling Functions</a>
<ul>
<li><a href="#org0ff9169">4.1.1. Simulating Named and Optional Parameters</a></li>
<li><a href="#org7934acc">4.1.2. Variadic Input Parameters and Dlices</a></li>
<li><a href="#org5469e9c">4.1.3. Multiple Return Values</a></li>
<li><a href="#orgfd7dd4a">4.1.4. Multiple Return Values Are Multiple Values</a></li>
<li><a href="#org6676f4e">4.1.5. Ignoring Returned Values</a></li>
<li><a href="#orgecb8b9b">4.1.6. Named Return Values</a></li>
<li><a href="#org69e20e8">4.1.7. Blank Returns - Never Use These !</a></li>
</ul>
</li>
<li><a href="#org7d65ee6">4.2. Functions Are Values</a>
<ul>
<li><a href="#org5e23737">4.2.1. Function Type Declarations</a></li>
<li><a href="#org3eed4f1">4.2.2. Anonymous Functions</a></li>
</ul>
</li>
<li><a href="#orgc93a3da">4.3. Closures</a>
<ul>
<li><a href="#orgcf16bdc">4.3.1. Passing Functions as Parameters</a></li>
<li><a href="#org219ca77">4.3.2. Returning Functions from Functions</a></li>
</ul>
</li>
<li><a href="#org5aee616">4.4. defer</a></li>
<li><a href="#org2460780">4.5. Go is Call By Value</a></li>
</ul>
</li>
<li><a href="#orgff1a91b">5. Chapter 6: Pointers</a>
<ul>
<li><a href="#org1241940">5.1. A Quick Pointer Primer</a></li>
<li><a href="#org6f4ec0b">5.2. Don't Fear the Pointers</a></li>
<li><a href="#org59c4a6a">5.3. Pointers Indicate Mutable Parameters</a></li>
<li><a href="#orgfee4cf8">5.4. Pointers Are a Lst Resort</a></li>
<li><a href="#orgaddb56d">5.5. Pointer Passing Performance</a></li>
<li><a href="#org38c8ab6">5.6. The Zero Value Versus No Value</a></li>
<li><a href="#orgf5d1f42">5.7. The Difference Between Maps</a></li>
<li><a href="#org73d2daf">5.8. Slices are Buffers</a></li>
<li><a href="#org513d667">5.9. Reducing the Garbage Collector's Workload</a></li>
</ul>
</li>
<li><a href="#orga5c9c06">6. Chapter 10: Concurrency in Go</a>
<ul>
<li><a href="#orgd08c63d">6.1. When to Use Concurrency</a></li>
<li><a href="#orgae45c9c">6.2. Goroutines</a></li>
<li><a href="#orgde28926">6.3. Channels</a>
<ul>
<li><a href="#orgfe58f98">6.3.1. Reading, Writing, and Buffering</a></li>
<li><a href="#org3053d0b">6.3.2. for-range and Channels</a></li>
<li><a href="#orgb31ae51">6.3.3. Closing a Channel</a></li>
<li><a href="#org6c46815">6.3.4. How Channels Behave</a></li>
</ul>
</li>
<li><a href="#orgfa587b5">6.4. select</a></li>
<li><a href="#org4dd53ff">6.5. Concurrency Practices and Patterns</a>
<ul>
<li><a href="#orgc6cba91">6.5.1. Keep Your APIs Concurrency-Free</a></li>
<li><a href="#org2f1b3c7">6.5.2. Goroutines, for Loops, and Varying Variables</a></li>
<li><a href="#orgd934953">6.5.3. Always Clean Up Your Goroutines</a></li>
<li><a href="#org6704aed">6.5.4. The Done Channel Pattern</a></li>
<li><a href="#org8fb7c79">6.5.5. Using aa Cancel Function to Terminate a Goroutine</a></li>
<li><a href="#orgc51d8fa">6.5.6. When to Use Buffered and Unbuffered Channels</a></li>
<li><a href="#org13b4f5f">6.5.7. Backpressure</a></li>
<li><a href="#orgbe8c285">6.5.8. Turning Off a case in a select</a></li>
<li><a href="#org433515b">6.5.9. How to Time Out Code</a></li>
<li><a href="#org6e32c73">6.5.10. Using WaitGroup</a></li>
<li><a href="#org309a4f8">6.5.11. Running Code Exactly Once</a></li>
<li><a href="#orgde02cca">6.5.12. Putting Our Concurrent Tools Together</a></li>
</ul>
</li>
<li><a href="#orga468e18">6.6. When to Use Mutexes Instead of Channels</a></li>
<li><a href="#org86a8955">6.7. Atomics-Your Probably Don't Need These</a></li>
<li><a href="#orge6d4d6a">6.8. Where to Learn More About Concurrency</a></li>
</ul>
</li>
<li><a href="#orgfd50b7d">7. Chapter 12: The Context</a>
<ul>
<li><a href="#orgd9baa8a">7.1. What Is the Context?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org754abd8" class="outline-2">
<h2 id="org754abd8"><span class="section-number-2">1.</span> Setting Up Your Go Environment</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org587d697" class="outline-3">
<h3 id="org587d697"><span class="section-number-3">1.1.</span> Installing the Go Tools</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li><p>
安装好go之后,使用如下命令确认go是否已经安装成功
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go version
go version go1.19.2 darwin/arm64
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgae49492" class="outline-3">
<h3 id="orgae49492"><span class="section-number-3">1.2.</span> The Go Workspace</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>从2009年以来,go历经改动,最初的一些建议可能已经不适用了</li>
<li>对于现代Go开发者(1.15之后)来说,如何组织代码是自由的,没有任何约束的</li>
<li>虽然没有约束,但是Go还是有最佳实践的:
<ul class="org-ul">
<li>所有的第三方Go tools安装在一个单独的workspace, 并且是通过go install 安装,默认情况下这个workspace
在$HOME/go(其中源代码在$HOME/go/src, 二进制在$HOME/go/bin), 可以使用$GOPATH设置这个workspace</li>
<li><p>
在profile文件里面设置GOPATH和加入bin到PATH
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #82aaff;">export</span> <span style="color: #ffcb6b;">GOPATH</span>=$<span style="color: #ffcb6b;">HOME</span>/go
<span style="color: #82aaff;">export</span> <span style="color: #ffcb6b;">PATH</span>=$<span style="color: #ffcb6b;">PATH</span>:$<span style="color: #ffcb6b;">GOPATH</span>/bin
</pre>
</div></li>
</ul></li>
<li>很多老的资料说要设置GOROOT环境变量,这个是老的要求,现在已经不需要了</li>
</ul>
</div>
</div>
<div id="outline-container-org207bddc" class="outline-3">
<h3 id="org207bddc"><span class="section-number-3">1.3.</span> The go Command</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Go把自己的所有能力都通过go command来传递的</li>
</ul>
</div>
<div id="outline-container-org6c3c24f" class="outline-4">
<h4 id="org6c3c24f"><span class="section-number-4">1.3.1.</span> go run and go build</h4>
<div class="outline-text-4" id="text-1-3-1">
<ul class="org-ul">
<li>这两个命令有点相似,下面来看下区别:
<ul class="org-ul">
<li>go run 会把你的代码编译成二进制,并且放到一个临时文件夹,运行代码,然后再马上删掉临时文件夹中的二进制文件</li>
<li><p>
go build会在当前文件夹下面生成一个新的二进制文件,如果想把二进制文件换个名字或者换个地方,可以使用-o
</p>
<div class="org-src-container">
<pre class="src src-shell">go build -o /tmp/hello_world hello.go
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd131416" class="outline-4">
<h4 id="orgd131416"><span class="section-number-4">1.3.2.</span> Getting Third-Party Go Tools</h4>
<div class="outline-text-4" id="text-1-3-2">
<ul class="org-ul">
<li>有些开发者会把预先编译好的go二进制进行分发,另外一些开发者会分发源代码,然后使用GO编译成二进制(使
用go install命令,把二进制安装到$GOPATH/bin, 后者更多的人使用的方法)</li>
<li><p>
go install 带一个参数,这个参数是二进制的源代码地址加上一个@,再加上版本(如果是最新版,使用latest),
我们来看一个例子hey
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go install github.com/rakyll/hey@latest
go: downloading github.com/rakyll/hey v0.1.4
go: downloading golang.org/x/net v0.0.0-20181017193950-04a2e542c03f
$ which hey
/Users/harri/go/bin/hey
</pre>
</div></li>
<li>go的二进制不一定放在$GOPATH/bin下面,放在任意$PATH下面都可以.同样,开发者也不一定以源代码的方式来
分发他们的工具.但是使用源代码分发,并且go install到$GOPATH/bin是go的推荐做法,这么做容易让其他go
开发者理解并且使用.</li>
</ul>
</div>
</div>
<div id="outline-container-org5033151" class="outline-4">
<h4 id="org5033151"><span class="section-number-4">1.3.3.</span> Formating Your Code</h4>
<div class="outline-text-4" id="text-1-3-3">
<ul class="org-ul">
<li>很多语言运行非常灵活的code layout,但是Go并不是:Go有一个standard format,这简化了编译器,并且让代
码更容易阅读</li>
<li>go默认的格式化工具是go fmt</li>
<li>还有一个改进版本的format工具叫做goimports,除了 go fmt的功能外, goimports还会:
<ul class="org-ul">
<li>clean up你的import</li>
<li>让你的import以字母顺序排列</li>
<li>去掉没有使用的imports</li>
<li>猜测你需要的import,当然了这个功能不太准确</li>
</ul></li>
<li><p>
可以使用如下命令下载goimports
</p>
<div class="org-src-container">
<pre class="src src-shell">go install golang.org/x/tools/cmd/goimports@latest
</pre>
</div></li>
<li>goimports的使用方法如下:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-shell">goimports -l -w .
</pre>
</div></li>
<li>-l表示打印出错误的formatting到console</li>
<li>-w表示in-place的更改文件</li>
<li>`.`表示当前文件夹夹里面的文件都需要扫描</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3796214" class="outline-3">
<h3 id="org3796214"><span class="section-number-3">1.4.</span> Linting and Vetting</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>go fmt只是格式化了你的代码,这只是让你的代码得到高质量的第一步</li>
<li>所有的go开发者都需要读一下Effective Go和Go's Wiki Code Review来理解如何书写一个地道(idiomatic)的
go代码</li>
<li>想写出地道go代码的另外一个方法是使用各种lint tool</li>
<li>golint就是这样一种lint tool,它会在如下地方做出推荐:
<ul class="org-ul">
<li>引入符合规范的nameing variable</li>
<li>format 错误信息</li>
<li>再public method和type前面加注释</li>
</ul></li>
<li>golint这种lint工具指出来的并不是错误(因为他们不会让你的代码编译失败,或者运行错误)</li>
<li>lint工具的suggestion并不是都是对的,所以你并不需要完全按照lint工具的推荐进行修改,但是你要严肃的
对待这些建议</li>
<li><p>
使用如下代码安装golint
</p>
<div class="org-src-container">
<pre class="src src-shell">go install golang.org/x/lint/golint@latest
</pre>
</div></li>
<li><p>
使用如下代码来lint整个项目
</p>
<div class="org-src-container">
<pre class="src src-shell">golint ./...
</pre>
</div></li>
<li>和linting很像的另外一种工具是vetting,它会发现这么一种错误:
<ul class="org-ul">
<li>首先和linting发现的错误一样,这个错误不会影响编译</li>
<li>但是和linting不一样的地方是,linting发现的错误是"你不知道这样是错的", vetting发现的错误是
"你知道这样是错误的,但是由于不小心还是犯错了"</li>
</ul></li>
<li>vetting发现的错误例子有:
<ul class="org-ul">
<li>给formatting method传入的参数个数不对</li>
<li>给variable赋值,但是这个variable从来不使用</li>
</ul></li>
<li><p>
go自带了vetting工具,使用如下代码来完成vetting操作
</p>
<div class="org-src-container">
<pre class="src src-shell">go vet ./...
</pre>
</div></li>
<li>除了golint和go vet,还有很多的第三方的工具来做linting和vetting.但是这种工具如果有几十个都一起使
用的话,会严重影响整个的build过程,因为每个工具都会把所有的源代码都跑一遍,换句话说,使用几十个工具
做linting和vetting的话,就是要跑几十遍.</li>
<li>为了解决这个问题,出现了一个新的工具叫做golangci-lint,这个工具就是可以把各种linting和vetting工具
结合起来,扫描一次,应用多种linting和vetting工具.</li>
<li><p>
golangci-lint一旦安装,可以使用如下方法进行运行
</p>
<div class="org-src-container">
<pre class="src src-shell">golangci-lint run
</pre>
</div></li>
<li>golangci-lint的设计初衷是好的(同时应用多个linting和vetting工具,现在最多支持50种),但是坏处是team
并不能完全同意这些linting和vetting工具的结果.你可以配置一下哪些linting和vetting工具是你们需要的.
配置文件在project文件夹下的.golangci.yml文件.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbed372d" class="outline-3">
<h3 id="orgbed372d"><span class="section-number-3">1.5.</span> Choose Your Tools</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orge4edd9c" class="outline-4">
<h4 id="orge4edd9c"><span class="section-number-4">1.5.1.</span> Visual Studio Code</h4>
<div class="outline-text-4" id="text-1-5-1">
<ul class="org-ul">
<li>vscode 对Go的支持来源于第三方工具:
<ul class="org-ul">
<li>Delve debugger</li>
<li>gopls: Go Language Server</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org334e372" class="outline-4">
<h4 id="org334e372"><span class="section-number-4">1.5.2.</span> GoLand</h4>
<div class="outline-text-4" id="text-1-5-2">
<ul class="org-ul">
<li>GoLand是Go-specific IDE,它和vscode不同,它不需要你额外下载工具来让你的IDE开始工作</li>
</ul>
</div>
</div>
<div id="outline-container-orgf722161" class="outline-4">
<h4 id="orgf722161"><span class="section-number-4">1.5.3.</span> The Go Playground</h4>
<div class="outline-text-4" id="text-1-5-3">
<ul class="org-ul">
<li>Go Playground是一个网站,它让你能够实验并且分享你的小段代码</li>
<li>Playground运行在google的服务器,所以不要放敏感信息在上面</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9f3960f" class="outline-3">
<h3 id="org9f3960f"><span class="section-number-3">1.6.</span> Makefile</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>Go没有自己的自动化build工具,所以借助了Unix平台上的工具make</li>
</ul>
</div>
</div>
<div id="outline-container-org41c06cc" class="outline-3">
<h3 id="org41c06cc"><span class="section-number-3">1.7.</span> Staying Up to Date</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>绝大部分情况下,由于Go COmpatibility Promise的保证,升级到新代码不会break已有代码,但是Go 的最新代
码有bug的情况下,可能会break已有代码,为了保证新版本的go不会影响老的代码,我们可以在系统上安装多个
go版本</li>
<li><p>
假设你当前是使用的1.15.2版本,你想试验一下1.15.6版本会不会break你的代码,那么,可以使用如下代码来
安装一个1.18版本的go
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go install golang.org/dl/go1.18@latest
</pre>
</div></li>
<li><p>
然后go1.15.6就作为一个命令,安装到你的path里面了
</p>
<div class="org-src-container">
<pre class="src src-shell">$ which go1.18
~/go/bin/go1.18
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9c4e63d" class="outline-2">
<h2 id="org9c4e63d"><span class="section-number-2">2.</span> Primitive Types and Declarations</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgef11719" class="outline-3">
<h3 id="orgef11719"><span class="section-number-3">2.1.</span> Built-in Types</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>在了解type之前,首先介绍一些对所有type都适用的概念</li>
</ul>
</div>
<div id="outline-container-org2914851" class="outline-4">
<h4 id="org2914851"><span class="section-number-4">2.1.1.</span> The Zero Value</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>向很多现代语言一样,在go里面,声明但是没有被赋值的变量都拥有zero value</li>
</ul>
</div>
</div>
<div id="outline-container-orgcbfc24a" class="outline-4">
<h4 id="orgcbfc24a"><span class="section-number-4">2.1.2.</span> Literals</h4>
<div class="outline-text-4" id="text-2-1-2">
<ul class="org-ul">
<li>在Go里面literal代表直接写出数字,字符,或者string</li>
<li>在Go里面有四种常见的literal</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org9595b2d"></a>Integer Literal<br />
<div class="outline-text-5" id="text-2-1-2-1">
<ul class="org-ul">
<li>integer literal是一系列数字,通常情况下是base 10,但是其他的prefix可以用来表示其他的base:
<ul class="org-ul">
<li>0b表示binary</li>
<li>0o(或者仅仅是一个0,但是请不要这样使用,容易令人费解)表示octal</li>
<li>0x表示hexadecimal</li>
</ul></li>
<li>当然了prefx可以是大写也可以是小写</li>
<li>为了让阅读integer literal更加容易,Go允许你在数字之间加上underscore,比如1234可以写成1_234:
<ul class="org-ul">
<li>要求就是不能以'_'开头</li>
<li>不能连续使用两个'_'</li>
<li>你可以使用1_2_3_4这种,但是请不要使用,太令人费解了</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org8ae01a1"></a>Floating point literal<br />
<div class="outline-text-5" id="text-2-1-2-2">
<ul class="org-ul">
<li>floating point literal可以使用'.'来区分小数部分</li>
<li>还可以使用科学计数法,比如6.03e23</li>
<li><p>
还可以使用0x来使用十六位的小数,同时后面加上p来表示2的几次方,这个需要一个例子来理解
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-09 22:23:14</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>0x1p3<span style="color: #F78C6C;">)</span>   <span style="color: #626262;">// </span><span style="color: #626262;">=&gt; (1 + 0 ) * 2^3 = 8</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>0x1.8p3<span style="color: #F78C6C;">)</span> <span style="color: #626262;">// </span><span style="color: #626262;">=&gt; (1 + 8/16) * 2^3 = 12</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">8</span>
<span style="color: #626262;">// </span><span style="color: #626262;">12</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org47b2a0a"></a>Rune literal<br />
<div class="outline-text-5" id="text-2-1-2-3">
<ul class="org-ul">
<li>rune literal代表的是字符,并且是使用单引号进行围绕</li>
<li>和其他语言不一样的地方是,go的单引号和双引号不能互换</li>
<li>Rune literal可以使用如下方法书写:
<ul class="org-ul">
<li>single Unicode character: 'a'</li>
<li>8-bit octal number: '\141'</li>
<li>8-bit hexadecimal number: '\x61'</li>
<li>16-bit hexadecimal number: '\u0061'</li>
<li>32-bit Unicode number: '\U00000061'</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org5daf887"></a>String literal<br />
<div class="outline-text-5" id="text-2-1-2-4">
<ul class="org-ul">
<li>我们有两种表达string literal的方式:
<ul class="org-ul">
<li>使用双引号: "Greetings and Salutations"</li>
<li><p>
使用raw string literal: 这种情况下,可以包含换行,单引号,双引号等
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-09 22:50:34</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">s</span> := <span style="color: #c3e88d;">`</span>
<span style="color: #c3e88d;">Greetings and</span>
<span style="color: #c3e88d;">"Salutations"`</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>

<span style="color: #626262;">// </span><span style="color: #626262;">Greetings and</span>
<span style="color: #626262;">// </span><span style="color: #626262;">"Salutations"</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf1ce4ba" class="outline-4">
<h4 id="orgf1ce4ba"><span class="section-number-4">2.1.3.</span> Booleans</h4>
<div class="outline-text-4" id="text-2-1-3">
<ul class="org-ul">
<li>bool 类型的变量可以有两种值:
<ul class="org-ul">
<li>true</li>
<li>false</li>
</ul></li>
<li>zero value是false</li>
</ul>
</div>
</div>
<div id="outline-container-orgfb0c8d4" class="outline-4">
<h4 id="orgfb0c8d4"><span class="section-number-4">2.1.4.</span> Numeric Types</h4>
<div class="outline-text-4" id="text-2-1-4">
<ul class="org-ul">
<li>go拥有多达12种不同的numeric type,这12种分成3大类</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org3dd3e78"></a>Integer types<br />
<div class="outline-text-5" id="text-2-1-4-1">
<ul class="org-ul">
<li><p>
go提供有符号和没有符号两种整数,从1到4个byte
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Value range</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">int8</td>
<td class="org-left">-128 to 127</td>
</tr>

<tr>
<td class="org-left">int16</td>
<td class="org-left">-32768 to 32767</td>
</tr>

<tr>
<td class="org-left">int32</td>
<td class="org-left">-2147483648 to -2147483647</td>
</tr>

<tr>
<td class="org-left">int64</td>
<td class="org-left">-9223372036854775808 to 9223372036854775807</td>
</tr>

<tr>
<td class="org-left">uint8</td>
<td class="org-left">0 to 255</td>
</tr>

<tr>
<td class="org-left">uint16</td>
<td class="org-left">0 to 65535</td>
</tr>

<tr>
<td class="org-left">uint32</td>
<td class="org-left">0 to 4294967295</td>
</tr>

<tr>
<td class="org-left">uint64</td>
<td class="org-left">0 to 4294967295</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</li>
<li><a id="org2aff389"></a>The special integer types<br />
<div class="outline-text-5" id="text-2-1-4-2">
<ul class="org-ul">
<li>GO还有一些的类型,虽然不包含integer,但是其实是integer:
<ul class="org-ul">
<li>byte是uint8的别名: 这两种类型可以赋值,比较,进行数学运算</li>
<li>int在32位机器上是int32的别名,在64位机器上,是int64的别名,由于这个是根据平台来决定是32还是64的,
所以int和int32(或者int64)是不能进行赋值,比较,数学运算的.注意, integer literal默认是int type类型</li>
<li>和int类型,uint也是根据平台来决定是uint32还uint64</li>
<li>rune类型</li>
<li>uintptr类型</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org2ec9418"></a>Choosing which integer to use<br />
<div class="outline-text-5" id="text-2-1-4-3">
<ul class="org-ul">
<li>由于有多个integer类型存在,所以我们需要以如下的准则来决定使用哪种integer:
<ul class="org-ul">
<li>如果你工作的内容是binary file format或者network protocol,那么使用对应的integer类型</li>
<li>如果你的函数需要对所有integer类型都能用,那么你需要写这么两个函数:
<ol class="org-ol">
<li>以int64为主要参数</li>
<li>以uint64为主要参数</li>
</ol></li>
<li>其他所有情况,使用int就可以了</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org2c27a8b"></a>Integer operators<br />
<div class="outline-text-5" id="text-2-1-4-4">
<ul class="org-ul">
<li>integer支持如下操作,并且结果也是integer:
<ul class="org-ul">
<li>`+`</li>
<li>`-`</li>
<li>`*`</li>
<li>`/`</li>
<li>`%`</li>
</ul></li>
<li>如果想获得float的结果,需要在运算之前就把int转换成float</li>
<li>integer还支持`=`和常见的五个操作联合起来:
<ul class="org-ul">
<li>`+=`</li>
<li>`-=`</li>
<li>`*=`</li>
<li>`/=`</li>
<li>`%=`</li>
</ul></li>
<li>go还支持bit维度的操作:
<ul class="org-ul">
<li>left shifit: &lt;&lt;</li>
<li>right shift: &gt;&gt;</li>
<li>bit mask logical AND: &amp;</li>
<li>bit mask logical OR: |</li>
<li>bit mask logical XOR: ^</li>
<li>bit mask AND NOT: &amp;^</li>
</ul></li>
<li>上面所有操作都可以和`=`配合起来,所以就有:
<ul class="org-ul">
<li>&lt;&lt;=</li>
<li>&gt;&gt;=</li>
<li>&amp;=</li>
<li>|=</li>
<li>^=</li>
<li>&amp;^=</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org19179f9"></a>Floating point types<br />
<div class="outline-text-5" id="text-2-1-4-5">
<ul class="org-ul">
<li>有两种浮点数类型:
<ul class="org-ul">
<li>float32</li>
<li>float64</li>
</ul></li>
<li>Float point literal 的默认类型是float64</li>
<li>如果确定使用浮点数,那么就使用float64</li>
<li>问题在于,绝大多数情况下,不要使用浮点数类型,因为浮点数类型不能把它range内的所有情况都存储下来,
所以用浮点数来存储exact decimal representation(比如钱),就会非常危险</li>
<li>只有如下两个领域使用浮点数是well understood,并且其不精确性也能领用户忍受:
<ul class="org-ul">
<li>graphics</li>
<li>scientific oprations</li>
</ul></li>
<li>浮点数不支持%操作:
<ul class="org-ul">
<li>% 一个非零浮点数得到Inf(或者-Inf)</li>
<li>% 浮点数0,得到NaN(Not a Number)</li>
</ul></li>
<li>虽然编译器不报错,但是不要使用==和!=来比较两个浮点数,两个浮点数的差别在一个很小的delta之内都算相等</li>
</ul>
</div>
</li>
<li><a id="org73b9171"></a>Complex types (you're probably not going to use these)<br />
<div class="outline-text-5" id="text-2-1-4-6">
<ul class="org-ul">
<li>Go对complex有first-class支持,但是我们用不到,所以跳过这一节</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org19a1806" class="outline-4">
<h4 id="org19a1806"><span class="section-number-4">2.1.5.</span> A Taste of Strings and Runes</h4>
<div class="outline-text-4" id="text-2-1-5">
<ul class="org-ul">
<li>string的zero value是空字符串</li>
<li>Go支持Unicode,我们可以把任何unicode字符串存储到go 的string类型中</li>
<li>string可以使用任何比较符号进行比较</li>
<li>go里面的string是immutable类型:
<ul class="org-ul">
<li>你可以重新赋值给string variable</li>
<li>但是你不能更改string index上的值</li>
</ul></li>
<li>String的每个single code point使用一个类型指代,这就是rune type</li>
<li>rune type是int32的alias,就像byte是uint8的alias</li>
</ul>
</div>
</div>
<div id="outline-container-orgc2e0069" class="outline-4">
<h4 id="orgc2e0069"><span class="section-number-4">2.1.6.</span> Explicit Type Conversion</h4>
<div class="outline-text-4" id="text-2-1-6">
<ul class="org-ul">
<li>大部分的编程语言都有多个numeric type的自动转换,这叫作自动类型转换(automatic type promotion)</li>
<li>虽然自动类型提升看上去很方便,但是相互之间的转换规则很复杂,并且会产生unexpected result</li>
<li>为了提升阅读性,go直接不允许automatic type promotion</li>
<li>当需要类型转换的时候,go里面必须使用type conversion,即便是长度不同的integer和长度不同的float</li>
<li>如此严格的类型要求,导致在go里面,不能把其他类型看成是boolean
<ul class="org-ul">
<li>在很多其他语言中,非零值,或者非空字符串都被看成是true</li>
</ul></li>
<li>在go语言中,必须使用如下的操作符来产生boolean值:
<ul class="org-ul">
<li>==</li>
<li>!=</li>
<li>&gt;</li>
<li>&lt;</li>
<li>&gt;=</li>
<li>&lt;=</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2ab92a7" class="outline-3">
<h3 id="org2ab92a7"><span class="section-number-3">2.2.</span> var Versus :=</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>最啰嗦的创建变量的方式是:
<ul class="org-ul">
<li>使用var</li>
<li>明确类型</li>
<li>还给初始化值</li>
<li><p>
如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">int</span> = 10
</pre>
</div></li>
</ul></li>
<li><p>
类似integer literal默认的类型int,我们是可以省略的,下面和上面的代码等价
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> = 10
</pre>
</div></li>
<li><p>
如果你想保留类型,但是希望zero value初始化,那么可以写成
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">int</span>
</pre>
</div></li>
<li><p>
可以使用var同时初始化两个变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span>, <span style="color: #ffcb6b;">y</span> <span style="color: #c792ea;">int</span> = 10, 20
<span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">a</span>, <span style="color: #ffcb6b;">b</span> <span style="color: #c792ea;">int</span>
</pre>
</div></li>
<li><p>
甚至可以一次初始化两个不同类型变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span>, <span style="color: #ffcb6b;">y</span> = 10, <span style="color: #c3e88d;">"hello"</span>
</pre>
</div></li>
<li><p>
如果变量一次定义非常多个,可以使用declaration list
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #c792ea;">(</span>
        <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">int</span>
        <span style="color: #ffcb6b;">y</span> = 20
        <span style="color: #ffcb6b;">z</span> <span style="color: #c792ea;">int</span> = 30
        <span style="color: #ffcb6b;">d</span>, <span style="color: #ffcb6b;">e</span> = 40, <span style="color: #c3e88d;">"hello"</span>
        <span style="color: #ffcb6b;">f</span>, <span style="color: #ffcb6b;">g</span> <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li>:= operator 有一个局限性:它必须在function内部,所以package level的变量就必须使用 var啦</li>
<li>那么到底使用哪种style呢?:
<ul class="org-ul">
<li>绝大部分情况下,使用 :=</li>
<li>在function外,使用declaration list来定义多个package-level 变量,这种情况并不多见</li>
</ul></li>
<li>在如下情况下,请避免使用 :=
<ul class="org-ul">
<li>如果初始化变量为zero值,那么使用var x int, 这样能让读者意识到这个是要让值初始化为zero value</li>
<li><p>
如果初始化某个变量,其literal default类型不是你想要的,那么请使用`var 变量 类型 = 值`的方式(虽然使用 := 也可以,但是不够地道)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">byte</span> = 20
<span style="color: #626262;">// </span><span style="color: #626262;">also work way, but not idiomatic</span>
<span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">byte</span><span style="color: #c792ea;">(</span>20<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li><p>
由于 := 允许左边只要有一个新变量就可以了, 所以有时候你以为是使用了老的变量,其实是初始化了新的变量(如下). 这时候最好使用var先初始化所有
变量,然后使用=来赋值.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-20 18:23:52</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">_a</span> := 200

        <span style="color: #626262;">// </span><span style="color: #626262;">you thought you use existing a, actually you create one new a</span>
        <span style="color: #ffcb6b;">a</span>, <span style="color: #ffcb6b;">b</span> := 1, 2
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>_a<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>a, b<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">200</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1 2</span>
</pre>
</div></li>
</ul></li>
<li>虽然var和:=都允许你在一行一次初始化多个变量,但是请只在如下两个情况下使用:
<ul class="org-ul">
<li>从函数返回多个值的时候</li>

<li><p>
comma ok idiom: 例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-20 18:31:37</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">m</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c3e88d;">"hello"</span>: 5,
                <span style="color: #c3e88d;">"world"</span>: 0,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">ok</span> := m<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"hello"</span><span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, ok<span style="color: #F78C6C;">)</span>

        v, ok = m<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"goodbye"</span><span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, ok<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">5 true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0 false</span>
</pre>
</div></li>
</ul></li>
<li><p>
你应该非常少的会在function之外(package level)来定义变量. 这些变量的值如果改变了,是非常坏的主意
</p>
<pre class="example" id="org6b0e28e">
Package-level variables whose values change are a bad idea
</pre></li>
<li><p>
package level的变量一旦改变的话,我们是非常难以track他的值的,这会让我们难以理解数据如何flow,所以
我们建议只在package level定义不变的变量
</p>
<pre class="example" id="org4d62ef1">
As a general rule, you should only declare variables in the package
block that are effectively immutable
</pre></li>
<li>go提供了immutable value的方法,但是和其他语言有些不一样,这就是const</li>
</ul>
</div>
</div>
<div id="outline-container-orga584761" class="outline-3">
<h3 id="orga584761"><span class="section-number-3">2.3.</span> Using const</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>初看起来,go里面的const确实能提供immutable的作用,如下例子编译:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">x</span> <span style="color: #c792ea;">int64</span> = 10

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">y</span> = <span style="color: #c3e88d;">"hello"</span>

        x = x + 1
        y = <span style="color: #c3e88d;">"bye"</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
编译结果,不通过.错误如下
</p>
<pre class="example" id="orge1de562">
./snippet.go:22:4: cannot assign to x (declared const)
./snippet.go:23:4: cannot assign to y (declared const)
</pre></li>
<li>我们可以看到const保证了我们的变量值不改变</li>
</ul></li>
<li><p>
但是其实go里面的const其功能非常有限,用一句话概括就是在go里面,const其实只能给literal起别名
</p>
<pre class="example" id="org00ae2d3">
Constants in Go are a way to give names to literals
</pre></li>
<li>换句话说,const只能用在`在编译器可以确定值的value(和literal的范围基本相同)`,主要就是如下几种情况:
<ul class="org-ul">
<li>Numeric literal</li>
<li>true and false</li>
<li>String</li>
<li>Rune</li>
<li>内存函数complex, real, imag, len, cap</li>
<li>包含上面所有的种类,外加operator的表达式</li>
</ul></li>
<li>由于go的const不为`在runtime为immutable的value`提供服务,所以:
<ul class="org-ul">
<li>不存在immutable array, slice, map, struct</li>
<li>也没有办法保证struct的field是immutable的</li>
</ul></li>
<li>在function内部,我们是知道某个变量是否改变的,因为我们知道他的整个生命周期.所以没有函数内部的immutable
的方法是可以忍受的.</li>
<li>另外,由于"Go Is Call By Value", 所以go的函数不会不小心改变传入函数的参数</li>
</ul>
</div>
</div>
<div id="outline-container-orgca70899" class="outline-3">
<h3 id="orgca70899"><span class="section-number-3">2.4.</span> Typed and Untyped Constants</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>costant也是可以有typed和untyped之分的:
<ul class="org-ul">
<li><p>
untyped const其实就是和literal一样, 是untype的:也就是有default type,但是和"相似"type可以不经
过显示转换而进行赋值或运算
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">x</span> = 10

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">y</span> <span style="color: #c792ea;">int</span> = x
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">z</span> <span style="color: #c792ea;">float64</span> = x
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">d</span> <span style="color: #c792ea;">byte</span> = x

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y, z, d<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">10 10 10</span>
</pre>
</div></li>
<li><p>
typed const就只能和相同类型的变量进行运算了(如果不经过显示转换的话)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-24 16:16:31</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">typedX</span> <span style="color: #c792ea;">int</span> = 10

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">y</span> <span style="color: #c792ea;">int</span> = typedX
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">/////////////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">./snippet.go:24:6: cannot use typedX (type int) as type int64 in assignment //</span>
        <span style="color: #626262;">/////////////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">var z int64 = typedX</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">10</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgaa1147a" class="outline-3">
<h3 id="orgaa1147a"><span class="section-number-3">2.5.</span> Unused Variables</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>为了能够让GO能够在大规模协作的时候起作用,Go制定了很多和其他编程语言不一样的规则:
<ul class="org-ul">
<li>使用go fmt来进行官方认证的format:这个是一个非强制的规则</li>
<li>每个声明的local variable都必须被read:这就是一个必须遵守的规则,否则编译器会报错</li>
</ul></li>
<li>编译器的检查是比较简单的:
<ul class="org-ul">
<li>只要这个变量被read过一次,就算合格</li>
<li><p>
很多情况下,一个变量可能被赋值很多次,但是只有其中一个值被读取了. 这种情况不是编译错误,但是这种
情况很可能隐含着bug. 这种隐含的bug适合使用lint来探测,比如golangci-lint
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-24 16:24:46</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := 10
        x = 20
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x<span style="color: #F78C6C;">)</span>
        x = 30
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">$ golangci-lint run</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet.go:17:2: ineffectual assignment to x (ineffassign)</span>
<span style="color: #626262;">//      </span><span style="color: #626262;">x := 10</span>
<span style="color: #626262;">//      </span><span style="color: #626262;">^</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet.go:20:2: ineffectual assignment to x (ineffassign)</span>
<span style="color: #626262;">//      </span><span style="color: #626262;">x = 30</span>
<span style="color: #626262;">//      </span><span style="color: #626262;">^</span>
</pre>
</div></li>
</ul></li>
<li><p>
另外需要注意的是,编译器只检查local variable有没有被read过,对于package-level variable是否被读取
过,是不去检查的.这也是为什么我们要:"禁止使用package-level variable"
</p>
<pre class="example" id="orgae08596">
The Go compiler won't stop you from creating unread package-level
variables. This is one more reason why you should avoid creating
package-level variables.
</pre></li>
<li>注意,最好不要创建package-level variable,但是可以创建package-level const</li>
<li><p>
Go还会允许用户创建"没有被读取过的const",如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-24 16:40:11</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">x</span> = 10
        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">y</span> <span style="color: #c792ea;">int64</span> = 10
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Finish"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Finish</span>
</pre>
</div></li>
<li>之所以Go允许创建"没有被读取过的const",是因为这些const压根不会被编译到二进制文件里面.</li>
</ul>
</div>
</div>
<div id="outline-container-org31bbcc1" class="outline-3">
<h3 id="org31bbcc1"><span class="section-number-3">2.6.</span> Naming Variables and Constrants</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Go的变量名可以使用Unicode,但是不要这么做,这是不地道的做法</li>
<li>GO的变量名:
<ul class="org-ul">
<li>可以使用snake case(蛇形命名法,比如,index_counter),但是不推荐</li>
<li>推荐使用camel caske(驼峰命名法, 比如, indexCounter)</li>
</ul></li>
<li>在很多语言里面, const必须是全大写外加蛇形命名法(比如INDEX_COUNTER),但是由于GO里面,首字母用来判
断某个item是否在package外可见.所以Go不使用这个方案</li>
<li>一般来说,一个变量所处的scope大小,决定了其变量名的长度:
<ul class="org-ul">
<li>for loop或者if block中,会使用单个字母的变量</li>
<li>在package level命名const(或者variable,虽然不推荐,但是合法)的时候,需要起够长,够descriptive的名字</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb5f97a7" class="outline-2">
<h2 id="orgb5f97a7"><span class="section-number-2">3.</span> Composite Types</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org541e8d5" class="outline-3">
<h3 id="org541e8d5"><span class="section-number-3">3.1.</span> Arrays-Too Rigid to Use Directly</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>go里面的数组,由于设计的原因,几乎不会被使用到.其他语言使用数组的地方,go都是使用slice来替代</li>
<li>下面的例子介绍了初始化数组的三种方式:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-24 17:31:58</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x1</span> <span style="color: #F78C6C;">[</span>3<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x2</span> = <span style="color: #F78C6C;">[</span>3<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>10, 20, 30<span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x3</span> = <span style="color: #F78C6C;">[</span>12<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, <span style="color: #F78C6C;">5</span>: 4, 6, <span style="color: #F78C6C;">10</span>: 100, 15<span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x4</span> = <span style="color: #F78C6C;">[</span>...<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>10, 20, 30<span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x1<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x2<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x3<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x4<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[0 0 0]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20 30]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 0 0 0 0 4 6 0 0 0 100 15]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20 30]</span>
</pre>
</div></li>
<li>第一种创建的x1,其初始化值都是int的zero value 0</li>
<li>第二种创建的x2,分别初始化了三个值</li>
<li>第三种创建的x3,只初始化了部分值,没有初始化的值都是0</li>
<li>第四种创建的x4,可以用初始化数字的个数来确定array的长度</li>
</ul></li>
<li>array使用[]来读取index上的内容,不能读取或写入不存在的index,否则会报编译错误</li>
<li>之前说过,在go里面,几乎不会使用array,原因在于array把他的size作为type的一部分,这导致:
<ul class="org-ul">
<li>[3]int和[4]int不是一个类型</li>
<li>不可以是用variable来specify array的size,因为这个size要在编译期确定</li>
<li>不可以转换两个size不同的array到同一个类型</li>
<li>不能写一个函数能够处理各种不同size的array</li>
</ul></li>
<li>array存在的唯一原因是为slice提供backing store</li>
</ul>
</div>
</div>
<div id="outline-container-org2a5a350" class="outline-3">
<h3 id="org2a5a350"><span class="section-number-3">3.2.</span> Slices</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>大多数情况下,当你需要一系列相同类型的value的时候,你需要的是slice</li>
<li>slice之所以有用,在于其length不是slice type的一部分,这就可以让我们做到:
<ul class="org-ul">
<li>一个函数来处理不同size的slice</li>
<li>我们可以增加slice的长度</li>
</ul></li>
<li><p>
slice和array的用法类似,唯一不同是不需要写size
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> = <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span><span style="color: #c792ea;">{</span>10, 20, 30<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
当然也可以只设置某几个位置
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> = <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span><span style="color: #c792ea;">{</span>1, <span style="color: #F78C6C;">5</span>:4, 6, <span style="color: #F78C6C;">10</span>: 100, 15<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
我们可以模拟多维slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">[][]</span><span style="color: #c792ea;">int</span>
</pre>
</div></li>
<li><p>
前面都是和array比较一致的行为,那么下面我们来看看slice和array不一致的行为,比如我们
使用var创建了一个slice(没有添加literal), 如下
</p>
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-27 08:11:20</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span>

        fmt.<span style="color: #82aaff;">Printf</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"FileName:[snippet.go]=====&gt;Var:[ x ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, x<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Printf</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"FileName:[snippet.go]=====&gt;Var:[ x == nil ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, x == <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">FileName:[snippet.go]=====&gt;Var:[ x ]=====&gt;Type:[&lt;[]int&gt;] Value:[&lt;[]&gt;]&lt;=====</span>
<span style="color: #626262;">// </span><span style="color: #626262;">FileName:[snippet.go]=====&gt;Var:[ x == nil ]=====&gt;Type:[&lt;bool&gt;] Value:[&lt;true&gt;]&lt;=====</span>
</pre>
</div></li>
<li>这段代码创建了一个int类型的slice,但是因为没有赋值,所以这里应该是int类型slice的zero value</li>
<li>这个zero value是nil,但是注意,只有你打印`x==nil`才能发现是nil,否则展示出来还是`[]`</li>
<li>nil和前面的untyped numeric constant一样,nil是没有type的,所以它可以给任何类型赋值,也可以和任何类型比较</li>
<li>nil slice不包含任何东西</li>
<li>slice是不能比较的类型,任意两个slice的比较都是编译错误</li>
<li>但是!slice却可以和nil比较(因为nil没有类型,所以不是slice嘛)</li>
</ul>
<ul class="org-ul">
<li>在reflect package里面,you个叫做DeepEqual的函数,用来比较任意的两个同等对象,包括slice.但是这个packag推荐只在测试环境使用.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org1c520b5" class="outline-4">
<h4 id="org1c520b5"><span class="section-number-4">3.2.1.</span> len</h4>
<div class="outline-text-4" id="text-3-2-1">
<ul class="org-ul">
<li>go 提供了很多内置的函数来和内置的类型进行工作.len就是其中一个,len可以作用于array,同时也可以作用于slice</li>
<li>一个nil slice的len是0</li>
<li>内置函数之所以叫内置是因为:
<ul class="org-ul">
<li>它可以传入很多类型,比如len可以对array,slice,map,string起作用</li>
<li>普通用户无法自己写一个内置函数</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb9e78d0" class="outline-4">
<h4 id="orgb9e78d0"><span class="section-number-4">3.2.2.</span> append</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li><p>
内置函数append是用来增长slice的, 其返回值是新的slice,用法是把返回值再赋予之前的变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span>
x = <span style="color: #82aaff;">append</span><span style="color: #c792ea;">(</span>x, 10<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li><p>
append函数最少需要两个参数,其中第一个参数必须是slice,但其实append函数最多可以有无数个参数,其中
第一个参数必须是slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> = <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span><span style="color: #c792ea;">{</span>1, 2, 3<span style="color: #c792ea;">}</span>
x = <span style="color: #82aaff;">append</span><span style="color: #c792ea;">(</span>x, 4, 5, 6<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li><p>
这种不定参数,在go里面叫variadic function parameter,模样是使用三个点,放在变量前面
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-30 23:04:24</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">sumFunc</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">nums</span> ...<span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">res</span> := 0
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">n</span> := <span style="color: #89DDFF;">range</span> nums <span style="color: #F78C6C;">{</span>
                res += n
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> res
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">sumFunc</span><span style="color: #F78C6C;">(</span>1, 2, 3, 4<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">10</span>
</pre>
</div></li>
<li><p>
sliceB想要作为参数append给sliceA,那么必须要把sliceB展开,这种展开叫做arguments to variadic
functions,模样是使用三个点,放在变量后面
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-11-30 23:10:10</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>3, 4<span style="color: #F78C6C;">}</span>

        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, y...<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 2 3 4]</span>
</pre>
</div></li>
<li><p>
append函数如果忘记把返回值赋予变量,那么会报编译错误.这会强制大家使用好append
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-01 09:49:32</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>3<span style="color: #F78C6C;">}</span>
        <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 6<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">./snippet.go:18:8: append(x, 6) evaluated but not used</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org47eceaf" class="outline-4">
<h4 id="org47eceaf"><span class="section-number-4">3.2.3.</span> Capacity</h4>
<div class="outline-text-4" id="text-3-2-3">
<ul class="org-ul">
<li>我们可以看到slice是一个sequence of value, slice里面的element都是放到连续的memory location里面的</li>
<li>每个slice都有一个属性叫做capacity, 这个每个slice预留的连续的内存slot的数目,因为是预留的,所以是可以大于length的</li>
<li>如果length等于了capacity,那么就放不进去了.这个时候Go runtime会申请另外一块空间,把老的数据都拷贝过去</li>
<li>这里我们遇到了go runtime这个概念,我们停下来解释一下:
<ul class="org-ul">
<li>每个高级语言,都有一系列的library来让以当前语言书写的程序能够运行,go也有类似的libaray,叫做go
runtime</li>
<li>go runtime提供了如下的服务:
<ol class="org-ol">
<li>内存分配</li>
<li>垃圾回收</li>
<li>并发支持</li>
<li>网络</li>
<li>内置的类型和函数</li>
</ol></li>
<li>go runtime是和每个go代码编译在一起的(都在二进制文件里面),这个是和其他的使用虚拟机语言不通,那
些语言必须另外安装迅疾才能让程序运行</li>
<li>把runtime包裹在二进制文件里面,能够让go程序更容易的分发,并且避免runtime和程序之间的兼容问题</li>
</ul></li>
<li>由于slice通过append的增长需要go runtime先分配内存在拷贝已有数据,很浪费时间,所以runtime申请capacity
的时候,每次会申请多一点:
<ul class="org-ul">
<li>1024个之前,每次申请,capacity翻倍</li>
<li>1024个之后,每次申请,capacity增加25%</li>
<li><p>
我们可以通过例子直观感受一下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 19:37:23</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 10<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 20<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 30<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 40<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 50<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[] 0 0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10] 1 1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20] 2 2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20 30] 3 4</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20 30 40] 4 4</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10 20 30 40 50] 5 8</span>
</pre>
</div></li>
<li>我们可以看到,每次capacity不够用的时候,都会触发一次申请内存和拷贝原有内容.那么我们会思考,如果
我知道最终会放多少的内容到slice厘米,我能最开始的时候就设置capacity么?答案是可以的,使用我们下
一节介绍的make</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc4257da" class="outline-4">
<h4 id="orgc4257da"><span class="section-number-4">3.2.4.</span> make</h4>
<div class="outline-text-4" id="text-3-2-4">
<ul class="org-ul">
<li>我们可以使用slice literal或者nil zero value(通过var)</li>
<li>但是这两者都不能标识新创建的slice的length和capacity,而make是可以完成上述任务的.</li>
<li>make有好几种用法,需要挨个说明,因为非常容易用错:
<ul class="org-ul">
<li><p>
创建五个值为0的slice, capacity没有设置,默认和length一样,都是五.注意这种创建方式创建出来的五个
成员都是有值的,值是0
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 19:58:42</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 5<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[0 0 0 0 0]</span>
</pre>
</div></li>

<li><p>
初学者常犯的错误,就是初始化length之后,马上赋予一个值,这样的话,我们的slice会立刻进行一次内存申
请和数据拷贝
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 20:01:19</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 5<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 10<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[0 0 0 0 0] 5 5</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[0 0 0 0 0 10] 6 10</span>
</pre>
</div></li>
<li><p>
上面的例子,其实使用者本意是想申请一个slice,然后第一个成员为10,其实正确的做法是给make第三个参
数来确认capacity,同时把第二个参数length设置为0,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 20:03:57</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 0, 5<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 10<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[] 0 5</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[10] 1 5</span>
</pre>
</div></li>
<li>注意make种capacity的值要大于等于length的值,否则程序会panic</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org16c9e1e" class="outline-4">
<h4 id="org16c9e1e"><span class="section-number-4">3.2.5.</span> Declaring Your Slice</h4>
<div class="outline-text-4" id="text-3-2-5">
<ul class="org-ul">
<li>既然slice有多种初始化方式,那么我们应该如何取舍呢?</li>
<li><p>
如果是创建一个不会grow的slice,那么我们就创建一个nil slice(注意,nil slice和nil比较是true的)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 20:20:16</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">data</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>data, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>data<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>data<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>data == <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
        data = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>data, 1<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>data, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>data<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>data<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[] 0 0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1] 1 1</span>
</pre>
</div></li>
<li><p>
还有的情况,你要创建一个zero-length slice,注意,这个slice也是没有成员的,length为0, 但是其不是nil的,
和nil比较为false,zero-length slice只有在把slice转换成json的时候会用到
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 20:21:29</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">x</span> = <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x == <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 1<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[] 0 0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">false</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1] 1 1</span>
</pre>
</div></li>
<li><p>
如果你的slice有一些初始化值,或者你的slice不怎么改动,那么使用slice literal是非常好的选择
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-22 20:23:13</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">data</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>2, 4, 6, 8<span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>data<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[2 4 6 8]</span>
</pre>
</div></li>
<li>如果你知道你的slice会有多大,但是在创建的时候,不知道成员是什么,那么显然你要使用make(因为可以传入capacity),
剩下的问题,就是你到底要不要创建zero length的slice:
<ol class="org-ol">
<li>make, specified length, specified capacity: 这种情况使用index来设置value.这种情况的缺点是如
果size错误了,那么在slice后半部分会多出来很多0或者是panic了,因为你访问了一个不再的index</li>
<li>make, 0 length, specified capacity: 这种情况下,如果预想的数据比这少,那么不会在后半部分剩下0,
如果预想数据多也不会panic</li>
</ol></li>
<li>通常推荐大家使用第二种,也就是make的第二个参数length设置为0</li>
</ul>
</div>
</div>
<div id="outline-container-orgcbe258e" class="outline-4">
<h4 id="orgcbe258e"><span class="section-number-4">3.2.6.</span> Slicing Slices</h4>
<div class="outline-text-4" id="text-3-2-6">
<ul class="org-ul">
<li>slice expression (也就是[start:end]) 会从slice创建新的slice:
<ul class="org-ul">
<li>`:`左边是start, `:`右边是end</li>
<li><p>
左边的start是include,右边的end的exclud
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 20:28:46</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>1:3<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[2 3]</span>
</pre>
</div></li>
<li><p>
如果左边的start不给,那么默认是0
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 20:27:07</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 2]</span>
</pre>
</div></li>
<li><p>
如果右边的end不给,那么默认是end
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 20:27:50</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>1:<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[2 3 4 5]</span>
</pre>
</div></li>
<li><p>
如果左右都不给,那么是一个新的slice,注意,虽然地址不一样,但是因为slice是reference类型,所以只是
新的指针不一样,指向的内容还是一样的(下面会讲到slice 共享内存)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 20:01:38</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Printf</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x address is %p\n"</span>, &amp;x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Printf</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y address is %p\n"</span>, &amp;y<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, y<span style="color: #F78C6C;">)</span>
        y<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]</span> = 100
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, y<span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x address is 0x1400000c030</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y address is 0x1400000c048</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 2 3 4 5] [1 2 3 4 5]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 100 3 4 5] [1 100 3 4 5]</span>
</pre>
</div></li>
</ul></li>
<li><p>
slice一个slice最让人意想不到的地方是:这些slice共享内存. slice是reference类型再这里再次彰显
</p>
<pre class="example" id="org3a22180">
When you take a slice from a slice, you are not making a copy of the data.
Instead, you now have two variables that are sharing memory.
</pre></li>
<li><p>
这也就意味着一个slice的内容改变,所有slice的内容都会改变.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 21:02:29</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2<span style="color: #F78C6C;">]</span>
        <span style="color: #ffcb6b;">z</span> := x<span style="color: #F78C6C;">[</span>1:<span style="color: #F78C6C;">]</span>
        x<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]</span> = 20
        y<span style="color: #F78C6C;">[</span>0<span style="color: #F78C6C;">]</span> = 10
        z<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]</span> = 30
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x"</span>, x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x [10 20 30 4 5]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [10 20]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [20 30 4 5]</span>
</pre>
</div></li>
<li>如果和append结合起来,那么情况就会更加复杂
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 21:18:04</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 0, 5<span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 1, 2, 3, 4<span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2<span style="color: #F78C6C;">]</span>
        <span style="color: #ffcb6b;">z</span> := x<span style="color: #F78C6C;">[</span>2:<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>x<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>y<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>z<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        y = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>y, 30, 40, 50<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y<span style="color: #F78C6C;">)</span>
        x = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>x, 60<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x"</span>, x<span style="color: #F78C6C;">)</span>
        z = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>z, 70<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">5 5 3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [1 2 30 40 50]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x [1 2 30 40 60]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [30 40 70]</span>
</pre>
</div></li>
<li>我们可以看到,slice操作得到新的slice之后,新的slice的capcity等于:之前的capcity减去新slice的start
这也就意味着,所有的原来slice的unused capacity也要共享</li>
<li>上面的例子告诉我们,如果用了普通的slice,那么不要使用append和普通的slice一起使用</li>
<li><p>
slice有一种变体叫做full slice expression,它可以和append一起使用,full slice expression原理,是
限定新的slice的capacity最多到哪个position
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 21:31:48</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2:2<span style="color: #F78C6C;">]</span>
        <span style="color: #ffcb6b;">z</span> := x<span style="color: #F78C6C;">[</span>2:4:4<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"cap(y)"</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>y<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"cap(z)"</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>z<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [1 2]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">cap(y) 2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [3 4]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">cap(z) 2</span>
</pre>
</div></li>
<li>如果full slice expression要和append公用,可以把full slice expression的第三个参数设置为新slice
的最后一个position. 这有两点好处:
<ol class="org-ol">
<li>如果新的slice没有被再次append,那么可以继续和老的slice share memory</li>
<li><p>
如果新的slice真的被append了,那么会触发go runtime创建新的内存地址拷贝老的内容到新的地址,也
就不会和之前的slice共享内存了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-23 21:37:36</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2:2<span style="color: #F78C6C;">]</span>
        <span style="color: #ffcb6b;">z</span> := x<span style="color: #F78C6C;">[</span>2:4:4<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x,y,z"</span>, x, y, z<span style="color: #F78C6C;">)</span>

        y = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>y, 50<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"after append 50 to y"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x,y,z"</span>, x, y, z<span style="color: #F78C6C;">)</span>

        z = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>z, 60<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"after append 60 to z"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x,y,z"</span>, x, y, z<span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x,y,z [1 2 3 4 5] [1 2] [3 4]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">after append 50 to y</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x,y,z [1 2 3 4 5] [1 2 50] [3 4]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">after append 60 to z</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x,y,z [1 2 3 4 5] [1 2 50] [3 4 60]</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgcc58ab1" class="outline-4">
<h4 id="orgcc58ab1"><span class="section-number-4">3.2.7.</span> Converting Arrays to Slices</h4>
<div class="outline-text-4" id="text-3-2-7">
<ul class="org-ul">
<li><p>
我们也可以在数组上面进行slice expression操作,这个操作即便是作用在数组上面,依然会share same memory
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 19:04:08</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[</span>4<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>5, 6, 7, 8<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := x<span style="color: #F78C6C;">[</span>:2<span style="color: #F78C6C;">]</span>
        <span style="color: #ffcb6b;">z</span> := x<span style="color: #F78C6C;">[</span>2:<span style="color: #F78C6C;">]</span>
        x<span style="color: #F78C6C;">[</span>0<span style="color: #F78C6C;">]</span> = 10
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"x"</span>, x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">x [10 6 7 8]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [10 6]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [7 8]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgf1d6272" class="outline-4">
<h4 id="orgf1d6272"><span class="section-number-4">3.2.8.</span> copy</h4>
<div class="outline-text-4" id="text-3-2-8">
<ul class="org-ul">
<li>前面的slice expression会share memory, 如果不想share memory,那么就要使用copy内置函数
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 19:12:14</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 3<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y, <span style="color: #c3e88d;">"cap(y)"</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>y<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"After copy"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">num</span> := <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>y, x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"y"</span>, y<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"num"</span>, num<span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">z</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 4, 10<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z, <span style="color: #c3e88d;">"cap(z)"</span>, <span style="color: #82aaff;">cap</span><span style="color: #c3e88d;">(</span>z<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"After copy"</span><span style="color: #F78C6C;">)</span>
        num = <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>z, x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"z"</span>, z<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"num"</span>, num<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [0 0 0] cap(y) 3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">After copy</span>
<span style="color: #626262;">// </span><span style="color: #626262;">y [1 2 3]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">num 3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [0 0 0 0] cap(z) 10</span>
<span style="color: #626262;">// </span><span style="color: #626262;">After copy</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z [1 2 3 4]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">num 4</span>
</pre>
</div></li>
<li>copy有两个参数,第一个参数是dest,第二个参数是src</li>
<li>copy会尽可能的从src拷贝数据到dest(只有dest length的部分才能分配的到, capacity不会作为参考)</li>
</ul></li>
<li>copy的使用非常的灵活:
<ul class="org-ul">
<li><p>
我们可以从src中间拷贝一部分到dest, 不关心拷贝了多少,可以不保留copy的返回值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 19:29:29</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 2<span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>y, x<span style="color: #c3e88d;">[</span>2:<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[3 4]</span>
</pre>
</div></li>
<li><p>
我们的src和dest还可以是同一个slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 19:31:19</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">num</span> := <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>x<span style="color: #c3e88d;">[</span>:3<span style="color: #c3e88d;">]</span>, x<span style="color: #c3e88d;">[</span>1:<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>x, num<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[2 3 4 4] 3</span>
</pre>
</div></li>
<li><p>
由于copy不在乎capacity,所以copy的src和dest都可以是slice expression数组后得到的slice(使用`[:]`)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 20:02:33</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">x</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3, 4, 5<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">d</span> := <span style="color: #F78C6C;">[</span>5<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>5, 6, 7, 8, 9<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">y</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 2<span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>y, d<span style="color: #c3e88d;">[</span>:<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>y<span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">copy</span><span style="color: #F78C6C;">(</span>d<span style="color: #c3e88d;">[</span>:<span style="color: #c3e88d;">]</span>, x<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>d<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[5 6]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[1 2 3 4 5]</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9368834" class="outline-3">
<h3 id="org9368834"><span class="section-number-3">3.3.</span> Strings and Runes and Bytes</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>一种比较常见的误解是认为string是由rune组成的.这种误区的来源于:
<ul class="org-ul">
<li>for-loop是以rune为单位的</li>
<li>很多go的library function是以rune为单位的</li>
</ul></li>
<li>但是,这其实是不对的,在go里面string其实是由byte组成的(由于Go默认使用UTF-8,所以这种byte默认是使用UTF-8
解析的,除非你另外指定)</li>
<li><p>
如果把string看成是一个slice,就像你可以从一个slice(array)里面获取一个value一样,你可以从string里面获取一个byte
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-25 21:44:08</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"Hello World"</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">b</span> <span style="color: #c792ea;">byte</span> = s<span style="color: #F78C6C;">[</span>6<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">string</span><span style="color: #c3e88d;">(</span>b<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">W</span>
</pre>
</div></li>
<li><p>
如果把string看成是一个slice,当然也可以对使用使用slice expression
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 19:18:21</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"Hello there"</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s2</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>4:7<span style="color: #F78C6C;">]</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s3</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>:5<span style="color: #F78C6C;">]</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s4</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>6:<span style="color: #F78C6C;">]</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s5</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>:<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s2<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s3<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s4<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s5<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">o t</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Hello</span>
<span style="color: #626262;">// </span><span style="color: #626262;">there</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Hello there</span>
</pre>
</div></li>
<li>string可以看做是一个slice,但是string是一个immutable的slice,所以:
<ul class="org-ul">
<li><p>
slice expression得到的新string更改不了,也就影响不到之前的string
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 19:27:27</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"hello world"</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s2</span> = s<span style="color: #F78C6C;">[</span>2:5<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"s"</span>, s<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"s2"</span>, s2<span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">//  </span><span style="color: #626262;">cannot assign to s2[0] (value of type byte)</span>
        <span style="color: #626262;">/////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">s2[0] = "H" //</span>
        <span style="color: #626262;">/////////////////</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"-&gt; s2 is now point to another memory address"</span><span style="color: #F78C6C;">)</span>
        s2 = <span style="color: #c3e88d;">"now"</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"s"</span>, s<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"s2"</span>, s2<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">s hello world</span>
<span style="color: #626262;">// </span><span style="color: #626262;">s2 llo</span>
<span style="color: #626262;">// </span><span style="color: #626262;">-&gt; s2 is now point to another memory address</span>
<span style="color: #626262;">// </span><span style="color: #626262;">s hello world</span>
<span style="color: #626262;">// </span><span style="color: #626262;">s2 now</span>
</pre>
</div></li>
<li><p>
但是有新的问题,因为string可以看做是byte的slice,所以我们可以从任意的位置来访问byte,但是UTF-8的
code point却不一定是每个位置(因为utf-8有1到4个byte的可能),所以使用slice expression获取的新string
可能是invalid的,比如
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 19:31:25</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"Hello &#20013;&#22269;"</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s2</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>4:7<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s2<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s3</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>4:8<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s3<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s4</span> <span style="color: #c792ea;">string</span> = s<span style="color: #F78C6C;">[</span>4:9<span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s4<span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">o \344</span>
<span style="color: #626262;">// </span><span style="color: #626262;">o \344\270</span>
<span style="color: #626262;">// </span><span style="color: #626262;">o &#20013;</span>
</pre>
</div></li>
</ul></li>
<li><p>
string可以看做是一个slice,其len的结果自然是byte的长度,而不是code point的长度
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 19:40:35</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"Hello &#20013;&#22269;"</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>s<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">12</span>
</pre>
</div></li>
<li><p>
之前我们讲过go存在一个int32的alias类型rune type(uint8的alias类型是byte type),这个rune类型就可以
用来存储utf-8字符(unicode是ascii,比如'z'的超集)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 19:49:52</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">r</span> <span style="color: #c792ea;">rune</span> = <span style="color: #c3e88d;">'&#20013;'</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">string</span><span style="color: #c3e88d;">(</span>r<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">r2</span> <span style="color: #c792ea;">rune</span> = <span style="color: #c3e88d;">'z'</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">string</span><span style="color: #c3e88d;">(</span>r2<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">cannot use '&#20013;' (untyped rune constant 20013) as byte value in variable declaration (overflows)</span>
        <span style="color: #626262;">///////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">var b byte = '&#20013;' //</span>
        <span style="color: #626262;">///////////////////////</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">b2</span> <span style="color: #c792ea;">byte</span> = <span style="color: #c3e88d;">'z'</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">string</span><span style="color: #c3e88d;">(</span>b2<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">&#20013;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z</span>
<span style="color: #626262;">// </span><span style="color: #626262;">z</span>
</pre>
</div></li>
<li>由于string和如下两种类型如此紧密的联系,以至于他们三者之间变化可以相互转换
<ul class="org-ul">
<li>byte(uint8的alias)</li>
<li>rune(int32的alias)</li>
</ul></li>
<li><p>
当然,转换也必须是explicit的,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-27 21:42:05</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span> = <span style="color: #c3e88d;">"Hello &#20013;&#22269;"</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">bs</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">byte</span> = <span style="color: #F78C6C;">[]</span><span style="color: #82aaff;">byte</span><span style="color: #F78C6C;">(</span>s<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">rs</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">rune</span> = <span style="color: #F78C6C;">[]</span><span style="color: #82aaff;">rune</span><span style="color: #F78C6C;">(</span>s<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>bs<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>rs<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[72 101 108 108 111 32 228 184 173 229 155 189]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[72 101 108 108 111 32 20013 22269]</span>
</pre>
</div></li>
<li>注意,对string来说:
<ul class="org-ul">
<li>我们不要使用slice expression或者index expression</li>
<li>我们要使用的是strings, unicode/utf8 package里面的function</li>
</ul></li>
<li>对于string来说,for loop是使用的code point,我们下一章会进行介绍</li>
</ul>
</div>
</div>
<div id="outline-container-org846cf20" class="outline-3">
<h3 id="org846cf20"><span class="section-number-3">3.4.</span> Maps</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>当你的数据是sequantial data的时候,slice对你很重要,但是你需要key-value数据的时候,就不能用slice了
每个语言都有自己的key-value容器.go的选择是map type</li>
<li>使用var可以创建一个nil map,此时map的nil值为nil(说明map和slice一样,是reference type)
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 14:45:21</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">nilMap</span> <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>nilMap == <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>nilMap<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"hello"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">// </span><span style="color: #626262;">panic: assignment to entry in nil map</span>
        <span style="color: #626262;">////////////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">nilMap["hello"] = 1        //</span>
        <span style="color: #626262;">////////////////////////////////</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0</span>
</pre>
</div></li>
<li>nil map的length为0</li>
<li>读取nil map总会返回相应类型的zero value</li>
<li>尝试写入nil map会报panic</li>
</ul></li>
<li><p>
使用 `:=` 创建的不再是nil map,而是empty map, 虽然两者length都是0,但是由于empty map被分配了内存
地址,所以其是可以写入的(读取当然更可以了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 14:49:29</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">totalWins</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{}</span>

        totalWins<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"hello"</span><span style="color: #F78C6C;">]</span> = 1
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>totalWins<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"hello"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
</pre>
</div></li>
<li><p>
我们可以使用map literal在初始化的时候,就给map赋一些值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 14:51:05</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">teams</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">][]</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c3e88d;">"Orcas"</span>:   <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Fred"</span>, <span style="color: #c3e88d;">"Ralph"</span>, <span style="color: #c3e88d;">"Bijou"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">"Lions"</span>:   <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Sarah"</span>, <span style="color: #c3e88d;">"Peter"</span>, <span style="color: #c3e88d;">"Billie"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">"Kittens"</span>: <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Waldo"</span>, <span style="color: #c3e88d;">"Raul"</span>, <span style="color: #c3e88d;">"Ze"</span><span style="color: #c3e88d;">}</span>,
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>teams<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">map[Kittens:[Waldo Raul Ze] Lions:[Sarah Peter Billie] Orcas:[Fred Ralph Bijou]]</span>
</pre>
</div></li>
<li><p>
如果你预先知道map的长度,也可以使用make创建一个capacity为N的map,但是这个N是可以超过的,换句话说,
这个N只不过是开始创建map的时候申请的内存地址,不够了可以再换(当然了,效率会低一点)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 14:54:22</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">ages</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">map</span><span style="color: #c3e88d;">[</span><span style="color: #c792ea;">int</span><span style="color: #c3e88d;">]</span><span style="color: #c792ea;">int</span>, 2<span style="color: #F78C6C;">)</span>
        ages<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]</span> = 11
        ages<span style="color: #F78C6C;">[</span>2<span style="color: #F78C6C;">]</span> = 22
        ages<span style="color: #F78C6C;">[</span>3<span style="color: #F78C6C;">]</span> = 33

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>ages<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">map[1:11 2:22 3:33]</span>
</pre>
</div></li>
<li>map和slice在很多地方上,都是类似的,比如:
<ul class="org-ul">
<li>map会随着你增加key-value而自动增加, slice会随着append自动增加</li>
<li>如果知道最终的数量,在申请map的make里面可以加上capacity, slice也一样,不过slice的第三个参数是capacity</li>
<li>map和slice都可使用len来进行长度计算</li>
<li>map和slice的zero value都是nil</li>
<li>map之间(以及slice之间),是没有办法比较的,换句话说不能使用 `==` 或者 `!=` 来比较两个map(或者slice),
但是map和slice是可以和nil使用`==`或者`!=`和nil进行比较的</li>
</ul></li>
<li>map的key value必须是可以比较的两种类型,这样就意味着:slice(或者map)不能作为key value</li>
<li>map中的key是没有顺序的(哈希表的原理导致),slice中的数据都是有顺序的</li>
</ul>
</div>
<div id="outline-container-org7e7184d" class="outline-4">
<h4 id="org7e7184d"><span class="section-number-4">3.4.1.</span> Reading and Writing a Map</h4>
<div class="outline-text-4" id="text-3-4-1">
<ul class="org-ul">
<li>下面的例子给我们来介绍一下如何读取map
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 16:45:36</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">totalWins</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{}</span>
        totalWins<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"Orcas"</span><span style="color: #F78C6C;">]</span> = 1
        totalWins<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"Lions"</span><span style="color: #F78C6C;">]</span> = 2
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>totalWins<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"Orcas"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>totalWins<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"Kittens"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        totalWins<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"Kittens"</span><span style="color: #F78C6C;">]</span>++
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>totalWins<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"Kittens"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        totalWins<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"Linos"</span><span style="color: #F78C6C;">]</span> = 3
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>totalWins<span style="color: #c3e88d;">[</span><span style="color: #c3e88d;">"Linos"</span><span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">3</span>
</pre>
</div></li>
<li>我们可以看到assign value使用的是`=` 而不是`:=`</li>
<li>如果读取一个没有存在的key,那么返回zero value</li>
<li>我们甚至可以使用`++`来提升一个value,即便这个key不存在都会直接设置成zero value然后increase</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org0bc39b8" class="outline-4">
<h4 id="org0bc39b8"><span class="section-number-4">3.4.2.</span> The comma ok idiom</h4>
<div class="outline-text-4" id="text-3-4-2">
<ul class="org-ul">
<li>map在没有key的情况下返回zero value,那如果用户真的写入的值就是zero value怎么办呢?
<ul class="org-ul">
<li>go给出的方案就是comma ok ldiom</li>
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 17:13:57</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">m</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c3e88d;">"hello"</span>: 5,
                <span style="color: #c3e88d;">"world"</span>: 0,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">ok</span> := m<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"hello"</span><span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, ok<span style="color: #F78C6C;">)</span>

        v, ok = m<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"world"</span><span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, ok<span style="color: #F78C6C;">)</span>

        v, ok = m<span style="color: #F78C6C;">[</span><span style="color: #c3e88d;">"goodbye"</span><span style="color: #F78C6C;">]</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, ok<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">5 true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0 true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0 false</span>
</pre>
</div></li>
<li>返回两个值,第一个是value type的值,第二个是bool,如果第二个是true的情况下,第一个值才有意义</li>
</ul></li>
<li>comma ok ldiom还用在如下两个方面:
<ul class="org-ul">
<li>type assertion</li>
<li>从channel读取数据</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgfbc0f62" class="outline-4">
<h4 id="orgfbc0f62"><span class="section-number-4">3.4.3.</span> Deleting from Maps</h4>
<div class="outline-text-4" id="text-3-4-3">
<ul class="org-ul">
<li>我们使用delete函数来从map里面删除某个key-value组合
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 17:16:53</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">m</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c3e88d;">"hello"</span>: 5,
                <span style="color: #c3e88d;">"world"</span>: 10,
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>m<span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">delete</span><span style="color: #F78C6C;">(</span>m, <span style="color: #c3e88d;">"hello"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>m<span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">delete</span><span style="color: #F78C6C;">(</span>m, <span style="color: #c3e88d;">"not-exist-key"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">m2</span> <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">string</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>m2 == <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>

        <span style="color: #82aaff;">delete</span><span style="color: #F78C6C;">(</span>m2, <span style="color: #c3e88d;">"some-key"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">map[hello:5 world:10]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">map[world:10]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
</pre>
</div></li>
<li>如果key不存在,不会发生任何事情</li>
<li>如果map是nil,也不会发生任何事情</li>
<li>delete没有返回值</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org67f8312" class="outline-4">
<h4 id="org67f8312"><span class="section-number-4">3.4.4.</span> Using Maps as Sets</h4>
<div class="outline-text-4" id="text-3-4-4">
<ul class="org-ul">
<li>go没有专门为set设计一个类型,只需要把map的value type设置成bool就是一个set了(当然了是没有set的union,
intersection操作的,如果需要这些操作请使用第三方库)
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 17:25:49</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">intSet</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">bool</span><span style="color: #F78C6C;">{}</span>
        <span style="color: #ffcb6b;">vals</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>5, 10, 2, 5, 8, 7, 3, 9, 1, 2, 10<span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> vals <span style="color: #F78C6C;">{</span>
                intSet<span style="color: #c3e88d;">[</span>v<span style="color: #c3e88d;">]</span> = <span style="color: #F78C6C;">true</span>
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>vals<span style="color: #c3e88d;">)</span>, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>intSet<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>intSet<span style="color: #c3e88d;">[</span>5<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>intSet<span style="color: #c3e88d;">[</span>500<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> intSet<span style="color: #F78C6C;">[</span>100<span style="color: #F78C6C;">]</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"100 is in the set"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">11 8</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">false</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org830f047" class="outline-3">
<h3 id="org830f047"><span class="section-number-3">3.5.</span> Structs</h3>
<div class="outline-text-3" id="text-3-5">
<ul class="org-ul">
<li>map只能存储类型一样的数据,如果想存储不一样类型但是有逻辑联系的数据,那么我们需要struct
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">person</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        name <span style="color: #c792ea;">string</span>
        age <span style="color: #c792ea;">int</span>
        pet <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>struct 类型有两个关键字type在前,struct在后</li>
<li>`{}`里面是成员,也是名字在前,类型在后</li>
<li>struct类型可以定义在function外,也可以定义在function内部.定义在function内部的只能被function所访问</li>
</ul></li>
<li>之前map和slice的var和:=初始化的结果是不一样的,但是在struct这里,如下两种初始化结果是一样的,都是所
有的field都设置为0:
<ul class="org-ul">
<li><p>
使用var
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">fred</span> <span style="color: #c792ea;">person</span>
</pre>
</div></li>
<li><p>
使用:=
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">bob</span> := <span style="color: #c792ea;">person</span><span style="color: #c792ea;">{}</span>
</pre>
</div></li>
</ul></li>
<li>初始化如果有内容,可以使用如下两种方法(两种方法不能混用):
<ul class="org-ul">
<li><p>
把所有初始化值按照顺序罗列:不推荐因为以后struct可能会发生变化
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">julia</span> := <span style="color: #c792ea;">person</span><span style="color: #c792ea;">{</span>
        <span style="color: #c3e88d;">"Julia"</span>,
        40,
        <span style="color: #c3e88d;">"cat"</span>,
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
罗列value的时候,还加上key. 没有设置的key,value就是zero值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">beth</span> := person <span style="color: #c792ea;">{</span>
        <span style="color: #F78C6C;">age</span>: 30,
        <span style="color: #F78C6C;">name</span>: <span style="color: #c3e88d;">"Beth"</span>,
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
<li><p>
我们使用dottted notation来读取field
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 19:04:41</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">person</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
                age  <span style="color: #c792ea;">int</span>
                pet  <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">bob</span> := <span style="color: #c792ea;">person</span><span style="color: #F78C6C;">{}</span>
        bob.name = <span style="color: #c3e88d;">"Bob"</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>bob.name<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Bob</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-orgcc7ed57" class="outline-4">
<h4 id="orgcc7ed57"><span class="section-number-4">3.5.1.</span> Anoymous Structs</h4>
<div class="outline-text-4" id="text-3-5-1">
<ul class="org-ul">
<li>我们刚才说struct创建的时候有两个关键字,type在前,struct再后. type在前其实就是为了给struct一个名
字.</li>
<li>如果我们的struct只使用一次(只给一个变量实例化),那么我们可以不给这个struct取名字(因为取名字还挺
麻烦的),那么我们可以使用anonymous struct</li>
<li>所谓anonymous struct,就是只用struct在后,而没有type+类型名字这一部分.有两种创建方法:
<ul class="org-ul">
<li><p>
使用var
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 19:30:30</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">p1</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
                age  <span style="color: #c792ea;">int</span>
                pet  <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        p1.name = <span style="color: #c3e88d;">"bob"</span>
        p1.age = 50
        p1.pet = <span style="color: #c3e88d;">"dog"</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>p1<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{bob 50 dog}</span>
</pre>
</div></li>
<li><p>
使用`:=`
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:00:34</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">pet</span> := <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
                kind <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}{</span>
                <span style="color: #F78C6C;">name</span>: <span style="color: #c3e88d;">"Fido"</span>,
                <span style="color: #F78C6C;">kind</span>: <span style="color: #c3e88d;">"dog"</span>,
        <span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>pet<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{Fido dog}</span>
</pre>
</div></li>
</ul></li>
<li>匿名struct在如下两种情况下比较有用:
<ul class="org-ul">
<li>marshaling(把struct转换成external data), 或者unmarshaling(把external data转换成struct). 这里
的external data最常见的类型是json</li>
<li>在写测试用例的时候,会用到匿名struct</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf951678" class="outline-4">
<h4 id="orgf951678"><span class="section-number-4">3.5.2.</span> Comparing and Converting Structs</h4>
<div class="outline-text-4" id="text-3-5-2">
<ul class="org-ul">
<li>一个struct是否是可比较的类型,要看这个struct的所有field是不是都是可比较的.如果有一个filed是不可比较
的类型(比如map或者slice),那么整个struct都是不可比较的类型</li>
<li><p>
一个可比较的struct的两个instance之间是可以使用 `==` 或者 `!=` 来进行比较的.但是一个不可比较类型
的struct的两个instance之间的比较是不成功的(报编译错误)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:12:42</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">firstPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f1</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"alice"</span><span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">f2</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"bob"</span><span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">f3</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"alice"</span><span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f1 == f2<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f1 == f3<span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">secondPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name  <span style="color: #c792ea;">string</span>
                age   <span style="color: #c792ea;">int</span>
                extra <span style="color: #89DDFF;">map</span><span style="color: #c3e88d;">[</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">]</span><span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f4</span> := <span style="color: #c792ea;">secondPerson</span><span style="color: #F78C6C;">{</span><span style="color: #F78C6C;">name</span>: <span style="color: #c3e88d;">"carl"</span>, <span style="color: #F78C6C;">age</span>: 30<span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">f5</span> := <span style="color: #c792ea;">secondPerson</span><span style="color: #F78C6C;">{</span><span style="color: #F78C6C;">name</span>: <span style="color: #c3e88d;">"david"</span>, <span style="color: #F78C6C;">age</span>: 31<span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f4, f5<span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">// </span><span style="color: #626262;">invalid operation: f4 == f5 (struct containing map[string]string cannot be compared)</span>
        <span style="color: #626262;">///////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">fmt.Println(f4 == f5) //</span>
        <span style="color: #626262;">///////////////////////////</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">false</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{carl 30 map[]} {david 31 map[]}</span>
</pre>
</div></li>
<li><p>
用户自己创建的struct可以看做是一个类型,就像go不允许不同primitive type的两个instance进行比较一样,
我们也不允许两个不同struct的instance进行比较
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:34:30</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">a1</span> <span style="color: #c792ea;">int16</span> = 1
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">a2</span> <span style="color: #c792ea;">int32</span> = 2

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>a1, a2<span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">// </span><span style="color: #626262;">invalid operation: a1 == a2 (mismatched types int16 and int32)</span>
        <span style="color: #626262;">///////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">fmt.Println(a1 == a2) //</span>
        <span style="color: #626262;">///////////////////////////</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">firstPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f1</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"alice"</span><span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">secondPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f2</span> := <span style="color: #c792ea;">secondPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"bob"</span><span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f1, f2<span style="color: #F78C6C;">)</span>

        <span style="color: #626262;">// </span><span style="color: #626262;">invalid operation: f1 == f2 (mismatched types firstPerson and secondPerson)</span>
        <span style="color: #626262;">///////////////////////////</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">fmt.Println(f1 == f2) //</span>
        <span style="color: #626262;">///////////////////////////</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1 2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{alice} {bob}</span>
</pre>
</div></li>
<li>如果实在希望比较两个不同struct的instance,那么我们要进行type conversion,能进行type conversion的
前提要求是这两个struct的field拥有:
<ul class="org-ul">
<li>same name</li>
<li>same order</li>
<li>same type</li>
</ul></li>
<li><p>
两个struct类型的type conversion后边比较的例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:38:36</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">firstPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f1</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"alice"</span><span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">secondPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f2</span> := <span style="color: #c792ea;">secondPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"alice"</span><span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f2Convert</span> := <span style="color: #82aaff;">firstPerson</span><span style="color: #F78C6C;">(</span>f2<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f1, f2, f2Convert<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f1 == f2Convert<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{alice} {alice} {alice}</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
</pre>
</div></li>
<li>匿名struct这里有一个优势:它可以减少一次type conversion, 换句话说就是匿名struct的名字可以认为是
和任意的struct的名字相同.</li>
<li>如果两个struct中有一个struct是匿名的,又假设两个struct的filed有same name, same order, same type,那么
我们可以直接:
<ul class="org-ul">
<li><p>
比较两者
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:44:38</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">firstPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">f</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"Alice"</span><span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">g</span> := <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}{</span>
                <span style="color: #c3e88d;">"Alice"</span>,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">h</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f, g, h<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f == g<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f == h<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>g == h<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{Alice} {Alice} {}</span>
<span style="color: #626262;">// </span><span style="color: #626262;">true</span>
<span style="color: #626262;">// </span><span style="color: #626262;">false</span>
<span style="color: #626262;">// </span><span style="color: #626262;">false</span>
</pre>
</div></li>
<li><p>
给两者进行赋值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-12-28 20:47:24</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Other useful commands:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #626262;">// </span><span style="color: #626262;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">firstPerson</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">f</span> := <span style="color: #c792ea;">firstPerson</span><span style="color: #F78C6C;">{</span><span style="color: #c3e88d;">"Alice"</span><span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">g</span> := <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}{</span>
                <span style="color: #c3e88d;">"Bob"</span>,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">h</span> <span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                name <span style="color: #c792ea;">string</span>
        <span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f, g, h<span style="color: #F78C6C;">)</span>

        h = f
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>h<span style="color: #F78C6C;">)</span>
        f = g
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>f<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{Alice} {Bob} {}</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{Alice}</span>
<span style="color: #626262;">// </span><span style="color: #626262;">{Bob}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org8766fc6" class="outline-2">
<h2 id="org8766fc6"><span class="section-number-2">4.</span> Chapter 5: Functions</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org107e34b" class="outline-3">
<h3 id="org107e34b"><span class="section-number-3">4.1.</span> Declaring and Calling Functions</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Go和C,Python,JS一样,都是拥有first-class function的语言</li>
<li>Go为function添加了很多的特性,但是有些特性是实验性质的,引入后效果不好,应该予以避免</li>
<li><p>
下面是一个function的例子
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">div</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">numerator</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">denominator</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">if</span> denominator == 0 <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> 0
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> numerator / denominator
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>一个函数声明包含四个部分:
<ul class="org-ul">
<li>keyword func</li>
<li>函数的名字</li>
<li>函数的参数</li>
<li>返回值类型</li>
</ul></li>
<li>go函数也是使用return关键字来返回</li>
<li><p>
如果一个函数没有input parameter那么使用empty parenthese就可以,如果没有返回值,那么可以省略掉函数
声明的第四部分:main函数就是这样一个没有参数,也没有返回值的函数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">result</span> := <span style="color: #82aaff;">div</span><span style="color: #F78C6C;">(</span>5, 2<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>result<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-org0ff9169" class="outline-4">
<h4 id="org0ff9169"><span class="section-number-4">4.1.1.</span> Simulating Named and Optional Parameters</h4>
<div class="outline-text-4" id="text-4-1-1">
<ul class="org-ul">
<li>在讲Go函数的特性之前,我们先在这里提一下Go函数没有的特性:named and optional input parameter</li>
<li>由于在Go里面没有这个特性,我们先看看在其他语言里面的named and optional input parameter 是什么样
子,我们以Python为例:
<ul class="org-ul">
<li><p>
所谓named parameter,就是在call function 的时候,除了参数值,同时把参数名也写进去,这样的话,参数
顺序可以颠倒
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">display</span><span style="color: #c792ea;">(</span>a, b, c<span style="color: #c792ea;">)</span>:
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[a] ==&gt;"""</span>, a<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[b] ==&gt;"""</span>, b<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[c] ==&gt;"""</span>, c<span style="color: #c792ea;">)</span>


<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">"__main__"</span>:
    display<span style="color: #c792ea;">(</span>1, 2, 3<span style="color: #c792ea;">)</span>
    display<span style="color: #c792ea;">(</span>b=3, a=2, c=1<span style="color: #c792ea;">)</span>


<span style="color: #626262;"># </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[a] ==&gt; 1</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[b] ==&gt; 2</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[c] ==&gt; 3</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[a] ==&gt; 2</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[b] ==&gt; 3</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[c] ==&gt; 1</span>
</pre>
</div></li>
<li><p>
所谓optional parameter,就是在call function的时候不给足参数数目,省略的参数由创建的时候指的的
default值来代替.还可以同时使用named input parameter,给定某些参数(而不是后面的参数)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">display</span><span style="color: #c792ea;">(</span>a=1, b=2, c=3<span style="color: #c792ea;">)</span>:
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[a] ==&gt;"""</span>, a<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[b] ==&gt;"""</span>, b<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[c] ==&gt;"""</span>, c<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"--------------"</span><span style="color: #c792ea;">)</span>


<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">"__main__"</span>:
    display<span style="color: #c792ea;">(</span>5<span style="color: #c792ea;">)</span>
    display<span style="color: #c792ea;">(</span>c=5<span style="color: #c792ea;">)</span>

<span style="color: #626262;"># </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[a] ==&gt; 5</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[b] ==&gt; 2</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[c] ==&gt; 3</span>
<span style="color: #626262;"># </span><span style="color: #626262;">--------------</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[a] ==&gt; 1</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[b] ==&gt; 2</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[c] ==&gt; 5</span>
<span style="color: #626262;"># </span><span style="color: #626262;">--------------</span>
</pre>
</div></li>
</ul></li>
<li>在Go里面,除了一个特例(variadic input),其他所有的情况下,函数调用的时候,必须把所有的参数都填满</li>
<li>如果实在想模拟named and optional parameter,我们可以使用如下的方法:
<ul class="org-ul">
<li>定义一个struct,里面填满函数所需要的所有的参数</li>
<li>调用的时候,可以选择初始化部分struct,没有初始化的就zero值</li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-10 19:45:37</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">MyFuncOpts</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        FirstName <span style="color: #c792ea;">string</span>
        LastName  <span style="color: #c792ea;">string</span>
        Age       <span style="color: #c792ea;">int</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">MyFunc</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">opts</span> <span style="color: #c792ea;">MyFuncOpts</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"FirstName:"</span>, opts.FirstName<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"LastName:"</span>, opts.LastName<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Age:"</span>, opts.Age<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">MyFunc</span><span style="color: #F78C6C;">(</span><span style="color: #c792ea;">MyFuncOpts</span><span style="color: #c3e88d;">{</span>
                <span style="color: #F78C6C;">LastName</span>: <span style="color: #c3e88d;">"Patel"</span>,
                <span style="color: #F78C6C;">Age</span>:      50,
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>
        <span style="color: #82aaff;">MyFunc</span><span style="color: #F78C6C;">(</span><span style="color: #c792ea;">MyFuncOpts</span><span style="color: #c3e88d;">{</span>
                <span style="color: #F78C6C;">FirstName</span>: <span style="color: #c3e88d;">"Joe"</span>,
                <span style="color: #F78C6C;">LastName</span>:  <span style="color: #c3e88d;">"Patel"</span>,
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">FirstName:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">LastName: Patel</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Age: 50</span>
<span style="color: #626262;">// </span><span style="color: #626262;">FirstName: Joe</span>
<span style="color: #626262;">// </span><span style="color: #626262;">LastName: Patel</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Age: 0</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7934acc" class="outline-4">
<h4 id="org7934acc"><span class="section-number-4">4.1.2.</span> Variadic Input Parameters and Dlices</h4>
<div class="outline-text-4" id="text-4-1-2">
<ul class="org-ul">
<li><p>
我们使用fmt.Println的时候可以使用任意数量的参数,原因就是fmt.Println使用了可变参数(variadic
input parameter),其源代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">Println formats using the default formats for its operands and writes to standard output.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Spaces are always added between operands and a newline is appended.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">It returns the number of bytes written and any write error encountered.</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">Println</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">a</span> ...<span style="color: #c792ea;">any</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">n</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #82aaff;">Fprintln</span><span style="color: #F78C6C;">(</span>os.Stdout, a...<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>可变参数的要求有两个:
<ul class="org-ul">
<li>在type前面使用`&#x2026;`</li>
<li>必须是最后一个参数(所以一个函数最多只能有一个可变参数)</li>
</ul></li>
<li>使用的时候,就把可变参数当做一个slice即可.</li>
<li><p>
我们可以把slice类型延展开,传递给variadic input parameter,注意,这种情况下是把`&#x2026;`放到变量后面,
学名叫做Arguments to variadic functions
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-10 19:58:30</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">addTo</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">base</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">vals</span> ...<span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">out</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">int</span>, 0, <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>vals<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> vals <span style="color: #F78C6C;">{</span>
                out = <span style="color: #82aaff;">append</span><span style="color: #c3e88d;">(</span>out, base+v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> out
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">addTo</span><span style="color: #c3e88d;">(</span>10, 5, 6, 7<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">sl</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3<span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">addTo</span><span style="color: #c3e88d;">(</span>10, sl...<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[15 16 17]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[11 12 13]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org5469e9c" class="outline-4">
<h4 id="org5469e9c"><span class="section-number-4">4.1.3.</span> Multiple Return Values</h4>
<div class="outline-text-4" id="text-4-1-3">
<ul class="org-ul">
<li>Go和其他语言特别不一样的地方在于: Go允许返回多个返回值:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">divAndRemainder</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">numerator</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">denominator</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #c792ea;">int</span>, <span style="color: #c792ea;">int</span>, <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">if</span> denominator == 0 <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> 0, 0, errors.<span style="color: #82aaff;">New</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"cannot divided by zero"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> numerator /denominator, numerator % denominator, <span style="color: #F78C6C;">nil</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>一旦使用多个返回值,在函数声明的地方,多个返回值要放在一个括号里面</li>
<li>但是在函数内部返回的时候,却是直接return a, b, c没有在a,b,c前后加括号</li>
<li>按照惯例,error都是作为最后一个参数</li>
<li><p>
调用的时候,需要把每个参数都赋值到对应参数,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"os"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">result</span>, <span style="color: #ffcb6b;">remainder</span>, <span style="color: #ffcb6b;">err</span> := <span style="color: #82aaff;">divAndRemainder</span><span style="color: #F78C6C;">(</span>5, 2<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>err<span style="color: #c3e88d;">)</span>
                os.<span style="color: #82aaff;">Exit</span><span style="color: #c3e88d;">(</span>1<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>result, remainder<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgfd7dd4a" class="outline-4">
<h4 id="orgfd7dd4a"><span class="section-number-4">4.1.4.</span> Multiple Return Values Are Multiple Values</h4>
<div class="outline-text-4" id="text-4-1-4">
<ul class="org-ul">
<li>go的多返回值和python多返回值不一样的地方在:
<ul class="org-ul">
<li><p>
python的返回值其实是一个tuple,你可以把返回值(多个的情况)赋予一个变量,这个变量就是一个tuple,也
可以赋值给多个变量,如下
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">div_and_remainder</span><span style="color: #c792ea;">(</span>n, d<span style="color: #c792ea;">)</span>:
    <span style="color: #89DDFF;">if</span> d == 0:
        <span style="color: #89DDFF;">raise</span> <span style="color: #c792ea;">Exception</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"cannot divide by zero"</span><span style="color: #c792ea;">)</span>
    <span style="color: #89DDFF;">return</span> n / d, n % d


<span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">__name__</span> == <span style="color: #c3e88d;">"__main__"</span>:
    v = div_and_remainder<span style="color: #c792ea;">(</span>5, 2<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[v] ==&gt;"""</span>, v<span style="color: #c792ea;">)</span>
    <span style="color: #ffcb6b;">result</span>, <span style="color: #ffcb6b;">remainder</span> = div_and_remainder<span style="color: #c792ea;">(</span>5, 2<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[result] ==&gt;"""</span>, result<span style="color: #c792ea;">)</span>
    <span style="color: #82aaff;">print</span><span style="color: #c792ea;">(</span><span style="color: #c3e88d;">"""[remainder] ==&gt;"""</span>, remainder<span style="color: #c792ea;">)</span>


<span style="color: #626262;"># </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[v] ==&gt; (2.5, 1)</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[result] ==&gt; 2.5</span>
<span style="color: #626262;"># </span><span style="color: #626262;">[remainder] ==&gt; 1</span>
</pre>
</div></li>
<li>go的返回值是真的多个返回值,你不能把返回值(多个的情况)赋予一个变量(编译会报错),需要赋予多个变量</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6676f4e" class="outline-4">
<h4 id="org6676f4e"><span class="section-number-4">4.1.5.</span> Ignoring Returned Values</h4>
<div class="outline-text-4" id="text-4-1-5">
<ul class="org-ul">
<li>Go 不允许有未使用的变量,所以一旦接收函数返回值,那么就必须全部接收,不想使用的用`_`来占位</li>
<li><p>
Go 虽然不允许有未使用的变量,但是却可以选择忽略所有返回值(因为忽略全部的话,就不会创建变量),其实
我们一直在使用这个特性,比如fmt.Println其实是有两个返回值的,但是我们从来不去处理他们,都是全部忽略
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">Println formats using the default formats for its operands and writes to standard output.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Spaces are always added between operands and a newline is appended.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">It returns the number of bytes written and any write error encountered.</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">Println</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">a</span> ...<span style="color: #c792ea;">any</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">n</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #82aaff;">Fprintln</span><span style="color: #F78C6C;">(</span>os.Stdout, a...<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgecb8b9b" class="outline-4">
<h4 id="orgecb8b9b"><span class="section-number-4">4.1.6.</span> Named Return Values</h4>
<div class="outline-text-4" id="text-4-1-6">
<ul class="org-ul">
<li>除了可以返回多个返回值,go另外一个和其他语言最大的不同是可以给返回值设置name:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">divAndRemainder</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">numerator</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">denominator</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">result</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">remainder</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">if</span> denominator == 0 <span style="color: #F78C6C;">{</span>
                err = errors.<span style="color: #82aaff;">New</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"cannot divide by zero"</span><span style="color: #c3e88d;">)</span>
                <span style="color: #89DDFF;">return</span> result, remainder, err
        <span style="color: #F78C6C;">}</span>
        result, remainder = numerator/denominator, numerator%denominator

        <span style="color: #89DDFF;">return</span> result, remainder, err
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>一旦给返回值都设置name了,那么必须得用括号括起来(即便只有一个返回值)</li>
<li>named return value会被初始化城zero value</li>
</ul></li>
<li>绝大部分情况下不要使用named return value,因为存在变量shadow的问题.只有一种情况下必须要使用named
return value,我们会在defer部分介绍</li>
</ul>
</div>
</div>
<div id="outline-container-org69e20e8" class="outline-4">
<h4 id="org69e20e8"><span class="section-number-4">4.1.7.</span> Blank Returns - Never Use These !</h4>
<div class="outline-text-4" id="text-4-1-7">
<ul class="org-ul">
<li>如果你使用了named return value,那么go还提供了延伸的特性,那就是:blank return
<ul class="org-ul">
<li>所谓blank return,就是在返回的时候,直接写一个return. 然后所有的named return value最后得到的值就直接返回了</li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">divAndReminder</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">numerator</span>, <span style="color: #ffcb6b;">denominator</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">result</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">remainder</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">if</span> denominator == 0 <span style="color: #F78C6C;">{</span>
                err = errors.<span style="color: #82aaff;">New</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"cannot divide by zero"</span><span style="color: #c3e88d;">)</span>
                <span style="color: #89DDFF;">return</span>
        <span style="color: #F78C6C;">}</span>
        result, remainder = numerator /denominator, numerator % denominator
        <span style="color: #89DDFF;">return</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
注意这个特性不要使用, 这是go里面设计的最不好的一个特性
</p>
<pre class="example" id="orgab14f3c">
If your function returns values, never use a blank return. It can
make it very confusing to figure out what value is actually returned.
</pre></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7d65ee6" class="outline-3">
<h3 id="org7d65ee6"><span class="section-number-3">4.2.</span> Functions Are Values</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>和很多其他语言一样,在go里面function也是value</li>
<li>function的type来自于三个个部分:
<ul class="org-ul">
<li>keyword func</li>
<li>参数的type</li>
<li>返回值的type</li>
</ul></li>
<li>上面这三个部分,也叫function的signature.</li>
<li>两个函数如果拥有相同数目,相同类型的参数和相同数目,相同类型的返回值,那么我们认为两个函数meet the type signature</li>
<li><p>
把function设置成为value,能让我们做一些聪明的操作.比如下面的例子中把函数做为map的value
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-12 22:25:59</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"strconv"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">add</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">i</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">j</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span> <span style="color: #89DDFF;">return</span> i + j <span style="color: #c792ea;">}</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">sub</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">i</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">j</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span> <span style="color: #89DDFF;">return</span> i - j <span style="color: #c792ea;">}</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">mul</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">i</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">j</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span> <span style="color: #89DDFF;">return</span> i * j <span style="color: #c792ea;">}</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">div</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">i</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">j</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span> <span style="color: #89DDFF;">return</span> i / j <span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">opMap</span> = <span style="color: #89DDFF;">map</span><span style="color: #c792ea;">[</span><span style="color: #c792ea;">string</span><span style="color: #c792ea;">]</span><span style="color: #89DDFF;">func</span><span style="color: #c792ea;">(</span><span style="color: #c792ea;">int</span>, <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">{</span>
        <span style="color: #c3e88d;">"+"</span>: add,
        <span style="color: #c3e88d;">"-"</span>: sub,
        <span style="color: #c3e88d;">"*"</span>: mul,
        <span style="color: #c3e88d;">"/"</span>: div,
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">expressions</span> := <span style="color: #F78C6C;">[][]</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"2"</span>, <span style="color: #c3e88d;">"+"</span>, <span style="color: #c3e88d;">"3"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"2"</span>, <span style="color: #c3e88d;">"-"</span>, <span style="color: #c3e88d;">"3"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"2"</span>, <span style="color: #c3e88d;">"*"</span>, <span style="color: #c3e88d;">"3"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"2"</span>, <span style="color: #c3e88d;">"/"</span>, <span style="color: #c3e88d;">"3"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"2"</span>, <span style="color: #c3e88d;">"%"</span>, <span style="color: #c3e88d;">"3"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"two"</span>, <span style="color: #c3e88d;">"+"</span>, <span style="color: #c3e88d;">"three"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"5"</span><span style="color: #c3e88d;">}</span>,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">expression</span> := <span style="color: #89DDFF;">range</span> expressions <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #c3e88d;">(</span>expression<span style="color: #c3e88d;">)</span> != 3 <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span><span style="color: #c3e88d;">"invalid expression: "</span>, expression<span style="color: #89DDFF;">)</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>
                <span style="color: #ffcb6b;">p1</span>, <span style="color: #ffcb6b;">err</span> := strconv.<span style="color: #82aaff;">Atoi</span><span style="color: #c3e88d;">(</span>expression<span style="color: #89DDFF;">[</span>0<span style="color: #89DDFF;">]</span><span style="color: #c3e88d;">)</span>
                <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span>err<span style="color: #89DDFF;">)</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>
                <span style="color: #ffcb6b;">op</span> := expression<span style="color: #c3e88d;">[</span>1<span style="color: #c3e88d;">]</span>
                <span style="color: #ffcb6b;">opFunc</span>, <span style="color: #ffcb6b;">ok</span> := opMap<span style="color: #c3e88d;">[</span>op<span style="color: #c3e88d;">]</span>

                <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF; font-weight: bold;">!</span>ok <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span><span style="color: #c3e88d;">"unsupported operator:"</span>, op<span style="color: #89DDFF;">)</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>

                <span style="color: #ffcb6b;">p2</span>, <span style="color: #ffcb6b;">err</span> := strconv.<span style="color: #82aaff;">Atoi</span><span style="color: #c3e88d;">(</span>expression<span style="color: #89DDFF;">[</span>2<span style="color: #89DDFF;">]</span><span style="color: #c3e88d;">)</span>
                <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span>err<span style="color: #89DDFF;">)</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>

                <span style="color: #ffcb6b;">result</span> := <span style="color: #82aaff;">opFunc</span><span style="color: #c3e88d;">(</span>p1, p2<span style="color: #c3e88d;">)</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>result<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">5</span>
<span style="color: #626262;">// </span><span style="color: #626262;">-1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">6</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">unsupported operator: %</span>
<span style="color: #626262;">// </span><span style="color: #626262;">strconv.Atoi: parsing "two": invalid syntax</span>
<span style="color: #626262;">// </span><span style="color: #626262;">invalid expression:  [5]</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-org5e23737" class="outline-4">
<h4 id="org5e23737"><span class="section-number-4">4.2.1.</span> Function Type Declarations</h4>
<div class="outline-text-4" id="text-4-2-1">
<ul class="org-ul">
<li>就像可以使用type来定义一个struct一样,我们也可以使用type来定义一个function type:
<ul class="org-ul">
<li><p>
如下定义一个function type
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">opFuncType</span> <span style="color: #89DDFF;">func</span><span style="color: #c792ea;">(</span><span style="color: #c792ea;">int</span>, <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span>
</pre>
</div></li>
<li><p>
上面的map定义就可以写成如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">opMap</span> = <span style="color: #89DDFF;">map</span><span style="color: #c792ea;">[</span><span style="color: #c792ea;">string</span><span style="color: #c792ea;">]</span><span style="color: #c792ea;">opFuncType</span> <span style="color: #c792ea;">{</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">same as before</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org3eed4f1" class="outline-4">
<h4 id="org3eed4f1"><span class="section-number-4">4.2.2.</span> Anonymous Functions</h4>
<div class="outline-text-4" id="text-4-2-2">
<ul class="org-ul">
<li>在function内部定义的function叫做anonymous function:
<ul class="org-ul">
<li>这种函数没有名字</li>
<li>可以把匿名函数赋值给变量</li>
<li><p>
也可以直接使用匿名函数(inline创建,并且直接调用),如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-13 16:16:37</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; 5; i++ <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">j</span> <span style="color: #c792ea;">int</span><span style="color: #c3e88d;">)</span> <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span><span style="color: #c3e88d;">"printing"</span>, j, <span style="color: #c3e88d;">"form inside of an anonymous function"</span><span style="color: #89DDFF;">)</span>
                <span style="color: #c3e88d;">}(</span>i<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">printing 0 form inside of an anonymous function</span>
<span style="color: #626262;">// </span><span style="color: #626262;">printing 1 form inside of an anonymous function</span>
<span style="color: #626262;">// </span><span style="color: #626262;">printing 2 form inside of an anonymous function</span>
<span style="color: #626262;">// </span><span style="color: #626262;">printing 3 form inside of an anonymous function</span>
<span style="color: #626262;">// </span><span style="color: #626262;">printing 4 form inside of an anonymous function</span>
</pre>
</div></li>
</ul></li>
<li>创建匿名调用逻辑代码和直接使用逻辑代码,似乎也没有什么不同.但是有两种情况下,必须创建你们函数来调用逻辑代码:
<ul class="org-ul">
<li>使用defer statement的时候</li>
<li>启用goroutine的时候</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc93a3da" class="outline-3">
<h3 id="orgc93a3da"><span class="section-number-3">4.3.</span> Closures</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li><p>
定义在function里面的function是比较特殊的,他们叫做闭包
</p>
<pre class="example" id="orgd22d3e9">
functions declared inside of functions are special; they are closures
</pre></li>
<li>所谓closure是这样一种计算机的概念: 定义在outer function里面的inner function可以访问并且修改outer
function里面定义的变量. 这个特性在closure传递给另外的function(或者作为返回值返回)的时候,就会非
常有用:因为这个时候,closure不仅仅包含了这个function,还包含了outer function所在的scope(里面的变量)</li>
<li>所以,我们可以深化一下前面对于closure的定义:
<ul class="org-ul">
<li>一旦一个function定义在另外一个function里面,这个function就必然是closure,这个和定义一致</li>
<li>但是closure又比普通function多一点,多的就是outer function所在的scope里面的变量,也是closure的一
部分,因为inner function能访问到这些变量,所以这些变量会一直valid,并且每次closure初始化的时候,
初始化scope里面的变量.这么讲有些空洞,我们看后面两个例子就理解了:
<ol class="org-ol">
<li><p>
把functionA作为参数传递给另外一个functionB,那么functionA其实就是定义在另外一个functionB里
面的.functionA,外加functionB的参数(因为和functionA在一个scope)和起来就是一个closure
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-14 16:45:27</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"sort"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">authors</span> := <span style="color: #F78C6C;">[]</span><span style="color: #89DDFF;">struct</span> <span style="color: #F78C6C;">{</span>
                Name <span style="color: #c792ea;">string</span>
                ID   <span style="color: #c792ea;">int</span>
        <span style="color: #F78C6C;">}{</span>
                <span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Cina"</span>, 2<span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Bell"</span>, 1<span style="color: #c3e88d;">}</span>,
                <span style="color: #c3e88d;">{</span><span style="color: #c3e88d;">"Alex"</span>, 3<span style="color: #c3e88d;">}</span>,
        <span style="color: #F78C6C;">}</span>

        sort.<span style="color: #82aaff;">Slice</span><span style="color: #F78C6C;">(</span>authors, <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">p</span>, <span style="color: #ffcb6b;">q</span> <span style="color: #c792ea;">int</span><span style="color: #c3e88d;">)</span> <span style="color: #c792ea;">bool</span> <span style="color: #c3e88d;">{</span>
                <span style="color: #89DDFF;">return</span> authors<span style="color: #89DDFF;">[</span>p<span style="color: #89DDFF;">]</span>.Name &lt; authors<span style="color: #89DDFF;">[</span>q<span style="color: #89DDFF;">]</span>.Name
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Sort authors by name"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>authors<span style="color: #F78C6C;">)</span>

        sort.<span style="color: #82aaff;">Slice</span><span style="color: #F78C6C;">(</span>authors, <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">p</span>, <span style="color: #ffcb6b;">q</span> <span style="color: #c792ea;">int</span><span style="color: #c3e88d;">)</span> <span style="color: #c792ea;">bool</span> <span style="color: #c3e88d;">{</span>
                <span style="color: #89DDFF;">return</span> authors<span style="color: #89DDFF;">[</span>p<span style="color: #89DDFF;">]</span>.ID &lt; authors<span style="color: #89DDFF;">[</span>q<span style="color: #89DDFF;">]</span>.ID
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Sort authors by id"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>authors<span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Sort authors by name</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[{Alex 3} {Bell 1} {Cina 2}]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Sort authors by id</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[{Bell 1} {Cina 2} {Alex 3}]</span>
</pre>
</div></li>
<li><p>
把functionA作为另外一个函数functionB的一个返回值返回,那么functionB里面的变量和functionA也
合成了一个closure, 一个例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-13 22:54:40</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">intSeq</span><span style="color: #c792ea;">()</span> <span style="color: #89DDFF;">func</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">i</span> := 0
        <span style="color: #89DDFF;">return</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #c792ea;">int</span> <span style="color: #F78C6C;">{</span>
                i++
                <span style="color: #89DDFF;">return</span> i
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">nextInt</span> := <span style="color: #82aaff;">intSeq</span><span style="color: #F78C6C;">()</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">nextInt</span><span style="color: #c3e88d;">()</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">nextInt</span><span style="color: #c3e88d;">()</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">nextInt</span><span style="color: #c3e88d;">()</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">nextInt2</span> := <span style="color: #82aaff;">intSeq</span><span style="color: #F78C6C;">()</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">nextInt2</span><span style="color: #c3e88d;">()</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgcf16bdc" class="outline-4">
<h4 id="orgcf16bdc"><span class="section-number-4">4.3.1.</span> Passing Functions as Parameters</h4>
<div class="outline-text-4" id="text-4-3-1">
<ul class="org-ul">
<li>前面说了function是value, 你可以设置function的类型(通过其参数和返回值来唯一定义)</li>
<li><p>
既然function是value,那么他当然可以作为参数传递给其他function.这里是我们需要额外理解的地方,直接
传递一个函数给另外一个函数是没有意义的.因为函数是stateless的,传递一个逻辑计算能力(function)给
另外一个function是没有用的.所以,我们必须是function+scope,形成一个closure传递给另外的function
</p>
<pre class="example" id="org2a11462">
If you aren't used to treating functions like data, you might need a moment to think about
the implications of creating a closure that references local variables and then passing
that closure to another function
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org219ca77" class="outline-4">
<h4 id="org219ca77"><span class="section-number-4">4.3.2.</span> Returning Functions from Functions</h4>
<div class="outline-text-4" id="text-4-3-2">
<ul class="org-ul">
<li>从functionB中返回一个functionA,其实这个functionA还带着functionB的scope,合起来就是一个closure</li>
<li><p>
上面的例子是functionA继承了functionB中的i的初始化值,这个i是在functionB的body当中,另外一种情况是
变量存在于functionB的参数中,然后也在functionB的scope种.这种情况更普遍,因为functionB的参数可以从
外界接受实参.例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-14 18:39:12</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">makeMult</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">base</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #89DDFF;">func</span><span style="color: #c792ea;">(</span><span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">(</span><span style="color: #ffcb6b;">factor</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> base * factor
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">twoBase</span> := <span style="color: #82aaff;">makeMult</span><span style="color: #F78C6C;">(</span>2<span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">threeBase</span> := <span style="color: #82aaff;">makeMult</span><span style="color: #F78C6C;">(</span>3<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; 3; i++ <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #82aaff;">twoBase</span><span style="color: #89DDFF;">(</span>i<span style="color: #89DDFF;">)</span>, <span style="color: #82aaff;">threeBase</span><span style="color: #89DDFF;">(</span>i<span style="color: #89DDFF;">)</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0 0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">2 3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">4 6</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5aee616" class="outline-3">
<h3 id="org5aee616"><span class="section-number-3">4.4.</span> defer</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>程序总是会创建临时资源,比如:
<ul class="org-ul">
<li>文件</li>
<li>网络连接</li>
</ul></li>
<li>临时资源的特点是他们需要被清理,然后清理的过程比想象中复杂,因为:
<ul class="org-ul">
<li>一个程序有可能是运行完所有代码return</li>
<li>一个程序还有可能是在中间的逻辑return</li>
<li>一个程序还有可能没有正确运行(发生了异常),就从没有return的位置退出</li>
</ul></li>
<li>所以,所有的编程语言都要有一种清理临时资源的机制,在java里面是try catch,在Go里面就是defer</li>
<li>下面的例子是我们使用Go来编写Unix下的命令cat,在这个过程当中,使用了defer
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-16 19:40:55</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"io"</span>
        <span style="color: #c3e88d;">"log"</span>
        <span style="color: #c3e88d;">"os"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">if</span> <span style="color: #82aaff;">len</span><span style="color: #F78C6C;">(</span>os.Args<span style="color: #F78C6C;">)</span> &lt; 2 <span style="color: #F78C6C;">{</span>
                log.<span style="color: #82aaff;">Fatal</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"no file specified"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">f</span>, <span style="color: #ffcb6b;">err</span> := os.<span style="color: #82aaff;">Open</span><span style="color: #F78C6C;">(</span>os.Args<span style="color: #c3e88d;">[</span>1<span style="color: #c3e88d;">]</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #F78C6C;">{</span>
                log.<span style="color: #82aaff;">Fatal</span><span style="color: #c3e88d;">(</span>err<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">defer</span> f.<span style="color: #82aaff;">Close</span><span style="color: #F78C6C;">()</span>

        <span style="color: #ffcb6b;">data</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">byte</span>, 2048<span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #ffcb6b;">count</span>, <span style="color: #ffcb6b;">err</span> := f.<span style="color: #82aaff;">Read</span><span style="color: #c3e88d;">(</span>data<span style="color: #c3e88d;">)</span>
                os.Stdout.<span style="color: #82aaff;">Write</span><span style="color: #c3e88d;">(</span>data<span style="color: #89DDFF;">[</span>:count<span style="color: #89DDFF;">]</span><span style="color: #c3e88d;">)</span>
                <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">if</span> err != io.EOF <span style="color: #89DDFF;">{</span>
                                log.<span style="color: #82aaff;">Fatal</span><span style="color: #bb80b3;">(</span>err<span style="color: #bb80b3;">)</span>
                        <span style="color: #89DDFF;">}</span>
                        <span style="color: #89DDFF;">break</span>
                <span style="color: #c3e88d;">}</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>上面的例子就使用了defer加一个method</li>
<li>defer不会马上运行,它会在surrounding function exit的时候(无论是中国正常的还是异常的退出)调用</li>
</ul></li>
<li>关于defer还有如下要点:
<ul class="org-ul">
<li><p>
一个函数里面可以defer多次,按照"后来先运行"的方法运行:
</p>
<pre class="example" id="org891495b">
The last defer registered runs first
</pre></li>
<li><p>
defer函数的参数在定义的时候就已经明确并且和defer语句一起入栈.不会再改变
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-16 20:14:57</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">i</span> := 1
        <span style="color: #89DDFF;">defer</span> fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>i<span style="color: #F78C6C;">)</span>
        i += 100
        <span style="color: #89DDFF;">return</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
</pre>
</div></li>
<li><p>
defer运行在return statement之后,但是在return statemnt返回给用户之前.这就有意思了,我们可以用这
个特性来"根据情况修改返回值":我们可以在defer里面创建一个closure, 这个closure所在的scope就是这
个函数,那么这个函数的返回值自然可以被closure所使用.注意这里同时还要使用named return value,而且
是唯一使用named return value的地方(以为你named return value可以从函数还没开始的时候就定义了返
回值变量)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">DoSomeInserts</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ctx</span> <span style="color: #c792ea;">context.Context</span>, <span style="color: #ffcb6b;">db</span> *<span style="color: #c792ea;">sql.DB</span>, <span style="color: #ffcb6b;">value1</span>, <span style="color: #ffcb6b;">value2</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">tx</span>, <span style="color: #ffcb6b;">err</span> := db.<span style="color: #82aaff;">BeginTx</span><span style="color: #F78C6C;">(</span>ctx, <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> err
        <span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">defer</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">if</span> err == <span style="color: #F78C6C;">nil</span> <span style="color: #c3e88d;">{</span>
                        err = tx.<span style="color: #82aaff;">Commit</span><span style="color: #89DDFF;">()</span>
                <span style="color: #c3e88d;">}</span>
                <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #c3e88d;">{</span>
                        tx.<span style="color: #82aaff;">Rollback</span><span style="color: #89DDFF;">()</span>
                <span style="color: #c3e88d;">}</span>
        <span style="color: #F78C6C;">}()</span>
        _, err = tx.<span style="color: #82aaff;">ExecContext</span><span style="color: #F78C6C;">(</span>ctx, <span style="color: #c3e88d;">"INSERT INTO FOO (val) values $1"</span>, value1<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> err
        <span style="color: #F78C6C;">}</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">use tx to do more database inserts here</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #F78C6C;">nil</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
<li>Go中还有一种常见的pattern就是返回资源的同时,还返回一个"清理这个资源的closure",比如下面的例子:
<ul class="org-ul">
<li><p>
我们的函数除了返回一个file以外,还返回了这个回收这个file的closure,以及一个error(确认这个函数调
用是否正常)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">getFile</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">name</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span>*<span style="color: #c792ea;">os.File</span>, <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span>, <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">file</span>, <span style="color: #ffcb6b;">err</span> := os.<span style="color: #82aaff;">Open</span><span style="color: #F78C6C;">(</span>name<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">return</span> <span style="color: #F78C6C;">nil</span>, <span style="color: #F78C6C;">nil</span>, err
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> file, <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                file.<span style="color: #82aaff;">Close</span><span style="color: #c3e88d;">()</span>
        <span style="color: #F78C6C;">}</span>, <span style="color: #F78C6C;">nil</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
使用的时候,我们就是除了使用file以外,还要defer"清理这个file的closure"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">f</span>, <span style="color: #ffcb6b;">closer</span>, <span style="color: #ffcb6b;">err</span> := <span style="color: #82aaff;">getFile</span><span style="color: #c792ea;">(</span>os.Args<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]</span><span style="color: #c792ea;">)</span>
<span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #c792ea;">{</span>
        log.<span style="color: #82aaff;">Fatal</span><span style="color: #F78C6C;">(</span>err<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">defer</span> <span style="color: #82aaff;">closer</span><span style="color: #c792ea;">()</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2460780" class="outline-3">
<h3 id="org2460780"><span class="section-number-3">4.5.</span> Go is Call By Value</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li><p>
Go是所谓的call by value,也就是说当你提供一个变量给function作为参数的时候,编译器总是把这个变量给
copy一遍
</p>
<pre class="example" id="orgcc1eeb8">
It means that when you supply a vairable for a parameter to a function,
Go always makes a copy of the value of the variable
</pre></li>
<li>我们来看个例子,绝大部分情况下函数不会更改参数的值:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-16 20:52:03</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">person</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        age  <span style="color: #c792ea;">int</span>
        name <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">modifyFails</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">i</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span>, <span style="color: #ffcb6b;">p</span> <span style="color: #c792ea;">person</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        i = i * 2
        s = <span style="color: #c3e88d;">"Goodbye"</span>
        p.name = <span style="color: #c3e88d;">"Bob"</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">p</span> := <span style="color: #c792ea;">person</span><span style="color: #F78C6C;">{}</span>
        <span style="color: #ffcb6b;">i</span> := 2
        <span style="color: #ffcb6b;">s</span> := <span style="color: #c3e88d;">"Hello"</span>
        <span style="color: #82aaff;">modifyFails</span><span style="color: #F78C6C;">(</span>i, s, p<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>i, s, p<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">2 Hello {0 }</span>
</pre>
</div></li>
<li>我们可以看到function没有更改参数的value</li>
</ul></li>
<li>有两种情况函数会更改输入参数的值,分别是参数为map或者slice,因为这两种类型都是以pointer来实现的:
<ul class="org-ul">
<li><p>
输入参数是map的情况,比较符合直觉,就是都可以改动,因为copy传进来的是指针,也就是形参实参都是同一
块内存,所以无论怎样更改形参,都会影响到实参
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-16 21:15:22</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">modMap</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">m</span> <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        m<span style="color: #F78C6C;">[</span>2<span style="color: #F78C6C;">]</span> = <span style="color: #c3e88d;">"hello"</span>
        m<span style="color: #F78C6C;">[</span>3<span style="color: #F78C6C;">]</span> = <span style="color: #c3e88d;">"goodbye"</span>
        <span style="color: #82aaff;">delete</span><span style="color: #F78C6C;">(</span>m, 1<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">m</span> := <span style="color: #89DDFF;">map</span><span style="color: #F78C6C;">[</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">]</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">{</span>
                <span style="color: #F78C6C;">1</span>: <span style="color: #c3e88d;">"first"</span>,
                <span style="color: #F78C6C;">2</span>: <span style="color: #c3e88d;">"second"</span>,
        <span style="color: #F78C6C;">}</span>
        <span style="color: #82aaff;">modMap</span><span style="color: #F78C6C;">(</span>m<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>m<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">map[2:hello 3:goodbye]</span>
</pre>
</div></li>
<li><p>
输入参数是slice的情况,比map要更复杂一些, 虽然copy进来的也是指针,虽然理论上任何改动也会影响到
实参,但是由于slice更改长度只能使用append, 而append会产生新的地址,但是新地址是无法传递回去的.
所以代码中更改slice长度的部分没有成功
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-16 21:16:49</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">modSlice</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">s</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">k</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> s <span style="color: #F78C6C;">{</span>
                s<span style="color: #c3e88d;">[</span>k<span style="color: #c3e88d;">]</span> = v * 2
        <span style="color: #F78C6C;">}</span>

        s = <span style="color: #82aaff;">append</span><span style="color: #F78C6C;">(</span>s, 10<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">s</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>1, 2, 3<span style="color: #F78C6C;">}</span>
        <span style="color: #82aaff;">modSlice</span><span style="color: #F78C6C;">(</span>s<span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>s<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[2 4 6]</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgff1a91b" class="outline-2">
<h2 id="orgff1a91b"><span class="section-number-2">5.</span> Chapter 6: Pointers</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org1241940" class="outline-3">
<h3 id="org1241940"><span class="section-number-3">5.1.</span> A Quick Pointer Primer</h3>
</div>
<div id="outline-container-org6f4ec0b" class="outline-3">
<h3 id="org6f4ec0b"><span class="section-number-3">5.2.</span> Don't Fear the Pointers</h3>
</div>
<div id="outline-container-org59c4a6a" class="outline-3">
<h3 id="org59c4a6a"><span class="section-number-3">5.3.</span> Pointers Indicate Mutable Parameters</h3>
</div>
<div id="outline-container-orgfee4cf8" class="outline-3">
<h3 id="orgfee4cf8"><span class="section-number-3">5.4.</span> Pointers Are a Lst Resort</h3>
</div>
<div id="outline-container-orgaddb56d" class="outline-3">
<h3 id="orgaddb56d"><span class="section-number-3">5.5.</span> Pointer Passing Performance</h3>
</div>
<div id="outline-container-org38c8ab6" class="outline-3">
<h3 id="org38c8ab6"><span class="section-number-3">5.6.</span> The Zero Value Versus No Value</h3>
</div>
<div id="outline-container-orgf5d1f42" class="outline-3">
<h3 id="orgf5d1f42"><span class="section-number-3">5.7.</span> The Difference Between Maps</h3>
</div>
<div id="outline-container-org73d2daf" class="outline-3">
<h3 id="org73d2daf"><span class="section-number-3">5.8.</span> Slices are Buffers</h3>
</div>
<div id="outline-container-org513d667" class="outline-3">
<h3 id="org513d667"><span class="section-number-3">5.9.</span> Reducing the Garbage Collector's Workload</h3>
</div>
</div>
<div id="outline-container-orga5c9c06" class="outline-2">
<h2 id="orga5c9c06"><span class="section-number-2">6.</span> Chapter 10: Concurrency in Go</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>并发(concurrency)是一个计算机术语,用来描述如何把一个processs分成独立的部分,并且明确这些部分如何共享数据</li>
<li>大部分的语言都是通过library来使用操作系统的thread实现并发的</li>
<li>操作系统的thread是通过获取锁的方式来共享数据的</li>
<li>Go是不同的,它的并发理论来源于CSP(communicating Sequential Processes)</li>
<li>CSP和其他并发模型能力一样,但是具有容易理解的特点</li>
<li>本章会学习Go并发模型的几个重点特性:
<ul class="org-ul">
<li>goroutine</li>
<li>channel</li>
<li>select</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgd08c63d" class="outline-3">
<h3 id="orgd08c63d"><span class="section-number-3">6.1.</span> When to Use Concurrency</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>首先要确定你的程序能从并发里面获益</li>
<li>很多GO程序员一开始使用并发的时候,都会经历如下的几个阶段:
<ul class="org-ul">
<li>并发非常好,我要所有的东西都用并发!</li>
<li>我们的程序不够快,我要给我的channel加上buffer</li>
<li>我们的channel容易block,为了不deadline,我要使用巨大的buffer的 buffered channel</li>
<li>我们的channel还是blocking,我要使用mutex</li>
<li>算了,我放弃使用并发了</li>
</ul></li>
<li>人们被并发所吸引,是因为感觉并发能够让程序跑的更快,但是实际上这并非如此</li>
<li>真实的情况是: 更多的并发并不会自动的让程序更快,却很大概率让程序更难以理解</li>
<li><p>
理解上面所说的关键是要理解两个概念的区别: 并发并非并行
</p>
<pre class="example" id="org782eb17">
concurrency is not parallelism
</pre></li>
<li>并发其实是一个更好的组织工具,从逻辑上来解决你的问题.至于是否并发的代码能够并行运行,要看硬件(包括
算法)是否支持</li>
<li><p>
总结起来,我们需要理解:更多的并发并不意味着更快的代码
</p>
<pre class="example" id="org77ce792">
More concurrency does not mean more speed
</pre></li>
<li>概括起来讲,所有的程序都会按照如下三步来处理数据:
<ul class="org-ul">
<li>获取数据</li>
<li>更改数据</li>
<li>输出数据</li>
</ul></li>
<li>是否应该在代码里面使用并发取决于你的程序里面的data如何在不同step之间flow:
<ul class="org-ul">
<li>可以使用并发的情况:不同的step可以同时发生, 因为某个step的output,不影响后面的step的启动.也就是
说不同step之间的可以独立的启动和运行</li>
<li>不可以使用并发的情况:不同的step必须按照一定的顺序发生,因为后面一个step的启动,可能需要前面一个step的output.</li>
</ul></li>
<li>另外,还有一种情况"可以但是不适合引入并发": 那就是并发运行时间很短的情况</li>
<li>之所以不要在这种情况下引入并发,是因为得不偿失:因为引入并发是有代价的:
<ul class="org-ul">
<li>因为引入并发需要一些损耗(无论是并发手段还是处理器调度)</li>
</ul></li>
<li>并发往往应用在I/O上面,因为相比内存操作,IO操作(读取文件或者网络)的时间的速度要比内存操作几千倍</li>
<li>如果实在拿不准是否要使用并发,那么先写线性代码,再写并发代码,看看哪个的速度更快.</li>
</ul>
</div>
</div>
<div id="outline-container-orgae45c9c" class="outline-3">
<h3 id="orgae45c9c"><span class="section-number-3">6.2.</span> Goroutines</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>goroutine是GO并发工具的核心,为了能够搞明白goroutine,我们来定义几个术语:
<ul class="org-ul">
<li>process: process是一个program的运行时,是被计算机操作系统来调度和运行的.操作系统会赋予某个process
一定的资源(比如内存),并且保证其他process都无法解除这些资源</li>
<li>thread: 隶属于process,是运行的最小单位. 一个process内的不同thread共享process的资源.如果CPU有多
个核,那么可以同时运行多个thread.操作系统的主要工作就是通过调度让每个thread都有运行的机会</li>
</ul></li>
<li>goroutine是被Go runtime调度的lightweight processs</li>
<li>当一个Go 程序启动的时候, Go runtime会:
<ul class="org-ul">
<li>创建M个thread</li>
<li>并且启动一个goroutine(也就是main goroutine)来运行</li>
</ul></li>
<li>后续会创建其他新的goroutine,这些goroutine和main goroutine一起都会被Go runtime赋予给那M个thread,
当然这一切都是自动的</li>
<li>Go runtime去schedule goroutine看起来和操作系统去schedule thread的功能重复了,但是有其重要的意义:
<ul class="org-ul">
<li>goroutine的创建比thread的创建快捷,因为你不需要创建操作系统级别的资源</li>
<li>goroutine的初始化stack比较thread的小,但是可以根据需要扩大,所以goroutine的内存使用效率高</li>
<li>goroutine在Go runtime内部调度的上下文切换(由goroutineA执行变成goroutineB执行)非常快,反之在操作
系统内部不同thread上下文切换很慢.因为goroutine是在process内部切换不需要使用非常慢的系统调用</li>
<li>Go 内部的scheduler有很多优化的创新,比如:
<ol class="org-ol">
<li>go内部的scheduler会和network poller合作,监控哪些goroutine blocking在IO上了,那么就标记这个
goroutine为unscheduled</li>
<li>go内部的schedular还会和garbage collector合作,确保工作负荷平均分配到了M个thread(一开始分配
的)上</li>
</ol></li>
</ul></li>
<li>goroutine的这些优点,让一个process内部能够存在高达上万个goroutine,而在一个process中存在上万个thread
是不太可能的</li>
<li>goroutine的启动很简单.和调用一个function类似:
<ul class="org-ul">
<li>不同的地方: 在函数前面加一个go关键字, 返回值会被忽略</li>
<li>相同的地方: 函数的参数还是可以传入并且被使用</li>
</ul></li>
<li><p>
虽然所有的function都可以被启动为goroutine,但是,在实践当中,我们往往给goroutine外面包裹一个closure
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">process</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">val</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">do something with val</span>
        <span style="color: #89DDFF;">return</span> 0
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">runThingConcurrently</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">in</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">out</span> <span style="color: #89DDFF;">chan</span>&lt;- <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">val</span> := <span style="color: #89DDFF;">range</span> in <span style="color: #c3e88d;">{</span>
                        <span style="color: #ffcb6b;">result</span> := <span style="color: #82aaff;">process</span><span style="color: #89DDFF;">(</span>val<span style="color: #89DDFF;">)</span>
                        out &lt;- result
                <span style="color: #c3e88d;">}</span>
        <span style="color: #F78C6C;">}()</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>加一个function作为closure的作用是:
<ul class="org-ul">
<li>closure从channel读取数据,然后把数据传递给bussiness logic(例子中的process)</li>
<li>把bussiness logic的结果传递给另外的channel</li>
<li>整个过程当中,bussiness logic不知道自己在goroutine中运行,这让bussiness logic的测试非常容易,也
是很好的模块化做法</li>
<li>更重要的是,有了closure function,我们不会在API里面暴露concurrency</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgde28926" class="outline-3">
<h3 id="orgde28926"><span class="section-number-3">6.3.</span> Channels</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>goroutine之间的通信是通过channel</li>
<li><p>
和slice,map一样,channel也是使用make 创建,并且是内置的类型,创建代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li>和map一样, channel也是reference类型,这就意味着,当你把一个channel传递给function的时候,你其实传递
的是pointer</li>
<li>和其他reference类型一样, channel的zero值是nil</li>
</ul>
</div>
<div id="outline-container-orgfe58f98" class="outline-4">
<h4 id="orgfe58f98"><span class="section-number-4">6.3.1.</span> Reading, Writing, and Buffering</h4>
<div class="outline-text-4" id="text-6-3-1">
<ul class="org-ul">
<li>使用&lt;-来和channel进行交互:
<ul class="org-ul">
<li><p>
如果从channel读取,那么就把 &lt;- 放在channel的左边
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">a</span> := &lt;-ch <span style="color: #626262;">// </span><span style="color: #626262;">read a value from ch an assigns it to a</span>
</pre>
</div></li>
<li><p>
如果向channel写入,那么就把 &lt;- 放在channel的右边
</p>
<div class="org-src-container">
<pre class="src src-go">ch &lt;- b   <span style="color: #626262;">// </span><span style="color: #626262;">write the value in b to ch</span>
</pre>
</div></li>
</ul></li>
<li>和变量不同的是,写入到channel的值,只能被读取一次,如果有多个goroutine同时从一个channel读取这个value,
那么只会有一个goroutine成功</li>
<li>一个goroutine同时读取和写入到一个channel的情况,非常少见.为了让代码更不容易出错,我们可以定义只读或者只写的channel:
<ul class="org-ul">
<li><p>
只读channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">readonly</span> := <span style="color: #82aaff;">make</span><span style="color: #c792ea;">(</span>&lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">in</span><span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li><p>
只写channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">writeonly</span> := <span style="color: #82aaff;">make</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">chan</span>&lt;- <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span>
</pre>
</div></li>
</ul></li>
<li>定义只读或者只写的channel好像也没有意义,一个channel只读了,那么谁给他写入呢?</li>
<li><p>
所以只读,只写的channel要配合go语言的另外一个特性:可以通过赋值(或者显示转换)来把可读可写的channel
转换成只读channel(或者只写channel)
</p>
<pre class="example" id="org2c36706">
A channel may be constrained only to send or only to receive by assignment or explicit conversion.
</pre></li>
<li><p>
这样一来,我们就可以创建函数的时候,使用只读或者只写的类型,但是把一个可读可写的channel赋值给函数,
来保证在函数里面是只读或者只写的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">globalCh</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">string</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                globalCh &lt;- <span style="color: #c3e88d;">"hello world"</span>
        <span style="color: #F78C6C;">}()</span>

        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #82aaff;">takesReadonly</span><span style="color: #c3e88d;">(</span>globalCh<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>

        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">takesReadonly</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ch</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">msg</span> := &lt;-ch
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>msg<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">hello world</span>
</pre>
</div></li>
<li>默认情况下,channel都是unbuffered的,所谓unbuffered是指:
<ul class="org-ul">
<li>每一个对于unbuffered channel的write,都会让writing channel 停滞,直到有另外的goroutine从这个channel
里面读取走这个数据</li>
<li>每一个对于unbuffered channel的read,都会让reading channel停滞,直到有另外的goroutine向这个channel
里面写入数据</li>
</ul></li>
<li>换句话说,一旦创建了unbuffered的channel,那么你至少需要同时有两个运行的goroutine</li>
<li>Go里面同时也有buffered channel,和unbuffered channel不同的地方在于:
<ul class="org-ul">
<li>对于unbuffered channel,如果没有人读取,那么第一个写入就会block</li>
<li>对于buffered channel,如果没有人读取,可以写入N次,然后第N+1次写入才会block</li>
<li>N就是buffered的buffer大小</li>
</ul></li>
<li>我们可以使用如下代码来创建buffered channel
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #c792ea;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, 10<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li>我们使用len()返回buffered里面有几个值</li>
<li>我们使用cap()返回创建buffered channel的时候设计的buffer的大小</li>
<li><p>
巨大部分情况下,你都应该使用unbuffered channel
</p>
<pre class="example" id="orgf3b0adb">
Most of the time, you should use unbuffered channels.
</pre></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org3053d0b" class="outline-4">
<h4 id="org3053d0b"><span class="section-number-4">6.3.2.</span> for-range and Channels</h4>
<div class="outline-text-4" id="text-6-3-2">
<ul class="org-ul">
<li><p>
在go语言里面,for-range还能用在读取channel,不同的是,读取channel的时候,只有一个变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> ch <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>上面的loop停止的情况有:
<ul class="org-ul">
<li>channel被关闭(通常在其他goroutine中关闭这个channel)</li>
<li>break或者return中断</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb31ae51" class="outline-4">
<h4 id="orgb31ae51"><span class="section-number-4">6.3.3.</span> Closing a Channel</h4>
<div class="outline-text-4" id="text-6-3-3">
<ul class="org-ul">
<li><p>
当你不再想要写入这个channel的时候,你只用close来关闭它,注意只是不想写入,close了之后还是可以读取
的.代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #82aaff;">close</span><span style="color: #c792ea;">(</span>ch<span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li>一个channel一旦被close,那么如下操作就不允许出现在这个channel上面了,否则会出现panic
<ul class="org-ul">
<li>write to the channel</li>
<li>close the channel again</li>
</ul></li>
<li>与此对应的是,读取一个closed channel却总是成功的:
<ul class="org-ul">
<li>如果channel是buffered的,那么读取会把buffered的value给按照顺序读取出来</li>
<li><p>
如果channel是unbuffered的(或者buffered channel里面没有value了),那么读取也会成功,但是会返回zero
值.这里当然会出现如果本来channel里面就是zero值的情况,为了区分这种情况,我们使用第二个返回值来
判断channel是否被关闭了(ok为true表示channel还open,否则channel被关闭了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">ok</span> := &lt;-ch
</pre>
</div></li>
</ul></li>
<li>关闭channel的责任在于写入channel的goroutine</li>
<li>注意,只有如下的情况下才会去close一个channel: 有其他goroutine等待channel被关闭(其他goroutine使用
for-range loop在等待channel关闭)</li>
<li>如果没有其他goroutine等待channel被关闭,那么我们不需要显式关闭channel,因为GC会去清理channel</li>
<li>channel是GO并发模型最重要的概念之一(另外一个是select), channel会指导我们认清代码的dependency,
从而更好的进行并发设计</li>
<li>其他语言使用全局的共享state来沟通不同的thread,而这个全局的变化的shared state会使得如下两件事变得困难:
<ul class="org-ul">
<li>理解数据如何流转</li>
<li>理解两个thread是否真的independent</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6c46815" class="outline-4">
<h4 id="org6c46815"><span class="section-number-4">6.3.4.</span> How Channels Behave</h4>
<div class="outline-text-4" id="text-6-3-4">
<ul class="org-ul">
<li>channel有很多不同的state,在读,写,关闭的时候,都有不同的behavior,我们下面来总结一下
<ul class="org-ul">
<li><p>
图10-1
</p>

<div id="org55e8bdd" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/10-1.png" alt="10-1.png" />
</p>
<p><span class="figure-number">Figure 1: </span>lg/10-1.png</p>
</div></li>
</ul></li>
<li>涉及到close的情况,谁来关闭,怎么关闭有时候很难处理
<ul class="org-ul">
<li>标准的pattern要求,让writing goroutine来负责关闭channel(当没有什么东西要写的时候),但是如果有多
个goroutine同时写的话,问题就很难办,因为:
<ol class="org-ol">
<li>关闭channel超过一次就会panic</li>
<li>某个goroutine关闭channel之后,另外的goroutine再写入,也会panic</li>
</ol></li>
<li>后面我们知道这种问题会用sync.WaitGroup来解决</li>
</ul></li>
<li>nil channel也很危险,但是nil channel是有其特殊用处的,我们会在后面看到</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfa587b5" class="outline-3">
<h3 id="orgfa587b5"><span class="section-number-3">6.4.</span> select</h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li>select是Go语言里面用来control的语句,它主要解决了如下的一个问题:
<ul class="org-ul">
<li>如果你进行了一个并发操作,那么哪一个会先运行</li>
<li>这个问题在普通代码里面不是问题,但是在并发代码里面是问题,如果你每次都偏向某一种情况,那么另外
一种情况可能永远无法运行(也就是所谓的starvation)</li>
<li>select 可以做到,让goroutine随机的从(并发的)多种情况中选择,不至于出现starvation</li>
</ul></li>
<li>我们来看一个select的例子:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">select</span> <span style="color: #c792ea;">{</span>
<span style="color: #89DDFF;">case</span> <span style="color: #ffcb6b;">v</span> := &lt;- ch:
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v<span style="color: #F78C6C;">)</span>
<span style="color: #89DDFF;">case</span> <span style="color: #ffcb6b;">v</span> := &lt;- ch2:
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v<span style="color: #F78C6C;">)</span>
<span style="color: #89DDFF;">case</span> ch3 &lt;- x:
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"wrote"</span>, x<span style="color: #F78C6C;">)</span>
<span style="color: #89DDFF;">case</span> &lt;- ch4:
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"got value on ch4, but ignore it"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>select的每个case都是一个读取或者写入channel的操作,如果操作可行,那么就运行case的body</li>
<li>注意每个case都会创建子的block(和switch一样)</li>
<li>如果如果多个case同时满足,那么select就会随机选择一个运行.所以说,select的顺序是不重要的,并不是
放在前面的就一定先运行(这个和switch不一样)</li>
<li>前面说到了因为pick的随机性,select可以避免starvation.其实pick的随机性还能够避免deadlock的一种
最常见原因:不同goroutine中以不同顺序获取lock</li>
</ul></li>
<li>我们来看一个不同goroutine以不同顺序获取lock(这里是channel),从而导致deadlock的例子:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-06 23:22:51</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c3e88d;">"fmt"</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch1</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">ch2</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #ffcb6b;">v</span> := 1
                ch1 &lt;- v
                <span style="color: #ffcb6b;">v2</span> := &lt;-ch2
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>v, v2<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>

        <span style="color: #ffcb6b;">v</span> := 2
        ch2 &lt;- v
        <span style="color: #ffcb6b;">v2</span> := &lt;-ch1
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, v2<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

</pre>
</div></li>
<li><p>
输出
</p>
<pre class="example" id="orgdea74d3">
fatal error: all goroutines are asleep - deadlock!
</pre></li>
<li>上面例子的问题是:
<ol class="org-ol">
<li>main goroutine直到ch2被读取才能进行: 先写入ch1, 再读取ch2</li>
<li>子 goroutine直到ch1被读取才能运行: 先写入ch2, 再读取ch1</li>
<li>上面两个获取channel的顺序是相反的</li>
</ol></li>
<li><p>
修改的主要办法,就是在main goroutine里面使用select,这样就能避免deadlock了(因为select能够判断
哪个channel先可用,而不会使用固定的顺序),代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch1</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">ch2</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #ffcb6b;">v</span> := 1
                ch1 &lt;- v
                <span style="color: #ffcb6b;">v2</span> := &lt;-ch2
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>v, v2<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>

        <span style="color: #ffcb6b;">v</span> := 2
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">v2</span> <span style="color: #c792ea;">int</span>
        <span style="color: #89DDFF;">select</span> <span style="color: #F78C6C;">{</span>
        <span style="color: #89DDFF;">case</span> ch2 &lt;- v:
        <span style="color: #89DDFF;">case</span> v2 = &lt;-ch1:
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>v, v2<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
输出
</p>
<pre class="example" id="orgfc46849">
2 1
</pre></li>
</ul></li>
<li><p>
由于select主要用来和多个channel联系,而每次其实只可能有一个case成功,为了尽可能的让所有case成功,
需要让select和for组合起来,如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">for</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">select</span> <span style="color: #F78C6C;">{</span>
        <span style="color: #89DDFF;">case</span> &lt;- done:
                <span style="color: #89DDFF;">return</span>
        <span style="color: #89DDFF;">case</span> <span style="color: #ffcb6b;">v</span> := &lt;- ch:
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>这种用法非常普遍,以至于有个特殊的名字,叫做for-select loop.而且这种loop还得设计一种专门的方法来
退出for,就是上面的例子中的done channel, 我们后面会介绍</li>
<li>和switch类似,select也会有一个default语句,当select中所有的都没有命中的时候,整个语句不是pause而是
直接命中default语句,如下</li>
<li><p>
select中使用default通常只有一种使用场景: 对一个channel实施非阻塞的读取或者写入
</p>
<pre class="example" id="org0800292">
Implement a nonblocking read or write on a channel
</pre></li>
<li>其他场景中select和default配合通常都是不对的,特别是在for-select loop中使用default,因为这会导致
for-loop不停的运行default语句,即便没有channel准备好,这会极大的浪费CPU</li>
</ul>
</div>
</div>
<div id="outline-container-org4dd53ff" class="outline-3">
<h3 id="org4dd53ff"><span class="section-number-3">6.5.</span> Concurrency Practices and Patterns</h3>
<div class="outline-text-3" id="text-6-5">
</div>
<div id="outline-container-orgc6cba91" class="outline-4">
<h4 id="orgc6cba91"><span class="section-number-4">6.5.1.</span> Keep Your APIs Concurrency-Free</h4>
<div class="outline-text-4" id="text-6-5-1">
<ul class="org-ul">
<li>Concurrency是一种实现细节,好的API设计需要尽量隐藏这种细节,隐藏这种细节的好处是:
<ul class="org-ul">
<li>保证调用方式不变的情况下,可以在后面改变代码如何工作</li>
</ul></li>
<li>实践当中,这就要求,你永远不能在API里面暴露channel或者mutex:
<ul class="org-ul">
<li>比如,一旦你暴露了channel,那么你就把channel管理的责任丢给了你的使用者.你的使用者开始担心channel
是否buffered,closed或者是nil</li>
<li>同时,由于用户对于内部实现机制的不了解,他们可能会以错误的顺序调用channel或者mutex,从而引起deadlock</li>
</ul></li>
<li>注意,所谓的暴露,不是永远不能使用channel作为function的参数(或者作为struct的一个field),而是说不
能把channel给暴露出去(比如作为返回值传递给调用方)</li>
<li>当然也有例外,在库代码中,有些API是concurrency helper function(比如time.After), 他们确实会暴露channel</li>
</ul>
</div>
</div>
<div id="outline-container-org2f1b3c7" class="outline-4">
<h4 id="org2f1b3c7"><span class="section-number-4">6.5.2.</span> Goroutines, for Loops, and Varying Variables</h4>
<div class="outline-text-4" id="text-6-5-2">
<ul class="org-ul">
<li><p>
绝大部分情况下, 用来启动goroutine的closure(go后面都是匿名函数,匿名函数定义在另外的函数里面,所
以必然是closure)都是没有参数的,而是使用closure所在的scope里面的参数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-17 15:35:58</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">v</span> := 1
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"in goroutine, v is:"</span>, v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"in main, all finished"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in goroutine, v is: 1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in main, all finished</span>
</pre>
</div></li>
<li>但是使用外部的变量有一个问题,那就是closure取的是这个变量的地址,那么当我们的goroutine真正运行的
时候,到底变量是一个什么值,我们是不知道的:
<ul class="org-ul">
<li><p>
在goroutine被调度前值改变了:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-17 15:52:04</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">v</span> := 1
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"in goroutine, v is:"</span>, v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>

        v += 10
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"in main, all finished"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in goroutine, v is: 11</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in main, all finished</span>
</pre>
</div></li>
<li><p>
在goroutine给调度前值没有改变(main goutine sleep而让出了cpu):
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-17 15:55:45</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">v</span> := 1
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"in goroutine, v is:"</span>, v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>
        v += 10
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"in main, all finished"</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in goroutine, v is: 1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">in main, all finished</span>
</pre>
</div></li>
</ul></li>
<li><p>
我们知道,如果go语言的for循环使用了reference的话,会导致所有的值都是最后一个index的值,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-09 11:16:50</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">Person</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        Name <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">persons</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">Person</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c792ea;">Person</span><span style="color: #c3e88d;">{</span><span style="color: #F78C6C;">Name</span>: <span style="color: #c3e88d;">"Alice"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c792ea;">Person</span><span style="color: #c3e88d;">{</span><span style="color: #F78C6C;">Name</span>: <span style="color: #c3e88d;">"Bob"</span><span style="color: #c3e88d;">}</span>,
        <span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>persons<span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">alicePerson</span> *<span style="color: #c792ea;">Person</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span>, <span style="color: #ffcb6b;">person</span> := <span style="color: #89DDFF;">range</span> persons <span style="color: #F78C6C;">{</span>
                <span style="color: #626262;">// </span><span style="color: #626262;">i&#21644;person&#36825;&#20004;&#20010;&#21464;&#37327;,&#34987;&#21453;&#22797;&#21033;&#29992;,&#25152;&#20197;&#27599;&#27425;&#24490;&#29615;&#20013;,&#20004;&#32773;&#22320;&#22336;&#37117;&#19981;&#21464;</span>
                fmt.<span style="color: #82aaff;">Printf</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"%p,%p\n"</span>, &amp;i, &amp;person<span style="color: #c3e88d;">)</span>

                <span style="color: #89DDFF;">if</span> person.Name == <span style="color: #c3e88d;">"Alice"</span> <span style="color: #c3e88d;">{</span>
                        alicePerson = &amp;person
                <span style="color: #c3e88d;">}</span>
        <span style="color: #F78C6C;">}</span>

        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span>alicePerson<span style="color: #F78C6C;">)</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[{Alice} {Bob}]</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0xc0000ac020,0xc000096250</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0xc0000ac020,0xc000096250</span>
<span style="color: #626262;">// </span><span style="color: #626262;">&amp;{Bob}</span>
</pre>
</div></li>
<li><p>
我们的closure其实也是使用的reference,所以,在和for-loop配合的时候也容易出现值都是最后一个index的情况
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-17 19:29:18</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">Person</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        Name <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">getPersons</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">[]</span><span style="color: #89DDFF;">func</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">persons</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">Person</span><span style="color: #F78C6C;">{</span>
                <span style="color: #c792ea;">Person</span><span style="color: #c3e88d;">{</span><span style="color: #F78C6C;">Name</span>: <span style="color: #c3e88d;">"Alice"</span><span style="color: #c3e88d;">}</span>,
                <span style="color: #c792ea;">Person</span><span style="color: #c3e88d;">{</span><span style="color: #F78C6C;">Name</span>: <span style="color: #c3e88d;">"Bob"</span><span style="color: #c3e88d;">}</span>,
        <span style="color: #F78C6C;">}</span>

        <span style="color: #ffcb6b;">funcs</span> := <span style="color: #F78C6C;">[]</span><span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">(){}</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">person</span> := <span style="color: #89DDFF;">range</span> persons <span style="color: #F78C6C;">{</span>

                funcs = <span style="color: #82aaff;">append</span><span style="color: #c3e88d;">(</span>funcs,
                        <span style="color: #89DDFF;">func</span><span style="color: #89DDFF;">()</span> <span style="color: #89DDFF;">{</span>
                                fmt.<span style="color: #82aaff;">Println</span><span style="color: #bb80b3;">(</span>person.Name<span style="color: #bb80b3;">)</span>
                        <span style="color: #89DDFF;">}</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">return</span> funcs

<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">twoFuncs</span> := <span style="color: #82aaff;">getPersons</span><span style="color: #F78C6C;">()</span>
        twoFuncs<span style="color: #F78C6C;">[</span>0<span style="color: #F78C6C;">]()</span>
        twoFuncs<span style="color: #F78C6C;">[</span>1<span style="color: #F78C6C;">]()</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Bob</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Bob</span>
</pre>
</div></li>
<li><p>
go 后面跟的也是closure,在for循环里面来不及调度(轮不到子goroutine运行,注意这个很重要,轮得到子
goroutine运行的话,就不会只是最后一个index的value了),等到for循环之后轮到子goroutine运行的时候,
因为是ref到之前的变量的,所以和上面的例子一样,每个子goroutine都是打印的最后一个index值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-17 19:48:06</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>

        <span style="color: #ffcb6b;">a</span> := <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">{</span>2, 4, 6, 8, 10<span style="color: #F78C6C;">}</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> a <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">()</span> <span style="color: #c3e88d;">{</span>
                        fmt.<span style="color: #82aaff;">Println</span><span style="color: #89DDFF;">(</span>v * 2<span style="color: #89DDFF;">)</span>
                <span style="color: #c3e88d;">}()</span>
        <span style="color: #F78C6C;">}</span>

        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">20</span>
<span style="color: #626262;">// </span><span style="color: #626262;">20</span>
<span style="color: #626262;">// </span><span style="color: #626262;">20</span>
<span style="color: #626262;">// </span><span style="color: #626262;">20</span>
<span style="color: #626262;">// </span><span style="color: #626262;">20</span>
</pre>
</div></li>
<li>我们有两种方法避免上面的错误:
<ul class="org-ul">
<li><p>
在loop中shadow 变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> a <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">v</span> := v
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                ch &lt;- v * 2
        <span style="color: #F78C6C;">}()</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li><p>
传递value作为goroutine的参数(这样就是拷贝而不是referenc了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> a <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">(</span><span style="color: #ffcb6b;">val</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span> <span style="color: #F78C6C;">{</span>
                ch &lt;- val * 2
        <span style="color: #F78C6C;">}(</span>v<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd934953" class="outline-4">
<h4 id="orgd934953"><span class="section-number-4">6.5.3.</span> Always Clean Up Your Goroutines</h4>
<div class="outline-text-4" id="text-6-5-3">
<ul class="org-ul">
<li>如果你启动了一个goroutine,那么你要保证这个goroutine最终exit,否则就会发生goroutine leak</li>
<li>所谓goroutine,是因为scheduler是无法回收goroutine的.如果goroutine不exit,那么scheduler就会一直不
断的给goroutine运行时间.这会拖累整个系统的效率</li>
<li><p>
正常的保证所有goroutine都exit的代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-18 09:57:30</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">countTo</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">max</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; max; i++ <span style="color: #c3e88d;">{</span>
                        ch &lt;- i
                <span style="color: #c3e88d;">}</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>ch<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">return</span> ch
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := <span style="color: #89DDFF;">range</span> <span style="color: #82aaff;">countTo</span><span style="color: #F78C6C;">(</span>10<span style="color: #F78C6C;">)</span> <span style="color: #F78C6C;">{</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>i<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">4</span>
<span style="color: #626262;">// </span><span style="color: #626262;">5</span>
<span style="color: #626262;">// </span><span style="color: #626262;">6</span>
<span style="color: #626262;">// </span><span style="color: #626262;">7</span>
<span style="color: #626262;">// </span><span style="color: #626262;">8</span>
<span style="color: #626262;">// </span><span style="color: #626262;">9</span>
</pre>
</div></li>
<li><p>
不正常的,如下:后面五个goutine都block住,等待数据从channel里面被取走.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-18 09:59:29</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">countTo</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">max</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; max; i++ <span style="color: #c3e88d;">{</span>
                        ch &lt;- i
                <span style="color: #c3e88d;">}</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>ch<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">return</span> ch
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := <span style="color: #89DDFF;">range</span> <span style="color: #82aaff;">countTo</span><span style="color: #F78C6C;">(</span>10<span style="color: #F78C6C;">)</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">if</span> i &gt; 5 <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">break</span>
                <span style="color: #c3e88d;">}</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>i<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org6704aed" class="outline-4">
<h4 id="org6704aed"><span class="section-number-4">6.5.4.</span> The Done Channel Pattern</h4>
<div class="outline-text-4" id="text-6-5-4">
<ul class="org-ul">
<li>Go里面存在一种pattern用来提供一种通知goroutine:你该stop啦. 这种pattern叫做done channel pattern</li>
<li>done channel pattern的原理是使用一个channel来告诉goroutine该退出了,而该goroutine使用select来监
控这个channel(当然可能可以同时监控其他channel),下面就是这样一个例子:
<ul class="org-ul">
<li>数据传递给多个function,并且每个function都启动一个goroutine,最快的goroutine返回后,就关闭所有
其他的goroutine</li>
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">searchData</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">s</span> <span style="color: #c792ea;">string</span>, <span style="color: #ffcb6b;">searchers</span> <span style="color: #F78C6C;">[]</span><span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">(</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">)</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">string</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">done</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">result</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c3e88d;">[]</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">_</span>, <span style="color: #ffcb6b;">searcher</span> := <span style="color: #89DDFF;">range</span> searchers <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">searcher</span> <span style="color: #89DDFF;">func</span><span style="color: #89DDFF;">(</span><span style="color: #c792ea;">string</span><span style="color: #89DDFF;">)</span> <span style="color: #89DDFF;">[]</span><span style="color: #c792ea;">string</span><span style="color: #c3e88d;">)</span> <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">select</span> <span style="color: #89DDFF;">{</span>
                        <span style="color: #89DDFF;">case</span> result &lt;- <span style="color: #82aaff;">searcher</span><span style="color: #bb80b3;">(</span>s<span style="color: #bb80b3;">)</span>:
                        <span style="color: #89DDFF;">case</span> &lt;-done:
                        <span style="color: #89DDFF;">}</span>
                <span style="color: #c3e88d;">}(</span>searcher<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #ffcb6b;">r</span> := &lt;-result
        <span style="color: #82aaff;">close</span><span style="color: #F78C6C;">(</span>done<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">return</span> r
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>我们可以看到,实现的原理是所有的goroutine(每个goroutine都控制一个function),都去监控done channel,一旦done channel
close了,就可以结束自己的工作(select关注的其他channel在做自己的工作)了</li>
<li>done channel的类型默认 struct{},因为我们不会去用这个channel,不会传数据给它,我们只会close它</li>
<li>每个goroutine自己的工作完成后都会写到一个公共的channel result,而在main goroutine里面pasue on
这个result channel,一旦有数据来了就:
<ol class="org-ol">
<li>先关闭done channel,以便让其他goroutine关闭</li>
<li>返回result channel带回来的值</li>
</ol></li>
</ul></li>
<li>有些时候你可能会因为call stack上面的其他function的要求,而关闭自身.这种情况下需要使用contex里面
的Cancellation功能,我们后面会看到</li>
</ul>
</div>
</div>
<div id="outline-container-org8fb7c79" class="outline-4">
<h4 id="org8fb7c79"><span class="section-number-4">6.5.5.</span> Using aa Cancel Function to Terminate a Goroutine</h4>
<div class="outline-text-4" id="text-6-5-5">
<ul class="org-ul">
<li>我们再来解决一下 <b>Always clean up your goroutine</b> 那一节的问题</li>
<li>那个问题是使用了一个函数(内部的goroutine)来生成index, 如果要让函数功能不变,又能中断function,那
么我们必须创建done channel,同时把done channel返回回来.</li>
<li>下面的例子更近一步,直接返回了一个closure,让这个closure来调用done channel.其实还可以做其他操作,
这里就略过了:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-18 18:45:06</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">countTo</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">max</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span>&lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">func</span><span style="color: #F78C6C;">()</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">done</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">cancel</span> := <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>done<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; max; i++ <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">select</span> <span style="color: #89DDFF;">{</span>
                        <span style="color: #89DDFF;">case</span> &lt;-done:
                                <span style="color: #89DDFF;">return</span>
                        <span style="color: #89DDFF;">case</span> ch &lt;- i:
                        <span style="color: #89DDFF;">}</span>

                <span style="color: #c3e88d;">}</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>ch<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">return</span> ch, cancel
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">ch</span>, <span style="color: #ffcb6b;">cancel</span> := <span style="color: #82aaff;">countTo</span><span style="color: #F78C6C;">(</span>10<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := <span style="color: #89DDFF;">range</span> ch <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">if</span> i &gt; 5 <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">break</span>
                <span style="color: #c3e88d;">}</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span>i<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #82aaff;">cancel</span><span style="color: #F78C6C;">()</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">2</span>
<span style="color: #626262;">// </span><span style="color: #626262;">3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">4</span>
<span style="color: #626262;">// </span><span style="color: #626262;">5</span>
</pre>
</div></li>
<li>countTo 创建了两个channel,一个负责返回数据(ch),一个负责通知完成(done),注意ch channel不会被关
闭,因为select命中done之后,会直接return. 但是channel不关闭没事,GC会找到并且释放他们</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc51d8fa" class="outline-4">
<h4 id="orgc51d8fa"><span class="section-number-4">6.5.6.</span> When to Use Buffered and Unbuffered Channels</h4>
<div class="outline-text-4" id="text-6-5-6">
<ul class="org-ul">
<li>Go并发里面最难以掌握的,就是如何使用buffered channel</li>
<li>默认情况,channel是unbuffered的,这种情况下的channel就像是接力赛上面的接力棒一样:一个goroutine写
入了之后,等待下一个goroutine读取</li>
<li>buffered channel 的使用则更加的复杂,但是可以用一句话来总结:
<ul class="org-ul">
<li><p>
只有在你知道自己要启动多少个goroutine的情景下,你才会使用到buffered channel,比如:你想限制goroutine
启动的数目,或者限制队列中等待的工作数量
</p>
<pre class="example" id="org674d7b3">
Buffered channels are useful when you know how many goroutines you have launched,
want to limit the number of goroutines you will launch, or want to limit the amount
of work that is queued up
</pre></li>
</ul></li>
<li>下面就是一个使用buffered channel的例子:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-18 19:04:15</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        <span style="color: #ffcb6b;">input</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; 100; i++ <span style="color: #F78C6C;">{</span>

                <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">index</span> <span style="color: #c792ea;">int</span><span style="color: #c3e88d;">)</span> <span style="color: #c3e88d;">{</span>
                        input &lt;- index
                <span style="color: #c3e88d;">}(</span>i<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">processChannel</span><span style="color: #c3e88d;">(</span>input<span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>

        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">processChannel</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ch</span> <span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">const</span> <span style="color: #F78C6C;">conc</span> = 10
        <span style="color: #ffcb6b;">results</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, conc<span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; conc; i++ <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">()</span> <span style="color: #c3e88d;">{</span>
                        <span style="color: #ffcb6b;">v</span> := &lt;-ch
                        results &lt;- v
                <span style="color: #c3e88d;">}()</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">out</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; conc; i++ <span style="color: #F78C6C;">{</span>
                out = <span style="color: #82aaff;">append</span><span style="color: #c3e88d;">(</span>out, &lt;-results<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> out
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">[0 1 3 2 5 4 6 11 8 7]</span>
</pre>
</div></li>
<li>我们可以看到,上面的例子中,我们限制读取channel的数目是10</li>
<li>我们的results channel是不block的,不同goroutine可以开心的写入(直到buffer数目10)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org13b4f5f" class="outline-4">
<h4 id="org13b4f5f"><span class="section-number-4">6.5.7.</span> Backpressure</h4>
<div class="outline-text-4" id="text-6-5-7">
<ul class="org-ul">
<li>buffered channel还有一个用处是实现backpressure(限制压力)</li>
<li>虽然有些反直觉,但是系统的整体性能,在压力控制在一个数量上的时候,会最好</li>
<li>我们使用buffered channel(还有select),实现了一个限流代码:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-19 17:10:12</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"errors"</span>
        <span style="color: #c3e88d;">"net/http"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">PressureGauge</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
        ch <span style="color: #89DDFF;">chan</span> <span style="color: #89DDFF;">struct</span><span style="color: #F78C6C;">{}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">New</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">limit</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> *<span style="color: #c792ea;">PressureGauge</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">ch</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}</span>, limit<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; limit; i++ <span style="color: #F78C6C;">{</span>
                ch &lt;- <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}{}</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> &amp;<span style="color: #c792ea;">PressureGauge</span><span style="color: #F78C6C;">{</span>
                <span style="color: #F78C6C;">ch</span>: ch,
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">pg</span> *<span style="color: #c792ea;">PressureGauge</span><span style="color: #c792ea;">)</span> <span style="color: #82aaff;">Process</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">f</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">error</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">select</span> <span style="color: #F78C6C;">{</span>
        <span style="color: #89DDFF;">case</span> &lt;-pg.ch:
                <span style="color: #82aaff;">f</span><span style="color: #c3e88d;">()</span>
                pg.ch &lt;- <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}{}</span>
                <span style="color: #89DDFF;">return</span> <span style="color: #F78C6C;">nil</span>
        <span style="color: #89DDFF;">default</span>:
                <span style="color: #89DDFF;">return</span> errors.<span style="color: #82aaff;">New</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"no more capacity"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">doThingThatShouldBeLimited</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">string</span> <span style="color: #c792ea;">{</span>
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>20 * time.Second<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #c3e88d;">"done"</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">pg</span> := <span style="color: #82aaff;">New</span><span style="color: #F78C6C;">(</span>3<span style="color: #F78C6C;">)</span>
        http.<span style="color: #82aaff;">HandleFunc</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"/request"</span>, <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">(</span><span style="color: #ffcb6b;">w</span> <span style="color: #c792ea;">http.ResponseWriter</span>, <span style="color: #ffcb6b;">r</span> *<span style="color: #c792ea;">http.Request</span><span style="color: #c3e88d;">)</span> <span style="color: #c3e88d;">{</span>
                <span style="color: #ffcb6b;">err</span> := pg.<span style="color: #82aaff;">Process</span><span style="color: #89DDFF;">(</span><span style="color: #89DDFF;">func</span><span style="color: #bb80b3;">()</span> <span style="color: #bb80b3;">{</span>
                        w.<span style="color: #82aaff;">Write</span><span style="color: #ffcb6b;">(</span><span style="color: #82aaff;">[]</span><span style="color: #82aaff;">byte</span><span style="color: #82aaff;">(</span><span style="color: #82aaff;">doThingThatShouldBeLimited</span><span style="color: #44b9b1;">()</span><span style="color: #82aaff;">)</span><span style="color: #ffcb6b;">)</span>
                <span style="color: #bb80b3;">}</span><span style="color: #89DDFF;">)</span>
                <span style="color: #89DDFF;">if</span> err != <span style="color: #F78C6C;">nil</span> <span style="color: #89DDFF;">{</span>
                        w.<span style="color: #82aaff;">WriteHeader</span><span style="color: #bb80b3;">(</span>http.StatusTooManyRequests<span style="color: #bb80b3;">)</span>
                <span style="color: #89DDFF;">}</span>
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>
        http.<span style="color: #82aaff;">ListenAndServe</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">":8080"</span>, <span style="color: #F78C6C;">nil</span><span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">////////////////////</span>
<span style="color: #626262;">// </span><span style="color: #626262;">First three ok //</span>
<span style="color: #626262;">////////////////////</span>

<span style="color: #626262;">// </span><span style="color: #626262;">$ http localhost:8080/request</span>
<span style="color: #626262;">// </span><span style="color: #626262;">HTTP/1.1 200 OK</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Content-Length: 4</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Content-Type: text/plain; charset=utf-8</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Date: Wed, 19 Oct 2022 09:20:32 GMT</span>

<span style="color: #626262;">// </span><span style="color: #626262;">done</span>

<span style="color: #626262;">/////////////////////////////</span>
<span style="color: #626262;">// </span><span style="color: #626262;">After 3 http status 429 //</span>
<span style="color: #626262;">/////////////////////////////</span>

<span style="color: #626262;">// </span><span style="color: #626262;">$ http localhost:8080/request</span>
<span style="color: #626262;">// </span><span style="color: #626262;">HTTP/1.1 429 Too Many Requests</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Content-Length: 0</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Date: Wed, 19 Oct 2022 09:20:18 GMT</span>
</pre>
</div></li>
<li>我们这里首先创建了一个结构体PressureGuage,里面只有一个成员就是channel.(其实是buffered channel,
但是因为无论buffer与否,类型都是一样的,所以在结构体里面还看不出来是否是buffered)</li>
<li>在New里面,我们来创建我们的struct的时候,会根据输入的limit来确定我们buffered channel的大小,buffer
的数目就是token的数目,token就是令牌,每次执行命令之前,得先来拿牌</li>
<li>Process函数就是这么设计的:
<ol class="org-ol">
<li>每当某个goroutine想要使用函数f,它不能自己调用,需要通过Process来调用</li>
<li>而每次Process调用f之前,需要去channel里面抢token,抢得到就调用,抢不到就是429.通过select抢的
过程实现了流量控制</li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgbe8c285" class="outline-4">
<h4 id="orgbe8c285"><span class="section-number-4">6.5.8.</span> Turning Off a case in a select</h4>
<div class="outline-text-4" id="text-6-5-8">
<ul class="org-ul">
<li>select处理来自多个channel的情况非常得心应手.但是,有一种情况可能会降低select的效率,那就是:某个
channel已经被close了:
<ul class="org-ul">
<li>我们知道,一旦一个channel被close,那么这个channel肯定能被select read成功.</li>
<li>一旦select read成功这些close的channel,那么它势必要读取到zero value和ok去判断,这会极大影响性能</li>
</ul></li>
<li>面对这个问题,我们的处理办法是:将已经close的channel赋值为nil,这是基于如下的原理:
<ul class="org-ul">
<li><p>
读取或者写入一个nil channel会让你的代码一直hang(当然select也就不会去选择这种hang的代码啦)
</p>
<pre class="example" id="org00fe0e8">
Reading from or writing to a nil channel causes your code to hang forever
</pre></li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">for</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">select</span> <span style="color: #F78C6C;">{</span>
        <span style="color: #89DDFF;">case</span> <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">ok</span> := &lt;-in:
                <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF; font-weight: bold;">!</span>ok <span style="color: #c3e88d;">{</span>
                        in = <span style="color: #F78C6C;">nil</span> <span style="color: #626262;">// </span><span style="color: #626262;">the case will never succeed again!</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>
        <span style="color: #89DDFF;">case</span> <span style="color: #ffcb6b;">v</span>, <span style="color: #ffcb6b;">ok</span> := &lt;-in2:
                <span style="color: #89DDFF;">if</span> <span style="color: #89DDFF; font-weight: bold;">!</span>ok <span style="color: #c3e88d;">{</span>
                        in2 = <span style="color: #F78C6C;">nil</span> <span style="color: #626262;">// </span><span style="color: #626262;">the case will never succeed again!</span>
                        <span style="color: #89DDFF;">continue</span>
                <span style="color: #c3e88d;">}</span>
        <span style="color: #89DDFF;">case</span> &lt;-done:
                <span style="color: #89DDFF;">return</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org433515b" class="outline-4">
<h4 id="org433515b"><span class="section-number-4">6.5.9.</span> How to Time Out Code</h4>
<div class="outline-text-4" id="text-6-5-9">
<ul class="org-ul">
<li>大部分的响应式程序都要求在某个时间内完成response,否则用户体验很不好</li>
<li>Go的并发可以做的一件事情就是控制一个requst在某个时间内必须返回</li>
<li>其他的语言都是引入了新的特性来解决这个问题,而Go则是在已有的特性的基础上完成这个功能的.下面就是
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">timeLimit</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">(</span><span style="color: #c792ea;">int</span>, <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">result</span> <span style="color: #c792ea;">int</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">err</span> <span style="color: #c792ea;">error</span>

        <span style="color: #ffcb6b;">done</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #89DDFF;">struct</span><span style="color: #c3e88d;">{}</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                result, err = <span style="color: #82aaff;">doSomeWork</span><span style="color: #c3e88d;">()</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>done<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">select</span> <span style="color: #F78C6C;">{</span>
        <span style="color: #89DDFF;">case</span> &lt;-done:
                <span style="color: #89DDFF;">return</span> result, err
        <span style="color: #89DDFF;">case</span> &lt;-time.<span style="color: #82aaff;">After</span><span style="color: #c3e88d;">(</span>2 * time.Second<span style="color: #c3e88d;">)</span>:
                <span style="color: #89DDFF;">return</span> 0, errors.<span style="color: #82aaff;">New</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"work timed out"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>我们的例子中主要就是select,它处理了两个case:
<ol class="org-ol">
<li>done channel, 这是其他goroutine通知当前goroutine某个工作完成了. 如果done channel先完成了,
那么我们就把数据返回给用户</li>
<li><p>
第二个channel就是我们这个pattern需要用到的了:time package里面的After会返回一个channel,在
固定时间后,会有数据写入这个channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">After waits for the duration to elapse and then sends the current time</span>
<span style="color: #626262;">// </span><span style="color: #626262;">on the returned channel.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">It is equivalent to NewTimer(d).C.</span>
<span style="color: #626262;">// </span><span style="color: #626262;">The underlying Timer is not recovered by the garbage collector</span>
<span style="color: #626262;">// </span><span style="color: #626262;">until the timer fires. If efficiency is a concern, use NewTimer</span>
<span style="color: #626262;">// </span><span style="color: #626262;">instead and call Timer.Stop if the timer is no longer needed.</span>
<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">After</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">d</span> <span style="color: #c792ea;">Duration</span><span style="color: #c792ea;">)</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">Time</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #82aaff;">NewTimer</span><span style="color: #F78C6C;">(</span>d<span style="color: #F78C6C;">)</span>.C
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6e32c73" class="outline-4">
<h4 id="org6e32c73"><span class="section-number-4">6.5.10.</span> Using WaitGroup</h4>
<div class="outline-text-4" id="text-6-5-10">
<ul class="org-ul">
<li>如果某个goroutine等待另外一个goroutine结束,那么它可以使用done channel</li>
<li>如果某个goroutine等待另外多个goroutine来完成他们的工作,那么就要使用sync.WaitGroup
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-21 09:58:06</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"sync"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>

        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">wg</span> <span style="color: #c792ea;">sync.WaitGroup</span>
        wg.<span style="color: #82aaff;">Add</span><span style="color: #F78C6C;">(</span>3<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">defer</span> wg.<span style="color: #82aaff;">Done</span><span style="color: #c3e88d;">()</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"goroutine1"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">defer</span> wg.<span style="color: #82aaff;">Done</span><span style="color: #c3e88d;">()</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"goroutine2"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">defer</span> wg.<span style="color: #82aaff;">Done</span><span style="color: #c3e88d;">()</span>
                fmt.<span style="color: #82aaff;">Println</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"goroutine3"</span><span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        wg.<span style="color: #82aaff;">Wait</span><span style="color: #F78C6C;">()</span>

<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">goroutine3</span>
<span style="color: #626262;">// </span><span style="color: #626262;">goroutine1</span>
<span style="color: #626262;">// </span><span style="color: #626262;">goroutine2</span>
</pre>
</div></li>
<li>sync.WaitGroup不需要初始化,其zero value就可以使用</li>
<li>sync.WaitGroup有三个函数:
<ol class="org-ol">
<li>Add 提升需要等待的goroutine数目,counter加1.</li>
<li>Done 减少需要等待的goroutine数目,counter减1.为了保证Done被调用(即便是panic的情况),一般Done
使用defer调用</li>
<li>Wait 使得当前的goroutine pause以等待counter为0</li>
</ol></li>
<li>可以注意到,我们没有显式的把sync.WaitGroup传递给goroutine,原因有两点:
<ol class="org-ol">
<li>必须保证所有使用sync.WaitGroup的地方,都是使用的同一个instance,closure(也就是这里的goroutine
调用)是使用reference的. 如果我们传递(但是忘了使用pointer),那么由于Go是值传递,就会copy一份
WaitGroup instance</li>
<li><p>
第二个原因是设计原因: 我们要把concurrency排除在我们的API之外.我们一直pattern都是这么做的:
启动一个goroutine(肯定带着closure),其中closure处理并发,函数内部处理算法
</p>
<pre class="example" id="orgf0affb6">
The closure manages issues around concurrency and the function provides the algorithm
</pre></li>
</ol></li>
</ul></li>
<li>虽然WaitGroup非常的好用,但是却不是我们的第一选择,只有在如下情况才会去使用WaitGroup: 当你的worker
goroutine退出的时候,你需要清理一些东西,比如如下的例子,在等待N个goroutine完成写入后,我们去close
channel, channel只能被关闭一次,所以使用WaitGroup非常必要:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">processAndGather</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">in</span> &lt;-<span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">processor</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">(</span><span style="color: #c792ea;">int</span><span style="color: #F78C6C;">)</span> <span style="color: #c792ea;">int</span>, <span style="color: #ffcb6b;">num</span> <span style="color: #c792ea;">int</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">[]</span><span style="color: #c792ea;">int</span> <span style="color: #c792ea;">{</span>
        <span style="color: #ffcb6b;">out</span> := <span style="color: #82aaff;">make</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">chan</span> <span style="color: #c792ea;">int</span>, num<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">wg</span> <span style="color: #c792ea;">sync.WaitGroup</span>
        wg.<span style="color: #82aaff;">Add</span><span style="color: #F78C6C;">(</span>num<span style="color: #F78C6C;">)</span>

        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">i</span> := 0; i &lt; num; i++ <span style="color: #F78C6C;">{</span>
                <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">()</span> <span style="color: #c3e88d;">{</span>
                        <span style="color: #89DDFF;">defer</span> wg.<span style="color: #82aaff;">Done</span><span style="color: #89DDFF;">()</span>
                        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> in <span style="color: #89DDFF;">{</span>
                                out &lt;- <span style="color: #82aaff;">processor</span><span style="color: #bb80b3;">(</span>v<span style="color: #bb80b3;">)</span>
                        <span style="color: #89DDFF;">}</span>
                <span style="color: #c3e88d;">}()</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">go</span> <span style="color: #89DDFF;">func</span><span style="color: #F78C6C;">()</span> <span style="color: #F78C6C;">{</span>
                wg.<span style="color: #82aaff;">Wait</span><span style="color: #c3e88d;">()</span>
                <span style="color: #82aaff;">close</span><span style="color: #c3e88d;">(</span>out<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}()</span>
        <span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">result</span> <span style="color: #F78C6C;">[]</span><span style="color: #c792ea;">int</span>
        <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">v</span> := <span style="color: #89DDFF;">range</span> out <span style="color: #F78C6C;">{</span>
                result = <span style="color: #82aaff;">append</span><span style="color: #c3e88d;">(</span>result, v<span style="color: #c3e88d;">)</span>
        <span style="color: #F78C6C;">}</span>
        <span style="color: #89DDFF;">return</span> result
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>例子中,我们启动了一个monitor goroutine来等待,直到所有的worker goroutine退出</li>
<li>一旦其他所有的worker goroutine退出,那么monitor goroutine就会调用close在output channel上</li>
<li>main goroutine里面的for-range也会在out channel被关闭的情况下退出循环</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org309a4f8" class="outline-4">
<h4 id="org309a4f8"><span class="section-number-4">6.5.11.</span> Running Code Exactly Once</h4>
<div class="outline-text-4" id="text-6-5-11">
<ul class="org-ul">
<li>前面我们讲过, init只能用于初始化package-level的, immutable的state</li>
<li>但是有很多情况下,在运行了一段时间以后,我们也希望初始化一些代码,并且初始化一次(因为初始化过程浪
费时间,所以尽量只初始化一次)</li>
<li>通常是用到的时候才初始化,如果用不到, 因为创建时间长,可能永远不会初始化,学名叫做lazy load</li>
<li>sync里面包含了一个叫做Once的type,用来在go里面做lazy load
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #626262;">// </span><span style="color: #626262;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #626262;">// </span><span style="color: #626262;">snippet of code @ 2022-10-21 17:24:11</span>

<span style="color: #626262;">// </span><span style="color: #626262;">=== Go Playground ===</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Execute the snippet with Ctl-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #89DDFF;">package</span> main

<span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">(</span>
        <span style="color: #c3e88d;">"fmt"</span>
        <span style="color: #c3e88d;">"sync"</span>
        <span style="color: #c3e88d;">"time"</span>
<span style="color: #c792ea;">)</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">SlowComplicatedParser</span> <span style="color: #89DDFF;">interface</span> <span style="color: #c792ea;">{</span>
        <span style="color: #82aaff;">Parse</span><span style="color: #F78C6C;">(</span><span style="color: #c792ea;">string</span><span style="color: #F78C6C;">)</span> <span style="color: #c792ea;">string</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">type</span> <span style="color: #c792ea;">DailyParser</span> <span style="color: #89DDFF;">struct</span> <span style="color: #c792ea;">{</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">d</span> <span style="color: #c792ea;">DailyParser</span><span style="color: #c792ea;">)</span> <span style="color: #82aaff;">Parse</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">input</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">string</span> <span style="color: #c792ea;">{</span>
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>1 * time.Second<span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">return</span> fmt.<span style="color: #82aaff;">Sprintf</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"%v is Done"</span>, input<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">parser</span> <span style="color: #c792ea;">SlowComplicatedParser</span>
<span style="color: #89DDFF;">var</span> <span style="color: #ffcb6b;">once</span> <span style="color: #c792ea;">sync.Once</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">Parse</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">dataToParse</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">string</span> <span style="color: #c792ea;">{</span>
        once.<span style="color: #82aaff;">Do</span><span style="color: #F78C6C;">(</span><span style="color: #89DDFF;">func</span><span style="color: #c3e88d;">()</span> <span style="color: #c3e88d;">{</span>
                parser = <span style="color: #82aaff;">initParser</span><span style="color: #89DDFF;">()</span>
        <span style="color: #c3e88d;">}</span><span style="color: #F78C6C;">)</span>
        <span style="color: #89DDFF;">return</span> parser.<span style="color: #82aaff;">Parse</span><span style="color: #F78C6C;">(</span>dataToParse<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">initParser</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">SlowComplicatedParser</span> <span style="color: #c792ea;">{</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #c792ea;">DailyParser</span><span style="color: #F78C6C;">{}</span>
<span style="color: #c792ea;">}</span>

<span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">main</span><span style="color: #c792ea;">()</span> <span style="color: #c792ea;">{</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #c3e88d;">"Results:"</span><span style="color: #F78C6C;">)</span>
        fmt.<span style="color: #82aaff;">Println</span><span style="color: #F78C6C;">(</span><span style="color: #82aaff;">Parse</span><span style="color: #c3e88d;">(</span><span style="color: #c3e88d;">"Some Task"</span><span style="color: #c3e88d;">)</span><span style="color: #F78C6C;">)</span>
        time.<span style="color: #82aaff;">Sleep</span><span style="color: #F78C6C;">(</span>2 * time.Second<span style="color: #F78C6C;">)</span>
<span style="color: #c792ea;">}</span>

<span style="color: #626262;">// </span><span style="color: #626262;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Results:</span>
<span style="color: #626262;">// </span><span style="color: #626262;">Some Task is Done</span>
</pre>
</div></li>
<li>例子中创建了两个package level的变量:
<ul class="org-ul">
<li>parser,是SlowComplicatedParser类型的,用来面向接口编程</li>
<li>once,是sync.Once类型的:
<ol class="org-ol">
<li>和sync.WaitGroup一样,我们不需要初始化这个instance,它的zero value就很有用.</li>
<li>同时我们也要确保不要copy sync.Once的instance,所以我们的代码都是使用的全局变量申请once.</li>
<li>在函数内部申请once通常都是错误的,因为每个function里面都有一个instance的话,无法记忆之前
是否曾经调用过</li>
</ol></li>
</ul></li>
<li>例子中确保parser只被初始化一次的方法是把closure传递给once.Do函数,同时在这个closure里面初始化
parser. 函数Parser()可能被调用多次,但是Parser()里面的once.Do只会执行exactly一次这个closure</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgde02cca" class="outline-4">
<h4 id="orgde02cca"><span class="section-number-4">6.5.12.</span> Putting Our Concurrent Tools Together</h4>
<div class="outline-text-4" id="text-6-5-12">
<ul class="org-ul">
<li>TODO</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga468e18" class="outline-3">
<h3 id="orga468e18"><span class="section-number-3">6.6.</span> When to Use Mutexes Instead of Channels</h3>
<div class="outline-text-3" id="text-6-6">
<ul class="org-ul">
<li>如果你有其他语言处理并发的经验,那么你肯定使用过mutex(mutual exclusion的简称)</li>
<li>mutex的任务是限制对某段代码的并发访问,这段被包含的代码叫做critical section</li>
<li>Go的设计者使用channel和select来管理并发是有足够的原因的:
<ul class="org-ul">
<li>主要原因是mutex会模糊程序里面的data flow:
<ol class="org-ol">
<li>当使用mutex来保护value的时候,没有办法来确定哪个thread(goroutine)来占有这个数据,因为数据是
被所有的thread(goroutine)所共有的</li>
<li>而使用channel的时候,data flow是清晰的</li>
</ol></li>
</ul></li>
<li><p>
还是有些场景下使用mutex会更清晰,最常见的一个情景是当你的goroutine读取或者写入一个共享数据,但是
不处理这个数据
</p>
<pre class="example" id="org7ba75d9">
The most common case is when your goroutines read or write a shared value,
but don't process the value
</pre></li>
<li>我们先看看这种情况下使用goroutine和channel是什么样子的
<ul class="org-ul">
<li>TODO</li>
</ul></li>
<li>我们总结一下什么时候使用channel,什么时候使用mutex:
<ul class="org-ul">
<li>如果你的value会被多个goroutine进行改装,那么使用channel</li>
<li>如果你分享一个struct的field的acess,那么使用mutex</li>
<li>如果你使用channel发现了巨大的性能问题,而且找不到解决办法,那么使用mutex</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org86a8955" class="outline-3">
<h3 id="org86a8955"><span class="section-number-3">6.7.</span> Atomics-Your Probably Don't Need These</h3>
<div class="outline-text-3" id="text-6-7">
<ul class="org-ul">
<li>除了mutex以外,go还提供了其他的保证在多个thread之间consistent的方法,那就是sync/atomic package</li>
<li>sync/atomic package 提供了访问atomic variable 操作的方法,这些方法是基于现代CPU的,能够在寄存器级
别操作value.</li>
<li>这些只适用于超级专家,我们普通人使用goroutine和mutex就完全够了</li>
</ul>
</div>
</div>
<div id="outline-container-orge6d4d6a" class="outline-3">
<h3 id="orge6d4d6a"><span class="section-number-3">6.8.</span> Where to Learn More About Concurrency</h3>
<div class="outline-text-3" id="text-6-8">
<ul class="org-ul">
<li>学习书籍: Concurrency in Go</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfd50b7d" class="outline-2">
<h2 id="orgfd50b7d"><span class="section-number-2">7.</span> Chapter 12: The Context</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>服务器需要一种方法来处理每个请求的metadata</li>
<li>这些metadata分为两个大类:
<ul class="org-ul">
<li>为了正确的处理request所需要的metadata.比如,一个http server可能想要一个tracking ID来跟踪请求,因
为这个请求会经过一系列microservice,其实是一个请求</li>
<li>什么时候需要停止request的metadata.比如,在请求某个微服务的时候时间太久,我们可能想关闭这个请求</li>
</ul></li>
<li>其他语言会使用threadlocal variable来存储这些metadata,方法是把这些data和操作系统中的某个thread绑
定.</li>
<li>但是在go语言里面,由于goroutine没有唯一标识符,所以不能使用这种方法</li>
<li>同时,threadlocal也有缺点,它的缺点是看起来像黑魔法,数据从一个地方写入,从另外的地方冒出来</li>
<li>Go使用context技术来存储server需要的这些metadata</li>
</ul>
</div>
<div id="outline-container-orgd9baa8a" class="outline-3">
<h3 id="orgd9baa8a"><span class="section-number-3">7.1.</span> What Is the Context?</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>context不是一个语言特性,它只不过是满足Context interface(定义在context package)的instance</li>
<li>go语言不太喜欢threadlocal那种比较magic的用法,喜欢explicit的函数参数传递.</li>
<li>context也就是这样,只不过context默认作为函数的第一个参数传递,这算一个convention, go语言另外一个经
典的convention是返回值的最后一个数据是error</li>
<li><p>
就像error变量经常被写成err一样,context变量默认写成ctx,作为第一个参数,传递给函数,下面就是是一个例子
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #89DDFF;">func</span> <span style="color: #82aaff;">logic</span><span style="color: #c792ea;">(</span><span style="color: #ffcb6b;">ctx</span> <span style="color: #c792ea;">context.Context</span>, <span style="color: #ffcb6b;">info</span> <span style="color: #c792ea;">string</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">(</span><span style="color: #c792ea;">string</span>, <span style="color: #c792ea;">error</span><span style="color: #c792ea;">)</span> <span style="color: #c792ea;">{</span>
        <span style="color: #626262;">// </span><span style="color: #626262;">do some interesting stuff here</span>
        <span style="color: #89DDFF;">return</span> <span style="color: #c3e88d;">""</span>, <span style="color: #F78C6C;">nil</span>
<span style="color: #c792ea;">}</span>
</pre>
</div></li>
<li>除了定义了Contex interface, contex package还包含了很多工厂函数用来:
<ul class="org-ul">
<li>create context</li>
<li>wrap context</li>
</ul></li>
<li><p>
通常情况下,我们都是使用别人传过来的contex,如果你是一个command-line程序的开发者,那么你大概率要自
己创建一个empty的初始context,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffcb6b;">ctx</span> := context.<span style="color: #82aaff;">Background</span><span style="color: #c792ea;">()</span>
<span style="color: #ffcb6b;">result</span>, <span style="color: #ffcb6b;">err</span> := <span style="color: #82aaff;">logic</span><span style="color: #c792ea;">(</span>ctx, <span style="color: #c3e88d;">"a string"</span><span style="color: #c792ea;">)</span>
</pre>
</div></li>
<li>上面的例子是一个empty context,这是context的一个起始点.以后每次向这个context加东西的时候,你就要
通过 wrap context的工厂函数了(因为context是readonly的,所以只能wrap新的内容进去,不能更改)</li>
<li>在context package里面,还有另外一个工厂函数,功能和Background一样,也是产生一个empty的contex,叫做
context.TODO.但是不要在production代码里面使用这个context.TODO,因为:
<ul class="org-ul">
<li>context.TODO创建是因为写代码的时候,不知道context从哪里来(可能是自己初始化,也可能别人传给你),
所以占位.后面发布的时候必须改掉</li>
<li>如果明确的知道context是从我这里初始化(比如command-line tool的代码),那么就用context.Background</li>
</ul></li>
<li>由于context诞生于net/http package之后,我们不能在http.Handler interface里面添加context.Context参数
所以,在http.Handler相关的操作中,我们的context使用的pattern会有所不同</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: harrifeng@outlook.com</p>
<p class="date">Created: 2022-12-28 Wed 21:08</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
