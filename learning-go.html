<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-03-12 Sun 19:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>learning-go</title>
<meta name="author" content="harrifeng@outlook.com" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">learning-go</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfa24551">1. Setting Up Your Go Environment</a>
<ul>
<li><a href="#orgd12abf3">1.1. Installing the Go Tools</a></li>
<li><a href="#org3f76e08">1.2. The Go Workspace</a></li>
<li><a href="#org1e66350">1.3. The go Command</a>
<ul>
<li><a href="#org8d21ca5">1.3.1. go run and go build</a></li>
<li><a href="#orgc3df860">1.3.2. Getting Third-Party Go Tools</a></li>
<li><a href="#org7580eef">1.3.3. Formating Your Code</a></li>
</ul>
</li>
<li><a href="#org41d4598">1.4. Linting and Vetting</a></li>
<li><a href="#orgb7ff9b7">1.5. Choose Your Tools</a>
<ul>
<li><a href="#orgdb39cb5">1.5.1. Visual Studio Code</a></li>
<li><a href="#org339b810">1.5.2. GoLand</a></li>
<li><a href="#org9b9c8e2">1.5.3. The Go Playground</a></li>
</ul>
</li>
<li><a href="#org013a601">1.6. Makefile</a></li>
<li><a href="#org504bfde">1.7. Staying Up to Date</a></li>
</ul>
</li>
<li><a href="#org247a876">2. Primitive Types and Declarations</a>
<ul>
<li><a href="#org44e0f2d">2.1. Built-in Types</a>
<ul>
<li><a href="#org4d5e7a7">2.1.1. The Zero Value</a></li>
<li><a href="#orgbc039f3">2.1.2. Literals</a></li>
<li><a href="#org2fce20a">2.1.3. Booleans</a></li>
<li><a href="#org7944b54">2.1.4. Numeric Types</a></li>
<li><a href="#org869f12f">2.1.5. A Taste of Strings and Runes</a></li>
<li><a href="#org0097f66">2.1.6. Explicit Type Conversion</a></li>
</ul>
</li>
<li><a href="#orgc0e3ff1">2.2. var Versus :=</a></li>
<li><a href="#orgfb160ce">2.3. Using const</a></li>
<li><a href="#org3c08d72">2.4. Typed and Untyped Constants</a></li>
<li><a href="#org64e17c6">2.5. Unused Variables</a></li>
<li><a href="#org5225558">2.6. Naming Variables and Constrants</a></li>
</ul>
</li>
<li><a href="#orgdbf4be9">3. Composite Types</a>
<ul>
<li><a href="#org618440c">3.1. Arrays-Too Rigid to Use Directly</a></li>
<li><a href="#orgde94bc8">3.2. Slices</a>
<ul>
<li><a href="#org88499d0">3.2.1. len</a></li>
<li><a href="#org54a8044">3.2.2. append</a></li>
<li><a href="#org502fa00">3.2.3. Capacity</a></li>
<li><a href="#org48e12c6">3.2.4. make</a></li>
<li><a href="#orgea14c00">3.2.5. Declaring Your Slice</a></li>
<li><a href="#org50143de">3.2.6. Slicing Slices</a></li>
<li><a href="#orgba9c36a">3.2.7. Converting Arrays to Slices</a></li>
<li><a href="#org4f596f7">3.2.8. copy</a></li>
</ul>
</li>
<li><a href="#org2d5d41a">3.3. Strings and Runes and Bytes</a></li>
<li><a href="#orga26cc23">3.4. Maps</a>
<ul>
<li><a href="#orgfd0cf0f">3.4.1. Reading and Writing a Map</a></li>
<li><a href="#orgb9539e4">3.4.2. The comma ok idiom</a></li>
<li><a href="#orgc637023">3.4.3. Deleting from Maps</a></li>
<li><a href="#orge780096">3.4.4. Using Maps as Sets</a></li>
</ul>
</li>
<li><a href="#orgedb0d74">3.5. Structs</a>
<ul>
<li><a href="#org335022c">3.5.1. Anoymous Structs</a></li>
<li><a href="#orgad3da88">3.5.2. Comparing and Converting Structs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2ad1b8e">4. Blocks, Shadows, and Control Structures</a>
<ul>
<li><a href="#orgdc34513">4.1. Blocks</a>
<ul>
<li><a href="#orgaac1aed">4.1.1. Shadowing Variables</a></li>
<li><a href="#org71e34f5">4.1.2. Detecting Shadowed Variables</a></li>
</ul>
</li>
<li><a href="#org240d336">4.2. if</a></li>
<li><a href="#orgdd62929">4.3. for, Four Ways</a>
<ul>
<li><a href="#org09436a1">4.3.1. The Complete for Statement</a></li>
<li><a href="#org9dcd92c">4.3.2. The Condition-Only for Statement</a></li>
<li><a href="#orgeb8a1c8">4.3.3. The Infinite for Statement</a></li>
<li><a href="#org7aed433">4.3.4. break and continue</a></li>
<li><a href="#org2e300cd">4.3.5. The for-range Statement</a></li>
<li><a href="#org0efc453">4.3.6. Labeling Your for Statemetns</a></li>
<li><a href="#org44123b3">4.3.7. Choosing the Right for Statement</a></li>
</ul>
</li>
<li><a href="#orgccad8d2">4.4. switch</a></li>
<li><a href="#orge9fd331">4.5. Blank Switches</a></li>
<li><a href="#orgf73b016">4.6. Choosing Between if and switch</a></li>
<li><a href="#org1a22a24">4.7. goto&#x2013;Yes, goto</a></li>
</ul>
</li>
<li><a href="#org8e5620b">5. Functions</a>
<ul>
<li><a href="#org987329c">5.1. Declaring and Calling Functions</a>
<ul>
<li><a href="#orgc979842">5.1.1. Simulating Named and Optional Parameters</a></li>
<li><a href="#org9934028">5.1.2. Variadic Input Parameters and Dlices</a></li>
<li><a href="#org113254a">5.1.3. Multiple Return Values</a></li>
<li><a href="#orgea797e1">5.1.4. Multiple Return Values Are Multiple Values</a></li>
<li><a href="#orgded40fa">5.1.5. Ignoring Returned Values</a></li>
<li><a href="#orgeaaeb10">5.1.6. Named Return Values</a></li>
<li><a href="#org19c8493">5.1.7. Blank Returns - Never Use These !</a></li>
</ul>
</li>
<li><a href="#orgdd8fbbe">5.2. Functions Are Values</a>
<ul>
<li><a href="#orgcef6495">5.2.1. Function Type Declarations</a></li>
<li><a href="#orga34c1c9">5.2.2. Anonymous Functions</a></li>
</ul>
</li>
<li><a href="#org1b6641d">5.3. Closures</a>
<ul>
<li><a href="#orgc72f487">5.3.1. Passing Functions as Parameters</a></li>
<li><a href="#orgc805451">5.3.2. Returning Functions from Functions</a></li>
</ul>
</li>
<li><a href="#org71cbf1e">5.4. defer</a></li>
<li><a href="#org886e15f">5.5. Go is Call By Value</a></li>
</ul>
</li>
<li><a href="#orgacbc7f2">6. Pointers</a>
<ul>
<li><a href="#orgbab9f5a">6.1. A Quick Pointer Primer</a></li>
<li><a href="#org82ef37c">6.2. Don't Fear the Pointers</a></li>
<li><a href="#orgc53d8c1">6.3. Pointers Indicate Mutable Parameters</a></li>
<li><a href="#org1328987">6.4. Pointers Are a Last Resort</a></li>
<li><a href="#orge73739a">6.5. Pointer Passing Performance</a></li>
<li><a href="#orgf97b50f">6.6. The Zero Value Versus No Value</a></li>
<li><a href="#orgc31ccd0">6.7. The Difference Between Maps</a></li>
<li><a href="#orgc7c7823">6.8. Slices are Buffers</a></li>
<li><a href="#orgfb45c83">6.9. Reducing the Garbage Collector's Workload</a>
<ul>
<li><a href="#org6d6221e">6.9.1. Stack</a></li>
<li><a href="#org1210dd0">6.9.2. Heap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org49c8e80">7. Types, Methods, and Interfaces</a>
<ul>
<li><a href="#org04b420f">7.1. Types in Go</a></li>
<li><a href="#orge79db00">7.2. Methods</a>
<ul>
<li><a href="#org3fc3b87">7.2.1. Pointer Receivers and Value Receivers</a></li>
<li><a href="#org6f9b028">7.2.2. Code Your Methods for nil Instances</a></li>
<li><a href="#org87bd948">7.2.3. Methods Are Functions Too</a></li>
<li><a href="#orgc11bcdd">7.2.4. Functions Versus Methods</a></li>
<li><a href="#org8ae6d6e">7.2.5. Type Declarations Aren't Inheritance</a></li>
<li><a href="#orgb640cdd">7.2.6. Types Are Eexcutable Documentation</a></li>
<li><a href="#orga98f242">7.2.7. iota Is for Enumerations-Sometimes</a></li>
</ul>
</li>
<li><a href="#org2ebccbe">7.3. Use Embedding for Composition</a></li>
<li><a href="#org7c6e4ba">7.4. Embedding Is Not Inheritance</a></li>
<li><a href="#org9d15016">7.5. A Quick Lesson on Interfaces</a></li>
<li><a href="#orgd0d4199">7.6. Interfaces Are Type-Safe Duck Typing</a></li>
<li><a href="#org53dedbd">7.7. Embedding and Interfaces</a></li>
<li><a href="#org55d0df4">7.8. Accept Interfaces, Return Structs</a></li>
<li><a href="#org7ee208a">7.9. Interfaces and nil</a></li>
<li><a href="#org94f3a29">7.10. The Empty Interface Says Nothing</a></li>
<li><a href="#org80b190a">7.11. Type Assertions and Type Switches</a></li>
<li><a href="#org13c5ebc">7.12. Use Type Assertions and Type Switches Sparingly</a></li>
<li><a href="#org3916a88">7.13. Function Types Are a Bridge to Interfaces</a></li>
<li><a href="#org0669328">7.14. Implicit Interfaces Make Dependency injection Easier</a></li>
<li><a href="#org897d284">7.15. Wire</a></li>
<li><a href="#org7b18b99">7.16. Go Isn't Particularly Object-Oriented (and That's Great)</a></li>
</ul>
</li>
<li><a href="#orgc8d3e7c">8. Errors</a>
<ul>
<li><a href="#orgeb8d996">8.1. How to Handle errors: The Basics</a></li>
<li><a href="#org97cb9bd">8.2. Use Strings for Simple Errors</a></li>
<li><a href="#orgff5d5c0">8.3. Sentinel Errors</a></li>
<li><a href="#orgdf7a11d">8.4. Errors Are Values</a></li>
<li><a href="#orgc9ae752">8.5. Wrapping Errors</a></li>
<li><a href="#orgc4785c3">8.6. Is and As</a></li>
<li><a href="#org4e97161">8.7. Wrapping Errors with defer</a></li>
<li><a href="#org7e83530">8.8. panic and recover</a></li>
<li><a href="#org924e96d">8.9. Getting a Stack Trace from an Error</a></li>
</ul>
</li>
<li><a href="#org70d1c9a">9. Modules, Packags, and Imports</a>
<ul>
<li><a href="#orgeca176c">9.1. Repositories, Modules, and Packages</a></li>
<li><a href="#orga6402aa">9.2. go.mod</a></li>
<li><a href="#orgd649bff">9.3. Building Packages</a>
<ul>
<li><a href="#orgeb1dfde">9.3.1. Imports and Exports</a></li>
<li><a href="#orgd4ce01c">9.3.2. Creating and Accessing a Package</a></li>
<li><a href="#org1e87221">9.3.3. Naming Package</a></li>
<li><a href="#org21f6b33">9.3.4. How to Organize Your Module</a></li>
<li><a href="#org22216e4">9.3.5. Overriding a Package's Name</a></li>
<li><a href="#org2e9596b">9.3.6. Package Comments and godoc</a></li>
<li><a href="#org0dc9d7d">9.3.7. The internal Package</a></li>
<li><a href="#orgcb5489a">9.3.8. The init Function: Avoid if Possible</a></li>
<li><a href="#org283536a">9.3.9. Circular Dependencies</a></li>
<li><a href="#org463bec1">9.3.10. Gracefully Renaming and Reorganzing</a></li>
</ul>
</li>
<li><a href="#orgf4eaff9">9.4. Working with Modules</a>
<ul>
<li><a href="#org4f5c8a4">9.4.1. Importing Third-Party Code</a></li>
<li><a href="#orgeefa053">9.4.2. Working with Versions</a></li>
<li><a href="#org0cb6af1">9.4.3. Minimum Version Selection</a></li>
<li><a href="#orgad3f8a9">9.4.4. Updating to Compatible Versions</a></li>
<li><a href="#org4568371">9.4.5. Updating to Incompatible Versions</a></li>
<li><a href="#orgc9a5eb9">9.4.6. Vendoring</a></li>
<li><a href="#orgb4e6290">9.4.7. pkg.go.dev</a></li>
<li><a href="#orgcb834ed">9.4.8. Additional Information</a></li>
</ul>
</li>
<li><a href="#orga2cabd6">9.5. Publishing Your Module</a></li>
<li><a href="#orgdce83fb">9.6. Versioning Your Module</a></li>
<li><a href="#org2521fb7">9.7. Module Proxy Servers</a>
<ul>
<li><a href="#orgd6a5d15">9.7.1. Specifying a Proxy Server</a></li>
<li><a href="#orga3837a2">9.7.2. Private Repositories</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org86a1bcf">10. Concurrency in Go</a>
<ul>
<li><a href="#orgcbcb848">10.1. When to Use Concurrency</a></li>
<li><a href="#orgbd5be66">10.2. Goroutines</a></li>
<li><a href="#orgfed5737">10.3. Channels</a>
<ul>
<li><a href="#orga0a7d9b">10.3.1. Reading, Writing, and Buffering</a></li>
<li><a href="#org65751f8">10.3.2. for-range and Channels</a></li>
<li><a href="#org9fd86bd">10.3.3. Closing a Channel</a></li>
<li><a href="#orgd9a5e71">10.3.4. How Channels Behave</a></li>
</ul>
</li>
<li><a href="#orgec47c03">10.4. select</a></li>
<li><a href="#org05787d3">10.5. Concurrency Practices and Patterns</a>
<ul>
<li><a href="#org553e8e7">10.5.1. Keep Your APIs Concurrency-Free</a></li>
<li><a href="#orgb8098b1">10.5.2. Goroutines, for Loops, and Varying Variables</a></li>
<li><a href="#org338c125">10.5.3. Always Clean Up Your Goroutines</a></li>
<li><a href="#orgd2d5bb1">10.5.4. The Done Channel Pattern</a></li>
<li><a href="#org3a63209">10.5.5. Using aa Cancel Function to Terminate a Goroutine</a></li>
<li><a href="#org2ae11a4">10.5.6. When to Use Buffered and Unbuffered Channels</a></li>
<li><a href="#org9d053dc">10.5.7. Backpressure</a></li>
<li><a href="#orgc7f8abe">10.5.8. Turning Off a case in a select</a></li>
<li><a href="#orga11b951">10.5.9. How to Time Out Code</a></li>
<li><a href="#orga92b4cf">10.5.10. Using WaitGroup</a></li>
<li><a href="#org56471c3">10.5.11. Running Code Exactly Once</a></li>
<li><a href="#org2768bea">10.5.12. Putting Our Concurrent Tools Together</a></li>
</ul>
</li>
<li><a href="#orgd654f84">10.6. When to Use Mutexes Instead of Channels</a></li>
<li><a href="#org805dda4">10.7. Atomics-Your Probably Don't Need These</a></li>
<li><a href="#org5dffbd5">10.8. Where to Learn More About Concurrency</a></li>
</ul>
</li>
<li><a href="#org24169f8">11. The Standard Library</a>
<ul>
<li><a href="#org4cd6b6e">11.1. io and Friends</a></li>
<li><a href="#org5f904b2">11.2. time</a>
<ul>
<li><a href="#org7d2542f">11.2.1. Monotonic Time</a></li>
<li><a href="#org65c96be">11.2.2. Timers and Timeouts</a></li>
</ul>
</li>
<li><a href="#org7a0b290">11.3. encoding/json</a>
<ul>
<li><a href="#orgbc149d9">11.3.1. Use Struct to Add Metadata</a></li>
<li><a href="#orgba85a48">11.3.2. Unmarshaling and Marshaling</a></li>
<li><a href="#orgab31214">11.3.3. JSON, Readers, and Writers</a></li>
<li><a href="#orgca449fa">11.3.4. Enoding and Decoding JSON Streams</a></li>
<li><a href="#org66f242a">11.3.5. Custom JSON Parsing</a></li>
</ul>
</li>
<li><a href="#orgceb9141">11.4. net/http</a>
<ul>
<li><a href="#org61217b8">11.4.1. The Client</a></li>
<li><a href="#org72aa07e">11.4.2. The Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2731952">12. The Context</a>
<ul>
<li><a href="#org3ccd348">12.1. What Is the Context?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa24551" class="outline-2">
<h2 id="orgfa24551"><span class="section-number-2">1.</span> Setting Up Your Go Environment</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgd12abf3" class="outline-3">
<h3 id="orgd12abf3"><span class="section-number-3">1.1.</span> Installing the Go Tools</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li><p>
安装好go之后,使用如下命令确认go是否已经安装成功
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go version
go version go1.19.2 darwin/arm64
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3f76e08" class="outline-3">
<h3 id="org3f76e08"><span class="section-number-3">1.2.</span> The Go Workspace</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>从2009年以来,go历经改动,最初的一些建议可能已经不适用了</li>
<li>对于现代Go开发者(1.15之后)来说,如何组织代码是自由的,没有任何约束的</li>
<li>虽然没有约束,但是Go还是有最佳实践的:
<ul class="org-ul">
<li>所有的第三方Go tools安装在一个单独的workspace, 并且是通过go install 安装,默认情况下这个workspace
在$HOME/go(其中源代码在$HOME/go/src, 二进制在$HOME/go/bin), 可以使用$GOPATH设置这个workspace</li>
<li><p>
在profile文件里面设置GOPATH和加入bin到PATH
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #d33682; font-style: italic;">export</span> <span style="color: #268bd2;">GOPATH</span>=$<span style="color: #268bd2;">HOME</span>/go
<span style="color: #d33682; font-style: italic;">export</span> <span style="color: #268bd2;">PATH</span>=$<span style="color: #268bd2;">PATH</span>:$<span style="color: #268bd2;">GOPATH</span>/bin
</pre>
</div></li>
</ul></li>
<li>很多老的资料说要设置GOROOT环境变量,这个是老的要求,现在已经不需要了</li>
</ul>
</div>
</div>
<div id="outline-container-org1e66350" class="outline-3">
<h3 id="org1e66350"><span class="section-number-3">1.3.</span> The go Command</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Go把自己的所有能力都通过go command来传递的</li>
</ul>
</div>
<div id="outline-container-org8d21ca5" class="outline-4">
<h4 id="org8d21ca5"><span class="section-number-4">1.3.1.</span> go run and go build</h4>
<div class="outline-text-4" id="text-1-3-1">
<ul class="org-ul">
<li>这两个命令有点相似,下面来看下区别:
<ul class="org-ul">
<li>go run 会把你的代码编译成二进制,并且放到一个临时文件夹,运行代码,然后再马上删掉临时文件夹中的二进制文件</li>
<li><p>
go build会在当前文件夹下面生成一个新的二进制文件,如果想把二进制文件换个名字或者换个地方,可以使用-o
</p>
<div class="org-src-container">
<pre class="src src-shell">go build -o /tmp/hello_world hello.go
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc3df860" class="outline-4">
<h4 id="orgc3df860"><span class="section-number-4">1.3.2.</span> Getting Third-Party Go Tools</h4>
<div class="outline-text-4" id="text-1-3-2">
<ul class="org-ul">
<li>有些开发者会把预先编译好的go二进制进行分发,另外一些开发者会分发源代码,然后使用GO编译成二进制(使
用go install命令,把二进制安装到$GOPATH/bin, 后者更多的人使用的方法)</li>
<li><p>
go install 带一个参数,这个参数是二进制的源代码地址加上一个@,再加上版本(如果是最新版,使用latest),
我们来看一个例子hey
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go install github.com/rakyll/hey@latest
go: downloading github.com/rakyll/hey v0.1.4
go: downloading golang.org/x/net v0.0.0-20181017193950-04a2e542c03f
$ which hey
/Users/harri/go/bin/hey
</pre>
</div></li>
<li>go的二进制不一定放在$GOPATH/bin下面,放在任意$PATH下面都可以.同样,开发者也不一定以源代码的方式来
分发他们的工具.但是使用源代码分发,并且go install到$GOPATH/bin是go的推荐做法,这么做容易让其他go
开发者理解并且使用.</li>
</ul>
</div>
</div>
<div id="outline-container-org7580eef" class="outline-4">
<h4 id="org7580eef"><span class="section-number-4">1.3.3.</span> Formating Your Code</h4>
<div class="outline-text-4" id="text-1-3-3">
<ul class="org-ul">
<li>很多语言运行非常灵活的code layout,但是Go并不是:Go有一个standard format,这简化了编译器,并且让代
码更容易阅读</li>
<li>go默认的格式化工具是go fmt</li>
<li>还有一个改进版本的format工具叫做goimports,除了 go fmt的功能外, goimports还会:
<ul class="org-ul">
<li>clean up你的import</li>
<li>让你的import以字母顺序排列</li>
<li>去掉没有使用的imports</li>
<li>猜测你需要的import,当然了这个功能不太准确</li>
</ul></li>
<li><p>
可以使用如下命令下载goimports
</p>
<div class="org-src-container">
<pre class="src src-shell">go install golang.org/x/tools/cmd/goimports@latest
</pre>
</div></li>
<li>goimports的使用方法如下:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-shell">goimports -l -w .
</pre>
</div></li>
<li>-l表示打印出错误的formatting到console</li>
<li>-w表示in-place的更改文件</li>
<li>`.`表示当前文件夹夹里面的文件都需要扫描</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org41d4598" class="outline-3">
<h3 id="org41d4598"><span class="section-number-3">1.4.</span> Linting and Vetting</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>go fmt只是格式化了你的代码,这只是让你的代码得到高质量的第一步</li>
<li>所有的go开发者都需要读一下Effective Go和Go's Wiki Code Review来理解如何书写一个地道(idiomatic)的
go代码</li>
<li>想写出地道go代码的另外一个方法是使用各种lint tool</li>
<li>golint就是这样一种lint tool,它会在如下地方做出推荐:
<ul class="org-ul">
<li>引入符合规范的nameing variable</li>
<li>format 错误信息</li>
<li>再public method和type前面加注释</li>
</ul></li>
<li>golint这种lint工具指出来的并不是错误(因为他们不会让你的代码编译失败,或者运行错误)</li>
<li>lint工具的suggestion并不是都是对的,所以你并不需要完全按照lint工具的推荐进行修改,但是你要严肃的
对待这些建议</li>
<li><p>
使用如下代码安装golint
</p>
<div class="org-src-container">
<pre class="src src-shell">go install golang.org/x/lint/golint@latest
</pre>
</div></li>
<li><p>
使用如下代码来lint整个项目
</p>
<div class="org-src-container">
<pre class="src src-shell">golint ./...
</pre>
</div></li>
<li>和linting很像的另外一种工具是vetting,它会发现这么一种错误:
<ul class="org-ul">
<li>首先和linting发现的错误一样,这个错误不会影响编译</li>
<li>但是和linting不一样的地方是,linting发现的错误是"你不知道这样是错的", vetting发现的错误是
"你知道这样是错误的,但是由于不小心还是犯错了"</li>
</ul></li>
<li>vetting发现的错误例子有:
<ul class="org-ul">
<li>给formatting method传入的参数个数不对</li>
<li>给variable赋值,但是这个variable从来不使用</li>
</ul></li>
<li><p>
go自带了vetting工具,使用如下代码来完成vetting操作
</p>
<div class="org-src-container">
<pre class="src src-shell">go vet ./...
</pre>
</div></li>
<li>除了golint和go vet,还有很多的第三方的工具来做linting和vetting.但是这种工具如果有几十个都一起使
用的话,会严重影响整个的build过程,因为每个工具都会把所有的源代码都跑一遍,换句话说,使用几十个工具
做linting和vetting的话,就是要跑几十遍.</li>
<li>为了解决这个问题,出现了一个新的工具叫做golangci-lint,这个工具就是可以把各种linting和vetting工具
结合起来,扫描一次,应用多种linting和vetting工具.</li>
<li><p>
golangci-lint一旦安装,可以使用如下方法进行运行
</p>
<div class="org-src-container">
<pre class="src src-shell">golangci-lint run
</pre>
</div></li>
<li>golangci-lint的设计初衷是好的(同时应用多个linting和vetting工具,现在最多支持50种),但是坏处是team
并不能完全同意这些linting和vetting工具的结果.你可以配置一下哪些linting和vetting工具是你们需要的.
配置文件在project文件夹下的.golangci.yml文件.</li>
</ul>
</div>
</div>
<div id="outline-container-orgb7ff9b7" class="outline-3">
<h3 id="orgb7ff9b7"><span class="section-number-3">1.5.</span> Choose Your Tools</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orgdb39cb5" class="outline-4">
<h4 id="orgdb39cb5"><span class="section-number-4">1.5.1.</span> Visual Studio Code</h4>
<div class="outline-text-4" id="text-1-5-1">
<ul class="org-ul">
<li>vscode 对Go的支持来源于第三方工具:
<ul class="org-ul">
<li>Delve debugger</li>
<li>gopls: Go Language Server</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org339b810" class="outline-4">
<h4 id="org339b810"><span class="section-number-4">1.5.2.</span> GoLand</h4>
<div class="outline-text-4" id="text-1-5-2">
<ul class="org-ul">
<li>GoLand是Go-specific IDE,它和vscode不同,它不需要你额外下载工具来让你的IDE开始工作</li>
</ul>
</div>
</div>
<div id="outline-container-org9b9c8e2" class="outline-4">
<h4 id="org9b9c8e2"><span class="section-number-4">1.5.3.</span> The Go Playground</h4>
<div class="outline-text-4" id="text-1-5-3">
<ul class="org-ul">
<li>Go Playground是一个网站,它让你能够实验并且分享你的小段代码</li>
<li>Playground运行在google的服务器,所以不要放敏感信息在上面</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org013a601" class="outline-3">
<h3 id="org013a601"><span class="section-number-3">1.6.</span> Makefile</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>Go没有自己的自动化build工具,所以借助了Unix平台上的工具make</li>
</ul>
</div>
</div>
<div id="outline-container-org504bfde" class="outline-3">
<h3 id="org504bfde"><span class="section-number-3">1.7.</span> Staying Up to Date</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>绝大部分情况下,由于Go COmpatibility Promise的保证,升级到新代码不会break已有代码,但是Go 的最新代
码有bug的情况下,可能会break已有代码,为了保证新版本的go不会影响老的代码,我们可以在系统上安装多个
go版本</li>
<li><p>
假设你当前是使用的1.15.2版本,你想试验一下1.15.6版本会不会break你的代码,那么,可以使用如下代码来
安装一个1.18版本的go
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go install golang.org/dl/go1.18@latest
</pre>
</div></li>
<li><p>
然后go1.15.6就作为一个命令,安装到你的path里面了
</p>
<div class="org-src-container">
<pre class="src src-shell">$ which go1.18
~/go/bin/go1.18
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org247a876" class="outline-2">
<h2 id="org247a876"><span class="section-number-2">2.</span> Primitive Types and Declarations</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org44e0f2d" class="outline-3">
<h3 id="org44e0f2d"><span class="section-number-3">2.1.</span> Built-in Types</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>在了解type之前,首先介绍一些对所有type都适用的概念</li>
</ul>
</div>
<div id="outline-container-org4d5e7a7" class="outline-4">
<h4 id="org4d5e7a7"><span class="section-number-4">2.1.1.</span> The Zero Value</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>向很多现代语言一样,在go里面,声明但是没有被赋值的变量都拥有zero value</li>
</ul>
</div>
</div>
<div id="outline-container-orgbc039f3" class="outline-4">
<h4 id="orgbc039f3"><span class="section-number-4">2.1.2.</span> Literals</h4>
<div class="outline-text-4" id="text-2-1-2">
<ul class="org-ul">
<li>在Go里面literal代表直接写出数字,字符,或者string</li>
<li>在Go里面有四种常见的literal</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgd1f1d2f"></a>Integer Literal<br />
<div class="outline-text-5" id="text-2-1-2-1">
<ul class="org-ul">
<li>integer literal是一系列数字,通常情况下是base 10,但是其他的prefix可以用来表示其他的base:
<ul class="org-ul">
<li>0b表示binary</li>
<li>0o(或者仅仅是一个0,但是请不要这样使用,容易令人费解)表示octal</li>
<li>0x表示hexadecimal</li>
</ul></li>
<li>当然了prefx可以是大写也可以是小写</li>
<li>为了让阅读integer literal更加容易,Go允许你在数字之间加上underscore,比如1234可以写成1_234:
<ul class="org-ul">
<li>要求就是不能以'_'开头</li>
<li>不能连续使用两个'_'</li>
<li>你可以使用1_2_3_4这种,但是请不要使用,太令人费解了</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="orgc1dfa6b"></a>Floating point literal<br />
<div class="outline-text-5" id="text-2-1-2-2">
<ul class="org-ul">
<li>floating point literal可以使用'.'来区分小数部分</li>
<li>还可以使用科学计数法,比如6.03e23</li>
<li><p>
还可以使用0x来使用十六位的小数,同时后面加上p来表示2的几次方,这个需要一个例子来理解
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-09 22:23:14</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>0x1p3<span style="color: #d33682;">)</span>   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=&gt; (1 + 0 ) * 2^3 = 8</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>0x1.8p3<span style="color: #d33682;">)</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=&gt; (1 + 8/16) * 2^3 = 12</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="orgb66abcb"></a>Rune literal<br />
<div class="outline-text-5" id="text-2-1-2-3">
<ul class="org-ul">
<li>rune literal代表的是字符,并且是使用单引号进行围绕</li>
<li>和其他语言不一样的地方是,go的单引号和双引号不能互换</li>
<li>Rune literal可以使用如下方法书写:
<ul class="org-ul">
<li>single Unicode character: 'a'</li>
<li>8-bit octal number: '\141'</li>
<li>8-bit hexadecimal number: '\x61'</li>
<li>16-bit hexadecimal number: '\u0061'</li>
<li>32-bit Unicode number: '\U00000061'</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org15059fc"></a>String literal<br />
<div class="outline-text-5" id="text-2-1-2-4">
<ul class="org-ul">
<li>我们有两种表达string literal的方式:
<ul class="org-ul">
<li>使用双引号: "Greetings and Salutations"</li>
<li><p>
使用raw string literal: 这种情况下,可以包含换行,单引号,双引号等
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-09 22:50:34</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">`</span>
<span style="color: #2aa198;">Greetings and</span>
<span style="color: #2aa198;">"Salutations"`</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Greetings and</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">"Salutations"</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org2fce20a" class="outline-4">
<h4 id="org2fce20a"><span class="section-number-4">2.1.3.</span> Booleans</h4>
<div class="outline-text-4" id="text-2-1-3">
<ul class="org-ul">
<li>bool 类型的变量可以有两种值:
<ul class="org-ul">
<li>true</li>
<li>false</li>
</ul></li>
<li>zero value是false</li>
</ul>
</div>
</div>
<div id="outline-container-org7944b54" class="outline-4">
<h4 id="org7944b54"><span class="section-number-4">2.1.4.</span> Numeric Types</h4>
<div class="outline-text-4" id="text-2-1-4">
<ul class="org-ul">
<li>go拥有多达12种不同的numeric type,这12种分成3大类</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org651a57a"></a>Integer types<br />
<div class="outline-text-5" id="text-2-1-4-1">
<ul class="org-ul">
<li><p>
go提供有符号和没有符号两种整数,从1到4个byte
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Value range</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">int8</td>
<td class="org-left">-128 to 127</td>
</tr>

<tr>
<td class="org-left">int16</td>
<td class="org-left">-32768 to 32767</td>
</tr>

<tr>
<td class="org-left">int32</td>
<td class="org-left">-2147483648 to -2147483647</td>
</tr>

<tr>
<td class="org-left">int64</td>
<td class="org-left">-9223372036854775808 to 9223372036854775807</td>
</tr>

<tr>
<td class="org-left">uint8</td>
<td class="org-left">0 to 255</td>
</tr>

<tr>
<td class="org-left">uint16</td>
<td class="org-left">0 to 65535</td>
</tr>

<tr>
<td class="org-left">uint32</td>
<td class="org-left">0 to 4294967295</td>
</tr>

<tr>
<td class="org-left">uint64</td>
<td class="org-left">0 to 4294967295</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</li>
<li><a id="orgd8143e5"></a>The special integer types<br />
<div class="outline-text-5" id="text-2-1-4-2">
<ul class="org-ul">
<li>GO还有一些的类型,虽然不包含integer,但是其实是integer:
<ul class="org-ul">
<li>byte是uint8的别名: 这两种类型可以赋值,比较,进行数学运算</li>
<li>int在32位机器上是int32的别名,在64位机器上,是int64的别名,由于这个是根据平台来决定是32还是64的,
所以int和int32(或者int64)是不能进行赋值,比较,数学运算的.注意, integer literal默认是int type类型</li>
<li>和int类型,uint也是根据平台来决定是uint32还uint64</li>
<li>rune类型</li>
<li>uintptr类型</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="orga4b962b"></a>Choosing which integer to use<br />
<div class="outline-text-5" id="text-2-1-4-3">
<ul class="org-ul">
<li>由于有多个integer类型存在,所以我们需要以如下的准则来决定使用哪种integer:
<ul class="org-ul">
<li>如果你工作的内容是binary file format或者network protocol,那么使用对应的integer类型</li>
<li>如果你的函数需要对所有integer类型都能用,那么你需要写这么两个函数:
<ol class="org-ol">
<li>以int64为主要参数</li>
<li>以uint64为主要参数</li>
</ol></li>
<li>其他所有情况,使用int就可以了</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="orgaffb2ea"></a>Integer operators<br />
<div class="outline-text-5" id="text-2-1-4-4">
<ul class="org-ul">
<li>integer支持如下操作,并且结果也是integer:
<ul class="org-ul">
<li>`+`</li>
<li>`-`</li>
<li>`*`</li>
<li>`/`</li>
<li>`%`</li>
</ul></li>
<li>如果想获得float的结果,需要在运算之前就把int转换成float</li>
<li>integer还支持`=`和常见的五个操作联合起来:
<ul class="org-ul">
<li>`+=`</li>
<li>`-=`</li>
<li>`*=`</li>
<li>`/=`</li>
<li>`%=`</li>
</ul></li>
<li>go还支持bit维度的操作:
<ul class="org-ul">
<li>left shifit: &lt;&lt;</li>
<li>right shift: &gt;&gt;</li>
<li>bit mask logical AND: &amp;</li>
<li>bit mask logical OR: |</li>
<li>bit mask logical XOR: ^</li>
<li>bit mask AND NOT: &amp;^</li>
</ul></li>
<li>上面所有操作都可以和`=`配合起来,所以就有:
<ul class="org-ul">
<li>&lt;&lt;=</li>
<li>&gt;&gt;=</li>
<li>&amp;=</li>
<li>|=</li>
<li>^=</li>
<li>&amp;^=</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org9413b06"></a>Floating point types<br />
<div class="outline-text-5" id="text-2-1-4-5">
<ul class="org-ul">
<li>有两种浮点数类型:
<ul class="org-ul">
<li>float32</li>
<li>float64</li>
</ul></li>
<li>Float point literal 的默认类型是float64</li>
<li>如果确定使用浮点数,那么就使用float64</li>
<li>问题在于,绝大多数情况下,不要使用浮点数类型,因为浮点数类型不能把它range内的所有情况都存储下来,
所以用浮点数来存储exact decimal representation(比如钱),就会非常危险</li>
<li>只有如下两个领域使用浮点数是well understood,并且其不精确性也能领用户忍受:
<ul class="org-ul">
<li>graphics</li>
<li>scientific oprations</li>
</ul></li>
<li>浮点数不支持%操作:
<ul class="org-ul">
<li>% 一个非零浮点数得到Inf(或者-Inf)</li>
<li>% 浮点数0,得到NaN(Not a Number)</li>
</ul></li>
<li>虽然编译器不报错,但是不要使用==和!=来比较两个浮点数,两个浮点数的差别在一个很小的delta之内都算相等</li>
</ul>
</div>
</li>
<li><a id="org64b2cb2"></a>Complex types (you're probably not going to use these)<br />
<div class="outline-text-5" id="text-2-1-4-6">
<ul class="org-ul">
<li>Go对complex有first-class支持,但是我们用不到,所以跳过这一节</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org869f12f" class="outline-4">
<h4 id="org869f12f"><span class="section-number-4">2.1.5.</span> A Taste of Strings and Runes</h4>
<div class="outline-text-4" id="text-2-1-5">
<ul class="org-ul">
<li>string的zero value是空字符串</li>
<li>Go支持Unicode,我们可以把任何unicode字符串存储到go 的string类型中</li>
<li>string可以使用任何比较符号进行比较</li>
<li>go里面的string是immutable类型:
<ul class="org-ul">
<li>你可以重新赋值给string variable</li>
<li>但是你不能更改string index上的值</li>
</ul></li>
<li>String的每个single code point使用一个类型指代,这就是rune type</li>
<li>rune type是int32的alias,就像byte是uint8的alias</li>
</ul>
</div>
</div>
<div id="outline-container-org0097f66" class="outline-4">
<h4 id="org0097f66"><span class="section-number-4">2.1.6.</span> Explicit Type Conversion</h4>
<div class="outline-text-4" id="text-2-1-6">
<ul class="org-ul">
<li>大部分的编程语言都有多个numeric type的自动转换,这叫作自动类型转换(automatic type promotion)</li>
<li>虽然自动类型提升看上去很方便,但是相互之间的转换规则很复杂,并且会产生unexpected result</li>
<li>为了提升阅读性,go直接不允许automatic type promotion</li>
<li>当需要类型转换的时候,go里面必须使用type conversion,即便是长度不同的integer和长度不同的float</li>
<li>如此严格的类型要求,导致在go里面,不能把其他类型看成是boolean
<ul class="org-ul">
<li>在很多其他语言中,非零值,或者非空字符串都被看成是true</li>
</ul></li>
<li>在go语言中,必须使用如下的操作符来产生boolean值:
<ul class="org-ul">
<li>==</li>
<li>!=</li>
<li>&gt;</li>
<li>&lt;</li>
<li>&gt;=</li>
<li>&lt;=</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc0e3ff1" class="outline-3">
<h3 id="orgc0e3ff1"><span class="section-number-3">2.2.</span> var Versus :=</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>最啰嗦的创建变量的方式是:
<ul class="org-ul">
<li>使用var</li>
<li>明确类型</li>
<li>还给初始化值</li>
<li><p>
如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #b58900; font-style: italic;">int</span> = 10
</pre>
</div></li>
</ul></li>
<li><p>
类似integer literal默认的类型int,我们是可以省略的,下面和上面的代码等价
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> = 10
</pre>
</div></li>
<li><p>
如果你想保留类型,但是希望zero value初始化,那么可以写成
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #b58900; font-style: italic;">int</span>
</pre>
</div></li>
<li><p>
可以使用var同时初始化两个变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span>, <span style="color: #268bd2;">y</span> <span style="color: #b58900; font-style: italic;">int</span> = 10, 20
<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">a</span>, <span style="color: #268bd2;">b</span> <span style="color: #b58900; font-style: italic;">int</span>
</pre>
</div></li>
<li><p>
甚至可以一次初始化两个不同类型变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span>, <span style="color: #268bd2;">y</span> = 10, <span style="color: #2aa198;">"hello"</span>
</pre>
</div></li>
<li><p>
如果变量一次定义非常多个,可以使用declaration list
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">(</span>
        <span style="color: #268bd2;">x</span> <span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #268bd2;">y</span> = 20
        <span style="color: #268bd2;">z</span> <span style="color: #b58900; font-style: italic;">int</span> = 30
        <span style="color: #268bd2;">d</span>, <span style="color: #268bd2;">e</span> = 40, <span style="color: #2aa198;">"hello"</span>
        <span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">g</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>:= operator 有一个局限性:它必须在function内部,所以package level的变量就必须使用 var啦</li>
<li>那么到底使用哪种style呢?:
<ul class="org-ul">
<li>绝大部分情况下,使用 :=</li>
<li>在function外,使用declaration list来定义多个package-level 变量,这种情况并不多见</li>
</ul></li>
<li>在如下情况下,请避免使用 :=
<ul class="org-ul">
<li>如果初始化变量为zero值,那么使用var x int, 这样能让读者意识到这个是要让值初始化为zero value</li>
<li><p>
如果初始化某个变量,其literal default类型不是你想要的,那么请使用`var 变量 类型 = 值`的方式(虽然使用 := 也可以,但是不够地道)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #b58900; font-style: italic;">byte</span> = 20
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">also work way, but not idiomatic</span>
<span style="color: #268bd2;">x</span> := <span style="color: #b58900;">byte</span><span style="color: #268bd2;">(</span>20<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
由于 := 允许左边只要有一个新变量就可以了, 所以有时候你以为是使用了老的变量,其实是初始化了新的变量(如下). 这时候最好使用var先初始化所有
变量,然后使用=来赋值.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-20 18:23:52</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">_a</span> := 200

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">you thought you use existing a, actually you create one new a</span>
        <span style="color: #268bd2;">a</span>, <span style="color: #268bd2;">b</span> := 1, 2
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>_a<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>a, b<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">200</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1 2</span>
</pre>
</div></li>
</ul></li>
<li>虽然var和:=都允许你在一行一次初始化多个变量,但是请只在如下两个情况下使用:
<ul class="org-ul">
<li>从函数返回多个值的时候</li>

<li><p>
comma ok idiom: 例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-20 18:31:37</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"hello"</span>: 5,
                <span style="color: #2aa198;">"world"</span>: 0,
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">v</span>, <span style="color: #268bd2;">ok</span> := m<span style="color: #d33682;">[</span><span style="color: #2aa198;">"hello"</span><span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, ok<span style="color: #d33682;">)</span>

        v, ok = m<span style="color: #d33682;">[</span><span style="color: #2aa198;">"goodbye"</span><span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, ok<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 false</span>
</pre>
</div></li>
</ul></li>
<li><p>
你应该非常少的会在function之外(package level)来定义变量. 这些变量的值如果改变了,是非常坏的主意
</p>
<pre class="example" id="org67891a5">
Package-level variables whose values change are a bad idea
</pre></li>
<li><p>
package level的变量一旦改变的话,我们是非常难以track他的值的,这会让我们难以理解数据如何flow,所以
我们建议只在package level定义不变的变量
</p>
<pre class="example" id="orgef875e7">
As a general rule, you should only declare variables in the package
block that are effectively immutable
</pre></li>
<li>go提供了immutable value的方法,但是和其他语言有些不一样,这就是const</li>
</ul>
</div>
</div>
<div id="outline-container-orgfb160ce" class="outline-3">
<h3 id="orgfb160ce"><span class="section-number-3">2.3.</span> Using const</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>初看起来,go里面的const确实能提供immutable的作用,如下例子编译:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">x</span> <span style="color: #b58900; font-style: italic;">int64</span> = 10

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">y</span> = <span style="color: #2aa198;">"hello"</span>

        x = x + 1
        y = <span style="color: #2aa198;">"bye"</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
编译结果,不通过.错误如下
</p>
<pre class="example" id="org26ae63f">
./snippet.go:22:4: cannot assign to x (declared const)
./snippet.go:23:4: cannot assign to y (declared const)
</pre></li>
<li>我们可以看到const保证了我们的变量值不改变</li>
</ul></li>
<li><p>
但是其实go里面的const其功能非常有限,用一句话概括就是在go里面,const其实只能给literal起别名
</p>
<pre class="example" id="orgeed54a5">
Constants in Go are a way to give names to literals
</pre></li>
<li>换句话说,const只能用在`在编译器可以确定值的value(和literal的范围基本相同)`,主要就是如下几种情况:
<ul class="org-ul">
<li>Numeric literal</li>
<li>true and false</li>
<li>String</li>
<li>Rune</li>
<li>内存函数complex, real, imag, len, cap</li>
<li>包含上面所有的种类,外加operator的表达式</li>
</ul></li>
<li>由于go的const不为`在runtime为immutable的value`提供服务,所以:
<ul class="org-ul">
<li>不存在immutable array, slice, map, struct</li>
<li>也没有办法保证struct的field是immutable的</li>
</ul></li>
<li>在function内部,我们是知道某个变量是否改变的,因为我们知道他的整个生命周期.所以没有函数内部的immutable
的方法是可以忍受的.</li>
<li>另外,由于"Go Is Call By Value", 所以go的函数不会不小心改变传入函数的参数</li>
</ul>
</div>
</div>
<div id="outline-container-org3c08d72" class="outline-3">
<h3 id="org3c08d72"><span class="section-number-3">2.4.</span> Typed and Untyped Constants</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>costant也是可以有typed和untyped之分的:
<ul class="org-ul">
<li><p>
untyped const其实就是和literal一样, 是untype的:也就是有default type,但是和"相似"type可以不经
过显示转换而进行赋值或运算
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">x</span> = 10

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">y</span> <span style="color: #b58900; font-style: italic;">int</span> = x
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">z</span> <span style="color: #b58900; font-style: italic;">float64</span> = x
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">d</span> <span style="color: #b58900; font-style: italic;">byte</span> = x

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y, z, d<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10 10 10</span>
</pre>
</div></li>
<li><p>
typed const就只能和相同类型的变量进行运算了(如果不经过显示转换的话)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-24 16:16:31</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">typedX</span> <span style="color: #b58900; font-style: italic;">int</span> = 10

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">y</span> <span style="color: #b58900; font-style: italic;">int</span> = typedX
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">/////////////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">./snippet.go:24:6: cannot use typedX (type int) as type int64 in assignment //</span>
        <span style="color: #96A7A9; font-style: italic;">/////////////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">var z int64 = typedX</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org64e17c6" class="outline-3">
<h3 id="org64e17c6"><span class="section-number-3">2.5.</span> Unused Variables</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>为了能够让GO能够在大规模协作的时候起作用,Go制定了很多和其他编程语言不一样的规则:
<ul class="org-ul">
<li>使用go fmt来进行官方认证的format:这个是一个非强制的规则</li>
<li>每个声明的local variable都必须被read:这就是一个必须遵守的规则,否则编译器会报错</li>
</ul></li>
<li>编译器的检查是比较简单的:
<ul class="org-ul">
<li>只要这个变量被read过一次,就算合格</li>
<li><p>
很多情况下,一个变量可能被赋值很多次,但是只有其中一个值被读取了. 这种情况不是编译错误,但是这种
情况很可能隐含着bug. 这种隐含的bug适合使用lint来探测,比如golangci-lint
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-24 16:24:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := 10
        x = 20
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
        x = 30
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">$ golangci-lint run</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet.go:17:2: ineffectual assignment to x (ineffassign)</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">x := 10</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">^</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet.go:20:2: ineffectual assignment to x (ineffassign)</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">x = 30</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">^</span>
</pre>
</div></li>
</ul></li>
<li><p>
另外需要注意的是,编译器只检查local variable有没有被read过,对于package-level variable是否被读取
过,是不去检查的.这也是为什么我们要:"禁止使用package-level variable"
</p>
<pre class="example" id="orgb9048c0">
The Go compiler won't stop you from creating unread package-level
variables. This is one more reason why you should avoid creating
package-level variables.
</pre></li>
<li>注意,最好不要创建package-level variable,但是可以创建package-level const</li>
<li><p>
Go还会允许用户创建"没有被读取过的const",如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-24 16:40:11</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">x</span> = 10
        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">y</span> <span style="color: #b58900; font-style: italic;">int64</span> = 10
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Finish"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Finish</span>
</pre>
</div></li>
<li>之所以Go允许创建"没有被读取过的const",是因为这些const压根不会被编译到二进制文件里面.</li>
</ul>
</div>
</div>
<div id="outline-container-org5225558" class="outline-3">
<h3 id="org5225558"><span class="section-number-3">2.6.</span> Naming Variables and Constrants</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Go的变量名可以使用Unicode,但是不要这么做,这是不地道的做法</li>
<li>GO的变量名:
<ul class="org-ul">
<li>可以使用snake case(蛇形命名法,比如,index_counter),但是不推荐</li>
<li>推荐使用camel caske(驼峰命名法, 比如, indexCounter)</li>
</ul></li>
<li>在很多语言里面, const必须是全大写外加蛇形命名法(比如INDEX_COUNTER),但是由于GO里面,首字母用来判
断某个item是否在package外可见.所以Go不使用这个方案</li>
<li>一般来说,一个变量所处的scope大小,决定了其变量名的长度:
<ul class="org-ul">
<li>for loop或者if block中,会使用单个字母的变量</li>
<li>在package level命名const(或者variable,虽然不推荐,但是合法)的时候,需要起够长,够descriptive的名字</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgdbf4be9" class="outline-2">
<h2 id="orgdbf4be9"><span class="section-number-2">3.</span> Composite Types</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org618440c" class="outline-3">
<h3 id="org618440c"><span class="section-number-3">3.1.</span> Arrays-Too Rigid to Use Directly</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>go里面的数组,由于设计的原因,几乎不会被使用到.其他语言使用数组的地方,go都是使用slice来替代</li>
<li>下面的例子介绍了初始化数组的三种方式:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-24 17:31:58</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x1</span> <span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x2</span> = <span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>10, 20, 30<span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x3</span> = <span style="color: #d33682;">[</span>12<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, <span style="color: #6c71c4; font-weight: bold;">5</span>: 4, 6, <span style="color: #6c71c4; font-weight: bold;">10</span>: 100, 15<span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x4</span> = <span style="color: #d33682;">[</span>...<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>10, 20, 30<span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x1<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x2<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x3<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x4<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[0 0 0]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20 30]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 0 0 0 0 4 6 0 0 0 100 15]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20 30]</span>
</pre>
</div></li>
<li>第一种创建的x1,其初始化值都是int的zero value 0</li>
<li>第二种创建的x2,分别初始化了三个值</li>
<li>第三种创建的x3,只初始化了部分值,没有初始化的值都是0</li>
<li>第四种创建的x4,可以用初始化数字的个数来确定array的长度</li>
</ul></li>
<li>array使用[]来读取index上的内容,不能读取或写入不存在的index,否则会报编译错误</li>
<li>之前说过,在go里面,几乎不会使用array,原因在于array把他的size作为type的一部分,这导致:
<ul class="org-ul">
<li>[3]int和[4]int不是一个类型</li>
<li>不可以是用variable来specify array的size,因为这个size要在编译期确定</li>
<li>不可以转换两个size不同的array到同一个类型</li>
<li>不能写一个函数能够处理各种不同size的array</li>
</ul></li>
<li>array存在的唯一原因是为slice提供backing store</li>
</ul>
</div>
</div>
<div id="outline-container-orgde94bc8" class="outline-3">
<h3 id="orgde94bc8"><span class="section-number-3">3.2.</span> Slices</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>大多数情况下,当你需要一系列相同类型的value的时候,你需要的是slice</li>
<li>slice之所以有用,在于其length不是slice type的一部分,这就可以让我们做到:
<ul class="org-ul">
<li>一个函数来处理不同size的slice</li>
<li>我们可以增加slice的长度</li>
</ul></li>
<li><p>
slice和array的用法类似,唯一不同是不需要写size
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> = <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">{</span>10, 20, 30<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
当然也可以只设置某几个位置
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> = <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">{</span>1, <span style="color: #6c71c4; font-weight: bold;">5</span>:4, 6, <span style="color: #6c71c4; font-weight: bold;">10</span>: 100, 15<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
我们可以模拟多维slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #268bd2;">[][]</span><span style="color: #b58900; font-style: italic;">int</span>
</pre>
</div></li>
<li><p>
前面都是和array比较一致的行为,那么下面我们来看看slice和array不一致的行为,比如我们
使用var创建了一个slice(没有添加literal), 如下
</p>
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-27 08:11:20</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span>

        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"FileName:[snippet.go]=====&gt;Var:[ x ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, x<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"FileName:[snippet.go]=====&gt;Var:[ x == nil ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, x == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FileName:[snippet.go]=====&gt;Var:[ x ]=====&gt;Type:[&lt;[]int&gt;] Value:[&lt;[]&gt;]&lt;=====</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FileName:[snippet.go]=====&gt;Var:[ x == nil ]=====&gt;Type:[&lt;bool&gt;] Value:[&lt;true&gt;]&lt;=====</span>
</pre>
</div></li>
<li>这段代码创建了一个int类型的slice,但是因为没有赋值,所以这里应该是int类型slice的zero value</li>
<li>这个zero value是nil,但是注意,只有你打印`x==nil`才能发现是nil,否则展示出来还是`[]`</li>
<li>nil和前面的untyped numeric constant一样,nil是没有type的,所以它可以给任何类型赋值,也可以和任何类型比较</li>
<li>nil slice不包含任何东西</li>
<li>slice是不能比较的类型,任意两个slice的比较都是编译错误</li>
<li>但是!slice却可以和nil比较(因为nil没有类型,所以不是slice嘛)</li>
</ul>
<ul class="org-ul">
<li>在reflect package里面,you个叫做DeepEqual的函数,用来比较任意的两个同等对象,包括slice.但是这个packag推荐只在测试环境使用.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org88499d0" class="outline-4">
<h4 id="org88499d0"><span class="section-number-4">3.2.1.</span> len</h4>
<div class="outline-text-4" id="text-3-2-1">
<ul class="org-ul">
<li>go 提供了很多内置的函数来和内置的类型进行工作.len就是其中一个,len可以作用于array,同时也可以作用于slice</li>
<li>一个nil slice的len是0</li>
<li>内置函数之所以叫内置是因为:
<ul class="org-ul">
<li>它可以传入很多类型,比如len可以对array,slice,map,string起作用</li>
<li>普通用户无法自己写一个内置函数</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org54a8044" class="outline-4">
<h4 id="org54a8044"><span class="section-number-4">3.2.2.</span> append</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li><p>
内置函数append是用来增长slice的, 其返回值是新的slice,用法是把返回值再赋予之前的变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span>
x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #268bd2;">(</span>x, 10<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
append函数最少需要两个参数,其中第一个参数必须是slice,但其实append函数最多可以有无数个参数,其中
第一个参数必须是slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> = <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">{</span>1, 2, 3<span style="color: #268bd2;">}</span>
x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #268bd2;">(</span>x, 4, 5, 6<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
这种不定参数,在go里面叫variadic function parameter,模样是使用三个点,放在变量前面
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-30 23:04:24</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">sumFunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">nums</span> ...<span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">res</span> := 0
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">n</span> := <span style="color: #859900; font-weight: bold;">range</span> nums <span style="color: #d33682;">{</span>
                res += n
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> res
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #b58900;">sumFunc</span><span style="color: #d33682;">(</span>1, 2, 3, 4<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
<li><p>
sliceB想要作为参数append给sliceA,那么必须要把sliceB展开,这种展开叫做arguments to variadic
functions,模样是使用三个点,放在变量后面
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-11-30 23:10:10</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>3, 4<span style="color: #d33682;">}</span>

        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, y...<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 2 3 4]</span>
</pre>
</div></li>
<li><p>
append函数如果忘记把返回值赋予变量,那么会报编译错误.这会强制大家使用好append
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-01 09:49:32</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>3<span style="color: #d33682;">}</span>
        <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 6<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">./snippet.go:18:8: append(x, 6) evaluated but not used</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org502fa00" class="outline-4">
<h4 id="org502fa00"><span class="section-number-4">3.2.3.</span> Capacity</h4>
<div class="outline-text-4" id="text-3-2-3">
<ul class="org-ul">
<li>我们可以看到slice是一个sequence of value, slice里面的element都是放到连续的memory location里面的</li>
<li>每个slice都有一个属性叫做capacity, 这个每个slice预留的连续的内存slot的数目,因为是预留的,所以是可以大于length的</li>
<li>如果length等于了capacity,那么就放不进去了.这个时候Go runtime会申请另外一块空间,把老的数据都拷贝过去</li>
<li>这里我们遇到了go runtime这个概念,我们停下来解释一下:
<ul class="org-ul">
<li>每个高级语言,都有一系列的library来让以当前语言书写的程序能够运行,go也有类似的libaray,叫做go
runtime</li>
<li>go runtime提供了如下的服务:
<ol class="org-ol">
<li>内存分配</li>
<li>垃圾回收</li>
<li>并发支持</li>
<li>网络</li>
<li>内置的类型和函数</li>
</ol></li>
<li>go runtime是和每个go代码编译在一起的(都在二进制文件里面),这个是和其他的使用虚拟机语言不通,那
些语言必须另外安装迅疾才能让程序运行</li>
<li>把runtime包裹在二进制文件里面,能够让go程序更容易的分发,并且避免runtime和程序之间的兼容问题</li>
</ul></li>
<li>由于slice通过append的增长需要go runtime先分配内存在拷贝已有数据,很浪费时间,所以runtime申请capacity
的时候,每次会申请多一点:
<ul class="org-ul">
<li>1024个之前,每次申请,capacity翻倍</li>
<li>1024个之后,每次申请,capacity增加25%</li>
<li><p>
我们可以通过例子直观感受一下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 19:37:23</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 10<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 20<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 30<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 40<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 50<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[] 0 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10] 1 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20] 2 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20 30] 3 4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20 30 40] 4 4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10 20 30 40 50] 5 8</span>
</pre>
</div></li>
<li>我们可以看到,每次capacity不够用的时候,都会触发一次申请内存和拷贝原有内容.那么我们会思考,如果
我知道最终会放多少的内容到slice厘米,我能最开始的时候就设置capacity么?答案是可以的,使用我们下
一节介绍的make</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org48e12c6" class="outline-4">
<h4 id="org48e12c6"><span class="section-number-4">3.2.4.</span> make</h4>
<div class="outline-text-4" id="text-3-2-4">
<ul class="org-ul">
<li>我们可以使用slice literal或者nil zero value(通过var)</li>
<li>但是这两者都不能标识新创建的slice的length和capacity,而make是可以完成上述任务的.</li>
<li>make有好几种用法,需要挨个说明,因为非常容易用错:
<ul class="org-ul">
<li><p>
创建五个值为0的slice, capacity没有设置,默认和length一样,都是五.注意这种创建方式创建出来的五个
成员都是有值的,值是0
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 19:58:42</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 5<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[0 0 0 0 0]</span>
</pre>
</div></li>

<li><p>
初学者常犯的错误,就是初始化length之后,马上赋予一个值,这样的话,我们的slice会立刻进行一次内存申
请和数据拷贝
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 20:01:19</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 5<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 10<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[0 0 0 0 0] 5 5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[0 0 0 0 0 10] 6 10</span>
</pre>
</div></li>
<li><p>
上面的例子,其实使用者本意是想申请一个slice,然后第一个成员为10,其实正确的做法是给make第三个参
数来确认capacity,同时把第二个参数length设置为0,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 20:03:57</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 0, 5<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 10<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[] 0 5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[10] 1 5</span>
</pre>
</div></li>
<li>注意make种capacity的值要大于等于length的值,否则程序会panic</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgea14c00" class="outline-4">
<h4 id="orgea14c00"><span class="section-number-4">3.2.5.</span> Declaring Your Slice</h4>
<div class="outline-text-4" id="text-3-2-5">
<ul class="org-ul">
<li>既然slice有多种初始化方式,那么我们应该如何取舍呢?</li>
<li><p>
如果是创建一个不会grow的slice,那么我们就创建一个nil slice(注意,nil slice和nil比较是true的)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 20:20:16</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">data</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>data, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>data == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        data = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>data, 1<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>data, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[] 0 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1] 1 1</span>
</pre>
</div></li>
<li><p>
还有的情况,你要创建一个zero-length slice,注意,这个slice也是没有成员的,length为0, 但是其不是nil的,
和nil比较为false,zero-length slice只有在把slice转换成json的时候会用到
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 20:21:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> = <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 1<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[] 0 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1] 1 1</span>
</pre>
</div></li>
<li><p>
如果你的slice有一些初始化值,或者你的slice不怎么改动,那么使用slice literal是非常好的选择
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-22 20:23:13</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">data</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>2, 4, 6, 8<span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>data<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 4 6 8]</span>
</pre>
</div></li>
<li>如果你知道你的slice会有多大,但是在创建的时候,不知道成员是什么,那么显然你要使用make(因为可以传入capacity),
剩下的问题,就是你到底要不要创建zero length的slice:
<ol class="org-ol">
<li>make, specified length, specified capacity: 这种情况使用index来设置value.这种情况的缺点是如
果size错误了,那么在slice后半部分会多出来很多0或者是panic了,因为你访问了一个不再的index</li>
<li>make, 0 length, specified capacity: 这种情况下,如果预想的数据比这少,那么不会在后半部分剩下0,
如果预想数据多也不会panic</li>
</ol></li>
<li>通常推荐大家使用第二种,也就是make的第二个参数length设置为0</li>
</ul>
</div>
</div>
<div id="outline-container-org50143de" class="outline-4">
<h4 id="org50143de"><span class="section-number-4">3.2.6.</span> Slicing Slices</h4>
<div class="outline-text-4" id="text-3-2-6">
<ul class="org-ul">
<li>slice expression (也就是[start:end]) 会从slice创建新的slice:
<ul class="org-ul">
<li>`:`左边是start, `:`右边是end</li>
<li><p>
左边的start是include,右边的end的exclud
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 20:28:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>1:3<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 3]</span>
</pre>
</div></li>
<li><p>
如果左边的start不给,那么默认是0
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 20:27:07</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 2]</span>
</pre>
</div></li>
<li><p>
如果右边的end不给,那么默认是end
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 20:27:50</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>1:<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 3 4 5]</span>
</pre>
</div></li>
<li><p>
如果左右都不给,那么是一个新的slice,注意,虽然地址不一样,但是因为slice是reference类型,所以只是
新的指针不一样,指向的内容还是一样的(下面会讲到slice 共享内存)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 20:01:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x address is %p\n"</span>, &amp;x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y address is %p\n"</span>, &amp;y<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, y<span style="color: #d33682;">)</span>
        y<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]</span> = 100
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, y<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x address is 0x1400000c030</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y address is 0x1400000c048</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 2 3 4 5] [1 2 3 4 5]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 100 3 4 5] [1 100 3 4 5]</span>
</pre>
</div></li>
</ul></li>
<li><p>
slice一个slice最让人意想不到的地方是:这些slice共享内存. slice是reference类型再这里再次彰显
</p>
<pre class="example" id="orgf1f182c">
When you take a slice from a slice, you are not making a copy of the data.
Instead, you now have two variables that are sharing memory.
</pre></li>
<li><p>
这也就意味着一个slice的内容改变,所有slice的内容都会改变.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 21:02:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">z</span> := x<span style="color: #d33682;">[</span>1:<span style="color: #d33682;">]</span>
        x<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]</span> = 20
        y<span style="color: #d33682;">[</span>0<span style="color: #d33682;">]</span> = 10
        z<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]</span> = 30
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x"</span>, x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x [10 20 30 4 5]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [10 20]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [20 30 4 5]</span>
</pre>
</div></li>
<li>如果和append结合起来,那么情况就会更加复杂
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 21:18:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 0, 5<span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 1, 2, 3, 4<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">z</span> := x<span style="color: #d33682;">[</span>2:<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>y<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>z<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        y = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>y, 30, 40, 50<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y<span style="color: #d33682;">)</span>
        x = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>x, 60<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x"</span>, x<span style="color: #d33682;">)</span>
        z = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>z, 70<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 5 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [1 2 30 40 50]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x [1 2 30 40 60]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [30 40 70]</span>
</pre>
</div></li>
<li>我们可以看到,slice操作得到新的slice之后,新的slice的capcity等于:之前的capcity减去新slice的start
这也就意味着,所有的原来slice的unused capacity也要共享</li>
<li>上面的例子告诉我们,如果用了普通的slice,那么不要使用append和普通的slice一起使用</li>
<li><p>
slice有一种变体叫做full slice expression,它可以和append一起使用,full slice expression原理,是
限定新的slice的capacity最多到哪个position
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 21:31:48</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2:2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">z</span> := x<span style="color: #d33682;">[</span>2:4:4<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"cap(y)"</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>y<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"cap(z)"</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>z<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [1 2]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">cap(y) 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [3 4]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">cap(z) 2</span>
</pre>
</div></li>
<li>如果full slice expression要和append公用,可以把full slice expression的第三个参数设置为新slice
的最后一个position. 这有两点好处:
<ol class="org-ol">
<li>如果新的slice没有被再次append,那么可以继续和老的slice share memory</li>
<li><p>
如果新的slice真的被append了,那么会触发go runtime创建新的内存地址拷贝老的内容到新的地址,也
就不会和之前的slice共享内存了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-23 21:37:36</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2:2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">z</span> := x<span style="color: #d33682;">[</span>2:4:4<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x,y,z"</span>, x, y, z<span style="color: #d33682;">)</span>

        y = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>y, 50<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after append 50 to y"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x,y,z"</span>, x, y, z<span style="color: #d33682;">)</span>

        z = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>z, 60<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after append 60 to z"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x,y,z"</span>, x, y, z<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x,y,z [1 2 3 4 5] [1 2] [3 4]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after append 50 to y</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x,y,z [1 2 3 4 5] [1 2 50] [3 4]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after append 60 to z</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x,y,z [1 2 3 4 5] [1 2 50] [3 4 60]</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgba9c36a" class="outline-4">
<h4 id="orgba9c36a"><span class="section-number-4">3.2.7.</span> Converting Arrays to Slices</h4>
<div class="outline-text-4" id="text-3-2-7">
<ul class="org-ul">
<li><p>
我们也可以在数组上面进行slice expression操作,这个操作即便是作用在数组上面,依然会share same memory
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 19:04:08</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[</span>4<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>5, 6, 7, 8<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := x<span style="color: #d33682;">[</span>:2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">z</span> := x<span style="color: #d33682;">[</span>2:<span style="color: #d33682;">]</span>
        x<span style="color: #d33682;">[</span>0<span style="color: #d33682;">]</span> = 10
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"x"</span>, x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x [10 6 7 8]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [10 6]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [7 8]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4f596f7" class="outline-4">
<h4 id="org4f596f7"><span class="section-number-4">3.2.8.</span> copy</h4>
<div class="outline-text-4" id="text-3-2-8">
<ul class="org-ul">
<li>前面的slice expression会share memory, 如果不想share memory,那么就要使用copy内置函数
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 19:12:14</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 3<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y, <span style="color: #2aa198;">"cap(y)"</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>y<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"After copy"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">num</span> := <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>y, x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"y"</span>, y<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"num"</span>, num<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">z</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 4, 10<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z, <span style="color: #2aa198;">"cap(z)"</span>, <span style="color: #d33682; font-style: italic;">cap</span><span style="color: #859900;">(</span>z<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"After copy"</span><span style="color: #d33682;">)</span>
        num = <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>z, x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"z"</span>, z<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"num"</span>, num<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [0 0 0] cap(y) 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">After copy</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">y [1 2 3]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">num 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [0 0 0 0] cap(z) 10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">After copy</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z [1 2 3 4]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">num 4</span>
</pre>
</div></li>
<li>copy有两个参数,第一个参数是dest,第二个参数是src</li>
<li>copy会尽可能的从src拷贝数据到dest(只有dest length的部分才能分配的到, capacity不会作为参考)</li>
</ul></li>
<li>copy的使用非常的灵活:
<ul class="org-ul">
<li><p>
我们可以从src中间拷贝一部分到dest, 不关心拷贝了多少,可以不保留copy的返回值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 19:29:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 2<span style="color: #d33682;">)</span>
        <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>y, x<span style="color: #859900;">[</span>2:<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[3 4]</span>
</pre>
</div></li>
<li><p>
我们的src和dest还可以是同一个slice
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 19:31:19</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">num</span> := <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>x<span style="color: #859900;">[</span>:3<span style="color: #859900;">]</span>, x<span style="color: #859900;">[</span>1:<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x, num<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 3 4 4] 3</span>
</pre>
</div></li>
<li><p>
由于copy不在乎capacity,所以copy的src和dest都可以是slice expression数组后得到的slice(使用`[:]`)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 20:02:33</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">x</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3, 4, 5<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">d</span> := <span style="color: #d33682;">[</span>5<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>5, 6, 7, 8, 9<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">y</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 2<span style="color: #d33682;">)</span>
        <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>y, d<span style="color: #859900;">[</span>:<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>y<span style="color: #d33682;">)</span>
        <span style="color: #d33682; font-style: italic;">copy</span><span style="color: #d33682;">(</span>d<span style="color: #859900;">[</span>:<span style="color: #859900;">]</span>, x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>d<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[5 6]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[1 2 3 4 5]</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2d5d41a" class="outline-3">
<h3 id="org2d5d41a"><span class="section-number-3">3.3.</span> Strings and Runes and Bytes</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>一种比较常见的误解是认为string是由rune组成的.这种误区的来源于:
<ul class="org-ul">
<li>for-loop是以rune为单位的</li>
<li>很多go的library function是以rune为单位的</li>
</ul></li>
<li>但是,这其实是不对的,在go里面string其实是由byte组成的(由于Go默认使用UTF-8,所以这种byte默认是使用UTF-8
解析的,除非你另外指定)</li>
<li><p>
如果把string看成是一个slice,就像你可以从一个slice(array)里面获取一个value一样,你可以从string里面获取一个byte
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-25 21:44:08</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"Hello World"</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">b</span> <span style="color: #b58900; font-style: italic;">byte</span> = s<span style="color: #d33682;">[</span>6<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">W</span>
</pre>
</div></li>
<li><p>
如果把string看成是一个slice,当然也可以对使用使用slice expression
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 19:18:21</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"Hello there"</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s2</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>4:7<span style="color: #d33682;">]</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s3</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>:5<span style="color: #d33682;">]</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s4</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>6:<span style="color: #d33682;">]</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s5</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>:<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s2<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s3<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s4<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s5<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">o t</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">there</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello there</span>
</pre>
</div></li>
<li>string可以看做是一个slice,但是string是一个immutable的slice,所以:
<ul class="org-ul">
<li><p>
slice expression得到的新string更改不了,也就影响不到之前的string
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 19:27:27</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"hello world"</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s2</span> = s<span style="color: #d33682;">[</span>2:5<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"s"</span>, s<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"s2"</span>, s2<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">//  </span><span style="color: #96A7A9; font-style: italic;">cannot assign to s2[0] (value of type byte)</span>
        <span style="color: #96A7A9; font-style: italic;">/////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">s2[0] = "H" //</span>
        <span style="color: #96A7A9; font-style: italic;">/////////////////</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"-&gt; s2 is now point to another memory address"</span><span style="color: #d33682;">)</span>
        s2 = <span style="color: #2aa198;">"now"</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"s"</span>, s<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"s2"</span>, s2<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">s hello world</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">s2 llo</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-&gt; s2 is now point to another memory address</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">s hello world</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">s2 now</span>
</pre>
</div></li>
<li><p>
但是有新的问题,因为string可以看做是byte的slice,所以我们可以从任意的位置来访问byte,但是UTF-8的
code point却不一定是每个位置(因为utf-8有1到4个byte的可能),所以使用slice expression获取的新string
可能是invalid的,比如
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 19:31:25</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"Hello &#20013;&#22269;"</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s2</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>4:7<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s2<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s3</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>4:8<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s4</span> <span style="color: #b58900; font-style: italic;">string</span> = s<span style="color: #d33682;">[</span>4:9<span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s4<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">o \344</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">o \344\270</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">o &#20013;</span>
</pre>
</div></li>
</ul></li>
<li><p>
string可以看做是一个slice,其len的结果自然是byte的长度,而不是code point的长度
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 19:40:35</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"Hello &#20013;&#22269;"</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>s<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12</span>
</pre>
</div></li>
<li><p>
之前我们讲过go存在一个int32的alias类型rune type(uint8的alias类型是byte type),这个rune类型就可以
用来存储utf-8字符(unicode是ascii,比如'z'的超集)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 19:49:52</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">rune</span> = <span style="color: #2aa198;">'&#20013;'</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">string</span><span style="color: #859900;">(</span>r<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">r2</span> <span style="color: #b58900; font-style: italic;">rune</span> = <span style="color: #2aa198;">'z'</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">string</span><span style="color: #859900;">(</span>r2<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">cannot use '&#20013;' (untyped rune constant 20013) as byte value in variable declaration (overflows)</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">var b byte = '&#20013;' //</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">b2</span> <span style="color: #b58900; font-style: italic;">byte</span> = <span style="color: #2aa198;">'z'</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b2<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&#20013;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z</span>
</pre>
</div></li>
<li>由于string和如下两种类型如此紧密的联系,以至于他们三者之间变化可以相互转换
<ul class="org-ul">
<li>byte(uint8的alias)</li>
<li>rune(int32的alias)</li>
</ul></li>
<li><p>
当然,转换也必须是explicit的,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-27 21:42:05</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span> = <span style="color: #2aa198;">"Hello &#20013;&#22269;"</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">bs</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">byte</span> = <span style="color: #d33682;">[]</span><span style="color: #b58900;">byte</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">rs</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">rune</span> = <span style="color: #d33682;">[]</span><span style="color: #b58900;">rune</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>bs<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>rs<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[72 101 108 108 111 32 228 184 173 229 155 189]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[72 101 108 108 111 32 20013 22269]</span>
</pre>
</div></li>
<li>注意,对string来说:
<ul class="org-ul">
<li>我们不要使用slice expression或者index expression</li>
<li>我们要使用的是strings, unicode/utf8 package里面的function</li>
</ul></li>
<li>对于string来说,for loop是使用的code point,我们下一章会进行介绍</li>
</ul>
</div>
</div>
<div id="outline-container-orga26cc23" class="outline-3">
<h3 id="orga26cc23"><span class="section-number-3">3.4.</span> Maps</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>当你的数据是sequantial data的时候,slice对你很重要,但是你需要key-value数据的时候,就不能用slice了
每个语言都有自己的key-value容器.go的选择是map type</li>
<li>使用var可以创建一个nil map,此时map的nil值为nil(说明map和slice一样,是reference type)
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 14:45:21</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">nilMap</span> <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>nilMap == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>nilMap<span style="color: #859900;">[</span><span style="color: #2aa198;">"hello"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">panic: assignment to entry in nil map</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">nilMap["hello"] = 1        //</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
</pre>
</div></li>
<li>nil map的length为0</li>
<li>读取nil map总会返回相应类型的zero value</li>
<li>尝试写入nil map会报panic</li>
</ul></li>
<li><p>
使用 `:=` 创建的不再是nil map,而是empty map, 虽然两者length都是0,但是由于empty map被分配了内存
地址,所以其是可以写入的(读取当然更可以了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 14:49:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">totalWins</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>

        totalWins<span style="color: #d33682;">[</span><span style="color: #2aa198;">"hello"</span><span style="color: #d33682;">]</span> = 1
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>totalWins<span style="color: #859900;">[</span><span style="color: #2aa198;">"hello"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
</pre>
</div></li>
<li><p>
我们可以使用map literal在初始化的时候,就给map赋一些值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 14:51:05</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">teams</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">][]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"Orcas"</span>:   <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"Fred"</span>, <span style="color: #2aa198;">"Ralph"</span>, <span style="color: #2aa198;">"Bijou"</span><span style="color: #859900;">}</span>,
                <span style="color: #2aa198;">"Lions"</span>:   <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"Sarah"</span>, <span style="color: #2aa198;">"Peter"</span>, <span style="color: #2aa198;">"Billie"</span><span style="color: #859900;">}</span>,
                <span style="color: #2aa198;">"Kittens"</span>: <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"Waldo"</span>, <span style="color: #2aa198;">"Raul"</span>, <span style="color: #2aa198;">"Ze"</span><span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>teams<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[Kittens:[Waldo Raul Ze] Lions:[Sarah Peter Billie] Orcas:[Fred Ralph Bijou]]</span>
</pre>
</div></li>
<li><p>
如果你预先知道map的长度,也可以使用make创建一个capacity为N的map,但是这个N是可以超过的,换句话说,
这个N只不过是开始创建map的时候申请的内存地址,不够了可以再换(当然了,效率会低一点)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 14:54:22</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">ages</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">map</span><span style="color: #859900;">[</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #859900;">]</span><span style="color: #b58900; font-style: italic;">int</span>, 2<span style="color: #d33682;">)</span>
        ages<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]</span> = 11
        ages<span style="color: #d33682;">[</span>2<span style="color: #d33682;">]</span> = 22
        ages<span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span> = 33

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>ages<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[1:11 2:22 3:33]</span>
</pre>
</div></li>
<li>map和slice在很多地方上,都是类似的,比如:
<ul class="org-ul">
<li>map会随着你增加key-value而自动增加, slice会随着append自动增加</li>
<li>如果知道最终的数量,在申请map的make里面可以加上capacity, slice也一样,不过slice的第三个参数是capacity</li>
<li>map和slice都可使用len来进行长度计算</li>
<li>map和slice的zero value都是nil</li>
<li>map之间(以及slice之间),是没有办法比较的,换句话说不能使用 `==` 或者 `!=` 来比较两个map(或者slice),
但是map和slice是可以和nil使用`==`或者`!=`和nil进行比较的</li>
</ul></li>
<li>map的key value必须是可以比较的两种类型,这样就意味着:slice(或者map)不能作为key value</li>
<li>map中的key是没有顺序的(哈希表的原理导致),slice中的数据都是有顺序的</li>
</ul>
</div>
<div id="outline-container-orgfd0cf0f" class="outline-4">
<h4 id="orgfd0cf0f"><span class="section-number-4">3.4.1.</span> Reading and Writing a Map</h4>
<div class="outline-text-4" id="text-3-4-1">
<ul class="org-ul">
<li>下面的例子给我们来介绍一下如何读取map
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 16:45:36</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">totalWins</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>
        totalWins<span style="color: #d33682;">[</span><span style="color: #2aa198;">"Orcas"</span><span style="color: #d33682;">]</span> = 1
        totalWins<span style="color: #d33682;">[</span><span style="color: #2aa198;">"Lions"</span><span style="color: #d33682;">]</span> = 2
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>totalWins<span style="color: #859900;">[</span><span style="color: #2aa198;">"Orcas"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>totalWins<span style="color: #859900;">[</span><span style="color: #2aa198;">"Kittens"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        totalWins<span style="color: #d33682;">[</span><span style="color: #2aa198;">"Kittens"</span><span style="color: #d33682;">]</span>++
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>totalWins<span style="color: #859900;">[</span><span style="color: #2aa198;">"Kittens"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        totalWins<span style="color: #d33682;">[</span><span style="color: #2aa198;">"Linos"</span><span style="color: #d33682;">]</span> = 3
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>totalWins<span style="color: #859900;">[</span><span style="color: #2aa198;">"Linos"</span><span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
</pre>
</div></li>
<li>我们可以看到assign value使用的是`=` 而不是`:=`</li>
<li>如果读取一个没有存在的key,那么返回zero value</li>
<li>我们甚至可以使用`++`来提升一个value,即便这个key不存在都会直接设置成zero value然后increase</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb9539e4" class="outline-4">
<h4 id="orgb9539e4"><span class="section-number-4">3.4.2.</span> The comma ok idiom</h4>
<div class="outline-text-4" id="text-3-4-2">
<ul class="org-ul">
<li>map在没有key的情况下返回zero value,那如果用户真的写入的值就是zero value怎么办呢?
<ul class="org-ul">
<li>go给出的方案就是comma ok ldiom</li>
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 17:13:57</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"hello"</span>: 5,
                <span style="color: #2aa198;">"world"</span>: 0,
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">v</span>, <span style="color: #268bd2;">ok</span> := m<span style="color: #d33682;">[</span><span style="color: #2aa198;">"hello"</span><span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, ok<span style="color: #d33682;">)</span>

        v, ok = m<span style="color: #d33682;">[</span><span style="color: #2aa198;">"world"</span><span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, ok<span style="color: #d33682;">)</span>

        v, ok = m<span style="color: #d33682;">[</span><span style="color: #2aa198;">"goodbye"</span><span style="color: #d33682;">]</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, ok<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 false</span>
</pre>
</div></li>
<li>返回两个值,第一个是value type的值,第二个是bool,如果第二个是true的情况下,第一个值才有意义</li>
</ul></li>
<li>comma ok ldiom还用在如下两个方面:
<ul class="org-ul">
<li>type assertion</li>
<li>从channel读取数据</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc637023" class="outline-4">
<h4 id="orgc637023"><span class="section-number-4">3.4.3.</span> Deleting from Maps</h4>
<div class="outline-text-4" id="text-3-4-3">
<ul class="org-ul">
<li>我们使用delete函数来从map里面删除某个key-value组合
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 17:16:53</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"hello"</span>: 5,
                <span style="color: #2aa198;">"world"</span>: 10,
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m<span style="color: #d33682;">)</span>
        <span style="color: #d33682; font-style: italic;">delete</span><span style="color: #d33682;">(</span>m, <span style="color: #2aa198;">"hello"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m<span style="color: #d33682;">)</span>
        <span style="color: #d33682; font-style: italic;">delete</span><span style="color: #d33682;">(</span>m, <span style="color: #2aa198;">"not-exist-key"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">m2</span> <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">string</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m2 == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

        <span style="color: #d33682; font-style: italic;">delete</span><span style="color: #d33682;">(</span>m2, <span style="color: #2aa198;">"some-key"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[hello:5 world:10]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[world:10]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
</pre>
</div></li>
<li>如果key不存在,不会发生任何事情</li>
<li>如果map是nil,也不会发生任何事情</li>
<li>delete没有返回值</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge780096" class="outline-4">
<h4 id="orge780096"><span class="section-number-4">3.4.4.</span> Using Maps as Sets</h4>
<div class="outline-text-4" id="text-3-4-4">
<ul class="org-ul">
<li>go没有专门为set设计一个类型,只需要把map的value type设置成bool就是一个set了(当然了是没有set的union,
intersection操作的,如果需要这些操作请使用第三方库)
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 17:25:49</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">intSet</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">bool</span><span style="color: #d33682;">{}</span>
        <span style="color: #268bd2;">vals</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>5, 10, 2, 5, 8, 7, 3, 9, 1, 2, 10<span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> vals <span style="color: #d33682;">{</span>
                intSet<span style="color: #859900;">[</span>v<span style="color: #859900;">]</span> = <span style="color: #6c71c4; font-weight: bold;">true</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>vals<span style="color: #859900;">)</span>, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>intSet<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>intSet<span style="color: #859900;">[</span>5<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>intSet<span style="color: #859900;">[</span>500<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> intSet<span style="color: #d33682;">[</span>100<span style="color: #d33682;">]</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"100 is in the set"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">11 8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgedb0d74" class="outline-3">
<h3 id="orgedb0d74"><span class="section-number-3">3.5.</span> Structs</h3>
<div class="outline-text-3" id="text-3-5">
<ul class="org-ul">
<li>map只能存储类型一样的数据,如果想存储不一样类型但是有逻辑联系的数据,那么我们需要struct
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        name <span style="color: #b58900; font-style: italic;">string</span>
        age <span style="color: #b58900; font-style: italic;">int</span>
        pet <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>struct 类型有两个关键字type在前,struct在后</li>
<li>`{}`里面是成员,也是名字在前,类型在后</li>
<li>struct类型可以定义在function外,也可以定义在function内部.定义在function内部的只能被function所访问</li>
</ul></li>
<li>之前map和slice的var和:=初始化的结果是不一样的,但是在struct这里,如下两种初始化结果是一样的,都是所
有的field都设置为0:
<ul class="org-ul">
<li><p>
使用var
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">fred</span> <span style="color: #b58900; font-style: italic;">person</span>
</pre>
</div></li>
<li><p>
使用:=
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">bob</span> := <span style="color: #b58900; font-style: italic;">person</span><span style="color: #268bd2;">{}</span>
</pre>
</div></li>
</ul></li>
<li>初始化如果有内容,可以使用如下两种方法(两种方法不能混用):
<ul class="org-ul">
<li><p>
把所有初始化值按照顺序罗列:不推荐因为以后struct可能会发生变化
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">julia</span> := <span style="color: #b58900; font-style: italic;">person</span><span style="color: #268bd2;">{</span>
        <span style="color: #2aa198;">"Julia"</span>,
        40,
        <span style="color: #2aa198;">"cat"</span>,
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
罗列value的时候,还加上key. 没有设置的key,value就是zero值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">beth</span> := person <span style="color: #268bd2;">{</span>
        <span style="color: #6c71c4; font-weight: bold;">age</span>: 30,
        <span style="color: #6c71c4; font-weight: bold;">name</span>: <span style="color: #2aa198;">"Beth"</span>,
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li><p>
我们使用dottted notation来读取field
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 19:04:41</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
                age  <span style="color: #b58900; font-style: italic;">int</span>
                pet  <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">bob</span> := <span style="color: #b58900; font-style: italic;">person</span><span style="color: #d33682;">{}</span>
        bob.name = <span style="color: #2aa198;">"Bob"</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>bob.name<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Bob</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-org335022c" class="outline-4">
<h4 id="org335022c"><span class="section-number-4">3.5.1.</span> Anoymous Structs</h4>
<div class="outline-text-4" id="text-3-5-1">
<ul class="org-ul">
<li>我们刚才说struct创建的时候有两个关键字,type在前,struct再后. type在前其实就是为了给struct一个名
字.</li>
<li>如果我们的struct只使用一次(只给一个变量实例化),那么我们可以不给这个struct取名字(因为取名字还挺
麻烦的),那么我们可以使用anonymous struct</li>
<li>所谓anonymous struct,就是只用struct在后,而没有type+类型名字这一部分.有两种创建方法:
<ul class="org-ul">
<li><p>
使用var
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 19:30:30</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">p1</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
                age  <span style="color: #b58900; font-style: italic;">int</span>
                pet  <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        p1.name = <span style="color: #2aa198;">"bob"</span>
        p1.age = 50
        p1.pet = <span style="color: #2aa198;">"dog"</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>p1<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{bob 50 dog}</span>
</pre>
</div></li>
<li><p>
使用`:=`
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:00:34</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">pet</span> := <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
                kind <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}{</span>
                <span style="color: #6c71c4; font-weight: bold;">name</span>: <span style="color: #2aa198;">"Fido"</span>,
                <span style="color: #6c71c4; font-weight: bold;">kind</span>: <span style="color: #2aa198;">"dog"</span>,
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>pet<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Fido dog}</span>
</pre>
</div></li>
</ul></li>
<li>匿名struct在如下两种情况下比较有用:
<ul class="org-ul">
<li>marshaling(把struct转换成external data), 或者unmarshaling(把external data转换成struct). 这里
的external data最常见的类型是json</li>
<li>在写测试用例的时候,会用到匿名struct</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgad3da88" class="outline-4">
<h4 id="orgad3da88"><span class="section-number-4">3.5.2.</span> Comparing and Converting Structs</h4>
<div class="outline-text-4" id="text-3-5-2">
<ul class="org-ul">
<li>一个struct是否是可比较的类型,要看这个struct的所有field是不是都是可比较的.如果有一个filed是不可比较
的类型(比如map或者slice),那么整个struct都是不可比较的类型</li>
<li><p>
一个可比较的struct的两个instance之间是可以使用 `==` 或者 `!=` 来进行比较的.但是一个不可比较类型
的struct的两个instance之间的比较是不成功的(报编译错误)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:12:42</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">firstPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f1</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"alice"</span><span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f2</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"bob"</span><span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f3</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"alice"</span><span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f1 == f2<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f1 == f3<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">secondPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name  <span style="color: #b58900; font-style: italic;">string</span>
                age   <span style="color: #b58900; font-style: italic;">int</span>
                extra <span style="color: #859900; font-weight: bold;">map</span><span style="color: #859900;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">]</span><span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f4</span> := <span style="color: #b58900; font-style: italic;">secondPerson</span><span style="color: #d33682;">{</span><span style="color: #6c71c4; font-weight: bold;">name</span>: <span style="color: #2aa198;">"carl"</span>, <span style="color: #6c71c4; font-weight: bold;">age</span>: 30<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f5</span> := <span style="color: #b58900; font-style: italic;">secondPerson</span><span style="color: #d33682;">{</span><span style="color: #6c71c4; font-weight: bold;">name</span>: <span style="color: #2aa198;">"david"</span>, <span style="color: #6c71c4; font-weight: bold;">age</span>: 31<span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f4, f5<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">invalid operation: f4 == f5 (struct containing map[string]string cannot be compared)</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(f4 == f5) //</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{carl 30 map[]} {david 31 map[]}</span>
</pre>
</div></li>
<li><p>
用户自己创建的struct可以看做是一个类型,就像go不允许不同primitive type的两个instance进行比较一样,
我们也不允许两个不同struct的instance进行比较
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:34:30</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">a1</span> <span style="color: #b58900; font-style: italic;">int16</span> = 1
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">a2</span> <span style="color: #b58900; font-style: italic;">int32</span> = 2

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>a1, a2<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">invalid operation: a1 == a2 (mismatched types int16 and int32)</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(a1 == a2) //</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">firstPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f1</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"alice"</span><span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">secondPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f2</span> := <span style="color: #b58900; font-style: italic;">secondPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"bob"</span><span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f1, f2<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">invalid operation: f1 == f2 (mismatched types firstPerson and secondPerson)</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(f1 == f2) //</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{alice} {bob}</span>
</pre>
</div></li>
<li>如果实在希望比较两个不同struct的instance,那么我们要进行type conversion,能进行type conversion的
前提要求是这两个struct的field拥有:
<ul class="org-ul">
<li>same name</li>
<li>same order</li>
<li>same type</li>
</ul></li>
<li><p>
两个struct类型的type conversion后边比较的例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:38:36</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">firstPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f1</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"alice"</span><span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">secondPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f2</span> := <span style="color: #b58900; font-style: italic;">secondPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"alice"</span><span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f2Convert</span> := <span style="color: #b58900;">firstPerson</span><span style="color: #d33682;">(</span>f2<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f1, f2, f2Convert<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f1 == f2Convert<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{alice} {alice} {alice}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
</pre>
</div></li>
<li>匿名struct这里有一个优势:它可以减少一次type conversion, 换句话说就是匿名struct的名字可以认为是
和任意的struct的名字相同.</li>
<li>如果两个struct中有一个struct是匿名的,又假设两个struct的filed有same name, same order, same type,那么
我们可以直接:
<ul class="org-ul">
<li><p>
比较两者
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:44:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">firstPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"Alice"</span><span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">g</span> := <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}{</span>
                <span style="color: #2aa198;">"Alice"</span>,
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">h</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f, g, h<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f == g<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f == h<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>g == h<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Alice} {Alice} {}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
</pre>
</div></li>
<li><p>
给两者进行赋值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-28 20:47:24</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">firstPerson</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f</span> := <span style="color: #b58900; font-style: italic;">firstPerson</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"Alice"</span><span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">g</span> := <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}{</span>
                <span style="color: #2aa198;">"Bob"</span>,
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">h</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                name <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f, g, h<span style="color: #d33682;">)</span>

        h = f
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>h<span style="color: #d33682;">)</span>
        f = g
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Alice} {Bob} {}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Alice}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Bob}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org2ad1b8e" class="outline-2">
<h2 id="org2ad1b8e"><span class="section-number-2">4.</span> Blocks, Shadows, and Control Structures</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgdc34513" class="outline-3">
<h3 id="orgdc34513"><span class="section-number-3">4.1.</span> Blocks</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>go允许你在很多地方声明变量,比如:
<ul class="org-ul">
<li>在function外</li>
<li>作为function的参数</li>
<li>在function内部</li>
</ul></li>
<li>每个声明变量的地方都叫做block</li>
<li>所有定义在function外的变量(还有类型,常量,函数等)叫做定义在package block</li>
<li>前面我们使用import来获取一些帮助函数(比如print),我们import的这些name存在于file block</li>
<li>如果你在一个inner block里面,你可以访问outer block里面的identifier,这就引申出一个问题:
<ul class="org-ul">
<li>如果在outer block里面定义了identifer A, 在inner block里面也定义了一个identifer A,那么inner的
identifer A会shadow outer block里面的identifer A</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgaac1aed" class="outline-4">
<h4 id="orgaac1aed"><span class="section-number-4">4.1.1.</span> Shadowing Variables</h4>
<div class="outline-text-4" id="text-4-1-1">
<ul class="org-ul">
<li>我们以一个例子来讲解shadowing
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 16:38:27</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10
        <span style="color: #859900; font-weight: bold;">if</span> x &gt; 5 <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>
                <span style="color: #268bd2;">x</span> := 5
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>x<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
<li>在outer block的x叫做shadowed variable, 在inner block的叫做shadowing variable.一旦shadowing存
在,那么你在shadowing variable所在的block,永远无法访问shadowed variable</li>
</ul></li>
<li>在使用 `:=` 的情况下,很容易触发shadowing,这是因为 `:=` 左边只需要有一个新的变量就可以了,另外的
可能是已经创建的变量,这样这个变量就有可能会被shadow.
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 17:13:28</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10
        <span style="color: #859900; font-weight: bold;">if</span> x &gt; 5 <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">x</span>, <span style="color: #268bd2;">y</span> := 5, 20
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>x, y<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
</ul></li>

<li>local定义的变量还会shadow package level的name,比如下面的例子
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 17:14:42</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println undefined (type string has no field or method Println)</span>
        <span style="color: #96A7A9; font-style: italic;">/////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt := "oops"           //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(fmt)        //</span>
        <span style="color: #96A7A9; font-style: italic;">/////////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org71e34f5" class="outline-4">
<h4 id="org71e34f5"><span class="section-number-4">4.1.2.</span> Detecting Shadowed Variables</h4>
<div class="outline-text-4" id="text-4-1-2">
<ul class="org-ul">
<li>我们可以使用一个shadow linter工具来detect shadow
<ul class="org-ul">
<li><p>
首先安装,注意是安装二进制工具,而不是在go.mod下面安装library
</p>
<div class="org-src-container">
<pre class="src src-shell">go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow@latest
</pre>
</div></li>
<li><p>
使用方法
</p>
<div class="org-src-container">
<pre class="src src-shell">shadow ./...
/Users/fenghaoran/go/src/playground/at-2022-12-29-171328/snippet.go:22:3: declaration of <span style="color: #2aa198;">"x"</span> shadows declaration at line 20
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>



<div id="outline-container-org240d336" class="outline-3">
<h3 id="org240d336"><span class="section-number-3">4.2.</span> if</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>go的if和其他语言的用法差距不大,只有两个差距:
<ul class="org-ul">
<li>一个是if后面没有括号包围expression</li>
<li><p>
二个是在if statement 定义的变量在 else statement也能使用(这个很多语言都不支持)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 17:35:12</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"math/rand"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">n</span> := rand.<span style="color: #b58900;">Intn</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span>; n == 0 <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's too low"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> n &gt; 5 <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's too big:"</span>, n<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's a good number:"</span>, n<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">undefined: n</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(n) //</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">That's a good number: 1</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgdd62929" class="outline-3">
<h3 id="orgdd62929"><span class="section-number-3">4.3.</span> for, Four Ways</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>go语言的for提供了更加广泛的用处,有如下四种用法:
<ul class="org-ul">
<li>c-style的for</li>
<li>只有condition的for(类似其他语言的while)</li>
<li>无线循环for</li>
<li>for-range</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org09436a1" class="outline-4">
<h4 id="org09436a1"><span class="section-number-4">4.3.1.</span> The Complete for Statement</h4>
<div class="outline-text-4" id="text-4-3-1">
<ul class="org-ul">
<li><p>
这种for是和其他c-style语言的for没有太大区别的,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 19:46:18</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 10; i++ <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">6</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">7</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">9</span>
</pre>
</div></li>
<li>要说区别也有几个:
<ul class="org-ul">
<li>是不需要括号的</li>
<li>初始化的时候必须使用 `:=`, 而不能使用var</li>
<li>for内部申请的变量可能会shadow for语句中的变量</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9dcd92c" class="outline-4">
<h4 id="org9dcd92c"><span class="section-number-4">4.3.2.</span> The Condition-Only for Statement</h4>
<div class="outline-text-4" id="text-4-3-2">
<ul class="org-ul">
<li>go里面的for可以去掉initialization和increment阶段,直接运行第三个condition判断</li>
<li><p>
这种用法就和其他语言的while很像了,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 19:48:07</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">i</span> := 1
        <span style="color: #859900; font-weight: bold;">for</span> i &lt; 100 <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
                i = i * 2
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">16</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">32</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">64</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgeb8a1c8" class="outline-4">
<h4 id="orgeb8a1c8"><span class="section-number-4">4.3.3.</span> The Infinite for Statement</h4>
<div class="outline-text-4" id="text-4-3-3">
<ul class="org-ul">
<li><p>
for如果后面没有condition,那么就会永远loop
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 19:49:54</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Hello"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">...</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org7aed433" class="outline-4">
<h4 id="org7aed433"><span class="section-number-4">4.3.4.</span> break and continue</h4>
<div class="outline-text-4" id="text-4-3-4">
<ul class="org-ul">
<li>想要从永远for-loop中退出需要关键字break</li>
<li>如果是想结束当前循环进入下一次循环,那么使用continue</li>
</ul>
</div>
</div>
<div id="outline-container-org2e300cd" class="outline-4">
<h4 id="org2e300cd"><span class="section-number-4">4.3.5.</span> The for-range Statement</h4>
<div class="outline-text-4" id="text-4-3-5">
<ul class="org-ul">
<li>go里面还有模仿其他语言iterator特性的for-range</li>
<li>但是go只有如下内置的类型能够和谐的扮演iterator特性,所以只有如下类型(或者在如下类型基础上创建的
用户类型)才能使用for-range:
<ul class="org-ul">
<li>string</li>
<li>slice</li>
<li>array</li>
<li>map</li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgcb89b81"></a>Iterating over slices<br />
<div class="outline-text-5" id="text-4-3-5-1">
<ul class="org-ul">
<li>slice是经常使用for-loop的场景
<ul class="org-ul">
<li>for-loop slice例子如下</li>
<li>两个返回值:
<ol class="org-ol">
<li>第一个是index,通常使用i来做简称</li>
<li>第二个是value,通常使用v来做简称</li>
</ol></li>
</ul></li>
<li><p>
如果我们队index不感兴趣,需要把index的变量设置为`_`
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-29 20:22:56</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">evenVals</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>2, 4, 6, 8, 10, 12<span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> evenVals <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">6</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12</span>
</pre>
</div></li>
<li><p>
还有一种可能是你只想要index,不想要value.虽然这种情况在slice身上非常少见,但是也是支持的.只需要
处理一个返回值就可以了,不需要把第二个返回值设置成`_`(虽然这么写也行,某些lint会报错)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 11:54:43</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">evenVals</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>2, 4, 6, 8, 10, 12<span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> evenVals <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">should omit 2nd value from range; this loop is equivalent to `for i := range ...` (go-golint)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">_</span> := <span style="color: #859900; font-weight: bold;">range</span> evenVals <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
</pre>
</div></li>
<li>后面我们学到channel的时候,会发现channel也用for-range loop,但是只有一个返回值</li>
</ul>
</div>
</li>
<li><a id="orgce25b30"></a>Iterating over maps<br />
<div class="outline-text-5" id="text-4-3-5-2">
<ul class="org-ul">
<li><p>
loop的时候只需要index,不需要value的slice是不太合理的.但是loop的时候只需要key,不需要value的map
还是合理的(特别是把map当set用的时候).如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 12:05:11</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">uniqueNames</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">bool</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"Fred"</span>: <span style="color: #6c71c4; font-weight: bold;">true</span>, <span style="color: #2aa198;">"Raul"</span>: <span style="color: #6c71c4; font-weight: bold;">true</span>, <span style="color: #2aa198;">"Wilma"</span>: <span style="color: #6c71c4; font-weight: bold;">true</span><span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">k</span> := <span style="color: #859900; font-weight: bold;">range</span> uniqueNames <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>k<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Raul</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Wilma</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Fred</span>
</pre>
</div></li>
<li>map的for-range还有个特别的地方,就是每次for-range loop得到的key value的顺序不一样
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 12:11:40</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"a"</span>: 1,
                <span style="color: #2aa198;">"b"</span>: 2,
                <span style="color: #2aa198;">"c"</span>: 3,
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 3; i++ <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Loop"</span>, i<span style="color: #859900;">)</span>

                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">k</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> m <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>k, v<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Loop 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">b 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">c 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Loop 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">b 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">c 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Loop 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">b 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">c 3</span>
</pre>
</div></li>
<li>我们看到第一次和后面两次的顺序不一样.但是之前老的go版本是每次打印同样顺序的(每次哈希也是同
样位置),这样引入了两个问题
<ol class="org-ol">
<li>for-range会按照写入的顺序在loop的时候打印出来,会被用户作为一个已知特性.其实这是不对的,因
为我们知道哈希表是不保证顺序的</li>
<li>每次hash某个字符串都是到某个特定的位置(也就是哈希算法不变,也不加随机盐),结果就是不怀好意的
攻击者可以疯狂的创建某些key,都hash到某个位置,造成整个server反应非常慢,这个较多Hash DoS</li>
</ol></li>
<li>新版本的go的结果是随机的.原因自然是解决上面的问题. 为了解决上面的问题,go采用了双保险:
<ol class="org-ol">
<li>hash的时候,引入了随机盐,这样同一个key也会被hash到不同的位置</li>
<li>for-range loop的时候再进行一些order的转换</li>
</ol></li>
<li><p>
需要指出的是,如果使用fmt.Println输出整个map,每次顺序一样:都是按照key的升序
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 17:10:15</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>
                <span style="color: #2aa198;">"a"</span>: 1,
                <span style="color: #2aa198;">"c"</span>: 3,
                <span style="color: #2aa198;">"b"</span>: 2,
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 3; i++ <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>m<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[a:1 b:2 c:3]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[a:1 b:2 c:3]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[a:1 b:2 c:3]</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org1b621b6"></a>Iterating over strings<br />
<div class="outline-text-5" id="text-4-3-5-3">
<ul class="org-ul">
<li>string也可以作为for-range的对象,但是和使用index访问不同,for-range会把string分解成index和rune类型:
<ul class="org-ul">
<li><p>
如果没有unicode,那么看起来和普通循环没有不同(不过value类型还是rune)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 19:59:25</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">"hello"</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">r</span> := <span style="color: #859900; font-weight: bold;">range</span> s <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"%T,%[1]v  %T,%[2]v,%s\n"</span>, i, r, <span style="color: #b58900;">string</span><span style="color: #6c71c4;">(</span>r<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,0  int32,104,h</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,1  int32,101,e</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,2  int32,108,l</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,3  int32,108,l</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,4  int32,111,o</span>
</pre>
</div></li>
<li><p>
如果有unicode,那么你会看到index会跳过某些位置. 因为index是根据byte类型来的.unicode一次会占用
多个index
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 20:22:45</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">"hello_&#20013;&#22269;!"</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">r</span> := <span style="color: #859900; font-weight: bold;">range</span> s <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"%T,%[1]v  %T,%[2]v,%s\n"</span>, i, r, <span style="color: #b58900;">string</span><span style="color: #6c71c4;">(</span>r<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,0  int32,104,h</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,1  int32,101,e</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,2  int32,108,l</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,3  int32,108,l</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,4  int32,111,o</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,5  int32,95,_</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,6  int32,20013,&#20013;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,9  int32,22269,&#22269;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int,12  int32,33,!</span>
</pre>
</div></li>
</ul></li>
<li>注意,如果for-range的时候遇到的一个unicode不是一个合法的UTF-8值,会返回一个replacement character(hex
value 0xfffd)</li>
</ul>
</div>
</li>
<li><a id="orgd8f057e"></a>The for-range value is a copy<br />
<div class="outline-text-5" id="text-4-3-5-4">
<ul class="org-ul">
<li><p>
for-range loop每次循环都会copy一个数据从compound type到value里面,更改这个value不会更改compund
type
</p>
<pre class="example" id="org80c08b9">
Modifying the value variable will nt modify the value in the compound type
</pre></li>
<li><p>
下面的例子也验证了这一点
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 20:28:37</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">evenVals</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>2, 4, 6, 8, 10<span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> evenVals <span style="color: #d33682;">{</span>
                v *= 2
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>evenVals<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">16</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 4 6 8 10]</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org0efc453" class="outline-4">
<h4 id="org0efc453"><span class="section-number-4">4.3.6.</span> Labeling Your for Statemetns</h4>
<div class="outline-text-4" id="text-4-3-6">
<ul class="org-ul">
<li>默认情况下,break和continue都是作用在和他们最近的一层循环里面</li>
<li>如果你在很多层循环里面,但是你的break想作用在非最近的一层循环,那么你需要label特性
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-12-30 20:46:22</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">samples</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"hello"</span>, <span style="color: #2aa198;">"apple"</span><span style="color: #d33682;">}</span>
<span style="color: #6c71c4; font-weight: bold;">outer</span>:
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">sample</span> := <span style="color: #859900; font-weight: bold;">range</span> samples <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">r</span> := <span style="color: #859900; font-weight: bold;">range</span> sample <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>i, r, <span style="color: #b58900;">string</span><span style="color: #35a69c;">(</span>r<span style="color: #35a69c;">)</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">if</span> r == <span style="color: #2aa198;">'l'</span> <span style="color: #6c71c4;">{</span>
                                <span style="color: #859900; font-weight: bold;">continue</span> <span style="color: #6c71c4; font-weight: bold;">outer</span>
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">()</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 104 h</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1 101 e</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2 108 l</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 97 a</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1 112 p</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2 112 p</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3 108 l</span>
</pre>
</div></li>
<li>我们遇到单词l之后,就不再打印当前单词了,直接打印下一个单词.所以普通continue不够,我们要直接
continue到前面的label outer那里</li>
<li>我们可以看到go fmt把outer给格式化到和main函数的括号在同一列了.这是为了显著.所有的label都会和
当前block的括号在同一列</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org44123b3" class="outline-4">
<h4 id="org44123b3"><span class="section-number-4">4.3.7.</span> Choosing the Right for Statement</h4>
<div class="outline-text-4" id="text-4-3-7">
<ul class="org-ul">
<li>绝大部分情况下,首选使用for-range</li>
<li>使用for-loop的情况有如下:
<ul class="org-ul">
<li>并不从第一个到最后一个元素都访问的情况下,使用for-loop更合理</li>
<li>替代while的时候</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgccad8d2" class="outline-3">
<h3 id="orgccad8d2"><span class="section-number-3">4.4.</span> switch</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>c-like语言都有switch,但是其他语言的Switch普遍有问题(比如不是自动结束), go更改了这些问题,让switch
更加实用:
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-03 18:37:26</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">words</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"a"</span>, <span style="color: #2aa198;">"cow"</span>, <span style="color: #2aa198;">"smile"</span>, <span style="color: #2aa198;">"gopher"</span>, <span style="color: #2aa198;">"octopus"</span>, <span style="color: #2aa198;">"anthropologist"</span><span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">word</span> := <span style="color: #859900; font-weight: bold;">range</span> words <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #268bd2;">size</span> := <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>word<span style="color: #859900;">)</span>; size <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">case</span> 1, 2, 3, 4:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is a short word!"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900; font-weight: bold;">case</span> 5:
                        <span style="color: #268bd2;">wordLen</span> := <span style="color: #d33682; font-style: italic;">len</span><span style="color: #6c71c4;">(</span>word<span style="color: #6c71c4;">)</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is exactly the right length:"</span>, wordLen<span style="color: #6c71c4;">)</span>
                <span style="color: #859900; font-weight: bold;">case</span> 6, 7, 8, 9:
                <span style="color: #859900; font-weight: bold;">default</span>:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is a long word!"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a is a short word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">cow is a short word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">smile is exactly the right length: 5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">anthropologist is a long word!</span>
</pre>
</div></li>
<li>我们的swith后面也是不跟括号的</li>
<li>和if statement一样,你可以在switch后面定义变量,并且这个变量在所有的branch的scope里面(也就是size这个变量)</li>
<li>所有的case在一个大的括号里面</li>
<li>每个case的内容可以是多行</li>
<li>我们再case 5里面新创建了一个变量wordLen,由于这是一个新的block,所以wordLen只能在这个block里面被看到</li>
<li>go的switch branch里面不需要break,自动break</li>
<li>如果多个情景共享一系列logic,那么写到同一行,比如case 1, 2, 3</li>
<li>还有就是go switch里面的empty case就是什么都不做,比如6,7,8,9那个case</li>
</ul></li>
<li><p>
实际上,为了能够达到其他c-like语言的用法,go也准备了关键字fallthrough(但是一般不要使用,巨大部分情
况下使用了fallthrough是因为你的代码逻辑有问题),其效果如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-03 20:18:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">words</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"a"</span>, <span style="color: #2aa198;">"cow"</span>, <span style="color: #2aa198;">"smile"</span>, <span style="color: #2aa198;">"gopher"</span>, <span style="color: #2aa198;">"octopus"</span>, <span style="color: #2aa198;">"anthropologist"</span><span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">word</span> := <span style="color: #859900; font-weight: bold;">range</span> words <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #268bd2;">size</span> := <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>word<span style="color: #859900;">)</span>; size <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">case</span> 1:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is a short word!"</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">fallthrough</span>
                <span style="color: #859900; font-weight: bold;">case</span> 5:
                        <span style="color: #268bd2;">wordLen</span> := <span style="color: #d33682; font-style: italic;">len</span><span style="color: #6c71c4;">(</span>word<span style="color: #6c71c4;">)</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is exactly the right length:"</span>, wordLen<span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">fallthrough</span>
                <span style="color: #859900; font-weight: bold;">default</span>:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>word, <span style="color: #2aa198;">"is a long word!"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a is a short word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a is exactly the right length: 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">a is a long word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">cow is a long word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">smile is exactly the right length: 5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">smile is a long word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">gopher is a long word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">octopus is a long word!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">anthropologist is a long word!</span>
</pre>
</div></li>
<li>上面的例子都是比较的integer类型,其实所有可以使用`==`比较的类型都可以放在switch后面</li>
<li>虽然每个case之间不再使用break,但是某个case想提前退出还是需要一个break的.</li>
<li><p>
还有一种情况,是switch里面包含在一个for循环里面,但是我们不想break当前的switch,我们想break外面的for
那这个时候前面讲的label就起作用啦,我们可以在for那里label一下,退出的时候,就退出label啦
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-03 20:38:35</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
<span style="color: #6c71c4; font-weight: bold;">loop</span>:
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 10; i++ <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">case</span> i%2 == 0:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>i, <span style="color: #2aa198;">"is even"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900; font-weight: bold;">case</span> i%3 == 0:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>i, <span style="color: #2aa198;">"is divisible by 3 but not 2"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900; font-weight: bold;">case</span> i%7 == 0:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"exit the loop!"</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">break</span> <span style="color: #6c71c4; font-weight: bold;">loop</span>
                <span style="color: #859900; font-weight: bold;">default</span>:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>i, <span style="color: #2aa198;">"is boring"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 is even</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1 is boring</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2 is even</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3 is divisible by 3 but not 2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4 is even</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 is boring</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">6 is even</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">exit the loop!</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge9fd331" class="outline-3">
<h3 id="orge9fd331"><span class="section-number-3">4.5.</span> Blank Switches</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li>switch还有更加灵活的用法,那就是不确定switch什么,而让每个case自己去决定.换句话说,就是如下两个例子等价:
<ul class="org-ul">
<li><p>
常规switch
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">switch</span> a <span style="color: #268bd2;">{</span>
<span style="color: #859900; font-weight: bold;">case</span> 2:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 2"</span><span style="color: #d33682;">)</span>

<span style="color: #859900; font-weight: bold;">case</span> 3:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 3"</span><span style="color: #d33682;">)</span>

<span style="color: #859900; font-weight: bold;">case</span> 4:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 4"</span><span style="color: #d33682;">)</span>

<span style="color: #6c71c4; font-weight: bold;">defalt</span>:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is "</span>, a<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
black switch(只是为了演示等价性,其实不是一个好例子)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">switch</span>  <span style="color: #268bd2;">{</span>
<span style="color: #859900; font-weight: bold;">case</span> a == 2:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 2"</span><span style="color: #d33682;">)</span>

<span style="color: #859900; font-weight: bold;">case</span> a == 3:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 3"</span><span style="color: #d33682;">)</span>

<span style="color: #859900; font-weight: bold;">case</span> a == 4:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is 4"</span><span style="color: #d33682;">)</span>

<span style="color: #6c71c4; font-weight: bold;">defalt</span>:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"a is "</span>, a<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf73b016" class="outline-3">
<h3 id="orgf73b016"><span class="section-number-3">4.6.</span> Choosing Between if and switch</h3>
<div class="outline-text-3" id="text-4-6">
<ul class="org-ul">
<li>blank switch的存在,让switch其实和if-else拥有完全相同的能力.那么在go里面也就存在一个问题:何时使用
blank switch,何时使用if-else:
<ul class="org-ul">
<li>答案是,当你的case都有相互关系的情况下</li>
<li><p>
比如下面的例子,所有的比较都是针对n
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-03 21:01:56</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"math/rand"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #268bd2;">n</span> := rand.<span style="color: #b58900;">Intn</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span>; <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> n == 0:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's too low"</span><span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">case</span> n &gt; 5:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's too big:"</span>, n<span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">default</span>:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"That's a good number"</span>, n<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">That's a good number 1</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org1a22a24" class="outline-3">
<h3 id="org1a22a24"><span class="section-number-3">4.7.</span> goto&#x2013;Yes, goto</h3>
<div class="outline-text-3" id="text-4-7">
<ul class="org-ul">
<li>在编程语言界,goto就是害群之马的代名词,不到万不得已不要使用goto</li>
<li>go里面包含了goto,但是仅有非常非常少的情况下会用到goto
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-03 21:22:48</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"math/rand"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">a</span> := rand.<span style="color: #b58900;">Intn</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> a &lt; 100 <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> a%5 == 0 <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">goto</span> <span style="color: #6c71c4; font-weight: bold;">done</span>
                <span style="color: #859900;">}</span>
                a = a*2 + 1
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"do something when the loop completes normally"</span><span style="color: #d33682;">)</span>
<span style="color: #6c71c4; font-weight: bold;">done</span>:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"do complicated stuff no matter why we left the loop"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>a<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">do complicated stuff no matter why we left the loop</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">15</span>
</pre>
</div></li>
<li>上面这种情况就goto使用的场景:有些情况下,我们不想让"中间的逻辑"运行,但是我们想让"最后的逻辑"运
行,于是,我们就使用goto</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8e5620b" class="outline-2">
<h2 id="org8e5620b"><span class="section-number-2">5.</span> Functions</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org987329c" class="outline-3">
<h3 id="org987329c"><span class="section-number-3">5.1.</span> Declaring and Calling Functions</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Go和C,Python,JS一样,都是拥有first-class function的语言</li>
<li>Go为function添加了很多的特性,但是有些特性是实验性质的,引入后效果不好,应该予以避免</li>
<li><p>
下面是一个function的例子
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">div</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">numerator</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">denominator</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> denominator == 0 <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> 0
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> numerator / denominator
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>一个函数声明包含四个部分:
<ul class="org-ul">
<li>keyword func</li>
<li>函数的名字</li>
<li>函数的参数</li>
<li>返回值类型</li>
</ul></li>
<li>go函数也是使用return关键字来返回</li>
<li><p>
如果一个函数没有input parameter那么使用empty parenthese就可以,如果没有返回值,那么可以省略掉函数
声明的第四部分:main函数就是这样一个没有参数,也没有返回值的函数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">result</span> := <span style="color: #b58900;">div</span><span style="color: #d33682;">(</span>5, 2<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>result<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-orgc979842" class="outline-4">
<h4 id="orgc979842"><span class="section-number-4">5.1.1.</span> Simulating Named and Optional Parameters</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>在讲Go函数的特性之前,我们先在这里提一下Go函数没有的特性:named and optional input parameter</li>
<li>由于在Go里面没有这个特性,我们先看看在其他语言里面的named and optional input parameter 是什么样
子,我们以Python为例:
<ul class="org-ul">
<li><p>
所谓named parameter,就是在call function 的时候,除了参数值,同时把参数名也写进去,这样的话,参数
顺序可以颠倒
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">display</span><span style="color: #268bd2;">(</span>a, b, c<span style="color: #268bd2;">)</span>:
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[a] ==&gt;"""</span>, a<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[b] ==&gt;"""</span>, b<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[c] ==&gt;"""</span>, c<span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    display<span style="color: #268bd2;">(</span>1, 2, 3<span style="color: #268bd2;">)</span>
    display<span style="color: #268bd2;">(</span>b=3, a=2, c=1<span style="color: #268bd2;">)</span>


<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[a] ==&gt; 1</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[b] ==&gt; 2</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[c] ==&gt; 3</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[a] ==&gt; 2</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[b] ==&gt; 3</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[c] ==&gt; 1</span>
</pre>
</div></li>
<li><p>
所谓optional parameter,就是在call function的时候不给足参数数目,省略的参数由创建的时候指的的
default值来代替.还可以同时使用named input parameter,给定某些参数(而不是后面的参数)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">display</span><span style="color: #268bd2;">(</span>a=1, b=2, c=3<span style="color: #268bd2;">)</span>:
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[a] ==&gt;"""</span>, a<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[b] ==&gt;"""</span>, b<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[c] ==&gt;"""</span>, c<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"--------------"</span><span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    display<span style="color: #268bd2;">(</span>5<span style="color: #268bd2;">)</span>
    display<span style="color: #268bd2;">(</span>c=5<span style="color: #268bd2;">)</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[a] ==&gt; 5</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[b] ==&gt; 2</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[c] ==&gt; 3</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">--------------</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[a] ==&gt; 1</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[b] ==&gt; 2</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[c] ==&gt; 5</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">--------------</span>
</pre>
</div></li>
</ul></li>
<li>在Go里面,除了一个特例(variadic input),其他所有的情况下,函数调用的时候,必须把所有的参数都填满</li>
<li>如果实在想模拟named and optional parameter,我们可以使用如下的方法:
<ul class="org-ul">
<li>定义一个struct,里面填满函数所需要的所有的参数</li>
<li>调用的时候,可以选择初始化部分struct,没有初始化的就zero值</li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-10 19:45:37</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MyFuncOpts</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        FirstName <span style="color: #b58900; font-style: italic;">string</span>
        LastName  <span style="color: #b58900; font-style: italic;">string</span>
        Age       <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">MyFunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">opts</span> <span style="color: #b58900; font-style: italic;">MyFuncOpts</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"FirstName:"</span>, opts.FirstName<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"LastName:"</span>, opts.LastName<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Age:"</span>, opts.Age<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #b58900;">MyFunc</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">MyFuncOpts</span><span style="color: #859900;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">LastName</span>: <span style="color: #2aa198;">"Patel"</span>,
                <span style="color: #6c71c4; font-weight: bold;">Age</span>:      50,
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>
        <span style="color: #b58900;">MyFunc</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">MyFuncOpts</span><span style="color: #859900;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">FirstName</span>: <span style="color: #2aa198;">"Joe"</span>,
                <span style="color: #6c71c4; font-weight: bold;">LastName</span>:  <span style="color: #2aa198;">"Patel"</span>,
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FirstName:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">LastName: Patel</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Age: 50</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FirstName: Joe</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">LastName: Patel</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Age: 0</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9934028" class="outline-4">
<h4 id="org9934028"><span class="section-number-4">5.1.2.</span> Variadic Input Parameters and Dlices</h4>
<div class="outline-text-4" id="text-5-1-2">
<ul class="org-ul">
<li><p>
我们使用fmt.Println的时候可以使用任意数量的参数,原因就是fmt.Println使用了可变参数(variadic
input parameter),其源代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Println formats using the default formats for its operands and writes to standard output.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Spaces are always added between operands and a newline is appended.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">It returns the number of bytes written and any write error encountered.</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Println</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> ...<span style="color: #b58900; font-style: italic;">any</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">n</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">Fprintln</span><span style="color: #d33682;">(</span>os.Stdout, a...<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>可变参数的要求有两个:
<ul class="org-ul">
<li>在type前面使用`&#x2026;`</li>
<li>必须是最后一个参数(所以一个函数最多只能有一个可变参数)</li>
</ul></li>
<li>使用的时候,就把可变参数当做一个slice即可.</li>
<li><p>
我们可以把slice类型延展开,传递给variadic input parameter,注意,这种情况下是把`&#x2026;`放到变量后面,
学名叫做Arguments to variadic functions
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-10 19:58:30</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">addTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">base</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">vals</span> ...<span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">out</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">int</span>, 0, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>vals<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> vals <span style="color: #d33682;">{</span>
                out = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #859900;">(</span>out, base+v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> out
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">addTo</span><span style="color: #859900;">(</span>10, 5, 6, 7<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">sl</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3<span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">addTo</span><span style="color: #859900;">(</span>10, sl...<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[15 16 17]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[11 12 13]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org113254a" class="outline-4">
<h4 id="org113254a"><span class="section-number-4">5.1.3.</span> Multiple Return Values</h4>
<div class="outline-text-4" id="text-5-1-3">
<ul class="org-ul">
<li>Go和其他语言特别不一样的地方在于: Go允许返回多个返回值:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">divAndRemainder</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">numerator</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">denominator</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> denominator == 0 <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> 0, 0, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cannot divided by zero"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> numerator /denominator, numerator % denominator, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>一旦使用多个返回值,在函数声明的地方,多个返回值要放在一个括号里面</li>
<li>但是在函数内部返回的时候,却是直接return a, b, c没有在a,b,c前后加括号</li>
<li>按照惯例,error都是作为最后一个参数</li>
<li><p>
调用的时候,需要把每个参数都赋值到对应参数,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">result</span>, <span style="color: #268bd2;">remainder</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">divAndRemainder</span><span style="color: #d33682;">(</span>5, 2<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
                os.<span style="color: #b58900;">Exit</span><span style="color: #859900;">(</span>1<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>result, remainder<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgea797e1" class="outline-4">
<h4 id="orgea797e1"><span class="section-number-4">5.1.4.</span> Multiple Return Values Are Multiple Values</h4>
<div class="outline-text-4" id="text-5-1-4">
<ul class="org-ul">
<li>go的多返回值和python多返回值不一样的地方在:
<ul class="org-ul">
<li><p>
python的返回值其实是一个tuple,你可以把返回值(多个的情况)赋予一个变量,这个变量就是一个tuple,也
可以赋值给多个变量,如下
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">div_and_remainder</span><span style="color: #268bd2;">(</span>n, d<span style="color: #268bd2;">)</span>:
    <span style="color: #859900; font-weight: bold;">if</span> d == 0:
        <span style="color: #859900; font-weight: bold;">raise</span> <span style="color: #b58900; font-style: italic;">Exception</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"cannot divide by zero"</span><span style="color: #268bd2;">)</span>
    <span style="color: #859900; font-weight: bold;">return</span> n / d, n % d


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    v = div_and_remainder<span style="color: #268bd2;">(</span>5, 2<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[v] ==&gt;"""</span>, v<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">result</span>, <span style="color: #268bd2;">remainder</span> = div_and_remainder<span style="color: #268bd2;">(</span>5, 2<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[result] ==&gt;"""</span>, result<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[remainder] ==&gt;"""</span>, remainder<span style="color: #268bd2;">)</span>


<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[v] ==&gt; (2.5, 1)</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[result] ==&gt; 2.5</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[remainder] ==&gt; 1</span>
</pre>
</div></li>
<li>go的返回值是真的多个返回值,你不能把返回值(多个的情况)赋予一个变量(编译会报错),需要赋予多个变量</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgded40fa" class="outline-4">
<h4 id="orgded40fa"><span class="section-number-4">5.1.5.</span> Ignoring Returned Values</h4>
<div class="outline-text-4" id="text-5-1-5">
<ul class="org-ul">
<li>Go 不允许有未使用的变量,所以一旦接收函数返回值,那么就必须全部接收,不想使用的用`_`来占位</li>
<li><p>
Go 虽然不允许有未使用的变量,但是却可以选择忽略所有返回值(因为忽略全部的话,就不会创建变量),其实
我们一直在使用这个特性,比如fmt.Println其实是有两个返回值的,但是我们从来不去处理他们,都是全部忽略
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Println formats using the default formats for its operands and writes to standard output.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Spaces are always added between operands and a newline is appended.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">It returns the number of bytes written and any write error encountered.</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Println</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> ...<span style="color: #b58900; font-style: italic;">any</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">n</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">Fprintln</span><span style="color: #d33682;">(</span>os.Stdout, a...<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgeaaeb10" class="outline-4">
<h4 id="orgeaaeb10"><span class="section-number-4">5.1.6.</span> Named Return Values</h4>
<div class="outline-text-4" id="text-5-1-6">
<ul class="org-ul">
<li>除了可以返回多个返回值,go另外一个和其他语言最大的不同是可以给返回值设置name:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">divAndRemainder</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">numerator</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">denominator</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">result</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">remainder</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> denominator == 0 <span style="color: #d33682;">{</span>
                err = errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cannot divide by zero"</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">return</span> result, remainder, err
        <span style="color: #d33682;">}</span>
        result, remainder = numerator/denominator, numerator%denominator

        <span style="color: #859900; font-weight: bold;">return</span> result, remainder, err
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>一旦给返回值都设置name了,那么必须得用括号括起来(即便只有一个返回值)</li>
<li>named return value会被初始化城zero value</li>
</ul></li>
<li>绝大部分情况下不要使用named return value,因为存在变量shadow的问题.只有一种情况下必须要使用named
return value,我们会在defer部分介绍</li>
</ul>
</div>
</div>
<div id="outline-container-org19c8493" class="outline-4">
<h4 id="org19c8493"><span class="section-number-4">5.1.7.</span> Blank Returns - Never Use These !</h4>
<div class="outline-text-4" id="text-5-1-7">
<ul class="org-ul">
<li>如果你使用了named return value,那么go还提供了延伸的特性,那就是:blank return
<ul class="org-ul">
<li>所谓blank return,就是在返回的时候,直接写一个return. 然后所有的named return value最后得到的值就直接返回了</li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">divAndReminder</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">numerator</span>, <span style="color: #268bd2;">denominator</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">result</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">remainder</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> denominator == 0 <span style="color: #d33682;">{</span>
                err = errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cannot divide by zero"</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">return</span>
        <span style="color: #d33682;">}</span>
        result, remainder = numerator /denominator, numerator % denominator
        <span style="color: #859900; font-weight: bold;">return</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
注意这个特性不要使用, 这是go里面设计的最不好的一个特性
</p>
<pre class="example" id="org3f92f34">
If your function returns values, never use a blank return. It can
make it very confusing to figure out what value is actually returned.
</pre></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgdd8fbbe" class="outline-3">
<h3 id="orgdd8fbbe"><span class="section-number-3">5.2.</span> Functions Are Values</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>和很多其他语言一样,在go里面function也是value</li>
<li>function的type来自于三个个部分:
<ul class="org-ul">
<li>keyword func</li>
<li>参数的type</li>
<li>返回值的type</li>
</ul></li>
<li>上面这三个部分,也叫function的signature.</li>
<li>两个函数如果拥有相同数目,相同类型的参数和相同数目,相同类型的返回值,那么我们认为两个函数meet the type signature</li>
<li><p>
把function设置成为value,能让我们做一些聪明的操作.比如下面的例子中把函数做为map的value
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-12 22:25:59</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"strconv"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">add</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">j</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span> <span style="color: #859900; font-weight: bold;">return</span> i + j <span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">sub</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">j</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span> <span style="color: #859900; font-weight: bold;">return</span> i - j <span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">mul</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">j</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span> <span style="color: #859900; font-weight: bold;">return</span> i * j <span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">div</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">j</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span> <span style="color: #859900; font-weight: bold;">return</span> i / j <span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">opMap</span> = <span style="color: #859900; font-weight: bold;">map</span><span style="color: #268bd2;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">]</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">{</span>
        <span style="color: #2aa198;">"+"</span>: add,
        <span style="color: #2aa198;">"-"</span>: sub,
        <span style="color: #2aa198;">"*"</span>: mul,
        <span style="color: #2aa198;">"/"</span>: div,
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">expressions</span> := <span style="color: #d33682;">[][]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span>
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"2"</span>, <span style="color: #2aa198;">"+"</span>, <span style="color: #2aa198;">"3"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"2"</span>, <span style="color: #2aa198;">"-"</span>, <span style="color: #2aa198;">"3"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"2"</span>, <span style="color: #2aa198;">"*"</span>, <span style="color: #2aa198;">"3"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"2"</span>, <span style="color: #2aa198;">"/"</span>, <span style="color: #2aa198;">"3"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"2"</span>, <span style="color: #2aa198;">"%"</span>, <span style="color: #2aa198;">"3"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"two"</span>, <span style="color: #2aa198;">"+"</span>, <span style="color: #2aa198;">"three"</span><span style="color: #859900;">}</span>,
                <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"5"</span><span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">expression</span> := <span style="color: #859900; font-weight: bold;">range</span> expressions <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>expression<span style="color: #859900;">)</span> != 3 <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"invalid expression: "</span>, expression<span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>
                <span style="color: #268bd2;">p1</span>, <span style="color: #268bd2;">err</span> := strconv.<span style="color: #b58900;">Atoi</span><span style="color: #859900;">(</span>expression<span style="color: #6c71c4;">[</span>0<span style="color: #6c71c4;">]</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>err<span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>
                <span style="color: #268bd2;">op</span> := expression<span style="color: #859900;">[</span>1<span style="color: #859900;">]</span>
                <span style="color: #268bd2;">opFunc</span>, <span style="color: #268bd2;">ok</span> := opMap<span style="color: #859900;">[</span>op<span style="color: #859900;">]</span>

                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"unsupported operator:"</span>, op<span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>

                <span style="color: #268bd2;">p2</span>, <span style="color: #268bd2;">err</span> := strconv.<span style="color: #b58900;">Atoi</span><span style="color: #859900;">(</span>expression<span style="color: #6c71c4;">[</span>2<span style="color: #6c71c4;">]</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>err<span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>

                <span style="color: #268bd2;">result</span> := <span style="color: #b58900;">opFunc</span><span style="color: #859900;">(</span>p1, p2<span style="color: #859900;">)</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>result<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">6</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">unsupported operator: %</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">strconv.Atoi: parsing "two": invalid syntax</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">invalid expression:  [5]</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-orgcef6495" class="outline-4">
<h4 id="orgcef6495"><span class="section-number-4">5.2.1.</span> Function Type Declarations</h4>
<div class="outline-text-4" id="text-5-2-1">
<ul class="org-ul">
<li>就像可以使用type来定义一个struct一样,我们也可以使用type来定义一个function type:
<ul class="org-ul">
<li><p>
如下定义一个function type
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">opFuncType</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span>
</pre>
</div></li>
<li><p>
上面的map定义就可以写成如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">opMap</span> = <span style="color: #859900; font-weight: bold;">map</span><span style="color: #268bd2;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">]</span><span style="color: #b58900; font-style: italic;">opFuncType</span> <span style="color: #268bd2;">{</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">same as before</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga34c1c9" class="outline-4">
<h4 id="orga34c1c9"><span class="section-number-4">5.2.2.</span> Anonymous Functions</h4>
<div class="outline-text-4" id="text-5-2-2">
<ul class="org-ul">
<li>在function内部定义的function叫做anonymous function:
<ul class="org-ul">
<li>这种函数没有名字</li>
<li>可以把匿名函数赋值给变量</li>
<li><p>
也可以直接使用匿名函数(inline创建,并且直接调用),如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-13 16:16:37</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 5; i++ <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">j</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"printing"</span>, j, <span style="color: #2aa198;">"form inside of an anonymous function"</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printing 0 form inside of an anonymous function</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printing 1 form inside of an anonymous function</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printing 2 form inside of an anonymous function</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printing 3 form inside of an anonymous function</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printing 4 form inside of an anonymous function</span>
</pre>
</div></li>
</ul></li>
<li>创建匿名调用逻辑代码和直接使用逻辑代码,似乎也没有什么不同.但是有两种情况下,必须创建你们函数来调用逻辑代码:
<ul class="org-ul">
<li>使用defer statement的时候</li>
<li>启用goroutine的时候</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1b6641d" class="outline-3">
<h3 id="org1b6641d"><span class="section-number-3">5.3.</span> Closures</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><p>
定义在function里面的function是比较特殊的,他们叫做闭包
</p>
<pre class="example" id="orgd518a97">
functions declared inside of functions are special; they are closures
</pre></li>
<li>所谓closure是这样一种计算机的概念: 定义在outer function里面的inner function可以访问并且修改outer
function里面定义的变量. 这个特性在closure传递给另外的function(或者作为返回值返回)的时候,就会非
常有用:因为这个时候,closure不仅仅包含了这个function,还包含了outer function所在的scope(里面的变量)</li>
<li>所以,我们可以深化一下前面对于closure的定义:
<ul class="org-ul">
<li>一旦一个function定义在另外一个function里面,这个function就必然是closure,这个和定义一致</li>
<li>但是closure又比普通function多一点,多的就是outer function所在的scope里面的变量,也是closure的一
部分,因为inner function能访问到这些变量,所以这些变量会一直valid,并且每次closure初始化的时候,
初始化scope里面的变量.这么讲有些空洞,我们看后面两个例子就理解了:
<ol class="org-ol">
<li><p>
把functionA作为参数传递给另外一个functionB,那么functionA其实就是定义在另外一个functionB里
面的.functionA,外加functionB的参数(因为和functionA在一个scope)和起来就是一个closure
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-14 16:45:27</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"sort"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">authors</span> := <span style="color: #d33682;">[]</span><span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                Name <span style="color: #b58900; font-style: italic;">string</span>
                ID   <span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #d33682;">}{</span>
                <span style="color: #859900;">{</span><span style="color: #2aa198;">"Cina"</span>, 2<span style="color: #859900;">}</span>,
                <span style="color: #859900;">{</span><span style="color: #2aa198;">"Bell"</span>, 1<span style="color: #859900;">}</span>,
                <span style="color: #859900;">{</span><span style="color: #2aa198;">"Alex"</span>, 3<span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>

        sort.<span style="color: #b58900;">Slice</span><span style="color: #d33682;">(</span>authors, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">p</span>, <span style="color: #268bd2;">q</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #859900;">)</span> <span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> authors<span style="color: #6c71c4;">[</span>p<span style="color: #6c71c4;">]</span>.Name &lt; authors<span style="color: #6c71c4;">[</span>q<span style="color: #6c71c4;">]</span>.Name
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Sort authors by name"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>authors<span style="color: #d33682;">)</span>

        sort.<span style="color: #b58900;">Slice</span><span style="color: #d33682;">(</span>authors, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">p</span>, <span style="color: #268bd2;">q</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #859900;">)</span> <span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> authors<span style="color: #6c71c4;">[</span>p<span style="color: #6c71c4;">]</span>.ID &lt; authors<span style="color: #6c71c4;">[</span>q<span style="color: #6c71c4;">]</span>.ID
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Sort authors by id"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>authors<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Sort authors by name</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[{Alex 3} {Bell 1} {Cina 2}]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Sort authors by id</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[{Bell 1} {Cina 2} {Alex 3}]</span>
</pre>
</div></li>
<li><p>
把functionA作为另外一个函数functionB的一个返回值返回,那么functionB里面的变量和functionA也
合成了一个closure, 一个例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-13 22:54:40</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">intSeq</span><span style="color: #268bd2;">()</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">i</span> := 0
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #d33682;">{</span>
                i++
                <span style="color: #859900; font-weight: bold;">return</span> i
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">nextInt</span> := <span style="color: #b58900;">intSeq</span><span style="color: #d33682;">()</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">nextInt</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">nextInt</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">nextInt</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">nextInt2</span> := <span style="color: #b58900;">intSeq</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">nextInt2</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgc72f487" class="outline-4">
<h4 id="orgc72f487"><span class="section-number-4">5.3.1.</span> Passing Functions as Parameters</h4>
<div class="outline-text-4" id="text-5-3-1">
<ul class="org-ul">
<li>前面说了function是value, 你可以设置function的类型(通过其参数和返回值来唯一定义)</li>
<li><p>
既然function是value,那么他当然可以作为参数传递给其他function.这里是我们需要额外理解的地方,直接
传递一个函数给另外一个函数是没有意义的.因为函数是stateless的,传递一个逻辑计算能力(function)给
另外一个function是没有用的.所以,我们必须是function+scope,形成一个closure传递给另外的function
</p>
<pre class="example" id="orge776ac3">
If you aren't used to treating functions like data, you might need a moment to think about
the implications of creating a closure that references local variables and then passing
that closure to another function
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-orgc805451" class="outline-4">
<h4 id="orgc805451"><span class="section-number-4">5.3.2.</span> Returning Functions from Functions</h4>
<div class="outline-text-4" id="text-5-3-2">
<ul class="org-ul">
<li>从functionB中返回一个functionA,其实这个functionA还带着functionB的scope,合起来就是一个closure</li>
<li><p>
上面的例子是functionA继承了functionB中的i的初始化值,这个i是在functionB的body当中,另外一种情况是
变量存在于functionB的参数中,然后也在functionB的scope种.这种情况更普遍,因为functionB的参数可以从
外界接受实参.例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-14 18:39:12</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">makeMult</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">base</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">factor</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> base * factor
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">twoBase</span> := <span style="color: #b58900;">makeMult</span><span style="color: #d33682;">(</span>2<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">threeBase</span> := <span style="color: #b58900;">makeMult</span><span style="color: #d33682;">(</span>3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 3; i++ <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #b58900;">twoBase</span><span style="color: #6c71c4;">(</span>i<span style="color: #6c71c4;">)</span>, <span style="color: #b58900;">threeBase</span><span style="color: #6c71c4;">(</span>i<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2 3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4 6</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org71cbf1e" class="outline-3">
<h3 id="org71cbf1e"><span class="section-number-3">5.4.</span> defer</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>程序总是会创建临时资源,比如:
<ul class="org-ul">
<li>文件</li>
<li>网络连接</li>
</ul></li>
<li>临时资源的特点是他们需要被清理,然后清理的过程比想象中复杂,因为:
<ul class="org-ul">
<li>一个程序有可能是运行完所有代码return</li>
<li>一个程序还有可能是在中间的逻辑return</li>
<li>一个程序还有可能没有正确运行(发生了异常),就从没有return的位置退出</li>
</ul></li>
<li>所以,所有的编程语言都要有一种清理临时资源的机制,在java里面是try catch,在Go里面就是defer</li>
<li>下面的例子是我们使用Go来编写Unix下的命令cat,在这个过程当中,使用了defer
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-16 19:40:55</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"io"</span>
        <span style="color: #2aa198;">"log"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">len</span><span style="color: #d33682;">(</span>os.Args<span style="color: #d33682;">)</span> &lt; 2 <span style="color: #d33682;">{</span>
                log.<span style="color: #b58900;">Fatal</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"no file specified"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span>os.Args<span style="color: #859900;">[</span>1<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                log.<span style="color: #b58900;">Fatal</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">defer</span> f.<span style="color: #b58900;">Close</span><span style="color: #d33682;">()</span>

        <span style="color: #268bd2;">data</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, 2048<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">count</span>, <span style="color: #268bd2;">err</span> := f.<span style="color: #b58900;">Read</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span>
                os.Stdout.<span style="color: #b58900;">Write</span><span style="color: #859900;">(</span>data<span style="color: #6c71c4;">[</span>:count<span style="color: #6c71c4;">]</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">if</span> err != io.EOF <span style="color: #6c71c4;">{</span>
                                log.<span style="color: #b58900;">Fatal</span><span style="color: #35a69c;">(</span>err<span style="color: #35a69c;">)</span>
                        <span style="color: #6c71c4;">}</span>
                        <span style="color: #859900; font-weight: bold;">break</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>上面的例子就使用了defer加一个method</li>
<li>defer不会马上运行,它会在surrounding function exit的时候(无论是中国正常的还是异常的退出)调用</li>
</ul></li>
<li>关于defer还有如下要点:
<ul class="org-ul">
<li><p>
一个函数里面可以defer多次,按照"后来先运行"的方法运行:
</p>
<pre class="example" id="org619f0c0">
The last defer registered runs first
</pre></li>
<li><p>
defer函数的参数在定义的时候就已经明确并且和defer语句一起入栈.不会再改变
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-16 20:14:57</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">i</span> := 1
        <span style="color: #859900; font-weight: bold;">defer</span> fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i<span style="color: #d33682;">)</span>
        i += 100
        <span style="color: #859900; font-weight: bold;">return</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
</pre>
</div></li>
<li><p>
defer运行在return statement之后,但是在return statemnt返回给用户之前.这就有意思了,我们可以用这
个特性来"根据情况修改返回值":我们可以在defer里面创建一个closure, 这个closure所在的scope就是这
个函数,那么这个函数的返回值自然可以被closure所使用.注意这里同时还要使用named return value,而且
是唯一使用named return value的地方(以为你named return value可以从函数还没开始的时候就定义了返
回值变量)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">DoSomeInserts</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">ctx</span> <span style="color: #b58900; font-style: italic;">context.Context</span>, <span style="color: #268bd2;">db</span> *<span style="color: #b58900; font-style: italic;">sql.DB</span>, <span style="color: #268bd2;">value1</span>, <span style="color: #268bd2;">value2</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">tx</span>, <span style="color: #268bd2;">err</span> := db.<span style="color: #b58900;">BeginTx</span><span style="color: #d33682;">(</span>ctx, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> err
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">defer</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> err == <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        err = tx.<span style="color: #b58900;">Commit</span><span style="color: #6c71c4;">()</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        tx.<span style="color: #b58900;">Rollback</span><span style="color: #6c71c4;">()</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}()</span>
        _, err = tx.<span style="color: #b58900;">ExecContext</span><span style="color: #d33682;">(</span>ctx, <span style="color: #2aa198;">"INSERT INTO FOO (val) values $1"</span>, value1<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> err
        <span style="color: #d33682;">}</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">use tx to do more database inserts here</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>Go中还有一种常见的pattern就是返回资源的同时,还返回一个"清理这个资源的closure",比如下面的例子:
<ul class="org-ul">
<li><p>
我们的函数除了返回一个file以外,还返回了这个回收这个file的closure,以及一个error(确认这个函数调
用是否正常)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">getFile</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">name</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>*<span style="color: #b58900; font-style: italic;">os.File</span>, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">file</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span>name<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> file, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                file.<span style="color: #b58900;">Close</span><span style="color: #859900;">()</span>
        <span style="color: #d33682;">}</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
使用的时候,我们就是除了使用file以外,还要defer"清理这个file的closure"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">closer</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">getFile</span><span style="color: #268bd2;">(</span>os.Args<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]</span><span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        log.<span style="color: #b58900;">Fatal</span><span style="color: #d33682;">(</span>err<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">defer</span> <span style="color: #b58900;">closer</span><span style="color: #268bd2;">()</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org886e15f" class="outline-3">
<h3 id="org886e15f"><span class="section-number-3">5.5.</span> Go is Call By Value</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li><p>
Go是所谓的call by value,也就是说当你提供一个变量给function作为参数的时候,编译器总是把这个变量给
copy一遍
</p>
<pre class="example" id="org571a440">
It means that when you supply a vairable for a parameter to a function,
Go always makes a copy of the value of the variable
</pre></li>
<li>我们来看个例子,绝大部分情况下函数不会更改参数的值:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-16 20:52:03</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        age  <span style="color: #b58900; font-style: italic;">int</span>
        name <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">modifyFails</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">p</span> <span style="color: #b58900; font-style: italic;">person</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        i = i * 2
        s = <span style="color: #2aa198;">"Goodbye"</span>
        p.name = <span style="color: #2aa198;">"Bob"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">p</span> := <span style="color: #b58900; font-style: italic;">person</span><span style="color: #d33682;">{}</span>
        <span style="color: #268bd2;">i</span> := 2
        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">"Hello"</span>
        <span style="color: #b58900;">modifyFails</span><span style="color: #d33682;">(</span>i, s, p<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i, s, p<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2 Hello {0 }</span>
</pre>
</div></li>
<li>我们可以看到function没有更改参数的value</li>
</ul></li>
<li>有两种情况函数会更改输入参数的值,分别是参数为map或者slice,因为这两种类型都是以pointer来实现的:
<ul class="org-ul">
<li><p>
输入参数是map的情况,比较符合直觉,就是都可以改动,因为copy传进来的是指针,也就是形参实参都是同一
块内存,所以无论怎样更改形参,都会影响到实参
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-16 21:15:22</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">modMap</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">m</span> <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        m<span style="color: #d33682;">[</span>2<span style="color: #d33682;">]</span> = <span style="color: #2aa198;">"hello"</span>
        m<span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span> = <span style="color: #2aa198;">"goodbye"</span>
        <span style="color: #d33682; font-style: italic;">delete</span><span style="color: #d33682;">(</span>m, 1<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">m</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">1</span>: <span style="color: #2aa198;">"first"</span>,
                <span style="color: #6c71c4; font-weight: bold;">2</span>: <span style="color: #2aa198;">"second"</span>,
        <span style="color: #d33682;">}</span>
        <span style="color: #b58900;">modMap</span><span style="color: #d33682;">(</span>m<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[2:hello 3:goodbye]</span>
</pre>
</div></li>
<li><p>
输入参数是slice的情况,比map要更复杂一些, 虽然copy进来的也是指针,虽然理论上任何改动也会影响到
实参,但是由于slice更改长度只能使用append, 而append会产生新的地址,但是新地址是无法传递回去的.
所以代码中更改slice长度的部分没有成功
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-16 21:16:49</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">modSlice</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">s</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">k</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> s <span style="color: #d33682;">{</span>
                s<span style="color: #859900;">[</span>k<span style="color: #859900;">]</span> = v * 2
        <span style="color: #d33682;">}</span>

        s = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>s, 10<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3<span style="color: #d33682;">}</span>
        <span style="color: #b58900;">modSlice</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[2 4 6]</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgacbc7f2" class="outline-2">
<h2 id="orgacbc7f2"><span class="section-number-2">6.</span> Pointers</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgbab9f5a" class="outline-3">
<h3 id="orgbab9f5a"><span class="section-number-3">6.1.</span> A Quick Pointer Primer</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>pointer是一种变量,其存储的内容是内存中的location,这个location里面存储着数据</li>
<li>为了理解指针,我们先来理解下变量是如何存储的
<ul class="org-ul">
<li><p>
图6-1
</p>

<div id="org12c7dfd" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-1.png" alt="6-1.png" />
</p>
<p><span class="figure-number">Figure 1: </span>lg/6-1.png</p>
</div></li>
<li>每个变量都是存储在连续的内存空间里面的(比如上面的x,y),这个内存空间就叫做address</li>
<li>不同类型的变量会占据不同容量的内存,比如:
<ol class="org-ol">
<li>变量x是一个32-bit的int,占据四个字节</li>
<li>变量y是一个8-bit的boolean,占据一个字节(虽然只使用了一个bit,但是可寻址的最小单位是8个bit,也就是一个byte)</li>
</ol></li>
<li>x的四个字节占据了地址从1到4, y的一个字节占据了地址5</li>
</ul></li>
<li>我们再来看看,指针作为一个变量,其在内存中是怎样一种形式
<ul class="org-ul">
<li><p>
图6-2
</p>

<div id="orgd4fff02" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-2.png" alt="6-2.png" />
</p>
<p><span class="figure-number">Figure 2: </span>lg/6-2.png</p>
</div></li>
<li>虽然不同类型的变量会占据不同数目的byte,但是指针,不管指向何种类型,其长度都是一样的,比如在这个例
子里面,所有指针都是4个byte:
<ol class="org-ol">
<li>pointerX变量自身的长度是4byte,自己的地址是6, 存储着变量x的地址(也就是1)</li>
<li>pointerY变量自身的长度是4byte,自己的地址是10, 存储着变量y的地址(也就是5), 这个指针使用的内
存(4byte)比他指向的变量(x,1byte)所使用的内存还要大</li>
<li>pointerZ变量自身长度是4byte,自己的地址是14,没有存储任何变量的地址(也就是0)</li>
</ol></li>
</ul></li>
<li>指针的zero value是nil,所有内部使用指针实现的类型(也叫reference type),其zero value都是nil,reference
type总共有:
<ul class="org-ul">
<li>slice</li>
<li>map</li>
<li>function</li>
<li>channel</li>
<li>interface</li>
</ul></li>
<li>注意,和c语言不通,nil不是0的带名字,你不能把nil和数字进行强制转换.</li>
<li><p>
nil其实是一种untyped identifier,表示某种类型缺少value.
</p>
<pre class="example" id="orgae1a82d">
In Go, nil is an identifier that represents the lack of a value for some types.
Like the untyped numeric constants we saw in the previous chapter, nil has no
type, so it can be assigned or compared against values of different types.
</pre></li>
<li><p>
`&amp;` 符号在c语言里面叫做"取地址符",go也用了这个叫法(address operator), 在c++里面 `&amp;`叫引用,go里面
绝大部分情况下不会使用这个叫法,但是由于 `*`可以被叫做解引用,所以也要理解什么是引用.这个符号能获取当
前变量的内存地址
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 21:51:23</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := <span style="color: #2aa198;">"hello"</span>
        <span style="color: #268bd2;">pointerToX</span> := &amp;x

        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"type:%T, value:%[1]v\n"</span>, pointerToX<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">type:*string, value:0xc000014250</span>
</pre>
</div></li>
<li><p>
`*` 在c语言里面叫做"间接寻址运算符",go也适用了这个叫法(indirection operator), 它只能作用在pointer
type上面,并且返回pointer指向的value. 这个做法在c++里面也叫 `解引用(dereferencing)`, go也采用了
这种叫法
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 22:02:51</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10
        <span style="color: #268bd2;">pointerToX</span> := &amp;x
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>pointerToX<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>*pointerToX<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">z</span> := 5 + *pointerToX
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>z<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0xc0000160e8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">15</span>
</pre>
</div></li>
<li><p>
在我们解引用之前,我们要确认pointer不是nil的,否则会panic
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 22:13:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">x</span> *<span style="color: #b58900; font-style: italic;">int</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">panic: runtime error: invalid memory address or nil pointer dereference</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x108d1dc]</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(*x)        //</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
</pre>
</div></li>
<li><p>
前面说到的pointer type就是每种类型都有的属于自己的指针类型,其名字是type name前面加一个 `*`
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 22:27:24</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">pointerToX</span> *<span style="color: #b58900; font-style: italic;">int</span>
        pointerToX = &amp;x
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>pointerToX<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0xc0000ac020</span>
</pre>
</div></li>
<li>内置的函数new会创建一个pointer变量,但是初始化值不再是nil,而是这个pointer指向的instance是一个zero
值.</li>
<li>new的行为比较的不常见,所以在实践当中不会经常被使用.经常使用的方法是:
<ul class="org-ul">
<li><p>
strucct类型(比如struct),我们直接在struct literal前面加"取地址符&amp;"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">x</span> := &amp;<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">{}</span>
</pre>
</div></li>
<li><p>
对于primitive类型,其primitive literal因为没有内存地址,所以无法在他前面加"取地址符&amp;",
所以一般是先declare一个variable,然后再申请个指针指向它
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">y</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">z</span> := &amp;y
</pre>
</div></li>
<li>对于const类型,其也没有内存地址(因为其和primitive literal一样,只存在于compile time),所以也无法
再他前面加"取地址符&amp;",处理思路有两种:
<ol class="org-ol">
<li><p>
和primitive一样,申请个变量保留const,然后再用指针指向它
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 23:24:32</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">x</span> <span style="color: #b58900; font-style: italic;">int</span> = 23
        <span style="color: #268bd2;">tmp</span> := x
        <span style="color: #268bd2;">pointerX</span> := &amp;tmp
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"type:%T, value:%[1]v"</span>, pointerX<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">23</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">type:*int, value:0xc0000160e8</span>
</pre>
</div></li>

<li><p>
另外一种方法是写一个helper function,这个helper function的input parameter是const,由于const(实参)作
为参数传递给function的过程中会拷贝给形参,而形参(下面例子中的s)是一个variable,有地址,那么就
会有内存地址啦,那也就可以返回指向它的pointer啦
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-04 23:29:47</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">stringp</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> *<span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> &amp;s
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                FirstName <span style="color: #b58900; font-style: italic;">string</span>
                LastName  *<span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">p</span> := <span style="color: #b58900; font-style: italic;">person</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">FirstName</span>: <span style="color: #2aa198;">"Pat"</span>,
                <span style="color: #6c71c4; font-weight: bold;">LastName</span>:  <span style="color: #b58900;">stringp</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Perry"</span><span style="color: #859900;">)</span>,
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>p<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Pat 0xc00010c210}</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org82ef37c" class="outline-3">
<h3 id="org82ef37c"><span class="section-number-3">6.2.</span> Don't Fear the Pointers</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li><p>
首先,你不要被pointer所吓倒.因为:pointer的行为模式(对于class类型)其实是主流,而我们go使用的非pointer模式才是非主流
</p>
<pre class="example" id="org584b7a8">
Pointers are actually familiar behavior for classes.
It's the nonpointer structs in Go that are unusual.
</pre></li>
<li>好了,我们来看看主流语言里面,class(go里面的叫struct)的pointer模式是主流这句话如何解释</li>
<li>首先我们来看看主流语言里面的primitive 类型赋值的例子:
<ul class="org-ul">
<li><p>
先来看一个python primitive类型的赋值
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #268bd2;">x</span> = 10
<span style="color: #268bd2;">y</span> = x
<span style="color: #268bd2;">y</span> = 20
<span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[x] ==&gt;"""</span>, x<span style="color: #268bd2;">)</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[x] ==&gt; 10</span>
</pre>
</div></li>
<li>对于class类型来说,一旦赋值给另外的变量,那么另外的变量改变了field的内容,原来的变量field也会改变.
为什么呢?因为python(还有java,js,ruby等)里面,所有的class的instance都是使用pointer来实现的!</li>
<li>换句话说,python(还有java,js,ruby)等的变量,本身就是pointer. 传递来传递去的也是pointer.这些语言
其实就是pass-by-value,只不过他们的value是pointer!</li>
<li><p>
为了印证我们的想法,我们来看一下,下面的例子:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">Foo</span>:
    <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">__init__</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">self</span>, x<span style="color: #268bd2;">)</span>:
        <span style="color: #859900; font-weight: bold;">self</span>.x = x


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">outer</span><span style="color: #268bd2;">()</span>:
    <span style="color: #268bd2;">f</span> = Foo<span style="color: #268bd2;">(</span>10<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[f.x] ==&gt;"""</span>, f.x<span style="color: #268bd2;">)</span>
    inner1<span style="color: #268bd2;">(</span>f<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[f.x] ==&gt;"""</span>, f.x<span style="color: #268bd2;">)</span>
    inner2<span style="color: #268bd2;">(</span>f<span style="color: #268bd2;">)</span>
    <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[f.x] ==&gt;"""</span>, f.x<span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">inner1</span><span style="color: #268bd2;">(</span>f<span style="color: #268bd2;">)</span>:
    f.<span style="color: #268bd2;">x</span> = 20


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">inner2</span><span style="color: #268bd2;">(</span>f<span style="color: #268bd2;">)</span>:
    <span style="color: #268bd2;">f</span> = Foo<span style="color: #268bd2;">(</span>30<span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    outer<span style="color: #268bd2;">()</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[f.x] ==&gt; 10</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[f.x] ==&gt; 20</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[f.x] ==&gt; 20</span>
</pre>
</div></li>
<li>如果python(还有java,js,ruby等)是pass-by-reference的话,那么:
<ol class="org-ol">
<li>inner1里面的f.x改动了,outer也改动(实际上是的)</li>
<li>inner2里面的f reassign了,oouter也要reassign(实际上不是的)</li>
</ol></li>
<li>所以python(还有java,js,ruby等)不是pass-by-reference, 他们是pass-by-value, 只不过value是pointer</li>
</ul></li>
<li>Go也是pass-by-value:
<ul class="org-ul">
<li><p>
如果传递struct的pointer,那么就你能模仿python(还有java,js,ruby)等语言的用法
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-05 22:15:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Foo</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        x <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">outer</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner1</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> *<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo.x = 20
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner2</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> *<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo = &amp;<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #d33682;">{</span>30<span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">f</span> := <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #d33682;">{</span>10<span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner1</span><span style="color: #d33682;">(</span>&amp;f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner2</span><span style="color: #d33682;">(</span>&amp;f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{10}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{20}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{20}</span>
</pre>
</div></li>
<li><p>
Go更厉害的是,还有第二个选择:那就是直接传递struct(而不是*struct), 这样对struct的改动只是改动的
function内部的copy值,不会影响原先的变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-05 22:15:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Foo</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        x <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner1</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> *<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo.x = 20
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner2</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> *<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo = &amp;<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #d33682;">{</span>30<span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">f</span> := <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #d33682;">{</span>10<span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner1</span><span style="color: #d33682;">(</span>&amp;f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner2</span><span style="color: #d33682;">(</span>&amp;f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{10}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{20}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{20}</span>
</pre>
</div></li>
<li><p>
Go还有一点厉害的地方:其primitive 类型和 struct类型的使用方法,在pass-by-value的情况下是一样的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-05 22:43:09</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner1</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo = 20
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">inner2</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">foo</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        foo = 30
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">f</span> := 10
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner1</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">inner2</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
</ul></li>
<li>虽然go给了你选择,但是大多数情况下,要使用value来传递参数,而不是使用pointer.这有两个好处:
<ul class="org-ul">
<li>能够让代码阅读者理解数据是如何修改的</li>
<li>使用value传递参数能够减少GC的工作量</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc53d8c1" class="outline-3">
<h3 id="orgc53d8c1"><span class="section-number-3">6.3.</span> Pointers Indicate Mutable Parameters</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li><p>
go和其他语言不太一样的地方是:它没有const类型. 这似乎是一个问题,但是go之所以敢没有const类型是因为
go具备另外一个能力: 它能够选择给function传递value还是pointer!
</p>
<pre class="example" id="org06b088e">
The lack of immutable declarations in Go might seem problematic, but the ability to
choose between value and pointer parameter types addresses the issue
</pre></li>
<li>所以对go来说:
<ul class="org-ul">
<li>如果想要const的效果,就传递primitive 或者struct.反正函数也没法改动实参</li>
<li>如果不想要const的效果,就传递pointer. 这种情况下,原始数据是可以被修改的</li>
</ul></li>
<li>下面我们就详细的讲解传入pointer作为函数参数的情况
<ol class="org-ol">
<li>第一个例子是我们传递nil pointer到函数里面:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-06 21:09:36</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">failedUpdate</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">g</span> *<span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">x</span> := 10
        g = &amp;x
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">f</span> *<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">f is nil</span>
        <span style="color: #b58900;">failedUpdate</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;nil&gt;</span>
</pre>
</div></li>
<li>我们可以看到nil pointer传进去了,但是却没有办法改动原始值f(其实根本原因是我们没法"解引用"地址0)</li>
<li><p>
我们可以使用下面的图片来例理解这个过程,形参g拷贝了f的地址(也就是0), 虽然它可以在函数内部制
定一个新的地址.但是这个作用聊胜于无:因为函数退出后,这个值就不存在了.因为没有影响到f,所以整
个函数调用毫无意义
</p>

<div id="org0fe5b91" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-3.png" alt="6-3.png" />
</p>
<p><span class="figure-number">Figure 3: </span>lg/6-3.png</p>
</div></li>
</ul></li>
<li>第二个例子,我们传递一个非nil的pointer进函数,这就能做到更改实参的数据啦
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-06 21:20:42</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">failedUpdate</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">px</span> *<span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">x2</span> := 20
        px = &amp;x2
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">update</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">px</span> *<span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        *px = 20
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">x</span> := 10
        <span style="color: #b58900;">failedUpdate</span><span style="color: #d33682;">(</span>&amp;x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">update</span><span style="color: #d33682;">(</span>&amp;x<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>x<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
</pre>
</div></li>
<li>我们可以看到. pointer作为参数,也是对pointer进行拷贝.所以pointer类型的形参,直接改动还是改不
了原始值(实参).所以我们看到failedUpdate失败了,它直接改动了pointer类型的g,这个跟改动int类型
或者struct的形参一样,不会动实参一点毫毛</li>
<li><p>
而update()函数就不一样了,他给pointer来了一个"解引用",就直接给"实参x便利贴"创建了另一个便利
贴替身,两个便利贴都指向同一块内存. 所以,对便利贴替身的改动,自然也会影响到实参x
</p>

<div id="org38a50fc" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-4.png" alt="6-4.png" />
</p>
<p><span class="figure-number">Figure 4: </span>lg/6-4.png</p>
</div></li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-org1328987" class="outline-3">
<h3 id="org1328987"><span class="section-number-3">6.4.</span> Pointers Are a Last Resort</h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li>last resort是破釜沉舟的意思,换句话说当你使用pointer的时候,都要万分小心:
<ul class="org-ul">
<li>使用pointer会让你的代码不够清晰,无法理清楚data flow</li>
<li>另外会对gc造成负担</li>
</ul></li>
<li>如下两个例子,一个反例(是传入pointer修改数据), 一个正向的例子(是返回一个新的struct)
<ul class="org-ul">
<li><p>
反例如下,这样做会让代码阅读者很不理解
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">MakeFoo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> *<span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        f.Field1 = <span style="color: #2aa198;">"val"</span>
        f.Field2 = 20
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
正向的例子如下,我们再返回一个新的struct
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">MakeFoo</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">Foo</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">f</span> := <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">Field1</span>: <span style="color: #2aa198;">"val"</span>,
                <span style="color: #6c71c4; font-weight: bold;">Field2</span>: 20,
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> f, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li><p>
使用pointer参数来更改实参的情况,只有一种: function期待参数是一个interface的时候.我们在json的
marshal/unmarshal函数里面会看到
</p>
<pre class="example" id="org675b6c6">
我们可以把marshal和serialization看成是同义词:都是把内存中的对象转换成byte,
以便能够传播(当然主要是网络传播)
</pre></li>
<li>下面是一个unmarshal的例子: 把byte转换成一个内存中的struct:
<ul class="org-ul">
<li><p>
函数原型如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Unmarshal</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">data</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, <span style="color: #268bd2;">v</span> <span style="color: #b58900; font-style: italic;">any</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Check for well-formedness.</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Avoids filling out half a data structure</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">before discovering a JSON syntax error.</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">d</span> <span style="color: #b58900; font-style: italic;">decodeState</span>
        <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">checkValid</span><span style="color: #d33682;">(</span>data, &amp;d.scan<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> err
        <span style="color: #d33682;">}</span>

        d.<span style="color: #b58900;">init</span><span style="color: #d33682;">(</span>data<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> d.<span style="color: #b58900;">unmarshal</span><span style="color: #d33682;">(</span>v<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>参数是一个slice of bytes, 和一个interface.</li>
<li>而且传给这个interface的必须是一个pointer,这是因为go没有泛型.所以没办法用泛型来为多个不同类型提供返回值</li>
<li><p>
一个使用例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-06 22:35:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"encoding/json"</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">f</span> := <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                Name <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"name"`</span>
                Age  <span style="color: #b58900; font-style: italic;">int</span>    <span style="color: #2aa198;">`json:"age"`</span>
        <span style="color: #d33682;">}{}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">err</span> := json.<span style="color: #b58900;">Unmarshal</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900;">byte</span><span style="color: #859900;">(</span><span style="color: #2aa198;">`{"name": "Bob", "age": 30}`</span><span style="color: #859900;">)</span>, &amp;f<span style="color: #d33682;">)</span>; err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{ 0}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Bob 30}</span>
</pre>
</div></li>
</ul></li>
<li>后面我们还会看到和concurrency一起使用的data type有时候也必须使用pointer进行传参</li>
</ul>
</div>
</div>
<div id="outline-container-orge73739a" class="outline-3">
<h3 id="orge73739a"><span class="section-number-3">6.5.</span> Pointer Passing Performance</h3>
<div class="outline-text-3" id="text-6-5">
<ul class="org-ul">
<li>我们在cpp学习的时候,经常会用到使用指针而不是结构体,因为这样会节省时间.但是绝大部分情况下节省的时间并不多:
<ul class="org-ul">
<li>每次传输pointer到function的时间是固定的,一个nanosecond</li>
<li>传输结构体到function如果小于10MB,那么也就是一个millisecond</li>
</ul></li>
<li>由于差距不大,那么如果是结构体小于10MB的情况下,尽量使用struct,因为这样代码容易理解</li>
<li>一个反直觉的情况是:如果返回值小于1MB,那么返回struct比返回指针快!
<ul class="org-ul">
<li>一个100-byte的struct返回需要10 nanosecond</li>
<li>指向这个100-byte struct的指针返回,则需要30 nanosecond</li>
</ul></li>
<li>如果返回值大于10MB,那么:
<ul class="org-ul">
<li>返回struct需要2 millisecond</li>
<li>返回指针,提升的不多,只有0.5 millisecond</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf97b50f" class="outline-3">
<h3 id="orgf97b50f"><span class="section-number-3">6.6.</span> The Zero Value Versus No Value</h3>
<div class="outline-text-3" id="text-6-6">
<ul class="org-ul">
<li>pointer的另外一个用处是用来区别如下两种情况:
<ul class="org-ul">
<li>一个variable(或者是field)被赋予了zero value: 这种情况下可以赋予一个pointer,只不过pointer指向的field的值是zero值</li>
<li>一个variable(或者是field)从来没有被赋过值:这种情况就可以使用nil pointer</li>
</ul></li>
<li>但是注意,如果一个function的某个参数是pionter类型,并且传入的是nil pointer,那么这个function是无法更
改这个field的:因为没有地方存储这个数据(我们前面的例子讲过这个情况)</li>
<li>当然了,pointer类型传入function的话,如果要更改这个field,要记得在文档里面说明</li>
</ul>
</div>
</div>
<div id="outline-container-orgc31ccd0" class="outline-3">
<h3 id="orgc31ccd0"><span class="section-number-3">6.7.</span> The Difference Between Maps</h3>
<div class="outline-text-3" id="text-6-7">
<ul class="org-ul">
<li>由于map其实是一个pointer指向了一个struct,所以如果我们把一个map作为一个参数传递给某个function,那
么对这个map所有的改动,都会被保留下来.</li>
<li><p>
换句话说,把一个map传递给function,就意味着你拷贝了一个pointer
</p>
<pre class="example" id="orgcf4121d">
Passing a map to a function means that you are copying a pointer
</pre></li>
<li>由于map的这个特性,请不要把map作为input parameter,或者作为return value</li>
<li>从API-design的角度,map作为参数也不是一个好主意,因为你根本不知道map里面有什么</li>
<li>很多动态语言喜欢使用map作为参数,但是在go里面其实是有替代者的,就是struct. 这是go作为强类型语言的优势:
struct可以很好的告诉使用者自己包含了什么,做到self-documenting</li>
<li>把slice作为function的参数则有着非常复杂的行为:
<ul class="org-ul">
<li>所有对于原始的slice内容(已有index)的改变都会同时改变原来的变量</li>
<li>但是一旦使用append对input slice进行更改,增加的部分不会被原来的变量看到</li>
<li><p>
上述情况的代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-18 20:31:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">nums</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3<span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"before modify, nums is:"</span>, nums<span style="color: #d33682;">)</span>

        <span style="color: #b58900;">modifySlice</span><span style="color: #d33682;">(</span>nums<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after modify, nums is:"</span>, nums<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">modifySlice</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">input</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> input <span style="color: #d33682;">{</span>
                input<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> += 10
        <span style="color: #d33682;">}</span>
        input = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #d33682;">(</span>input, 999<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"FileName:[snippet.go&lt;at-2023-01-18-203104&gt;]=====&gt;Var:[ input ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, input<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">before modify, nums is: [1 2 3]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FileName:[snippet.go&lt;at-2023-01-18-203104&gt;]=====&gt;Var:[ input ]=====&gt;Type:[&lt;[]int&gt;] Value:[&lt;[11 12 13 999]&gt;]&lt;=====</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after modify, nums is: [11 12 13]</span>
</pre>
</div></li>
</ul></li>
<li>上述行为的原因,我们详细解释一下:
<ul class="org-ul">
<li><p>
slice是两个int,一个pointer的struct, 如下
</p>

<div id="org9f64e57" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-5.png" alt="6-5.png" />
</p>
<p><span class="figure-number">Figure 5: </span>lg/6-5.png</p>
</div></li>
<li><p>
当一个slice作为参数传递给一个function的时候,也会拷贝两个int,一个pointer.这时候,两个slice变量指
向同一块内存,如下
</p>

<div id="orgcdafa8d" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-6.png" alt="6-6.png" />
</p>
<p><span class="figure-number">Figure 6: </span>lg/6-6.png</p>
</div></li>
<li><p>
如果更改input slice的已有内容,那么显然原来的变量也能看到改动
</p>

<div id="orgb666e61" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-7.png" alt="6-7.png" />
</p>
<p><span class="figure-number">Figure 7: </span>lg/6-7.png</p>
</div></li>
<li><p>
如果append更改了capacity,那么pointer会指向一块更大的内存空间,显然原来的变量无法看到改动
</p>

<div id="org11198ac" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-8.png" alt="6-8.png" />
</p>
<p><span class="figure-number">Figure 8: </span>lg/6-8.png</p>
</div></li>
<li><p>
即便append没有更改capacity,也就是说形参没有申请新的内存块,但是由于形参只更改了copy的length,
原来的变量看不到length的改动,所以也就无法知道新的位置有新的数据了.就和上面的情况一样:原始的变量
看不到新加数据的改动
</p>

<div id="orgf7d70f9" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/6-9.png" alt="6-9.png" />
</p>
<p><span class="figure-number">Figure 9: </span>lg/6-9.png</p>
</div></li>
</ul></li>
<li>由于slice作为唯一的usable linear数据结构,其广泛的作为函数参数在到处传递.但是,请记住无论何时,你都
要assume:作为参数的slice不应该被改动. 换言之,如果要改动input slice,那么函数的文档要说清楚</li>
<li><p>
一个相关的知识是,我们把array传递进函数,array在函数内部改动后, 原始变量是不可能看到改动的:因为array
是作为整体传递进函数的,而不是像slice一样传递了两个int,一个pointer. 例子如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-01-18 20:43:02</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">nums</span> := <span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 3<span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"before modify, nums is:"</span>, nums<span style="color: #d33682;">)</span>

        <span style="color: #b58900;">modifySlice</span><span style="color: #d33682;">(</span>nums<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after modify, nums is:"</span>, nums<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">modifySlice</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">input</span> <span style="color: #d33682;">[</span>3<span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> input <span style="color: #d33682;">{</span>
                input<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> += 10
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"FileName:[snippet.go&lt;at-2023-01-18-203104&gt;]=====&gt;Var:[ input ]=====&gt;Type:[&lt;%T&gt;] Value:[&lt;%[1]v&gt;]&lt;=====\n"</span>, input<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">before modify, nums is: [1 2 3]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">FileName:[snippet.go&lt;at-2023-01-18-203104&gt;]=====&gt;Var:[ input ]=====&gt;Type:[&lt;[3]int&gt;] Value:[&lt;[11 12 13]&gt;]&lt;=====</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after modify, nums is: [1 2 3]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc7c7823" class="outline-3">
<h3 id="orgc7c7823"><span class="section-number-3">6.8.</span> Slices are Buffers</h3>
<div class="outline-text-3" id="text-6-8">
<ul class="org-ul">
<li>当从文件或者网络读取数据的时候,很多语言会在循环里面反复申请新的变量
<ul class="org-ul">
<li><p>
伪代码如下
</p>
<div class="org-src-container">
<pre class="src src-c++">r = open_resource<span style="color: #268bd2;">()</span>
<span style="color: #859900; font-weight: bold;">while</span> r.has_data<span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        data_chunk = r.next_chunk<span style="color: #d33682;">()</span>
        process<span style="color: #d33682;">(</span>data_chunk<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
close<span style="color: #268bd2;">(</span>r<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>每次循环生成的便利data_chunk都需要GC去释放</li>
</ul></li>
<li>Go虽然也是拥有GC的语言,但是地道的go语言代码会避免不必要的allocation.比如我们就经常使用同一个slice
作为buffer来从data source读取数据
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">file</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #268bd2;">(</span>fileName<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> err
<span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">defer</span> file.<span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span>
<span style="color: #268bd2;">data</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #268bd2;">(</span><span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, 100<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">counter</span>, <span style="color: #268bd2;">err</span> := file.<span style="color: #b58900;">Read</span><span style="color: #d33682;">(</span>data<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> err
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> counter == 0 <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #b58900;">process</span><span style="color: #d33682;">(</span>data<span style="color: #859900;">[</span>:count<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>记住,对于我们传递给函数的slice,我们是不能够改变其length和capacity的,但是我们可以更改当前length
的数据.对于这个例子来说,就是每次更改这100个byte</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgfb45c83" class="outline-3">
<h3 id="orgfb45c83"><span class="section-number-3">6.9.</span> Reducing the Garbage Collector's Workload</h3>
<div class="outline-text-3" id="text-6-9">
<ul class="org-ul">
<li>使用buffer只是减轻GC的一种例子,还有很多其他类似的例子</li>
<li>当程序员讨论"garbage"的时候,其实他是指的"data that has no more pointers pointing to it"</li>
<li>因为,一旦没有指针指向这个内存,那么这个内存就要被"回收再利用",好比垃圾要回收再利用一样. 而且这个
回收是必须的. 因为如果没有及时回收,那么最终垃圾会耗尽机器内存</li>
<li>c/c++等远古语言,都是手动释放内存的,现代语言比如go都是拥有garbage collector,让gc来自动探测未使用
的内存,并且释放,并且重复使用他们</li>
<li>但是拥有gc,并不意味着我们要创建很多garbage让gc去处理,我们还是要尽可能的减轻gc的压力</li>
<li>如果了解编程语言实现,那么heap和stack是逃不出的话题.</li>
</ul>
</div>
<div id="outline-container-org6d6221e" class="outline-4">
<h4 id="org6d6221e"><span class="section-number-4">6.9.1.</span> Stack</h4>
<div class="outline-text-4" id="text-6-9-1">
<ul class="org-ul">
<li>stack是一连串连续的内存</li>
<li>在一次function call中,使用的同一个stack</li>
<li>在stack中分配内存非常的简单和快捷,因为只是通过一个stack pointer一路递增,stack pointer跨过的地址
就是新申请的内存</li>
<li>当function被调用的时候会创建一个新的stack frame, function本地申请的变量和传入的实参都会被存储在stack frame上</li>
<li>每个新的variable在stack被存储的时候,stack pointer都会向前增加这个variable的size的长度</li>
<li>函数结束调用的时候,返回值会通过stack返回给上一层的function,然后stack pointer回到stack frame开始
的地方,stack pointer回滚就意味着内存释放完毕!</li>
<li>为了能够在stack上存储变量,你必须知道变量的实际大小, go的value type都在编译阶段就知道自己占用内存的大小,比如:
<ul class="org-ul">
<li>primitive</li>
<li>arrays (这也是为什么size也是array类型的一部分)</li>
<li>structs</li>
</ul></li>
<li>pointer type的size也是知道的(在32-bit机器上就是32-bit,在64-bit机器上就是64-bit),所以pointer type
也是存储在stack上的</li>
<li>对于其他语言来说,如果不知道其内存占用大小,那么直接丢到headp里面就是了. 但是go不想这么做,go想让
某些指针指向的对象(如果其大小可知,并且不会被返回),也存在stack上. 为了这个愿望(当然还有其他的原因),
go做了一个特殊的设计: go能够在运行的时候增长stack的size. 这是非比寻常的,只有go能做到,因为:
<ul class="org-ul">
<li>每个goroutine都有自己的stack</li>
<li>goroutine是由go runtime控制的,而不是操作系统</li>
</ul></li>
<li>具体到哪些被指针指向的变量也能存储在stack上,是一个有些复杂的问题,必须满足如下条件:
<ul class="org-ul">
<li>被指向的变量必须是在编译阶段size已知</li>
<li>指针必须不能从function返回值返回</li>
<li>如果指针是从实参传入的,那么还要去其创建的地方来核实如上两点</li>
</ul></li>
<li><p>
如果不能满足以上的要求,我们就只能把数据存储到heap上了.这种情况,我们会称被指向的数据逃逸了stack
</p>
<pre class="example" id="org8b305df">
Data the pointer points to escapes the stack
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org1210dd0" class="outline-4">
<h4 id="org1210dd0"><span class="section-number-4">6.9.2.</span> Heap</h4>
<div class="outline-text-4" id="text-6-9-2">
<ul class="org-ul">
<li>heap就是被gc管理的内存了(在c/c++里面是手动管理的)</li>
<li>gc的实现机制非常复杂,远远复杂于移动stack pointer的stack内存管理机制</li>
<li>heap上面的数据如果是被任意的,stack上面的pointer所指向的,那么这个数据是valid的.一旦没有pointer指
向这个数据,那么这个数据就变成了garbage,并且由gc负责来回收了.</li>
<li>c语言里面的常见bug,就是返回了指向function内部variable(会被存储在stack,在function退出的时候会被
释放)的指针.在go里面这种bug不会存在,因为go编译器看到指向local variable的指针被返回了,那么那个local
variable就会被存储在heap上面(也就是上节我们说的,这个local variable逃逸了)</li>
<li>go编译器的逃逸分析(escape analysis)并不完美,有些情况下可以本可以存储在stack上的变量,被存储在了
heap上.出现这种问题的原因在于编译器对于变量是否逃逸的判断,总是保守的(也就是更偏向于让变量逃逸),
因为这样至少能保证正确性(牺牲了性能). 新版本的go编译器加强了逃逸分析</li>
<li>之所以逃逸分析很重要,是因为一旦变量存储在heap上面,会对性能有很大的影响,原因有两点:
<ol class="org-ol">
<li>GC会花费很久的时间去工作,因为在heap上面维护未分配的内存是非常复杂的事情.</li>
<li>内存的特性也让在heap上面的访问非常困难: 虽然RAM是(random access memory)的缩写,也就意味着随机
访问内存是可行的,但是内存随机访问的效率很差,比起顺序访问,差了两个数量级. 如果一个slice里面包
含的都是struct,另外一个slice里面包含的都是pointer,那么前者的访问速度会明显慢于后者</li>
</ol></li>
<li>到这里,我们差不多理解为什么Go鼓励我们尽可能少的使用pointer:
<ul class="org-ul">
<li>尽可能少的使用pointer,能够让尽可能多的类型存储在stack上面,减少gc的工作</li>
<li>让slice包含一系列的struct而不是pointer,能够既让变量存储在stack上,还是连续存储的,访问起来更快</li>
<li>尽可能少的使用pointer能够让gc工作的时候一看,需要做的事情很少,就能快速返回,减少gc时间,提高效率</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org49c8e80" class="outline-2">
<h2 id="org49c8e80"><span class="section-number-2">7.</span> Types, Methods, and Interfaces</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org04b420f" class="outline-3">
<h3 id="org04b420f"><span class="section-number-3">7.1.</span> Types in Go</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li><p>
最常见的创建类型的方式是type后面跟struct
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        FirstName <span style="color: #b58900; font-style: italic;">string</span>
        LastName <span style="color: #b58900; font-style: italic;">string</span>
        Age <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
但是其实type后面也可以跟primitive type,或者compound type,甚至是function type
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Score</span> <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Converter</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span>Score
<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">TeamScores</span> <span style="color: #859900; font-weight: bold;">map</span><span style="color: #268bd2;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">]</span><span style="color: #b58900; font-style: italic;">Score</span>
</pre>
</div></li>
<li>Go允许在任意的block level定义类型,但是只能在自己所见的scope访问这些类型,除非是在package level
export这些type</li>
</ul>
</div>
</div>
<div id="outline-container-orge79db00" class="outline-3">
<h3 id="orge79db00"><span class="section-number-3">7.2.</span> Methods</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li><p>
和很多语言一样,GO支持在user-defined type上面增加method.请注意,method只能在package level添加,在
其他level添加会报错
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-01 16:19:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                FirstName <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">./snippet.go:23:27: syntax error: unexpected string at end of statement</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">./snippet.go:27:2: syntax error: non-declaration statement outside function body</span>

        <span style="color: #96A7A9; font-style: italic;">//////////////////////////////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">func (p Person) String() string {                    //</span>
        <span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">return fmt.Sprintf("%v", p.FirstName)           //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">}                                                    //</span>
        <span style="color: #96A7A9; font-style: italic;">//////////////////////////////////////////////////////////</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">p</span> := <span style="color: #b58900; font-style: italic;">Person</span><span style="color: #d33682;">{</span><span style="color: #2aa198;">"Alex"</span><span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>p<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{Alex}</span>
</pre>
</div></li>
<li>method和function的不同,在于其func关键字和函数名之间,多了个receiver.在go里面,最地道的用法是用一个
type的第一个字母的小写做receiver,比如Person就使用p</li>
<li>和function一样,method不能重载,换句话说,一个type不能有两个同名的method</li>
<li>method必须定义在package level,那么method所关联的type也必须在package level(虽然type可以定义在任
何level),因为这样才能证明这个method能够"控制"这个type</li>
<li>虽然可以把method和type定义在两个不同的文件(同一个package),但是不推荐这样做</li>
</ul>
</div>
<div id="outline-container-org3fc3b87" class="outline-4">
<h4 id="org3fc3b87"><span class="section-number-4">7.2.1.</span> Pointer Receivers and Value Receivers</h4>
<div class="outline-text-4" id="text-7-2-1">
<ul class="org-ul">
<li>前面第六章我们讲过,一旦一个函数的参数是pointer type的话那么就意味着这个参数可能会在这次function
调用中被改动</li>
<li>method把这种convention直接变成了强制的规则:
<ul class="org-ul">
<li>method的receiver如果是pointer receiver(类型是pointer),那么这个method可以更改receiver</li>
<li>method的receiver如果不是pointer receiver(类型不是pointer),那么这个method就不可以更改receiver</li>
</ul></li>
<li><p>
这个规则又延伸出了新的convention(best practice): 一旦某个类型有一个pointer receiver,那么所有的
method都要使用pointer receiver,即便这些method不更改receiver
</p>
<pre class="example" id="org8520e41">
When a type has any pointer receiver methods, a common practice is to be consistent
and use pointer receivers for all methods, even the ones that don't modify the receiver
</pre></li>
<li>那么很显然,绝大部分的type的method都会使用pointer receiver,比如下面的例子,虽然String()没有更改
receiver,但是也就使用pointer receiver啦
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-02 19:47:37</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Counter</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        total       <span style="color: #b58900; font-style: italic;">int</span>
        lastUpdated <span style="color: #b58900; font-style: italic;">time.Time</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Increment</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        c.total++
        c.lastUpdated = time.<span style="color: #b58900;">Now</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">String</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"total: %v, last upated: %v"</span>, c.total, c.lastUpdated<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Counter</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #859900;">(</span>&amp;c<span style="color: #859900;">)</span>.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        <span style="color: #d33682;">(</span>&amp;c<span style="color: #d33682;">)</span>.<span style="color: #b58900;">Increment</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">total: 0, last upated: 0001-01-01 00:00:00 +0000 UTC</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">total: 1, last upated: 2023-02-02 19:52:28.237051 +0800 CST m=+0.000114308</span>
</pre>
</div></li>
<li><p>
这么做的唯一问题,就是我们每次要把value type转换成pointer type(通过取地址符号`&amp;`).这样做非常
麻烦,而且也不美观.所以go的编译器可以自动帮你吧c.Increment()转换成(&amp;c).Increment(),也就是说,
上面的代码可以写成如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-02 19:59:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Counter</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        total       <span style="color: #b58900; font-style: italic;">int</span>
        lastUpdated <span style="color: #b58900; font-style: italic;">time.Time</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Increment</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        c.total++
        c.lastUpdated = time.<span style="color: #b58900;">Now</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">String</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"total: %v, last upated: %v"</span>, c.total, c.lastUpdated<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Counter</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        c.<span style="color: #b58900;">Increment</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">total: 0, last upated: 0001-01-01 00:00:00 +0000 UTC</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">total: 1, last upated: 2023-02-02 19:59:18.784843 +0800 CST m=+0.000127037</span>
</pre>
</div></li>
<li><p>
需要注意的是,这个自动"取地址"的功能只是在调用method的时候起作用,go runtime不会在type作为参数
的时候给这个type加"取地址符",比如下面的例子Counter作为value type传入的时候,操作还是作用于copy
上面的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-02 19:59:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Counter</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        total       <span style="color: #b58900; font-style: italic;">int</span>
        lastUpdated <span style="color: #b58900; font-style: italic;">time.Time</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Increment</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        c.total++
        c.lastUpdated = time.<span style="color: #b58900;">Now</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">String</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"total: %v, last upated: %v"</span>, c.total, c.lastUpdated<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">doUpdateWrong</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        c.<span style="color: #b58900;">Increment</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"indoUpdateWrong:"</span>, c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">doUpdateRight</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> *<span style="color: #b58900; font-style: italic;">Counter</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        c.<span style="color: #b58900;">Increment</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"indoUpdateRight:"</span>, c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Counter</span>

        <span style="color: #b58900;">doUpdateWrong</span><span style="color: #d33682;">(</span>c<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in main:"</span>, c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        <span style="color: #b58900;">doUpdateRight</span><span style="color: #d33682;">(</span>&amp;c<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in main:"</span>, c.<span style="color: #b58900;">String</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">indoUpdateWrong: total: 1, last upated: 2023-02-02 20:06:52.853029 +0800 CST m=+0.000116989</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in main: total: 0, last upated: 0001-01-01 00:00:00 +0000 UTC</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">indoUpdateRight: total: 1, last upated: 2023-02-02 20:06:52.853184 +0800 CST m=+0.000272165</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in main: total: 1, last upated: 2023-02-02 20:06:52.853184 +0800 CST m=+0.000272165</span>
</pre>
</div></li>
<li><p>
由于go runtime会自动把value type转换为pointer type,让我们忽略了一件事情: Go会给pointer instance
赋予pointer receiver method和value receiver method, 而对于value instance,只有value receiver
method才会被赋予(但是由于go runtime每次自动加`&amp;`,我们也没办法看到这种情况)
</p>
<pre class="example" id="org3813620">
Go considers both pointer and value receiver methods to be in the method set for
a pointer instance
</pre></li>
</ul></li>
<li>Go是不推荐写getter和setter的,直接访问field最好.</li>
</ul>
</div>
</div>
<div id="outline-container-org6f9b028" class="outline-4">
<h4 id="org6f9b028"><span class="section-number-4">7.2.2.</span> Code Your Methods for nil Instances</h4>
<div class="outline-text-4" id="text-7-2-2">
<ul class="org-ul">
<li>前面讨论到了pointer receiver,那么我们就会想,如果调用的时候对象是nil,那么nil调用method会怎么样?</li>
<li>大多数语言都会直接跑错,Object-C倒是不报错,但是什么也不做</li>
<li>Go的处理和其他语言不通:
<ul class="org-ul">
<li>如果method是value receiver(这种情况不多,因为有一个pointer receiver,其他都是pointer receiver),那么直接报错</li>
<li><p>
如果method是pointer receiver,那么不会直接报错,会先看看method有没有处理receiver为nil的情况,比如
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">IntTree</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        val <span style="color: #b58900; font-style: italic;">int</span>
        left, right *<span style="color: #b58900; font-style: italic;">IntTree</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">it</span> *<span style="color: #b58900; font-style: italic;">IntTree</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Insert</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> *<span style="color: #b58900; font-style: italic;">IntTree</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> it == <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> &amp;<span style="color: #b58900; font-style: italic;">IntTree</span><span style="color: #859900;">{</span><span style="color: #6c71c4; font-weight: bold;">val</span>: val<span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> val &lt; it.val <span style="color: #d33682;">{</span>
                it.left = it.left.<span style="color: #b58900;">Insert</span><span style="color: #859900;">(</span>val<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> val &gt; it.val <span style="color: #d33682;">{</span>
                it.right = it.right.<span style="color: #b58900;">Insert</span><span style="color: #859900;">(</span>val<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> it
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>虽然GO可以处理nil作为pointer receiver的情况,但是绝大多数情况下,这么做没有意义,我们一旦检测出nil
receiver,直接返回error就好了</li>
</ul>
</div>
</div>
<div id="outline-container-org87bd948" class="outline-4">
<h4 id="org87bd948"><span class="section-number-4">7.2.3.</span> Methods Are Functions Too</h4>
<div class="outline-text-4" id="text-7-2-3">
<ul class="org-ul">
<li>function是可以作为variable或者parameter(function type类型)
<ul class="org-ul">
<li><p>
赋给variable
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 10:48:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Increment</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> val + 1
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">f1</span> := Increment
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">f1</span><span style="color: #859900;">(</span>10<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">11</span>
</pre>
</div></li>
<li><p>
直接作为其他function的参数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 11:15:00</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Increment</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> val + 1
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">Increment</span><span style="color: #859900;">(</span>11<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12</span>
</pre>
</div></li>
</ul></li>

<li>同样的,method也可以起到同样的作用:
<ul class="org-ul">
<li><p>
赋给variable
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 13:46:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Adder</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        start <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">AddTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> a.start + val
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">myAdder</span> := <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #d33682;">{</span><span style="color: #6c71c4; font-weight: bold;">start</span>: 10<span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">f1</span> := myAdder.AddTo

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">f1</span><span style="color: #859900;">(</span>1<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">11</span>
</pre>
</div></li>
<li><p>
直接作为其他function的参数.  这个例子我们再global scope申请了myAdder, 和调用处离得很远. 调用
的时候加了个2就得到了102,那么这个100就是从global scope得来的. 我们的method value就有了一点closure
的味道,因为他能在自己使用的地方, access到自己定义的地方(global scope)的value
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 14:57:45</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Adder</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        start <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">AddTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> a.start + val
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">myAdder</span> <span style="color: #b58900; font-style: italic;">Adder</span> = <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #268bd2;">{</span><span style="color: #6c71c4; font-weight: bold;">start</span>: 100<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>myAdder.<span style="color: #b58900;">AddTo</span><span style="color: #859900;">(</span>2<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">102</span>
</pre>
</div></li>
<li><p>
method的receiver可以看成是function的第0个参数,那么我们再能使用function的地方,也可以使用没有
instance对应的method,同时把instance作为第一个参数传递进去
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 15:25:05</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Adder</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        start <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">AddTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> a.start + val
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">myAdder</span> <span style="color: #b58900; font-style: italic;">Adder</span> = <span style="color: #b58900; font-style: italic;">Adder</span><span style="color: #268bd2;">{</span><span style="color: #6c71c4; font-weight: bold;">start</span>: 200<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">f2</span> := Adder.AddTo <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Class.Method, NOT Instance.Method</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">f2</span><span style="color: #859900;">(</span>myAdder, 2<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">202</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc11bcdd" class="outline-4">
<h4 id="orgc11bcdd"><span class="section-number-4">7.2.4.</span> Functions Versus Methods</h4>
<div class="outline-text-4" id="text-7-2-4">
<ul class="org-ul">
<li>到底使用method还是function,主要看你的function是否要依赖于其他数据:
<ul class="org-ul">
<li>package-level的state应该是immutable的,只依赖这些数据的话,可以使用function</li>
<li>非package-level的数据如果初始化之后,在随后的时间里面会改动,那么这些数据要存储在struct里面,并
且配合method进行使用</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8ae6d6e" class="outline-4">
<h4 id="org8ae6d6e"><span class="section-number-4">7.2.5.</span> Type Declarations Aren't Inheritance</h4>
<div class="outline-text-4" id="text-7-2-5">
<ul class="org-ul">
<li><p>
type最常用的地方是type一个struct,但是type还有另外一种用法,那就是在user-defined type A的基础上
创建一个新的user-defined type B. 正所谓"一人千面"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Employee</span> <span style="color: #b58900; font-style: italic;">Person</span>
</pre>
</div></li>
<li>但是这个type declaration并不是一种面向对象的做法,不像继承(inheritance)一样,让新的类型能拥有旧的
类型的method,甚至像继承一样,能让新的child instance用在所有parent instance所能用到的地方.
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 15:58:52</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Score</span> <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">HighScore</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span> = 300
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">Score</span> = 100
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">hs</span> <span style="color: #b58900; font-style: italic;">HighScore</span> = 200

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i, s, hs<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">// ./snippet.go:29:7: cannot use s                                 //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">// (variable of type Score) as type HighScore in assignment        //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">hs = s                                                             //</span>
        <span style="color: #96A7A9; font-style: italic;">////////////////////////////////////////////////////////////////////////</span>
        hs = <span style="color: #b58900;">HighScore</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i, s, hs<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">300 100 200</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">300 100 100</span>
</pre>
</div></li>
<li>可以看到,对于type declaration创造出来的类型,只有untyped constant是可以直接赋值的</li>
<li>其他的赋值方式,比如hs想从s赋值过来,必须使用type conversion</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb640cdd" class="outline-4">
<h4 id="orgb640cdd"><span class="section-number-4">7.2.6.</span> Types Are Eexcutable Documentation</h4>
<div class="outline-text-4" id="text-7-2-6">
<ul class="org-ul">
<li>type declaration这种重新定义一个类型(用底层完全相同的其他类型)咋看起来不如普通struct定义(组合
多种数据到一个类型)来的直观.</li>
<li>但是我们深入思考 一下,这种定义新类型,一个底层类型多种名字的做法(也叫千人千面)其实是为了让代码
更加便于阅读,试想:
<ul class="org-ul">
<li>当别人看到你的代码为Percentage定义method的时候,肯定比为int定义method要便于理解</li>
<li>而且你为Percentage定义的method,其他int类型的instance也不会不小心调用</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga98f242" class="outline-4">
<h4 id="orga98f242"><span class="section-number-4">7.2.7.</span> iota Is for Enumerations-Sometimes</h4>
<div class="outline-text-4" id="text-7-2-7">
<ul class="org-ul">
<li><p>
很多语言都有enum类型,所谓enum类型,就是一个type的取值范围只能限定一个很小的set,比如java里面
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900; font-weight: bold;">enum</span> <span style="color: #b58900; font-style: italic;">Color</span>
<span style="color: #268bd2;">{</span>
    <span style="color: #268bd2;">RED</span>, <span style="color: #268bd2;">GREEN</span>, <span style="color: #268bd2;">BLUE</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">Test</span>
<span style="color: #268bd2;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">main</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">String</span><span style="color: #859900;">[]</span> <span style="color: #268bd2;">args</span><span style="color: #d33682;">)</span>
    <span style="color: #d33682;">{</span>
        <span style="color: #b58900; font-style: italic;">Color</span> <span style="color: #268bd2;">c1</span> = <span style="color: #6c71c4; font-weight: bold;">Color</span>.RED;
        System.out.println<span style="color: #859900;">(</span>c1<span style="color: #859900;">)</span>;
    <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">RED</span>
</pre>
</div></li>
<li>Go不支持enum类型,但是却支持一种叫做iota的特性,能够一次性创建值连续的const:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 16:31:40</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MailCategory</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">(</span>
        <span style="color: #6c71c4; font-weight: bold;">Uncategorized</span> <span style="color: #b58900; font-style: italic;">MailCategory</span> = <span style="color: #6c71c4; font-weight: bold;">iota</span>
        <span style="color: #6c71c4; font-weight: bold;">Personal</span>
        <span style="color: #6c71c4; font-weight: bold;">Spam</span>
        <span style="color: #6c71c4; font-weight: bold;">Social</span>
        <span style="color: #6c71c4; font-weight: bold;">Advertisements</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">mcP</span> := Personal
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>mcP<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
</pre>
</div></li>
<li><p>
iota的使用也是有步骤的,首先就是一定要type declaration一个新的类型,而且原始类型必须是int
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MailCategory</span> <span style="color: #b58900; font-style: italic;">int</span>
</pre>
</div></li>
<li>第二步就是建立一个const的blaock</li>
<li><p>
第三步是在第一个const上面标明类型MailCategory, 并且值写到等于iota,这个是最容易写错的地方了
</p>
<div class="org-src-container">
<pre class="src src-go">Uncategorized <span style="color: #b58900; font-style: italic;">MailCategory</span> = <span style="color: #6c71c4; font-weight: bold;">iota</span>
</pre>
</div></li>
<li>注意iota从0开始赋值,所以Uncategorized的值是0, Personal的值就是1,后面以此类推</li>
</ul></li>
<li><p>
介绍完iota是什么,怎么用的,那么我们来说结论:
</p>
<pre class="example" id="org61da4ed">
尽量不要使用iota,因为一旦再中间引入其他数据,那么后面数据的值都会改动,这将引入难以发现的bug
</pre></li>
<li>还有些说法说在内部数据中可以使用iota,但是在我看来,很难分清楚内部还是外部数据.内部数据后面也可
能变成外部数据.所以最好的办法是不要使用iota</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2ebccbe" class="outline-3">
<h3 id="org2ebccbe"><span class="section-number-3">7.3.</span> Use Embedding for Composition</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li><p>
在设计模式(GOF)这本书里面,作者倡导大家更多的使用composition,而不是继承.20年来,这已经成为共识
</p>
<pre class="example" id="orgf23aded">
Favor object composition over class inheritance
</pre></li>
<li>go压根就不支持继承,他们发明了embedded field来让大家直接使用compositon:
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 19:42:32</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Employee</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Name <span style="color: #b58900; font-style: italic;">string</span>
        ID   <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">e</span> <span style="color: #b58900; font-style: italic;">Employee</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Description</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"%s (%s)"</span>, e.Name, e.ID<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Manager</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Employee
        Reports <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">Employee</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">m</span> <span style="color: #b58900; font-style: italic;">Manager</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">FindNewEmployees</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">Employee</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Inside find new employees"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">Employee</span><span style="color: #d33682;">{}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">m</span> := <span style="color: #b58900; font-style: italic;">Manager</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">Employee</span>: <span style="color: #b58900; font-style: italic;">Employee</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">Name</span>: <span style="color: #2aa198;">"Bob Bobson"</span>,
                        <span style="color: #6c71c4; font-weight: bold;">ID</span>:   <span style="color: #2aa198;">"12345"</span>,
                <span style="color: #859900;">}</span>,
                <span style="color: #6c71c4; font-weight: bold;">Reports</span>: <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">Employee</span><span style="color: #859900;">{}</span>,
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m.ID<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>m.<span style="color: #b58900;">Description</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">12345</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Bob Bobson (12345)</span>
</pre>
</div></li>
<li>我们看到Manager包含了一个field Employ, 但是只有类型,没有给这个field名字. 这种field就叫做embeded field</li>
<li>所有在embeded field上面定义的method和field都自动promoted给了包含这个embeded field的struct,而且可以直接调用</li>
<li><p>
当然了promote的时候,如果containing struct和embeded field有重名filed(method)的情况,name需要加
上embeded field的名字来指明需要inner的,还是不加embeded field的名字来指明使用containing struct
自己的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 20:00:33</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Inner</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        X <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Outer</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Inner
        X <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">o</span> := <span style="color: #b58900; font-style: italic;">Outer</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">Inner</span>: <span style="color: #b58900; font-style: italic;">Inner</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">X</span>: 10,
                <span style="color: #859900;">}</span>,
                <span style="color: #6c71c4; font-weight: bold;">X</span>: 20,
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>o.X<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>o.Inner.X<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7c6e4ba" class="outline-3">
<h3 id="org7c6e4ba"><span class="section-number-3">7.4.</span> Embedding Is Not Inheritance</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>流行语言中,只有go是支持embedding field的,很多其他语言的用户总把embedding field当做继承来理解,这其实是不对的:
<ul class="org-ul">
<li>虽然containing struct可以调用embedding field的函数和field. 这个是和继承一样的</li>
<li><p>
但是go中并不能把containing struct type的instance赋值给embedding struct type的变量,你必须explicitly
的标记出embedding field
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">eFeil</span> <span style="color: #b58900; font-style: italic;">Employee</span> = m          <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">compilation error!</span>
<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">eOK</span> <span style="color: #b58900; font-style: italic;">Employee</span> = m.Employee   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">ok!</span>
</pre>
</div></li>
<li><p>
同时go中并不支持dynamic dispatch,也就是说,如果embedding type中的method调用另外一个method(假设
名字叫fABC)的时候,如果containing type也有一个fABC,那么embedding的fABC会被调用.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-09 20:20:40</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Inner</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        A <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">Inner</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">IntPrinter</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Inner: %d"</span>, val<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">Inner</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Double</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> i.<span style="color: #b58900;">IntPrinter</span><span style="color: #d33682;">(</span>i.A * 2<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Outer</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Inner
        S <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">o</span> <span style="color: #b58900; font-style: italic;">Outer</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">IntPrinter</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Outer: %d"</span>, val<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">o</span> := <span style="color: #b58900; font-style: italic;">Outer</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">Inner</span>: <span style="color: #b58900; font-style: italic;">Inner</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">A</span>: 10,
                <span style="color: #859900;">}</span>,
                <span style="color: #6c71c4; font-weight: bold;">S</span>: <span style="color: #2aa198;">"Hello"</span>,
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>o.<span style="color: #b58900;">Double</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Inner: 20</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9d15016" class="outline-3">
<h3 id="org9d15016"><span class="section-number-3">7.5.</span> A Quick Lesson on Interfaces</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>go总是以CSP并发模型而闻名,但是go设计的最优秀的地方,反而是他的interface</li>
<li><p>
我们首先看看如何定义interface: 我们可以把interface看成是一种类型,我们使用type+Name+interface的
办法来创建一个interface.而这个括号内部有一些函数声明,例子Stringer如下(注意interface通常以er结尾)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Stringer</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">String</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>interface内部定义的这些method,叫做interface的method set, 一个concrete type只有实现method set里
面的所有函数,才能说这个concrete type implement了这个interface</li>
</ul>
</div>
</div>
<div id="outline-container-orgd0d4199" class="outline-3">
<h3 id="orgd0d4199"><span class="section-number-3">7.6.</span> Interfaces Are Type-Safe Duck Typing</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li><p>
介绍完了interface的样子,下面来说下go interface真正特别的地方: 类型不必显式的声明自己实现了哪些
接口,只要你实现了所有的method set即可
</p>
<pre class="example" id="org634d406">
What makes Go's interfaces special is that they are implmented implicitly
</pre></li>
<li>一旦你的concrete type实现了interface的所有method set,那么你就实现了这个接口,你也就可以把自己赋值
给`定义为这个接口类型`的变量(或者域)</li>
<li>这种不需要"显式"的表明自己实现了哪种接口的行为,有点两个特点,分别借鉴了动态语言的duck typing和静
态语言明确的写出实现何种功能的接口(类)
<ol class="org-ol">
<li>先来看动态语言的duck typing:
<ul class="org-ul">
<li><p>
所谓duck typing就是在动态语言(Python,Ruby,Javascript)中,你可以直接把一个某个类型A的instance传
递给functionB作为参数,只要functionB在使用参数的时候,每个需要的method都能调用就可以了.环境话说
就是
</p>
<pre class="example" id="org13b664f">
If it walks like a duck and quacks like a duck, it's a duck
</pre></li>
<li>duck typing的优点是比较方便,需求更改时,不需要显式的更改某个类型实现的interface,只需要两处都增加
新函数即可</li>
<li>duck typing的缺点是没有一个地方总结一下到底需要满足哪些method set才能使用某个函数</li>
<li><p>
一个用python写的duck typing的例子
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">Logic</span>:
    <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">process</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">self</span>, data<span style="color: #268bd2;">)</span>:
        <span style="color: #d33682; font-style: italic;">print</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"""[data in process] ==&gt;"""</span>, data<span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #b58900;">program</span><span style="color: #268bd2;">(</span>logic<span style="color: #268bd2;">)</span>:
    data = <span style="color: #2aa198;">"data fetch in function program"</span>
    logic.process<span style="color: #268bd2;">(</span>data<span style="color: #268bd2;">)</span>


<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682; font-style: italic;">__name__</span> == <span style="color: #2aa198;">"__main__"</span>:
    logicToUse = Logic<span style="color: #268bd2;">()</span>
    program<span style="color: #268bd2;">(</span>logicToUse<span style="color: #268bd2;">)</span>

<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;"># </span><span style="color: #96A7A9; font-style: italic;">[data in process] ==&gt; data fetch in function program</span>
</pre>
</div></li>
</ul></li>
<li>再来看看静态语言的接口(类)
<ul class="org-ul">
<li>所谓接口,就是一个没有实现的类,其会描写出想要干的事情,以函数的形式列举出来,例子如下</li>
<li>接口的优点是明确的把某个接口改干什么写清楚,不像动态语言到底大家需要遵守什么method set不知道.</li>
<li>接口的缺点需求一旦更改,可能要更换所依赖的interface,更改很多代码</li>
<li><p>
java首先要创建一个interface来列举method set
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> com.harrifeng.<span style="color: #6c71c4; font-weight: bold;">app</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #268bd2;">{</span>
    <span style="color: #b58900; font-style: italic;">String</span> <span style="color: #b58900;">process</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">String</span> <span style="color: #268bd2;">data</span><span style="color: #d33682;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
然后再创建一个class来实现这个接口
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> com.harrifeng.<span style="color: #6c71c4; font-weight: bold;">app</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">LogicImpl</span> <span style="color: #859900; font-weight: bold;">implements</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #268bd2;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900; font-style: italic;">String</span> <span style="color: #b58900;">process</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">String</span> <span style="color: #268bd2;">data</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> data + <span style="color: #2aa198;">" processed"</span>;
    <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
由于面向接口编程的要求,所有的代码中都只使用interface,而不是implementation
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> com.harrifeng.<span style="color: #6c71c4; font-weight: bold;">app</span>;

<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">Client</span> <span style="color: #268bd2;">{</span>
    <span style="color: #859900; font-weight: bold;">private</span> <span style="color: #859900; font-weight: bold;">final</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #268bd2;">logic</span>;

    <span style="color: #859900; font-weight: bold;">public</span> Client<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #268bd2;">logic</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">this</span>.logic = logic;
    <span style="color: #d33682;">}</span>

    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">program</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>

        <span style="color: #b58900; font-style: italic;">String</span> <span style="color: #268bd2;">data</span> = <span style="color: #2aa198;">"some data"</span>;
        System.out.println<span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">this</span>.logic.process<span style="color: #6c71c4;">(</span>data<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>;
    <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
在真正使用client代码的时候,我们的main函数传入了implementation
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900; font-weight: bold;">package</span> com.harrifeng.<span style="color: #6c71c4; font-weight: bold;">app</span>;


<span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900; font-style: italic;">App</span>
<span style="color: #268bd2;">{</span>
    <span style="color: #859900; font-weight: bold;">public</span> <span style="color: #859900; font-weight: bold;">static</span> <span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">main</span><span style="color: #d33682;">(</span> <span style="color: #b58900; font-style: italic;">String</span><span style="color: #859900;">[]</span> <span style="color: #268bd2;">args</span> <span style="color: #d33682;">)</span>
    <span style="color: #d33682;">{</span>
        <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #268bd2;">logic</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900; font-style: italic;">LogicImpl</span><span style="color: #859900;">()</span>;
        <span style="color: #b58900; font-style: italic;">Client</span> <span style="color: #268bd2;">client</span> = <span style="color: #859900; font-weight: bold;">new</span> <span style="color: #b58900; font-style: italic;">Client</span><span style="color: #859900;">(</span>logic<span style="color: #859900;">)</span>;
        client.program<span style="color: #859900;">()</span>;
    <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">some data processed</span>
</pre>
</div></li>
</ul></li>
</ol></li>
<li>综合以上,我们来看看go是如何解决这种问题的
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-10 19:41:49</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">LogicProvider</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #268bd2;">{}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">lp</span> <span style="color: #b58900; font-style: italic;">LogicProvider</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Process</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">data</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> data + <span style="color: #2aa198;">" processed"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Process</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">data</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Client</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        L <span style="color: #b58900; font-style: italic;">Logic</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Client</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Program</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">data</span> := <span style="color: #2aa198;">"some data"</span>
        <span style="color: #268bd2;">newData</span> := c.L.<span style="color: #b58900;">Process</span><span style="color: #d33682;">(</span>data<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>newData<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">c</span> := <span style="color: #b58900; font-style: italic;">Client</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">L</span>: <span style="color: #b58900; font-style: italic;">LogicProvider</span><span style="color: #859900;">{}</span>,
        <span style="color: #d33682;">}</span>
        c.<span style="color: #b58900;">Program</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">some data processed</span>
</pre>
</div></li>
<li>我们可以看到和java中不同的是,只有Client code知道interface的存在, implementation(LogicProvider)
完全不知道interface姓名(当然不能知道,知道了就不好重构了), 这样做有两点好处:
<ol class="org-ol">
<li>和provider解耦了,以后可以用其他的provider</li>
<li>也能在编译器角度保证client代码的需求(必须满足某些method set)</li>
</ol></li>
</ul></li>
<li>Go里面提倡分享你的interface,甚至你最好能够实现standard library里面的interface,这让你的代码更能广泛适配</li>
<li>Go里面还有一种decorator pttern,指的是input instance是一个interface,经过处理后,会给一个新的output
instance,还是满足同样的interface. 这样做的好处是可以使用同样的代码来处理input instance和output instance
<ul class="org-ul">
<li><p>
假设有个处理函数,其处理的参数必须的io.Reader
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">process</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span>
</pre>
</div></li>
<li><p>
打开的普通文件句柄instance可以处理
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">r</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #268bd2;">(</span>fileName<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> err
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">defer</span> r.<span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span>
<span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">process</span><span style="color: #268bd2;">(</span>r<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
如果是处理压缩的文件呢? 我们还是想用process,那么就要保证对压缩文件decorate之后的output instance
还是满足io.Reader. 我们的gzzip.NewReader就做到了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The Reader.Header fields will be valid in the Reader returned.</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewReader</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>*<span style="color: #b58900; font-style: italic;">Reader</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">z</span> := <span style="color: #d33682; font-style: italic;">new</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">Reader</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">err</span> := z.<span style="color: #b58900;">Reset</span><span style="color: #d33682;">(</span>r<span style="color: #d33682;">)</span>; err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> z, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
所以,我们可以使用如下代码来处理压缩文件
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">r</span>, <span style="color: #268bd2;">err</span>:= os.<span style="color: #b58900;">Open</span><span style="color: #268bd2;">(</span>fileName<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> err
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">defer</span> r.<span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span>
gz, err = gzip.<span style="color: #b58900;">NewReader</span><span style="color: #268bd2;">(</span>r<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> err
<span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">defer</span> gz.<span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span>
<span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">process</span><span style="color: #268bd2;">(</span>gz<span style="color: #268bd2;">)</span>
</pre>
</div></li>
</ul></li>
<li>最后说一点,我们的type可以满足多个interface(通过拥有多个method),这样就等于隐式的实现了多个接口.
这是没有关系的:
<ul class="org-ul">
<li>有些client code可能关注type里面的一个setA的method</li>
<li>另外一些client code可能关注type里面的另外一个setB的method</li>
</ul></li>
<li>比如我们的io.File type,就满足了io.Writer interface, 同时满足了io.Reader interface:
<ul class="org-ul">
<li>如果一个代码关注写入文件,那么它只关心你的io.Writer</li>
<li>如果一个代码关注读取文件,那么它只关心你的io.Reader</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org53dedbd" class="outline-3">
<h3 id="org53dedbd"><span class="section-number-3">7.7.</span> Embedding and Interfaces</h3>
<div class="outline-text-3" id="text-7-7">
<ul class="org-ul">
<li><p>
我们之前讲过,一个type可以embed在一个struct里(注意是type embed,而不是instance embed), 例子如下(为
了和interface的例子对比,这里一个struct里面embed了两个type
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-11 12:22:11</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">A</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        NumA <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">B</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        NumB <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">C</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        A
        B
        NumC <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #268bd2;">c</span> := <span style="color: #b58900; font-style: italic;">C</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">A</span>:    <span style="color: #b58900; font-style: italic;">A</span><span style="color: #859900;">{</span>1<span style="color: #859900;">}</span>,
                <span style="color: #6c71c4; font-weight: bold;">B</span>:    <span style="color: #b58900; font-style: italic;">B</span><span style="color: #859900;">{</span>2<span style="color: #859900;">}</span>,
                <span style="color: #6c71c4; font-weight: bold;">NumC</span>: 3,
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>c<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{{1} {2} 3}</span>
</pre>
</div></li>
<li>然后,同样的,如果把interface看成是一个类型的话,我们还可以把interface embed到strucct里面(单元测试的时候会用到)</li>
<li><p>
再然后,我们可以把interface embed到另外一个interface里面(严格意义上说,这个和前面两种已经不一样了,
因为这是一个interfacce type embed到另外一个interface type里面)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Reader</span> <span style="color: #b58900; font-style: italic;">intrface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Read</span><span style="color: #d33682;">(</span>p <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #268bd2;">n</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">CLoser</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Close</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">error</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">ReadCloser</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        Reader
        Closer
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org55d0df4" class="outline-3">
<h3 id="org55d0df4"><span class="section-number-3">7.8.</span> Accept Interfaces, Return Structs</h3>
<div class="outline-text-3" id="text-7-8">
<ul class="org-ul">
<li>在go社区,流行着一个最佳实践: "Accept interfaces, return structs",这意味着:
<ul class="org-ul">
<li>触发你的function business logic的应该是interface. 前面的章节我们已经聊过为什么函数需要使用interface
来作为参数了: interface 参数让你的代码更加灵活,并且清晰的表述出function的要用的功能是什么</li>
<li>你的function的output尽量是concrete type. 为什么要这么做基于两点:
<ol class="org-ol">
<li>implicit interface 的主要优点,在于decoupling. 而如果一旦返回值是go的interface的话,那么你的
代码就依赖这些返回值(interface)所在的module啦</li>
<li>返回concrete type的话,我们以后给这些concreate type增加method毫无心理压力.但是如果返回值是
interface的话,我们完全无法给这些interface增加任何method,因为增加哪怕一个method,就意味着要
升级所有的implementation,否则代码会break</li>
</ol></li>
</ul></li>
<li>Accept interfaces, return structs是一个最佳实践,这就意味着这只是我们的最佳选择.很多时候,客观条件
不允许我们使用最佳选择,比如:
<ul class="org-ul">
<li>由于go不支持泛型(但是我们却要返回不同类型的错误),所以我们返回错误的时候,只能返回error(一个interface)</li>
</ul></li>
<li>使用interface作为参数会增加headp allocation,间接导致最终的gc会比较大.但是可以选择的话还是选择使
用interface作为函数的input 参数(因为这是面向接口编程的最基本要求),仅仅当程序由于gc速度下降太多的
时候再更改interface input为concrete type的input</li>
</ul>
</div>
</div>
<div id="outline-container-org7ee208a" class="outline-3">
<h3 id="org7ee208a"><span class="section-number-3">7.9.</span> Interfaces and nil</h3>
<div class="outline-text-3" id="text-7-9">
<ul class="org-ul">
<li>之前我们学习过nil,nil是pointer type的zero value</li>
<li>interface也是pointer type,所以其zero value也是nil.</li>
<li>但是interface其实是两个pointer的结合体(一个指向Type,一个指向instance),所以想要得到interface的zero
value,那么必须要保证:
<ul class="org-ul">
<li>pointerA指向的类型是interface{}</li>
<li>pointerB指向的instance也是nil</li>
</ul></li>
<li><p>
只有使用var创建interface的时候能得到其zero值,一旦赋值了其他类型,即便这个类型的value是nil的,但是
这个类型的type也不可能是nil的,所以zero值的interface就被覆盖了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 15:47:43</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">s</span> *<span style="color: #b58900; font-style: italic;">string</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>s == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

        i = s
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
</pre>
</div></li>
<li>一个interface是否nil只会影响一件事情,那就是你是否能够在这个interface上面invoke method:
<ul class="org-ul">
<li>如果interface是nil,那么在这个interface上面invoke任何的method都会panic</li>
<li>如果interface不是nil.那么就要再分情况了:
<ol class="org-ol">
<li>如果type不是nil的,但是value是nil的,同时这个type没有handle nil concrete instance的情况,那么调用会panic</li>
<li>除此以外,其他的调用都不会panic</li>
</ol></li>
</ul></li>
<li>由于interface有两个指针:type指针和value指针,那么如何判断当前处于`type指针不为空,但是value指针为空`的情况呢?
<ul class="org-ul">
<li>答案是使用反射(reflection)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org94f3a29" class="outline-3">
<h3 id="org94f3a29"><span class="section-number-3">7.10.</span> The Empty Interface Says Nothing</h3>
<div class="outline-text-3" id="text-7-10">
<ul class="org-ul">
<li>在静态语言中,有时候需要有一种办法来创建一个variable,这个variable的特点是能够存储任意类型的value</li>
<li><p>
在go里面我们使用interface{}来代表这种情况
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 18:52:52</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        i = 20
        i = <span style="color: #2aa198;">"hello"</span>
        i = <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #d33682;">{</span>
                FirstName <span style="color: #b58900; font-style: italic;">string</span>
                LastName  <span style="color: #b58900; font-style: italic;">string</span>
        <span style="color: #d33682;">}{</span><span style="color: #2aa198;">"Fred"</span>, <span style="color: #2aa198;">"Fredson"</span><span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

</pre>
</div></li>
<li>interface{}的用法非常巧妙:
<ul class="org-ul">
<li>interface{}看起来,就是一个method set为空的接口</li>
<li>任何type都至少实现了0个method,那么也就自然能够隐式的实现了interface{}</li>
</ul></li>
<li>由于go缺少泛型,所以很多需要处理多种类型的函数参数,必须设置成interface{}类型
当函数真正调用的时候,传入的肯定是具体类型了.这个时候如何知道用户传入的是什么
类型呢?我们在go里面有两种手段查找interface{}类型底层的类型具体是什么:
<ul class="org-ul">
<li>type assertion</li>
<li>type switch</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org80b190a" class="outline-3">
<h3 id="org80b190a"><span class="section-number-3">7.11.</span> Type Assertions and Type Switches</h3>
<div class="outline-text-3" id="text-7-11">
<ul class="org-ul">
<li>type assertion就是尝试判断一个interface是什么类型:
<ul class="org-ul">
<li><p>
如果判断对,那很好继续运行
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 19:11:02</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MyInt</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">mine</span> <span style="color: #b58900; font-style: italic;">MyInt</span> = 20
        i = mine
        <span style="color: #268bd2;">i2</span> := i.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">MyInt</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i2 + 1<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">21</span>
</pre>
</div></li>
<li><p>
如果判断错,那么panic
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 19:18:39</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MyInt</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">mine</span> <span style="color: #b58900; font-style: italic;">MyInt</span> = 20
        i = mine
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>i<span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">///////////////////////////////////////////////////////////////////////////////////</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">// panic: interface conversion: interface {} is main.MyInt, not string        //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">i2 := i.(string)                                                              //</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fmt.Println(i2)                                                               //</span>
        <span style="color: #96A7A9; font-style: italic;">///////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
</pre>
</div></li>
</ul></li>
<li>显然panic不是我们想要的,为此,go为type assertion引入了comma ok idiom:
<ul class="org-ul">
<li><p>
例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 19:28:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MyInt</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">mine</span> <span style="color: #b58900; font-style: italic;">MyInt</span> = 20
        i = mine
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">i2</span>, <span style="color: #268bd2;">ok</span> := i.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">MyInt</span><span style="color: #d33682;">)</span>; ok <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i2 is MyInt type, with value: "</span>, i2<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i2 is not MyInt type with value:[%v] "</span>, i2<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">i3</span>, <span style="color: #268bd2;">ok</span> := i.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span>; ok <span style="color: #d33682;">{</span>

                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i3 is string type with value:"</span>, i3<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i3 is not string type with value:[%v]"</span>, i3<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">i2 is MyInt type, with value:  20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">i3 is not string type with value:[]</span>
</pre>
</div></li>
<li>ok为true的情况下,正常运行,另外的变量(i2)设置为转换后的值</li>
<li>ok为false的情况下,另外的变量(i3)被设置为zero value</li>
</ul></li>
<li><p>
一个需要注意的是,type assertion的目标可能不仅仅是concrete type,也可能是另外一种interface
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 19:28:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"strconv"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">MyInt</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Stringer</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">String</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">m</span> <span style="color: #b58900; font-style: italic;">MyInt</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">String</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> strconv.<span style="color: #b58900;">Itoa</span><span style="color: #d33682;">(</span><span style="color: #b58900;">int</span><span style="color: #859900;">(</span>m<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">mine</span> <span style="color: #b58900; font-style: italic;">MyInt</span> = 20
        i = mine

        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">i1</span>, <span style="color: #268bd2;">ok</span> := i.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">Stringer</span><span style="color: #d33682;">)</span>; ok <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i1 implements Stringer, with value: "</span>, i1<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"i1 does not implement Stringer"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">i1 implements Stringer, with value:  20</span>
</pre>
</div></li>
<li>这里要把type assertion和type conversion的区别列一下:
<ul class="org-ul">
<li>type conversion可以作用在concrete type或者interface上面. 而type assertion只能作用于interface上面</li>
<li>type conversion是在compilation time进行check,而type assertion则是在runtime进行check,所以可能会panic</li>
</ul></li>
<li><p>
type assertion用在interface只可能是一种类型的情况,如果interface可能是多种类型,那么我们通常会用type switch
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-13 20:12:16</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">do</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #d33682;">{}</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #268bd2;">v</span> := i.<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">type</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #b58900; font-style: italic;">int</span>:
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Twice %v is %v\n"</span>, v, v*2<span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #b58900; font-style: italic;">string</span>:
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"%q is %v bytes long\n"</span>, v, <span style="color: #d33682; font-style: italic;">len</span><span style="color: #6c71c4;">(</span>v<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">default</span>:
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"I don't know about type %T\n"</span>, v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #b58900;">do</span><span style="color: #d33682;">(</span>21<span style="color: #d33682;">)</span>
        <span style="color: #b58900;">do</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"hello"</span><span style="color: #d33682;">)</span>
        <span style="color: #b58900;">do</span><span style="color: #d33682;">(</span><span style="color: #6c71c4; font-weight: bold;">true</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Twice 21 is 42</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">"hello" is 5 bytes long</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">I don't know about type bool</span>
</pre>
</div></li>
<li>注意: type switch是指你知道类型大概率处于某集中类型之中,换句话说,你知道interface可能的几个归宿,
需要在runtime进行判断. 而如果你完全不知道interface的类型,你是不可能使用type switch来穷举的(因为
go的类型是一人千面,每个类型都可以有新的名字,而不支持隐式转换)</li>
</ul>
</div>
</div>
<div id="outline-container-org13c5ebc" class="outline-3">
<h3 id="org13c5ebc"><span class="section-number-3">7.12.</span> Use Type Assertions and Type Switches Sparingly</h3>
<div class="outline-text-3" id="text-7-12">
<ul class="org-ul">
<li>虽然从interface变量里面获取concrete type的方法看起来非常的方便,但是我们却要克制的使用他们,尽可能
减少使用频率.因为function API需要精确的声明它需要什么样的类型来完成自己的工作</li>
<li>type assertion和type switch有其特定的使用场景:
<ol class="org-ol">
<li>第一个场景是某个concrete type(以能满足interfaceA从而能够赋值进函数),是否能满足interfaceB
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">copyBuffer</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">dst</span> <span style="color: #b58900; font-style: italic;">Writer</span>, <span style="color: #268bd2;">src</span> <span style="color: #b58900; font-style: italic;">Reader</span> buf <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">byte</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">written</span> <span style="color: #b58900; font-style: italic;">int64</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">wt</span>, <span style="color: #268bd2;">ok</span> := src.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">WriterTo</span><span style="color: #d33682;">)</span>; ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> wt.<span style="color: #b58900;">WriterTo</span><span style="color: #859900;">(</span>dst<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">rt</span>, <span style="color: #268bd2;">ok</span> := dst.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">ReadFrom</span><span style="color: #d33682;">)</span>; ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> rt.<span style="color: #b58900;">ReadFrom</span><span style="color: #859900;">(</span>src<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>dst的instance肯定是能满足io.Writer接口才能传递进来. 进来之后再判断一下dst是否能满足io.ReaderFrom
接口,如果满足的话,直接调用它的io.ReaderFrom的结果</li>
<li>同样的,src的instance肯定是能满足io.Reader接口才能传递进来. 进来之后再判断一下src是否能满足
io.WriterTo接口,如果满足的话,直接调用它的io.WriterTo的结果</li>
</ul></li>
<li>第二个场景是兼容多个版本API的时候,如果instance实现了新版本引入的接口,那么就使用新接口的函数,
否则使用其他办法来完成同样的工作
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">ctxDriverStmExec</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">ctx</span> <span style="color: #b58900; font-style: italic;">context.Context</span>, <span style="color: #268bd2;">si</span> <span style="color: #b58900; font-style: italic;">deriver.Stmt</span>,
        <span style="color: #268bd2;">nvdargs</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">driver.NamedValue</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">driver.Result</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">siCtx</span>, <span style="color: #268bd2;">is</span> := si.<span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">driver.StmtExecContext</span><span style="color: #d33682;">)</span>; is <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> siCtx.<span style="color: #b58900;">ExecContext</span><span style="color: #859900;">(</span>ctx, nvdargs<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">fallback code is here</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>首先判断si是否实现了StmtExecContext接口,这个接口存在一个1.8版本引入的method: ExecContext(能
够使用context的Exec函数)</li>
<li>如果si实现了StmtExecContext接口,说明si这个instance是新版本的理解context的,那么就调用ExecContext</li>
<li>如果si没有实现StmtExecContext接口,那么我们使用fallback代码来实现context的功能</li>
</ul></li>
</ol></li>
<li><p>
最后需要强调一下,type switch一定要加上default,因为type switch不可能穷举所有的类型(因为go是"一人千面"),
一定有类型你处理不了.另外,当我们添加新的类型给interface的时候,如果忘了update type switch,那么default
能为我们做好最后一道屏障
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">walkTree</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">t</span> *<span style="color: #b58900; font-style: italic;">treeNode</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">int</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">switch</span> <span style="color: #268bd2;">val</span> := t.val.<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">type</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>:
                <span style="color: #859900; font-weight: bold;">return</span> 0, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"invalide expression"</span><span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #b58900; font-style: italic;">number</span>:
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">int</span><span style="color: #859900;">(</span>val<span style="color: #859900;">)</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>
        <span style="color: #859900; font-weight: bold;">default</span>:
                <span style="color: #859900; font-weight: bold;">return</span> 0, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"unknown node type"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3916a88" class="outline-3">
<h3 id="org3916a88"><span class="section-number-3">7.13.</span> Function Types Are a Bridge to Interfaces</h3>
<div class="outline-text-3" id="text-7-13">
<ul class="org-ul">
<li><p>
我们是无法在自己的代码里面给int等内置类型添加method的,因为int没有被export出来
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-15 22:13:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #96A7A9; font-style: italic;">//////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">// ./snippet.go:17:7: cannot define new methods on non-local type int        //</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">func (i int) Display() {                                                     //</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">fmt.Println("display: ", i)                                             //</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">}                                                                            //</span>
<span style="color: #96A7A9; font-style: italic;">//////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
但是这也难不倒我们,由于go有"一人千面",我们可以给int一个新名字,就可以给新类型创建method啦
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-15 22:35:46</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">UserInt</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">u</span> <span style="color: #b58900; font-style: italic;">UserInt</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Display</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"UserInt:"</span>, u<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">ui</span> <span style="color: #b58900; font-style: italic;">UserInt</span> = 23
        ui.<span style="color: #b58900;">Display</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">UserInt: 23</span>
</pre>
</div></li>
<li>这也侧面说明了一个问题,那就是go可以给任意user-defined type定义method,只要你能看到它.</li>
<li>user-defined function type也是一种类型,那么只要能看到这种类型(说明是user-defined的),那么我们也能
给他创建method. function type能够创建method,那么就肯定能隐式的满足某些interface.我们以HTTP handler
为例讲解一下:
<ol class="org-ol">
<li>首先讲讲在没有function type帮助的情况下,如何让go处理不同path的请求
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-16 16:46:56</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"net/http"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">HelloWorldHandler</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #268bd2;">{}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">h</span> <span style="color: #b58900; font-style: italic;">HelloWorldHandler</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">ServeHTTP</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Fprintf</span><span style="color: #d33682;">(</span>w, <span style="color: #2aa198;">"HelloWorld!"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Ping</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #268bd2;">{}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">h</span> <span style="color: #b58900; font-style: italic;">Ping</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">ServeHTTP</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Fprintf</span><span style="color: #d33682;">(</span>w, <span style="color: #2aa198;">"Pong!"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #268bd2;">hw</span> := <span style="color: #b58900; font-style: italic;">HelloWorldHandler</span><span style="color: #d33682;">{}</span>
        <span style="color: #268bd2;">p</span> := <span style="color: #b58900; font-style: italic;">Ping</span><span style="color: #d33682;">{}</span>

        http.<span style="color: #b58900;">Handle</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/helloworld"</span>, hw<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">Handle</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/ping"</span>, p<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">ListenAndServe</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">":8889"</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&gt; curl http://localhost:8889/helloworld</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">HelloWorld!</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&gt; curl http://localhost:8889/ping</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Pong!</span>
</pre>
</div></li>
<li><p>
其中http.Handle的函数声明如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Handle</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">pattern</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">handler</span> <span style="color: #b58900; font-style: italic;">Handler</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
http.Handler就是我们的接口,定义如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Handler</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">ServeHTTP</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">ResponseWriter</span>, *<span style="color: #b58900; font-style: italic;">Request</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>我们可以看到,使用interface来作为参数的话,最大的问题就是每个path都需要创建类型,然后声明一个
instance,如果path很多的话,会声明非常多数量的instance.这显然是不够方便的</li>
</ul></li>
<li>然后我们来看看,go如何使用function type来替代interface作参数,从而减少类型和instance定义的数量的问题
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-16 19:05:39</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"net/http"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #268bd2;">myHelloWorldFunc</span> := <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Fprintf</span><span style="color: #859900;">(</span>w, <span style="color: #2aa198;">"HelloWorld!"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        http.<span style="color: #b58900;">HandleFunc</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/helloworld"</span>, myHelloWorldFunc<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">ListenAndServe</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">":8889"</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&gt; curl http://localhost:8889/helloworld</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">HelloWorld!</span>
</pre>
</div></li>
<li><p>
我们可以看到,我们不再使用http.Handle函数,而是使用http.HandleFunc函数,后者的第二个参数不再是
interface,而是一个function type.既然是是function type,那么能满足函数声明的就可以放下!HandleFunc
的定义如下,我们可以看到,第二个参数是一个function type
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">HandleFunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">pattern</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">handler</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">ResponseWriter</span>, *<span style="color: #b58900; font-style: italic;">Request</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        DefaultServeMux.<span style="color: #b58900;">HandleFunc</span><span style="color: #d33682;">(</span>pattern, handler<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
上面我们可以看到HandleFunc其实是使用DefaultSErveMux.HandleFunc来处理的.这个函数的实现如下,
你会看到,输入的函数最终被type convert成另外一种类型HandlerFunc
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">mux</span> *<span style="color: #b58900; font-style: italic;">ServeMux</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">HandleFunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">pattern</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">handler</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">ResponseWriter</span>, *<span style="color: #b58900; font-style: italic;">Request</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> handler == <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"http: nil handler"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        mux.<span style="color: #b58900;">Handle</span><span style="color: #d33682;">(</span>pattern, <span style="color: #b58900;">HandlerFunc</span><span style="color: #859900;">(</span>handler<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
整个过程最秒的一点就在这个HandlerFunc,它是一个function type, 作为type,它是可以实现接口的,于
是就实现了http.Handler接口. 又由于它自己是函数,而且函数的声明和这个接口里面唯一的函数ServeHTTP
一样.所以最终能够实现输入一个函数,就能完成原本需要一个type加一个instance的效果
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">HandlerFunc</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">ResponseWriter</span>, *<span style="color: #b58900; font-style: italic;">Request</span><span style="color: #268bd2;">)</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">ServeHTTP calls f(w, r).</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">HandlerFunc</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">ServeHTTP</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">Request</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">f</span><span style="color: #d33682;">(</span>w, r<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>最后注意!只有接口只有一个函数,才适合用function type替换interface作参数</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-org0669328" class="outline-3">
<h3 id="org0669328"><span class="section-number-3">7.14.</span> Implicit Interfaces Make Dependency injection Easier</h3>
<div class="outline-text-3" id="text-7-14">
<ul class="org-ul">
<li>很多时候使用全局变量是不好的做法,依赖注入就是为了规避全局变量的优点,同时让单元测试更简单</li>
<li>为了理解依赖注入,我们写了一个例子,并且按行分析这个例子:
<ul class="org-ul">
<li><p>
例子总体如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-17 21:01:38</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"net/http"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">LogOutput</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>message<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        userData <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sds</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">UserNameForID</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sds.userData<span style="color: #d33682;">[</span>userID<span style="color: #d33682;">]</span>
        <span style="color: #859900; font-weight: bold;">return</span> name, ok
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewSimpleDataStore</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">userData</span>: <span style="color: #859900; font-weight: bold;">map</span><span style="color: #859900;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span>
                        <span style="color: #2aa198;">"1"</span>: <span style="color: #2aa198;">"Fred"</span>,
                        <span style="color: #2aa198;">"2"</span>: <span style="color: #2aa198;">"Mary"</span>,
                        <span style="color: #2aa198;">"3"</span>: <span style="color: #2aa198;">"Pat"</span>,
                <span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">DataStore</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Logger</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">LoggerAdapter</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">lg</span> <span style="color: #b58900; font-style: italic;">LoggerAdapter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Log</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">lg</span><span style="color: #d33682;">(</span>message<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        l  <span style="color: #b58900; font-style: italic;">Logger</span>
        ds <span style="color: #b58900; font-style: italic;">DataStore</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sl</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayHello</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        sl.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in SayHello for "</span> + userID<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sl.ds.<span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"unknown user"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"Hello, "</span> + name, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sl</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayGoodbye</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        sl.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in SayGoodbye for "</span> + userID<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sl.ds.<span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"unknown user"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"Goodbye, "</span> + name, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewSimpleLogic</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">l</span> <span style="color: #b58900; font-style: italic;">Logger</span>, <span style="color: #268bd2;">ds</span> <span style="color: #b58900; font-style: italic;">DataStore</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">l</span>:  l,
                <span style="color: #6c71c4; font-weight: bold;">ds</span>: ds,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">SayHello</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Controller</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        l     <span style="color: #b58900; font-style: italic;">Logger</span>
        logic <span style="color: #b58900; font-style: italic;">Logic</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Controller</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayHello</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        c.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"In SayHello"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">userID</span> := r.URL.<span style="color: #b58900;">Query</span><span style="color: #d33682;">()</span>.<span style="color: #b58900;">Get</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"user_id"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">message</span>, <span style="color: #268bd2;">err</span> := c.logic.<span style="color: #b58900;">SayHello</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                w.<span style="color: #b58900;">WriteHeader</span><span style="color: #859900;">(</span>http.StatusBadRequest<span style="color: #859900;">)</span>
                w.<span style="color: #b58900;">Write</span><span style="color: #859900;">(</span><span style="color: #6c71c4;">[]</span><span style="color: #b58900;">byte</span><span style="color: #6c71c4;">(</span>err.<span style="color: #b58900;">Error</span><span style="color: #35a69c;">()</span><span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">return</span>
        <span style="color: #d33682;">}</span>
        w.<span style="color: #b58900;">Write</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900;">byte</span><span style="color: #859900;">(</span>message<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewController</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">l</span> <span style="color: #b58900; font-style: italic;">Logger</span>, <span style="color: #268bd2;">logic</span> <span style="color: #b58900; font-style: italic;">Logic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">Controller</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">Controller</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">l</span>:     l,
                <span style="color: #6c71c4; font-weight: bold;">logic</span>: logic,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">l</span> := <span style="color: #b58900;">LoggerAdapter</span><span style="color: #d33682;">(</span>LogOutput<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ds</span> := <span style="color: #b58900;">NewSimpleDataStore</span><span style="color: #d33682;">()</span>
        <span style="color: #268bd2;">logic</span> := <span style="color: #b58900;">NewSimpleLogic</span><span style="color: #d33682;">(</span>l, ds<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">c</span> := <span style="color: #b58900;">NewController</span><span style="color: #d33682;">(</span>l, logic<span style="color: #d33682;">)</span>

        http.<span style="color: #b58900;">HandleFunc</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/hello"</span>, c.SayHello<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">ListenAndServe</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">":8080"</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&gt; curl http://localhost:8080/hello?user_id=1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Hello, Fred</span>
</pre>
</div></li>
<li>我们逐行来分析一下,总体上来说,这是一个web service.我们要处理一个/hello的path,然后我们要一个满
足函数声明为(w http.ResponseWriter, r *http.Request)的function或者method.我们这里明显是一个method
不再是一个function,因为真实的web service handler肯定是结合了数据库,logger等结构体,不是一个function
能够完成的</li>
<li><p>
对于日志,假设我们已经有了一个utility function
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">LogOutput</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>message<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
我们还需要数据库,这里我们使用一个map来模拟数据库. 使用一个函数UserNameForID来读取某个id对应的
username.同时我们还需要一个工厂函数来创建一个instance
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        userData <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sds</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">UserNameForID</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sds.userData<span style="color: #d33682;">[</span>userID<span style="color: #d33682;">]</span>
        <span style="color: #859900; font-weight: bold;">return</span> name, ok
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewSimpleDataStore</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">SimpleDataStore</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">userData</span>: <span style="color: #859900; font-weight: bold;">map</span><span style="color: #859900;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">{</span>
                        <span style="color: #2aa198;">"1"</span>: <span style="color: #2aa198;">"Fred"</span>,
                        <span style="color: #2aa198;">"2"</span>: <span style="color: #2aa198;">"Mary"</span>,
                        <span style="color: #2aa198;">"3"</span>: <span style="color: #2aa198;">"Pat"</span>,
                <span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>辅助函数和辅助数据源写完了,我们这里需要开始处理业务逻辑了.我们的业务逻辑就是根据id从数据源中
获取到用户名,然后给这个用户说hello和goodbye.由于我们不想依赖LogOutput这个函数,和SimpleDataStore
这个struct(因为我们可能换logger,也可能换数据源),那么我们要为这两个依赖创建interface:
<ol class="org-ol">
<li><p>
对于数据源,我们设计了DataStore interface,虽然interface是后设计的,但是由于go是implicit interface,
所以我们的SimpleDataStore已经实现这个接口了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">DataStore</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
对于LogOutput我们创建一个interface,然后还要在创建一个function type来让我们的utility function
能够实现接口
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Logger</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">LoggerAdapter</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">lg</span> <span style="color: #b58900; font-style: italic;">LoggerAdapter</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Log</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">message</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">lg</span><span style="color: #d33682;">(</span>message<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ol></li>
<li><p>
前面说了,我们这里http handler必须用method,就是为了从struct里面获得log和数据库的支持.所以我们
要创建一个struct,包裹这两个支持.然后在这个struct上面完成业务逻辑(就是读取用户名,给与hello和goodbye)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        l  <span style="color: #b58900; font-style: italic;">Logger</span>
        ds <span style="color: #b58900; font-style: italic;">DataStore</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sl</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayHello</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        sl.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in SayHello for "</span> + userID<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sl.ds.<span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"unknown user"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"Hello, "</span> + name, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sl</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayGoodbye</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        sl.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in SayGoodbye for "</span> + userID<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">name</span>, <span style="color: #268bd2;">ok</span> := sl.ds.<span style="color: #b58900;">UserNameForID</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"unknown user"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"Goodbye, "</span> + name, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>可以看到我们的SimpleLogic虽然依赖了log和数据源,但是我们依赖的是interface,而不是具体的concrete
type,我们后面想换其他的concrete type完全没有任何负担.更重要的是,我们的concrete甚至不需要知道
interface的存在,这就意味着更改concrete type比起java来说,更加容易:
<ol class="org-ol">
<li>在golang里面,我们甚至可以把concrete type换成一个不知道源代码的library里面的concrete type,只
要函数声明一样</li>
<li>但是在java里面,我们不可能换一个另外不知道源码library里面的concrete type, 因为你不可能添加
一个implements interfaceA到这个源码里面</li>
</ol></li>
<li>但是注意java其实是不行的,因为java虽然有
interface,但是它是explicit interface,其interface还是会绑定client和provider到一块.我们可以看看
java的例子如下</li>
<li><p>
我们还要为SimpleLogic创建工厂函数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewSimpleLogic</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">l</span> <span style="color: #b58900; font-style: italic;">Logger</span>, <span style="color: #268bd2;">ds</span> <span style="color: #b58900; font-style: italic;">DataStore</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">SimpleLogic</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">l</span>:  l,
                <span style="color: #6c71c4; font-weight: bold;">ds</span>: ds,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
真正的http handler要满足(w http.ResponseWriter, r *http.Request)这个函数声明的,所以我们还得创
建一个struct来实现这个method,随便在这个struct里面包含log和数据源.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Logic</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">SayHello</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">userID</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Controller</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        l     <span style="color: #b58900; font-style: italic;">Logger</span>
        logic <span style="color: #b58900; font-style: italic;">Logic</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">c</span> <span style="color: #b58900; font-style: italic;">Controller</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">SayHello</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        c.l.<span style="color: #b58900;">Log</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"In SayHello"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">userID</span> := r.URL.<span style="color: #b58900;">Query</span><span style="color: #d33682;">()</span>.<span style="color: #b58900;">Get</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"user_id"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">message</span>, <span style="color: #268bd2;">err</span> := c.logic.<span style="color: #b58900;">SayHello</span><span style="color: #d33682;">(</span>userID<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                w.<span style="color: #b58900;">WriteHeader</span><span style="color: #859900;">(</span>http.StatusBadRequest<span style="color: #859900;">)</span>
                w.<span style="color: #b58900;">Write</span><span style="color: #859900;">(</span><span style="color: #6c71c4;">[]</span><span style="color: #b58900;">byte</span><span style="color: #6c71c4;">(</span>err.<span style="color: #b58900;">Error</span><span style="color: #35a69c;">()</span><span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">return</span>
        <span style="color: #d33682;">}</span>
        w.<span style="color: #b58900;">Write</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900;">byte</span><span style="color: #859900;">(</span>message<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
上面的代码和我们想的又有差距,因为我们的新struct包含了log和Logic interface,而不是我们以为的log
和数据源. 这个Logic interface是新创建的,里面有一个SayHello的函数,这个函数是之前的SimpleLogic这
个struct所隐式实现的.所以我们就能以SimpleLogic来传入这个Controller的logic field啦,而且是接口
和实现解耦了,新的工厂函数如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NewController</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">l</span> <span style="color: #b58900; font-style: italic;">Logger</span>, <span style="color: #268bd2;">logic</span> <span style="color: #b58900; font-style: italic;">Logic</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">Controller</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">Controller</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">l</span>:     l,
                <span style="color: #6c71c4; font-weight: bold;">logic</span>: logic,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
最终的main函数如下,我们其实也预料到了Controller的instance其实传入了两个log, 本身一个,logic field
一个
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #268bd2;">l</span> := <span style="color: #b58900;">LoggerAdapter</span><span style="color: #d33682;">(</span>LogOutput<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ds</span> := <span style="color: #b58900;">NewSimpleDataStore</span><span style="color: #d33682;">()</span>
        <span style="color: #268bd2;">logic</span> := <span style="color: #b58900;">NewSimpleLogic</span><span style="color: #d33682;">(</span>l, ds<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">c</span> := <span style="color: #b58900;">NewController</span><span style="color: #d33682;">(</span>l, logic<span style="color: #d33682;">)</span>

        http.<span style="color: #b58900;">HandleFunc</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/hello"</span>, c.SayHello<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">ListenAndServe</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">":8080"</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org897d284" class="outline-3">
<h3 id="org897d284"><span class="section-number-3">7.15.</span> Wire</h3>
<div class="outline-text-3" id="text-7-15">
<ul class="org-ul">
<li>如果你感觉手写依赖注入很麻烦,可以使用Wire,这个是一个Google出品的dependency injection helper.它可
以自己动生产concrete type</li>
</ul>
</div>
</div>
<div id="outline-container-org7b18b99" class="outline-3">
<h3 id="org7b18b99"><span class="section-number-3">7.16.</span> Go Isn't Particularly Object-Oriented (and That's Great)</h3>
<div class="outline-text-3" id="text-7-16">
<ul class="org-ul">
<li>经过本章的学习,我们可以看到我们很难把Go判断成那种类型的编程语言:
<ul class="org-ul">
<li>可能是不是一个面向过程的语言</li>
<li>但是在面向对象方面,它也缺少了继承,重载等概念</li>
<li>Go拥有function type和closure,但是它也不是一个functional语言</li>
</ul></li>
<li>如果非要给Go一个定义的话,它是一个实干型(practical)的语言,它从各种地方借鉴概念只为让自己能够拥有
如下特点:
<ul class="org-ul">
<li>simple</li>
<li>readable</li>
<li>maintainable</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc8d3e7c" class="outline-2">
<h2 id="orgc8d3e7c"><span class="section-number-2">8.</span> Errors</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orgeb8d996" class="outline-3">
<h3 id="orgeb8d996"><span class="section-number-3">8.1.</span> How to Handle errors: The Basics</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>我们前面讲到过,go处理错误主要依靠的是一个convention: 函数的最后一个参数是error类型的value,用来
返回错误:
<ul class="org-ul">
<li>如果函数正常运行完成,那么,返回nil</li>
<li>如果函数运行中出了问题,那么返回一个error value</li>
</ul></li>
<li>调用函数A的函数B会检查函数A的error:
<ul class="org-ul">
<li>如果是nil那就跳过</li>
<li>如果不是nil,如果自己能处理,那么就处理</li>
<li>如果不是nil,如果自己不能处理,那么就包裹一下,返回自己的error value</li>
</ul></li>
<li>我们可以使用errors package里面的New函数来从字符串创建一个error value</li>
<li>error value的error message不能有首字母大写的单词</li>
<li>绝大部分情况下,如果一个non-nil error value返回的情况下,和他一起返回的其他值要值为zero-value.唯一
的例外是当error是sentinel error的时候</li>
<li><p>
和使用exception的语言不通,GO没有特殊的结构来处理这种情况,只是使用if来check error variable是否为nil,
如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">remainder</span>, <span style="color: #268bd2;">mod</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">calcRemainderAndMod</span><span style="color: #268bd2;">(</span>numerator, denominator<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>err<span style="color: #d33682;">)</span>
        os.<span style="color: #b58900;">Exit</span><span style="color: #d33682;">(</span>1<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
error是一个内置的interface,其只定义了一个method
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Error</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>所有实现这个interface的类型都会被认为是error类型. 当没有错误的时候我们返回nil,也是因为nil就是interface
type的zero value</li>
<li>至于Exception和go的错误处理哪个更好,我们先不做讨论.但是需要注意的是,go的错误处理虽然可以使用如下
两种方式来忽略,但是除了极个别情况(比如fmt.Println),都不要忽略错误:
<ul class="org-ul">
<li>使用underscore(_) 来忽略最后一个返回值</li>
<li>忽略所有的返回值,当然也包裹error value</li>
</ul></li>
<li>在Go里面,error handling是在if statement里面,而bussiness logic并不是.这就给了代码阅读者一个明显的
提示:哪个是正常逻辑,哪个是错误逻辑</li>
</ul>
</div>
</div>
<div id="outline-container-org97cb9bd" class="outline-3">
<h3 id="org97cb9bd"><span class="section-number-3">8.2.</span> Use Strings for Simple Errors</h3>
<div class="outline-text-3" id="text-8-2">
<ul class="org-ul">
<li>主要有两种方法来创建error value:
<ul class="org-ul">
<li>使用errors.New</li>
<li>使用fmt.Errorf</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgff5d5c0" class="outline-3">
<h3 id="orgff5d5c0"><span class="section-number-3">8.3.</span> Sentinel Errors</h3>
<div class="outline-text-3" id="text-8-3">
<ul class="org-ul">
<li>有些error是可以让用户自己去用一个字符串去描述一下,然后传递给调用方的.这个字符串的创建比较随机</li>
<li>还有些情况的error比较严重,函数想告诉自己的调用方,自己由于"某些特定的原因",已经不能运行了.这种错
误有两个特点:
<ul class="org-ul">
<li>严重的不能继续运行</li>
<li>原因是特定的,甚至是调用方和函数都约定好的几种错误</li>
</ul></li>
<li>这种情况的错误有个特殊的名字,叫做哨兵错误(sentinel errors), 从convention上面,它们有如下特点:
<ul class="org-ul">
<li>定义在package level</li>
<li>以Err开头</li>
<li>应该被当做read-only的变量(没有编译器的帮助,纯粹靠convention)</li>
</ul></li>
<li>举个例子,在archive/zip package里面,定义了很多哨兵错误:
<ul class="org-ul">
<li><p>
其中一个叫ErrFormat,这个错误代表要解压的不是zip格式,源代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> zip

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"bufio"</span>
        <span style="color: #2aa198;">"encoding/binary"</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"hash"</span>
        <span style="color: #2aa198;">"hash/crc32"</span>
        <span style="color: #2aa198;">"io"</span>
        <span style="color: #2aa198;">"io/fs"</span>
        <span style="color: #2aa198;">"os"</span>
        <span style="color: #2aa198;">"path"</span>
        <span style="color: #2aa198;">"sort"</span>
        <span style="color: #2aa198;">"strings"</span>
        <span style="color: #2aa198;">"sync"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">(</span>
        <span style="color: #268bd2;">ErrFormat</span>    = errors.<span style="color: #b58900;">New</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"zip: not a valid zip file"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ErrAlgorithm</span> = errors.<span style="color: #b58900;">New</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"zip: unsupported compression algorithm"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ErrChecksum</span>  = errors.<span style="color: #b58900;">New</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"zip: checksum error"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
使用的例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-25 22:56:43</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"archive/zip"</span>
        <span style="color: #2aa198;">"bytes"</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">data</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900;">byte</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"This is not a zip file"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">notAZipFile</span> := bytes.<span style="color: #b58900;">NewReader</span><span style="color: #d33682;">(</span>data<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">err</span> := zip.<span style="color: #b58900;">NewReader</span><span style="color: #d33682;">(</span>notAZipFile, <span style="color: #b58900;">int64</span><span style="color: #859900;">(</span><span style="color: #d33682; font-style: italic;">len</span><span style="color: #6c71c4;">(</span>data<span style="color: #6c71c4;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err == zip.ErrFormat <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Told you so"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Told you so</span>
</pre>
</div></li>
</ul></li>
<li>需要注意我们实在需要哨兵错误才要定义,因为定义哨兵错误要承担很多责任:
<ul class="org-ul">
<li>一旦定义了它,那么它就是你public API的一部分,你要在后续版本中保持兼容性(所以如果标准库中有相同
的error,那么应该使用标准库中的错误)</li>
</ul></li>
<li><p>
测试哨兵错误很简单,使用==就可以,前面的例子中已经有了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">err</span> := zip.<span style="color: #b58900;">NewReader</span><span style="color: #268bd2;">(</span>notAZipFile, <span style="color: #b58900;">int64</span><span style="color: #d33682;">(</span><span style="color: #d33682; font-style: italic;">len</span><span style="color: #859900;">(</span>data<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err == zip.ErrFormat <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Told you so"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdf7a11d" class="outline-3">
<h3 id="orgdf7a11d"><span class="section-number-3">8.4.</span> Errors Are Values</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li>由于error是一个interface,所以除了string我们还是可以在我们的error value里面包含其他的信息的,只要
实现Error() method就好.</li>
<li>下面就是一个为error value增加int信息的例子:
<ul class="org-ul">
<li><p>
新error type例子定义如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-26 21:12:03</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Status</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">(</span>
        <span style="color: #6c71c4; font-weight: bold;">InvalidLogin</span> <span style="color: #b58900; font-style: italic;">Status</span> = <span style="color: #6c71c4; font-weight: bold;">iota</span> + 1
        <span style="color: #6c71c4; font-weight: bold;">NotFound</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">StatusErr</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Status  <span style="color: #b58900; font-style: italic;">Status</span>
        Message <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">se</span> <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Error</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> se.Message
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">login</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">uid</span>, <span style="color: #268bd2;">pwd</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"incorrect username and password"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">LoginAndGetData</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">uid</span>, <span style="color: #268bd2;">pwd</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">login</span><span style="color: #d33682;">(</span>uid, pwd<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">Status</span>:  InvalidLogin,
                        <span style="color: #6c71c4; font-weight: bold;">Message</span>: fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"invalid credentials for user %s"</span>, uid<span style="color: #6c71c4;">)</span>,
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">ret</span> := <span style="color: #b58900;">LoginAndGetData</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"username"</span>, <span style="color: #2aa198;">"password"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>ret<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">invalid credentials for user username</span>
</pre>
</div></li>

<li>我们看到,即便定义了自己的error type,但是我们返回error result的时候,还是使用了error interface,
这是因为这样可以让我们的function以后返回不是我们error type的其他error,同时还能让caller不依赖
我们的error type</li>
</ul></li>
<li>使用自己的error type有一个大坑:那就是不能先声明一个自己的error type的instance(未初始化的),然后:
<ul class="org-ul">
<li>如果有错误就设置相应的field并且返回错误</li>
<li>如果没有错误就直接返回未初始化的instance</li>
</ul></li>
<li>这个错误的原因在于:
<ol class="org-ol">
<li>error是一个interface,对于一个interface来说,其为nil要满足两个条件:
<ul class="org-ul">
<li>指向underlying type(实现这个interface的type)的指针为nil</li>
<li>指向underlying value(上述type的instance)的指针也为nil</li>
</ul></li>
<li><p>
一旦使用自己的erro type创建一个instance,返回值这个interface的"指向underlying type的指针"肯定
就不是nil了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-02-26 21:43:44</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Status</span> <span style="color: #b58900; font-style: italic;">int</span>

<span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">(</span>
        <span style="color: #6c71c4; font-weight: bold;">InvalidLogin</span> <span style="color: #b58900; font-style: italic;">Status</span> = <span style="color: #6c71c4; font-weight: bold;">iota</span> + 1
        <span style="color: #6c71c4; font-weight: bold;">NotFound</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">StatusErr</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Status  <span style="color: #b58900; font-style: italic;">Status</span>
        Message <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">se</span> <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Error</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> se.Message
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">GenerateError</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">flag</span> <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">genErr</span> <span style="color: #b58900; font-style: italic;">StatusErr</span>
        <span style="color: #859900; font-weight: bold;">if</span> flag <span style="color: #d33682;">{</span>
                genErr = <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">Status</span>: NotFound,
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> genErr
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errTrue</span> := <span style="color: #b58900;">GenerateError</span><span style="color: #d33682;">(</span><span style="color: #6c71c4; font-weight: bold;">true</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errTrue != <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">errFalse</span> := <span style="color: #b58900;">GenerateError</span><span style="color: #d33682;">(</span><span style="color: #6c71c4; font-weight: bold;">false</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errFalse != <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
</pre>
</div></li>
</ol></li>
<li>上面的问题正确的写法应该是如下两种:
<ul class="org-ul">
<li><p>
直接返回nil,不要创建一个为初始化的instance
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">GenerateError</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">flag</span> <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> flag <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">Status</span>: NotFound
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
local instance创建成error interface类型的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">GenerateError</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">flag</span> <span style="color: #b58900; font-style: italic;">bool</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">genErr</span> <span style="color: #b58900; font-style: italic;">error</span>
        <span style="color: #859900; font-weight: bold;">if</span> flag <span style="color: #d33682;">{</span>
                genErr = <span style="color: #b58900; font-style: italic;">StatusErr</span><span style="color: #859900;">{</span>
                        <span style="color: #6c71c4; font-weight: bold;">Status</span>: NotFound,
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> genErr
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc9ae752" class="outline-3">
<h3 id="orgc9ae752"><span class="section-number-3">8.5.</span> Wrapping Errors</h3>
<div class="outline-text-3" id="text-8-5">
<ul class="org-ul">
<li><p>
在1.13版本之前,我们如果想给已有error增加点信息的话,如果不借助额外的手段,那么必然会创建新的error.
老的error就再也找不到了
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errOld</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"%s"</span>, <span style="color: #2aa198;">"original error"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errNew</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"another error: %v"</span>, errOld<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errNew<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">another error: original error</span>
</pre>
</div></li>
<li>为了解决这个问题,go1.13创建了一个新的概念wrapped error,就是能够存储original error的情况下添加新的信息:
<ul class="org-ul">
<li><p>
使用的例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">e</span> := errors.<span style="color: #b58900;">New</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"origin error"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">w</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Wrap a error: %w"</span>, e<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errors.<span style="color: #b58900;">Unwrap</span><span style="color: #859900;">(</span>w<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">errors.Is</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errors.<span style="color: #b58900;">Is</span><span style="color: #859900;">(</span>w, e<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errors.<span style="color: #b58900;">Is</span><span style="color: #859900;">(</span>w, w<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>errors.<span style="color: #b58900;">Is</span><span style="color: #859900;">(</span>e, w<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">errors.As</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"non-existing"</span><span style="color: #d33682;">)</span>; err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">pathError</span> *<span style="color: #b58900; font-style: italic;">os.PathError</span>
                <span style="color: #859900; font-weight: bold;">if</span> errors.<span style="color: #b58900;">As</span><span style="color: #859900;">(</span>err, &amp;pathError<span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"Failed at path:"</span>, pathError.Path<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>err<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">origin error</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">false</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Failed at path: non-existing</span>
</pre>
</div></li>
<li><p>
其原理是使用两个field来存储信息,一个field存储原error,一个field存储新的message
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">wrapError</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        msg <span style="color: #b58900; font-style: italic;">string</span>
        err <span style="color: #b58900; font-style: italic;">error</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">e</span> *<span style="color: #b58900; font-style: italic;">wrapError</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Error</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> e.msg
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">e</span> *<span style="color: #b58900; font-style: italic;">wrapError</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Unwrap</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> e.err
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>当你在保证老的error的基础上再添加额外的信息,这个过程就叫做wrapping the error. 当你有一系列的wrapped
error的时候, 这一系列的错误叫做error chain</li>
<li><p>
前面的例子我们可以看到,wrap error没有使用新的函数,还是使用fmt.Errorf来wrap已有error,只不过不再使
用%v,而是使用新的%w. %w的使用还默认含有一个convention: %w在error信息的最后面
</p>
<pre class="example" id="orge31147e">
%w at the endof the error format string and make the error to be wrapped
the last parametr passed to fmt.Errorf
</pre></li>
<li><p>
标准库还提供了一个函数Unwrap来提取被包裹的error(如果没有被包裹的error,那么返回nil)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">e</span> := errors.<span style="color: #b58900;">New</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"origin error"</span><span style="color: #268bd2;">)</span>
<span style="color: #268bd2;">w</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"Wrap a error: %w"</span>, e<span style="color: #268bd2;">)</span>
fmt.<span style="color: #b58900;">Println</span><span style="color: #268bd2;">(</span>errors.<span style="color: #b58900;">Unwrap</span><span style="color: #d33682;">(</span>w<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>实际代码当中,使用Unwrap不多,还是使用errors.Is和errors.As为主</li>
</ul>
</div>
</div>
<div id="outline-container-orgc4785c3" class="outline-3">
<h3 id="orgc4785c3"><span class="section-number-3">8.6.</span> Is and As</h3>
<div class="outline-text-3" id="text-8-6">
<ul class="org-ul">
<li>如果哨兵错误(sentinel error)被wrap了的话,我们就不能再使用==来check了,因为我们的error可能包裹了很
多层,在最里面才是某个sentinel error,这个时候要使用errors.Is</li>
<li><p>
errors.Is函数的声明如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Is</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">err</span>, <span style="color: #268bd2;">target</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #268bd2;">{</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>errors.Is在作用是想检查一下参数err的error chain里面是否含有参数target:
<ul class="org-ul">
<li><p>
图8-1-1
</p>

<div id="orgfc9589a" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/8-1-1.png" alt="8-1-1.png" />
</p>
<p><span class="figure-number">Figure 10: </span>lg/8-1-1.png</p>
</div></li>
<li>如上图,我们可以看到error wrapper2的error chain里面的任何一个error和target相等的话,都会返回true:
<ol class="org-ol">
<li>error wrapper 2</li>
<li>error wrapper 1</li>
<li>core error</li>
</ol></li>
<li><p>
下面的例子中,我们使用os.ErrNotExist来代表core error
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">fileChecker</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">name</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span>name<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Errorf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in fileChecker: %w"</span>, err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        f.<span style="color: #b58900;">Close</span><span style="color: #d33682;">()</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">errorWrapper1</span> := <span style="color: #b58900;">fileChecker</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"non-existing"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errorWrapper2</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"wrapper2 : %w"</span>, errorWrapper1<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> errors.<span style="color: #b58900;">Is</span><span style="color: #d33682;">(</span>errorWrapper2, os.ErrNotExist<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"errorWrapper2 error chain contains ErrNotExist"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">errorWrapper2 error chain contains ErrNotExist</span>
</pre>
</div></li>
</ul></li>
<li>errors.As的作用是check我们的error(包括其error chain上的所有error)是否能match一个特定的类型.如果
match的话,把这个error(或者error chain上的error)赋值给这个类型的instance</li>
<li><p>
errors.As的原型如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">As</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span>, <span style="color: #268bd2;">target</span> <span style="color: #b58900; font-style: italic;">any</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">bool</span>
</pre>
</div></li>
<li>第二个参数以any(也就是interface{}给出),是因为errors.As有两种使用方法:
<ol class="org-ol">
<li><p>
把error(或者其error chain中某个error) convert成能够赋值给target的instance,这种情况下target必须是指向某种类型的指针
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">fileChecker</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">name</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span>name<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Errorf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in fileChecker: %w"</span>, err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        f.<span style="color: #b58900;">Close</span><span style="color: #d33682;">()</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errorWrapper1</span> := <span style="color: #b58900;">fileChecker</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"non-existing"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errorWrapper2</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"wrapper2 : %w"</span>, errorWrapper1<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">pathError</span> *<span style="color: #b58900; font-style: italic;">os.PathError</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>pathError == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> errors.<span style="color: #b58900;">As</span><span style="color: #d33682;">(</span>errorWrapper2, &amp;pathError<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Failed at path:"</span>, pathError.Path<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"errWrapper2 can not convert to os.PathError"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Failed at path: non-existing</span>
</pre>
</div></li>
<li><p>
判断error(或者其error chain中某个error)是否能convert成target这种interface,这种情况下target只要是interface类型就可以.
这种情况下,也同样会发生赋值.只不过是这个interface的"指向类型的指针"指向类型,"指向对象的指针"
指向了这个error unwrap后的地址
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">ResourceErr</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Resource <span style="color: #b58900; font-style: italic;">string</span>
        Code     <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">re</span> <span style="color: #b58900; font-style: italic;">ResourceErr</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Error</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"%s: %d"</span>, re.Resource, re.Code<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">re</span> <span style="color: #b58900; font-style: italic;">ResourceErr</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Coder</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> re.Code
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">reChecker</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">name</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in reChecker: %w"</span>, <span style="color: #b58900; font-style: italic;">ResourceErr</span><span style="color: #859900;">{</span>name, 1<span style="color: #859900;">}</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errorWrapper1</span> := <span style="color: #b58900;">reChecker</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"original string"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">errorWrapper2</span> := fmt.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"wrapper2 : %w"</span>, errorWrapper1<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">coder</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #d33682;">{</span>
                <span style="color: #b58900;">Coder</span><span style="color: #859900;">()</span> <span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>coder == <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> errors.<span style="color: #b58900;">As</span><span style="color: #d33682;">(</span>errorWrapper2, &amp;coder<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>coder.<span style="color: #b58900;">Coder</span><span style="color: #6c71c4;">()</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"errWrapper2 can not convert to ResourceErr"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">true</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
</pre>
</div></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-org4e97161" class="outline-3">
<h3 id="org4e97161"><span class="section-number-3">8.7.</span> Wrapping Errors with defer</h3>
<div class="outline-text-3" id="text-8-7">
<ul class="org-ul">
<li>有些情况下,我们要wrap 很多error,而且除了err其他部分的message都是一样的,我们可以选择使用defer来
简化代码. 换句话说,下面两个代码是等价的
<ul class="org-ul">
<li><p>
普通版本
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">DoSomeThings</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val1</span>, <span style="color: #268bd2;">int</span>, <span style="color: #268bd2;">val2</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">val3</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">doThing1</span><span style="color: #d33682;">(</span>val1<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, fmt.<span style="color: #b58900;">Errorf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in DoSomethings: %w"</span>, err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">val4</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">doThing2</span><span style="color: #d33682;">(</span>val2<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, fmt.<span style="color: #b58900;">Errorf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in DoSomethings: %w"</span>, err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">result</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">doThing3</span><span style="color: #d33682;">(</span>val3, val4<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, fmt.<span style="color: #b58900;">Errorf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in DoSomethings: %w"</span>, err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> result, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
使用defer简化版本,注意这里我们name了return value err,所以按说name了一个return value, 所有return
value都要name, 但是第一个参数不好name,我们就设置成了"_"(return的时候,只return第一个参数就好了).
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">DoSomeThings</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val1</span>, <span style="color: #268bd2;">int</span>, <span style="color: #268bd2;">val2</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">_</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">defer</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        err = fmt.<span style="color: #b58900;">Errorf</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"in DoSomeThings: %w"</span>, err<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}()</span>

        <span style="color: #268bd2;">val3</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">doThing1</span><span style="color: #d33682;">(</span>val1<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>,err
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">val4</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">doThing2</span><span style="color: #d33682;">(</span>val2<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, err
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">doThing3</span><span style="color: #d33682;">(</span>val3, val4<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7e83530" class="outline-3">
<h3 id="org7e83530"><span class="section-number-3">8.8.</span> panic and recover</h3>
<div class="outline-text-3" id="text-8-8">
<ul class="org-ul">
<li>当go runtime不知道下一步该如何行动的时候,go会发出panic. 可能的无法继续行动的原因有:
<ul class="org-ul">
<li>programming error: 比如试图读取slice长度的下一个index</li>
<li>environmental problem: 比如内存使用完毕</li>
</ul></li>
<li>一旦panic发生:
<ul class="org-ul">
<li>当前的function马上退出</li>
<li>当前function相关的defer开始运行</li>
<li>当前function相关的所有的defer完成之后,calling function相关的defer开始运行,然后一直向上运行defer,
直到main函数的defer运行完毕</li>
<li>最后程序退出,并且打印message和stack trace</li>
</ul></li>
<li><p>
我们的代码自己也可以生成panic(当然要用在unrecoverable的问题上面),自带的panic函数会接受一个任意
类型的参数,通常来说是字符串类型.一个例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-02 11:06:26</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">doPanic</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">msg</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #d33682;">(</span>msg<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #b58900;">doPanic</span><span style="color: #d33682;">(</span>os.Args<span style="color: #859900;">[</span>0<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">panic: /var/folders/ch/9qfmpyfn0td4wh580lswbgyh0000gn/T/go-build3806617347/b001/exe/snippet</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">goroutine 1 [running]:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">main.doPanic(...)</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">/Users/fenghaoran/go/src/playground/at-2023-03-02-110626/snippet.go:19</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">main.main()</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">/Users/fenghaoran/go/src/playground/at-2023-03-02-110626/snippet.go:24 +0x85</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">exit status 2</span>
</pre>
</div></li>
<li>panic发生的话,程序会退出(并且不是很优雅,因为会打印stack trace),如果想优雅退出(或者不要退出,吞掉
panic继续运行),那么就要使用go提供的recover function</li>
<li>recover function是在defer里面运行的(因为即便panic了,也会运行defer). recover函数没有参数.返回值
有两种情况:
<ul class="org-ul">
<li>没有panic发生,那么返回值为nil</li>
<li>发生了panic, 返回值为panic的参数</li>
</ul></li>
<li><p>
一旦在recover被调用了,那么程序不会退出,而是继续运行,例子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-02 11:39:30</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">div60</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">i</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">defer</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">v</span> := <span style="color: #d33682; font-style: italic;">recover</span><span style="color: #859900;">()</span>; v != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>v<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>60 / i<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">val</span> := <span style="color: #859900; font-weight: bold;">range</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>1, 2, 0, 6<span style="color: #d33682;">}</span> <span style="color: #d33682;">{</span>
                <span style="color: #b58900;">div60</span><span style="color: #859900;">(</span>val<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">60</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">30</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">runtime error: integer divide by zero</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10</span>
</pre>
</div></li>
<li>虽然panic和recover看起来像exception处理,但是他们却不能像exception一样广泛的使用,它们设计只是用
在非常严重的情景(fatal situation)</li>
<li>如果程序panic的话,使用recover继续运行要非常小心:
<ul class="org-ul">
<li>绝大多数情况下,都不应该在panic之后使用recover继续运行.</li>
<li>绝大多数情况下,都应该在panic之后,使用recover log下当前的环境,并且优雅的使用os.Exit(1)退出</li>
</ul></li>
<li>之所以不能像依赖exception一样依赖panic和recover,是因为recover不能告诉我们什么位置可能会出错,而
且,recover设计就是用来log一下环境,然后优雅退出的.</li>
<li>有一种情况下,我们推荐使用recover. 那就是我们创建了一个第三方库,第三方库不应该自己panic,而应该把
panic包装成error,然调用者决定是否该panic</li>
</ul>
</div>
</div>
<div id="outline-container-org924e96d" class="outline-3">
<h3 id="org924e96d"><span class="section-number-3">8.9.</span> Getting a Stack Trace from an Error</h3>
<div class="outline-text-3" id="text-8-9">
<ul class="org-ul">
<li>新的go开发者之所以对panic和recover感兴趣,是因为他们能打印出stack trace, 但是error不能</li>
<li><p>
借助一些第三方库(比如github.com/pkg/errors)的帮助,我们也能在error打印的时候打印出stack trace,例
子如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-01 22:40:18</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>

        <span style="color: #2aa198;">"github.com/pkg/errors"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">err</span> := errors.<span style="color: #b58900;">Errorf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"whoops: %s"</span>, <span style="color: #2aa198;">"foo"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Printf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"%+v"</span>, err<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">whoops: foo</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">main.main</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">/Users/harri/go/src/playground/at-2023-03-01-224018/snippet.go:22</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">runtime.main</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">/opt/homebrew/Cellar/go/1.19.2/libexec/src/runtime/proc.go:250</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">runtime.goexit</span>
<span style="color: #96A7A9; font-style: italic;">//      </span><span style="color: #96A7A9; font-style: italic;">/opt/homebrew/Cellar/go/1.19.2/libexec/src/runtime/asm_arm64.s:1172</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org70d1c9a" class="outline-2">
<h2 id="org70d1c9a"><span class="section-number-2">9.</span> Modules, Packags, and Imports</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgeca176c" class="outline-3">
<h3 id="orgeca176c"><span class="section-number-3">9.1.</span> Repositories, Modules, and Packages</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>go里面的库管理主要有三个概念:
<ul class="org-ul">
<li>repository: 是版本管理的基本单位, 可以认为repository的root folder里面有.git文件夹</li>
<li>module: 一个repository里面可以有一个或者多个module.但是我们建议一个repository里面只有一个module.
module的root folder里面有go.mod文件</li>
<li>package: 一个module里面含有一个或者多个package, package是为了让module更好的组织代码</li>
</ul></li>
<li>如果我们想使用standard library以外的库,我们需要创建一个module,也就是在root folder创建go.mod文件.</li>
<li>go.mod文件里面会有当前project的global unique id,比如com.companyname.projectname.library</li>
</ul>
</div>
</div>
<div id="outline-container-orga6402aa" class="outline-3">
<h3 id="orga6402aa"><span class="section-number-3">9.2.</span> go.mod</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li><p>
我们希望使用命令行来创建go.mod,例子如下
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go mod init github.com/learning-go-book/money
go: creating new go.mod: module github.com/learning-go-book/money
$ cat go.mod
module github.com/learning-go-book/money

go 1.19
$ go get github.com/shopspring/decimal
go: downloading github.com/shopspring/decimal v1.3.1
go: added github.com/shopspring/decimal v1.3.1
$ cat go.mod
module github.com/learning-go-book/money

go 1.19

require github.com/shopspring/decimal v1.3.1 // indirect
$ go get github.com/learning-go-book/formatter
go: downloading github.com/learning-go-book/formatter v0.0.0-20200921021027-5abc380940ae
go: added github.com/learning-go-book/formatter v0.0.0-20200921021027-5abc380940ae
$ cat go.mod
module github.com/learning-go-book/money

go 1.19

<span style="color: #b58900;">require</span> <span style="color: #268bd2;">(</span>
        github.com/learning-go-book/formatter v0.0.0-20200921021027-5abc380940ae // indirect
        github.com/shopspring/decimal v1.3.1 // indirect
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>go.mod里面还有两个optional的区域:
<ul class="org-ul">
<li>replace用来替换默认的module位置</li>
<li>exclude用来防止特定版本的引入到module里面</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd649bff" class="outline-3">
<h3 id="orgd649bff"><span class="section-number-3">9.3.</span> Building Packages</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-orgeb1dfde" class="outline-4">
<h4 id="orgeb1dfde"><span class="section-number-4">9.3.1.</span> Imports and Exports</h4>
<div class="outline-text-4" id="text-9-3-1">
<ul class="org-ul">
<li>Go的import允许你acces其他package所有export的:
<ul class="org-ul">
<li>constant</li>
<li>variable</li>
<li>function</li>
<li>type</li>
</ul></li>
<li>在Go里面,如果想要某个identifier给export出来,需要把这个identifier的第一个字符大写,否则只有package
内部能看到这个identifier</li>
<li>所有export的identifer都是API的一部分,所有export的identifer都要document,并且保证向后兼容</li>
</ul>
</div>
</div>
<div id="outline-container-orgd4ce01c" class="outline-4">
<h4 id="orgd4ce01c"><span class="section-number-4">9.3.2.</span> Creating and Accessing a Package</h4>
<div class="outline-text-4" id="text-9-3-2">
<ul class="org-ul">
<li>我们下面来自己创建一个module,并且让用户来使用其中的两个package,注意go是可以单独import一个module
的某个package的,而不用import整个module:
<ul class="org-ul">
<li><p>
module有个文件夹math,其内部有一个math.go文件,其第一行标识自己为math package
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> math

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Double</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">a</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> a * 2
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
module还有个文件夹formatter,其内部有个formatter.go文件,其第一行标识自己为print package.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> print

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Format</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">num</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"The number is %d"</span>, num<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
使用举例如下,注意使用的时候print才是package名字,而不是folder的名字formatter
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>

        <span style="color: #2aa198;">"github.com/learning-go-book/package_example/formatter"</span>
        <span style="color: #2aa198;">"github.com/learning-go-book/package_example/math"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">num</span> := math.<span style="color: #b58900;">Double</span><span style="color: #d33682;">(</span>2<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">output</span> := print.<span style="color: #b58900;">Format</span><span style="color: #d33682;">(</span>num<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>output<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The number is 4</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org1e87221" class="outline-4">
<h4 id="org1e87221"><span class="section-number-4">9.3.3.</span> Naming Package</h4>
<div class="outline-text-4" id="text-9-3-3">
<ul class="org-ul">
<li>由于go不建议把一个package的所有name都import,从而在使用的时候只使用名字(这个是通过import "."来
实现的),所以go的package也可以看做函数名字的一部分,那么:
<ul class="org-ul">
<li>我们取名字不要这么取: util.ExtractNames, util.FormatNames</li>
<li>而是要创建两个package,分别取: extract.Names, format.Names</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org21f6b33" class="outline-4">
<h4 id="org21f6b33"><span class="section-number-4">9.3.4.</span> How to Organize Your Module</h4>
<div class="outline-text-4" id="text-9-3-4">
<ul class="org-ul">
<li>一开始不要分package,把所有代码放到一个package,后面再去优化</li>
<li>其他package建议学习Kat Zien在GopherCon 2018的发言</li>
</ul>
</div>
</div>
<div id="outline-container-org22216e4" class="outline-4">
<h4 id="org22216e4"><span class="section-number-4">9.3.5.</span> Overriding a Package's Name</h4>
<div class="outline-text-4" id="text-9-3-5">
<ul class="org-ul">
<li><p>
如果引入的两个package同名(就是global indentifer的最后面一样),那么我们可以重命名这个package,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        crand <span style="color: #2aa198;">"crypto/rand"</span>
        <span style="color: #2aa198;">"encoding/binary"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"math/rand"</span>
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org2e9596b" class="outline-4">
<h4 id="org2e9596b"><span class="section-number-4">9.3.6.</span> Package Comments and godoc</h4>
<div class="outline-text-4" id="text-9-3-6">
<ul class="org-ul">
<li>godoc可以自动把comment转换为文档</li>
<li>所有export identifer都应该有comment</li>
</ul>
</div>
</div>
<div id="outline-container-org0dc9d7d" class="outline-4">
<h4 id="org0dc9d7d"><span class="section-number-4">9.3.7.</span> The internal Package</h4>
<div class="outline-text-4" id="text-9-3-7">
<ul class="org-ul">
<li>一旦package被命名为internal, 那么这个package的export identifier只能被"父母"或"子女"package所看到</li>
</ul>
</div>
</div>
<div id="outline-container-orgcb5489a" class="outline-4">
<h4 id="orgcb5489a"><span class="section-number-4">9.3.8.</span> The init Function: Avoid if Possible</h4>
<div class="outline-text-4" id="text-9-3-8">
<ul class="org-ul">
<li>go为了让运行的时候哪个函数被调用更清晰的被程序员所发现,不惜放弃了对重载的支持</li>
<li><p>
但是init函数的设计,却又违背了这个理念:这个函数竟然不需要调用就会运行,init函数在package被其他package
所引用之前,自己先运行一下
</p>
<pre class="example" id="org18b3097">
init function runs the first time the package is referenced by another package
</pre></li>
<li>go运行一个package里面有多个init函数,甚至允许一个文件里面多个init函数,运行的顺序那就很难界定了.
我们也不用去记忆这个顺序,因为我们压根不推荐大家使用多个init函数</li>
<li><p>
如果你只想使用一个package的init函数(比如数据库library会用init函数来注册数据库驱动),而不使用这
个package的其他identifer,那么你需要使用blank import,也就是在import的package前面加个"_"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"database/sql"</span>
        _ <span style="color: #2aa198;">"github.com/lib/pq"</span>
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>init函数的最主要作用,是为了能够初始化某些package-level变量,这些package-level变量可能相互有依赖
关系,不能通过一个赋值来确定</li>
<li>对于所有的package-level变量,都应该是effectively immutable的(不是依赖编译器,而是依赖你代码的convention
来保证变量不被修改).因为mutable的package-level变量会让开发者难以理解你的application内部的data flow</li>
<li>我们推荐在一个package内部只有一个init函数</li>
<li>如果init函数需要load file或者访问网络,那么我们需要文档记录这件事情,这样不至于让security-conscious
用户使用的时候感到诧异</li>
</ul>
</div>
</div>
<div id="outline-container-org283536a" class="outline-4">
<h4 id="org283536a"><span class="section-number-4">9.3.9.</span> Circular Dependencies</h4>
<div class="outline-text-4" id="text-9-3-9">
<ul class="org-ul">
<li>Go的两个目标分别是fast compile和easy to understand source code,为了支持这两个目标,Go不支持circular dependency</li>
<li><p>
所谓循环依赖(circular dependency)是指,如果package A import了package B,那么package B就不能再import package A
</p>
<pre class="example" id="org28ca122">
If package A imports package B, directly or indirectly, package B can
not import package A, directly or indirectly
</pre></li>
<li>解决循环依赖的方法是把相互依赖的PackageA和PackageB合并成一个package</li>
</ul>
</div>
</div>
<div id="outline-container-org463bec1" class="outline-4">
<h4 id="org463bec1"><span class="section-number-4">9.3.10.</span> Gracefully Renaming and Reorganzing</h4>
<div class="outline-text-4" id="text-9-3-10">
<ul class="org-ul">
<li>如果你想rename已经export的type,那么你可能会用到alias.
<ul class="org-ul">
<li><p>
本来有个类型是Foo
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Foo</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        a <span style="color: #b58900; font-style: italic;">int</span>
        B <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Hello</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"hello"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">goodbye</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"goodbye"</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
我们的Type Foo想换一个名字叫Bar,那么就如下书写
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Bar</span> = <span style="color: #b58900; font-style: italic;">Foo</span>
</pre>
</div></li>
<li><p>
alias Bar甚至可以不需要type conversion就可以替代Foo
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-03 22:52:52</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Foo</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        a <span style="color: #b58900; font-style: italic;">int</span>
        B <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Hello</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"hello"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">Foo</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">goodbye</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"goodbye"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Bar</span> = <span style="color: #b58900; font-style: italic;">Foo</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">MakeBar</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">Bar</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">bar</span> := <span style="color: #b58900; font-style: italic;">Bar</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">a</span>: 20,
                <span style="color: #6c71c4; font-weight: bold;">B</span>: <span style="color: #2aa198;">"Hello"</span>,
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">f</span> <span style="color: #b58900; font-style: italic;">Foo</span> = bar

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>f.<span style="color: #b58900;">Hello</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> bar
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">b</span> := <span style="color: #b58900;">MakeBar</span><span style="color: #d33682;">()</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>b<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">hello</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{20 Hello}</span>
</pre>
</div></li>
</ul></li>
<li>注意alias只是type的一个别名,如果你想增加method或者field,需要加到原来的类型(比如Foo里面),而不是Bar里面</li>
<li>有两种identifer无法拥有alias:
<ul class="org-ul">
<li>package-level variable</li>
<li>field in a struct</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf4eaff9" class="outline-3">
<h3 id="orgf4eaff9"><span class="section-number-3">9.4.</span> Working with Modules</h3>
<div class="outline-text-3" id="text-9-4">
</div>
<div id="outline-container-org4f5c8a4" class="outline-4">
<h4 id="org4f5c8a4"><span class="section-number-4">9.4.1.</span> Importing Third-Party Code</h4>
<div class="outline-text-4" id="text-9-4-1">
<ul class="org-ul">
<li>所有的第三方package,都需要go get,然后会在如下两个文件中体现:
<ul class="org-ul">
<li>go.mod</li>
<li>go.sum</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgeefa053" class="outline-4">
<h4 id="orgeefa053"><span class="section-number-4">9.4.2.</span> Working with Versions</h4>
<div class="outline-text-4" id="text-9-4-2">
<ul class="org-ul">
<li>有时候,我们需要downgrade到某个特定的版本,这一节介绍如何做到</li>
<li>首先看一个例子,这个例子有bug
<ul class="org-ul">
<li><p>
go.mod内容如下
</p>
<div class="org-src-container">
<pre class="src src-conf">module playground/at-2023-03-04-113922

go 1.19

require (
        github.com/learning-go-book/simpletax v1.1.0 // indirect
        github.com/shopspring/decimal v1.2.0 // indirect
)
</pre>
</div></li>
<li><p>
main函数是有bug的,代码和输出如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-04 11:39:22</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>

        <span style="color: #2aa198;">"github.com/learning-go-book/simpletax"</span>
        <span style="color: #2aa198;">"github.com/shopspring/decimal"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">amount</span>, <span style="color: #268bd2;">_</span> := decimal.<span style="color: #b58900;">NewFromString</span><span style="color: #d33682;">(</span>os.Args<span style="color: #859900;">[</span>1<span style="color: #859900;">]</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">zip</span> := os.Args<span style="color: #d33682;">[</span>2<span style="color: #d33682;">]</span>
        <span style="color: #268bd2;">percent</span>, <span style="color: #268bd2;">err</span> := simpletax.<span style="color: #b58900;">TaxForZip</span><span style="color: #d33682;">(</span>zip<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
                os.<span style="color: #b58900;">Exit</span><span style="color: #859900;">(</span>1<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">total</span> := amount.<span style="color: #b58900;">Add</span><span style="color: #d33682;">(</span>amount.<span style="color: #b58900;">Mul</span><span style="color: #859900;">(</span>percent<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>.<span style="color: #b58900;">Round</span><span style="color: #d33682;">(</span>2<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>total<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">./snippet 99.99 12345</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">unknown zip: 12345</span>
</pre>
</div></li>
</ul></li>
<li>然后我们要使用go list来判断module(注意不是package, go get的单位是package,但是版本的单位是module)
能回滚到哪些版本:
<ul class="org-ul">
<li><p>
go list默认列出当前project用到的package. 需要加上-m来列出module(而不是package), -version会把
远程所有的版本列出来
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go list -m -versions github.com/learning-go-book/simpletax
github.com/learning-go-book/simpletax v1.0.0 v1.1.0
</pre>
</div></li>
<li><p>
我们看到离v1.1.0最近的版本是v1.0.0,那么我们使用go get回滚到这个版本
</p>
<div class="org-src-container">
<pre class="src src-shell">$ go get github.com/learning-go-book/simpletax@v1.0.0
go: downloading github.com/learning-go-book/simpletax v1.0.0
go: downgraded github.com/learning-go-book/simpletax v1.1.0 =&gt; v1.0.0
<span style="color: #268bd2;">(</span>py3env<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[</span>harri@harri-mac-mini ~/go/src/playground/at-2023-03-04-113922<span style="color: #268bd2;">]</span> 12:27:51 <span style="color: #268bd2;">[</span>proxy_set<span style="color: #268bd2;">]</span> <span style="color: #268bd2;">[</span>main !<span style="color: #268bd2;">]</span>
$ git status
On branch main
Your branch is up to date with <span style="color: #2aa198;">'origin/main'</span>.

Changes not staged for commit:
  <span style="color: #268bd2;">(</span>use <span style="color: #2aa198;">"git add &lt;file&gt;..."</span> to update what will be committed<span style="color: #268bd2;">)</span>
  <span style="color: #268bd2;">(</span>use <span style="color: #2aa198;">"git restore &lt;file&gt;..."</span> to discard changes<span style="color: #859900; font-weight: bold;"> in</span> working directory<span style="color: #268bd2;">)</span>
        modified:   go.mod
        modified:   go.sum

no changes added to commit <span style="color: #268bd2;">(</span>use <span style="color: #2aa198;">"git add"</span> and/or <span style="color: #2aa198;">"git commit -a"</span><span style="color: #268bd2;">)</span>
<span style="color: #268bd2;">(</span>py3env<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[</span>harri@harri-mac-mini ~/go/src/playground/at-2023-03-04-113922<span style="color: #268bd2;">]</span> 12:27:58 <span style="color: #268bd2;">[</span>proxy_set<span style="color: #268bd2;">]</span> <span style="color: #268bd2;">[</span>main !<span style="color: #268bd2;">]</span>
$ git diff
diff --git a/at-2023-03-04-113922/go.mod b/at-2023-03-04-113922/go.mod
index 030e27a..a20366e 100644
--- a/at-2023-03-04-113922/go.mod
+++ b/at-2023-03-04-113922/go.mod
@@ -3,6 +3,6 @@ module playground/at-2023-03-04-113922
 go 1.19

 require <span style="color: #268bd2;">(</span>
-       github.com/learning-go-book/simpletax v1.1.0 // indirect
+       github.com/learning-go-book/simpletax v1.0.0 // indirect
        github.com/shopspring/decimal v1.2.0 // indirect
 <span style="color: #268bd2;">)</span>
diff --git a/at-2023-03-04-113922/go.sum b/at-2023-03-04-113922/go.sum
index 5f968b4..5fa549d 100644
--- a/at-2023-03-04-113922/go.sum
+++ b/at-2023-03-04-113922/go.sum
@@ -1,3 +1,5 @@
+github.com/learning-go-book/simpletax v1.0.0 h1:iH+7ADkdyrSqrMR2GzuWSFznXhF/DTbApdwoJylUcCk=
+github.com/learning-go-book/simpletax v1.0.0/go.mod h1:/YqHwHy95m0M4Qo3DmXVYP1a5/stZ/YHI9mnkiPVtUg=
 github.com/learning-go-book/simpletax v1.1.0 h1:Z/6s1ydS/vjblI6PFuDEnxW8QgYjGI4wKAeP/7DKLQ0=
 github.com/learning-go-book/simpletax v1.1.0/go.mod h1:/YqHwHy95m0M4Qo3DmXVYP1a5/stZ/YHI9mnkiPVtUg=
 github.com/shopspring/decimal v1.2.0 h1:abSATXmQEYyShuxI4/vyW3tV1MrKAJzCZ/0zLUXYbsQ=
</pre>
</div></li>
<li><p>
更改之后我们的代码就成功运行了
</p>
<div class="org-src-container">
<pre class="src src-shell">$ ./snippet 99.99 12345
107.99
</pre>
</div></li>
</ul></li>
<li>go的版本一般写作v&lt;Major&gt;.&lt;Minor&gt;.&lt;Patch&gt; 这是Semantic Version版本的写法</li>
</ul>
</div>
</div>
<div id="outline-container-org0cb6af1" class="outline-4">
<h4 id="org0cb6af1"><span class="section-number-4">9.4.3.</span> Minimum Version Selection</h4>
<div class="outline-text-4" id="text-9-4-3">
<ul class="org-ul">
<li>在Go里面有这样一种情况: 多个module依赖另外一个module的不同版本.</li>
<li>这种情况下go的应对策略叫做minimum version selection: 简言之就是选取所依赖版本里面最新的一个,比如:
<ul class="org-ul">
<li>moduleA 依赖 moduleD的v1.1.0</li>
<li>moduleB 依赖 moduleD的v1.2.0</li>
<li>moduleC 依赖 moduleD的v1.2.3</li>
<li>那么最终Go只会引入一个moduleD,其版本是最新的版本v1.2.3.</li>
</ul></li>
<li>如果引入最新版本(只有minor.patch版本是不同的,major版本一样)不成功,那么go的推荐做法是联系library
的作者进行修改.毕竟minor.patch版本要保证向后兼容</li>
</ul>
</div>
</div>
<div id="outline-container-orgad3f8a9" class="outline-4">
<h4 id="orgad3f8a9"><span class="section-number-4">9.4.4.</span> Updating to Compatible Versions</h4>
<div class="outline-text-4" id="text-9-4-4">
<ul class="org-ul">
<li>我们刚才说了,minor.patch版本是要求向后兼容的,那么所谓的更新到兼容版本,其实就是更新minor版本或者
path版本:
<ul class="org-ul">
<li><p>
更新到兼容的最新版本,也就是更新minor.patch到最新的方法
</p>
<div class="org-src-container">
<pre class="src src-shell">go get -u github.com/learning-go-book/simpletax
</pre>
</div></li>
<li><p>
只更新patch到最新版本的方法
</p>
<div class="org-src-container">
<pre class="src src-shell">go get -u=patch github.com/learning-go-book/simpletax
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4568371" class="outline-4">
<h4 id="org4568371"><span class="section-number-4">9.4.5.</span> Updating to Incompatible Versions</h4>
<div class="outline-text-4" id="text-9-4-5">
<ul class="org-ul">
<li>前面讲了更新到兼容的最新版本的方法,这里来讨论更新到不兼容的版本的方法</li>
<li>go里面的不兼容版本是指major版本的升级,在go里面,超过0和1的版本都要以vN结尾,比如v2, v3,以simpletax
为例,其2.0版本:
<ul class="org-ul">
<li>不再是github.com/learning-go-book/simpletax@v2.0.0</li>
<li><p>
而是github.com/learning-go-book/simpletax/v2 ,其文件结构如下(在v2文件夹下面来写新版本):
</p>
<div class="org-src-container">
<pre class="src src-shell">$ pwd
/Users/harri/github/simpletax
$ git ls-files
.gitignore
LICENSE
README.md
go.mod
go.sum
taxes.go
v2/go.mod
v2/go.sum
v2/taxes.go
</pre>
</div></li>
</ul></li>
<li>虽然module名字都变了,但是使用的时候,package还是叫simpletax(之前有例子展示过,package名字不是文
件夹决定的,而是第一行的package xxx决定的)</li>
<li><p>
这种升级版本的方法叫做semantic import versioning rule: 不同版本的package其实是两个不同的package
</p>
<pre class="example" id="org20f2ff2">
Incompatible versions of a package are not the same package
</pre></li>
<li><p>
既然不同版本都算两个package啦,那么两个版本的package都可以在同一个项目中引入,优点是:允许你在代
码的不同部分使用不同版本的package,这样升级更加优雅
</p>
<pre class="example" id="orgcab7de9">
Using different paths means that you can import two incompatible versions
of a package into different parts of your program, allowing you to upgrade
gracefully.
</pre></li>
<li><p>
如果升级后,如果所有代码都指向了新版本,那么老的版本就没有被import了,可以使用如下代码清除不再被
引用的package
</p>
<div class="org-src-container">
<pre class="src src-shell">go mod tidy
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc9a5eb9" class="outline-4">
<h4 id="orgc9a5eb9"><span class="section-number-4">9.4.6.</span> Vendoring</h4>
<div class="outline-text-4" id="text-9-4-6">
<ul class="org-ul">
<li><p>
为了让项目每次的依赖都是完全一样的,go也可以像c++一样,把所有的依赖都版本控制起来,这种技术叫做vendoring,
触发方法是使用如下命令,把所有的依赖都安装在vendor文件夹下
</p>
<div class="org-src-container">
<pre class="src src-shell">go mod vendor
</pre>
</div></li>
<li>值得注意的是,一旦使用go get或者其他方法更新了go.mod,那么就必须再次使用go mod vendor 来更新依赖,
否则编译会失败</li>
<li>vendoring是早期项目的首选,随着go module和proxy server的创建,如今的项目已经不再推荐使用vendoring了</li>
</ul>
</div>
</div>
<div id="outline-container-orgb4e6290" class="outline-4">
<h4 id="orgb4e6290"><span class="section-number-4">9.4.7.</span> pkg.go.dev</h4>
<div class="outline-text-4" id="text-9-4-7">
<ul class="org-ul">
<li>虽然go没有单独的管理module的中央代码库,比如js的npm. 但是go有一个自己的中央文档库pkg.go.dev</li>
</ul>
</div>
</div>
<div id="outline-container-orgcb834ed" class="outline-4">
<h4 id="orgcb834ed"><span class="section-number-4">9.4.8.</span> Additional Information</h4>
<div class="outline-text-4" id="text-9-4-8">
<ul class="org-ul">
<li>关于go module的详细信息,可以查看这个网页<a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga2cabd6" class="outline-3">
<h3 id="orga2cabd6"><span class="section-number-3">9.5.</span> Publishing Your Module</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li>发布你自己的go库,就像把代码放到版本管理一样简单,只需要记得:
<ul class="org-ul">
<li>把go.mod和go.sum加入版本管理就可以了.</li>
<li>如果是开源module,记得放一个LICENSE</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgdce83fb" class="outline-3">
<h3 id="orgdce83fb"><span class="section-number-3">9.6.</span> Versioning Your Module</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>在go里面,如果你到了要放弃向前兼容的时候,就是起新的major版本的时候,比如我们前面例子里面的simpletax的v2</li>
<li>如果发起了新版本,就涉及到如何存储你的新版本.一般有两种方法:
<ul class="org-ul">
<li>在当前文件夹下面创建一个新的子文件夹vN,比如2.0版本就是v2文件夹,v2里面有自己的go.mod, go.sum, README等等</li>
<li>为新的版本创建一个新的branch,比如v2 branch</li>
</ul></li>
<li>无论上面哪种改法, go.mod里面第一行module的名字一定要加上/vN,这样就意味着这是一个新的package了</li>
<li>最后打上tag,这样才算新版本发布成功</li>
</ul>
</div>
</div>
<div id="outline-container-org2521fb7" class="outline-3">
<h3 id="org2521fb7"><span class="section-number-3">9.7.</span> Module Proxy Servers</h3>
<div class="outline-text-3" id="text-9-7">
<ul class="org-ul">
<li>Go没有统一的中央代码库,但是有proxy server,我们可以设置proxy server,让我们所有的代码从proxy server
下载,如果proxy server里面没有我们想要的库,那么它会先去下载在自己数据库里面存储好之后,再下载给我
们,久而久之,这个库就会包含所有的go库(而且不会丢失,即便作者删库). 这个proxy server是由google运营的</li>
<li>除了proxy server, google还运营了sum database,它会存储每个module的每个版本的信息,保证tag和内容的
一一对应, 这能很好的规避两类问题:
<ul class="org-ul">
<li>恶意修改: 某些不怀好意的人会偷偷修改tag对应的代码,引入恶意内容</li>
<li>冒险失败: 某些库的维护者在进入新内容后,使用了老的tag</li>
</ul></li>
<li>每次你通过go get下载内容, go的工具都会把content计算一个哈希值,和tag一起发送给sum database用来判
断内容是否匹配,如果不匹配,module不会安装成功</li>
</ul>
</div>
<div id="outline-container-orgd6a5d15" class="outline-4">
<h4 id="orgd6a5d15"><span class="section-number-4">9.7.1.</span> Specifying a Proxy Server</h4>
<div class="outline-text-4" id="text-9-7-1">
<ul class="org-ul">
<li>默认你情况下是使用了google的proxy,如果你不想使用这个配置,那么有如下几种选择:
<ul class="org-ul">
<li><p>
使用其他公司维护的proxy,比如GoCenter,代码如下
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #d33682; font-style: italic;">export</span> <span style="color: #268bd2;">GOPROXY</span>=https://gocenter.io,direct
</pre>
</div></li>
<li><p>
disable proxy,代码如下
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #d33682; font-style: italic;">export</span> <span style="color: #268bd2;">GOPROXY</span>=direct
</pre>
</div></li>
<li>你可以运行自己的proxy server</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga3837a2" class="outline-4">
<h4 id="orga3837a2"><span class="section-number-4">9.7.2.</span> Private Repositories</h4>
<div class="outline-text-4" id="text-9-7-2">
<ul class="org-ul">
<li>前面讲过go默认使用内置的proxy,而且是google host的(默认为GOPROXY="<a href="https://proxy.golang.org,direct">https://proxy.golang.org,direct</a>"),
那么由于google没有你们公司的版本管理权限,google显然不能下载你们公司的module到自己那里(再转下载给你),</li>
<li>而且你试图下载公司内部module的时候,还会泄露你们module的名字给google(虽然没那么严重), 所以,对于
内部版本管理的module,就不能使用默认的proxy了,这种情况有如下几条路可选:
<ul class="org-ul">
<li>直接禁止proxy,那么有可能会遇到有些被作者移除的库安装不上</li>
<li>使用private proxy server,在private proxy server上面配置访问内部版本管理module的权限</li>
<li><p>
还是使用默认的public proxy server(无论是google还是其他公司host的),但是设置GOPRIVATE环境变量,
让满足情况的所有库都直接下载,不经过proxy,而且不去sum database做鉴定
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #d33682; font-style: italic;">export</span> <span style="color: #268bd2;">GOPRIVATE</span>=*.example.com,company.com/repo
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org86a1bcf" class="outline-2">
<h2 id="org86a1bcf"><span class="section-number-2">10.</span> Concurrency in Go</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>并发(concurrency)是一个计算机术语,用来描述如何把一个processs分成独立的部分,并且明确这些部分如何共享数据</li>
<li>大部分的语言都是通过library来使用操作系统的thread实现并发的</li>
<li>操作系统的thread是通过获取锁的方式来共享数据的</li>
<li>Go是不同的,它的并发理论来源于CSP(communicating Sequential Processes)</li>
<li>CSP和其他并发模型能力一样,但是具有容易理解的特点</li>
<li>本章会学习Go并发模型的几个重点特性:
<ul class="org-ul">
<li>goroutine</li>
<li>channel</li>
<li>select</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgcbcb848" class="outline-3">
<h3 id="orgcbcb848"><span class="section-number-3">10.1.</span> When to Use Concurrency</h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>首先要确定你的程序能从并发里面获益</li>
<li>很多GO程序员一开始使用并发的时候,都会经历如下的几个阶段:
<ul class="org-ul">
<li>并发非常好,我要所有的东西都用并发!</li>
<li>我们的程序不够快,我要给我的channel加上buffer</li>
<li>我们的channel容易block,为了不deadline,我要使用巨大的buffer的 buffered channel</li>
<li>我们的channel还是blocking,我要使用mutex</li>
<li>算了,我放弃使用并发了</li>
</ul></li>
<li>人们被并发所吸引,是因为感觉并发能够让程序跑的更快,但是实际上这并非如此</li>
<li>真实的情况是: 更多的并发并不会自动的让程序更快,却很大概率让程序更难以理解</li>
<li><p>
理解上面所说的关键是要理解两个概念的区别: 并发并非并行
</p>
<pre class="example" id="org2d00d41">
concurrency is not parallelism
</pre></li>
<li>并发其实是一个更好的组织工具,从逻辑上来解决你的问题.至于是否并发的代码能够并行运行,要看硬件(包括
算法)是否支持</li>
<li><p>
总结起来,我们需要理解:更多的并发并不意味着更快的代码
</p>
<pre class="example" id="org1cb516a">
More concurrency does not mean more speed
</pre></li>
<li>概括起来讲,所有的程序都会按照如下三步来处理数据:
<ul class="org-ul">
<li>获取数据</li>
<li>更改数据</li>
<li>输出数据</li>
</ul></li>
<li>是否应该在代码里面使用并发取决于你的程序里面的data如何在不同step之间flow:
<ul class="org-ul">
<li>可以使用并发的情况:不同的step可以同时发生, 因为某个step的output,不影响后面的step的启动.也就是
说不同step之间的可以独立的启动和运行</li>
<li>不可以使用并发的情况:不同的step必须按照一定的顺序发生,因为后面一个step的启动,可能需要前面一个step的output.</li>
</ul></li>
<li>另外,还有一种情况"可以但是不适合引入并发": 那就是并发运行时间很短的情况</li>
<li>之所以不要在这种情况下引入并发,是因为得不偿失:因为引入并发是有代价的:
<ul class="org-ul">
<li>因为引入并发需要一些损耗(无论是并发手段还是处理器调度)</li>
</ul></li>
<li>并发往往应用在I/O上面,因为相比内存操作,IO操作(读取文件或者网络)的时间的速度要比内存操作几千倍</li>
<li>如果实在拿不准是否要使用并发,那么先写线性代码,再写并发代码,看看哪个的速度更快.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbd5be66" class="outline-3">
<h3 id="orgbd5be66"><span class="section-number-3">10.2.</span> Goroutines</h3>
<div class="outline-text-3" id="text-10-2">
<ul class="org-ul">
<li>goroutine是GO并发工具的核心,为了能够搞明白goroutine,我们来定义几个术语:
<ul class="org-ul">
<li>process: process是一个program的运行时,是被计算机操作系统来调度和运行的.操作系统会赋予某个process
一定的资源(比如内存),并且保证其他process都无法解除这些资源</li>
<li>thread: 隶属于process,是运行的最小单位. 一个process内的不同thread共享process的资源.如果CPU有多
个核,那么可以同时运行多个thread.操作系统的主要工作就是通过调度让每个thread都有运行的机会</li>
</ul></li>
<li>goroutine是被Go runtime调度的lightweight processs</li>
<li>当一个Go 程序启动的时候, Go runtime会:
<ul class="org-ul">
<li>创建M个thread</li>
<li>并且启动一个goroutine(也就是main goroutine)来运行</li>
</ul></li>
<li>后续会创建其他新的goroutine,这些goroutine和main goroutine一起都会被Go runtime赋予给那M个thread,
当然这一切都是自动的</li>
<li>Go runtime去schedule goroutine看起来和操作系统去schedule thread的功能重复了,但是有其重要的意义:
<ul class="org-ul">
<li>goroutine的创建比thread的创建快捷,因为你不需要创建操作系统级别的资源</li>
<li>goroutine的初始化stack比较thread的小,但是可以根据需要扩大,所以goroutine的内存使用效率高</li>
<li>goroutine在Go runtime内部调度的上下文切换(由goroutineA执行变成goroutineB执行)非常快,反之在操作
系统内部不同thread上下文切换很慢.因为goroutine是在process内部切换不需要使用非常慢的系统调用</li>
<li>Go 内部的scheduler有很多优化的创新,比如:
<ol class="org-ol">
<li>go内部的scheduler会和network poller合作,监控哪些goroutine blocking在IO上了,那么就标记这个
goroutine为unscheduled</li>
<li>go内部的schedular还会和garbage collector合作,确保工作负荷平均分配到了M个thread(一开始分配
的)上</li>
</ol></li>
</ul></li>
<li>goroutine的这些优点,让一个process内部能够存在高达上万个goroutine,而在一个process中存在上万个thread
是不太可能的</li>
<li>goroutine的启动很简单.和调用一个function类似:
<ul class="org-ul">
<li>不同的地方: 在函数前面加一个go关键字, 返回值会被忽略</li>
<li>相同的地方: 函数的参数还是可以传入并且被使用</li>
</ul></li>
<li><p>
虽然所有的function都可以被启动为goroutine,但是,在实践当中,我们往往给goroutine外面包裹一个closure
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">process</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">do something with val</span>
        <span style="color: #859900; font-weight: bold;">return</span> 0
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">runThingConcurrently</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">in</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">out</span> <span style="color: #859900; font-weight: bold;">chan</span>&lt;- <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">val</span> := <span style="color: #859900; font-weight: bold;">range</span> in <span style="color: #859900;">{</span>
                        <span style="color: #268bd2;">result</span> := <span style="color: #b58900;">process</span><span style="color: #6c71c4;">(</span>val<span style="color: #6c71c4;">)</span>
                        out &lt;- result
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}()</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>加一个function作为closure的作用是:
<ul class="org-ul">
<li>closure从channel读取数据,然后把数据传递给bussiness logic(例子中的process)</li>
<li>把bussiness logic的结果传递给另外的channel</li>
<li>整个过程当中,bussiness logic不知道自己在goroutine中运行,这让bussiness logic的测试非常容易,也
是很好的模块化做法</li>
<li>更重要的是,有了closure function,我们不会在API里面暴露concurrency</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgfed5737" class="outline-3">
<h3 id="orgfed5737"><span class="section-number-3">10.3.</span> Channels</h3>
<div class="outline-text-3" id="text-10-3">
<ul class="org-ul">
<li>goroutine之间的通信是通过channel</li>
<li><p>
和slice,map一样,channel也是使用make 创建,并且是内置的类型,创建代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>和map一样, channel也是reference类型,这就意味着,当你把一个channel传递给function的时候,你其实传递
的是pointer</li>
<li>和其他reference类型一样, channel的zero值是nil</li>
</ul>
</div>
<div id="outline-container-orga0a7d9b" class="outline-4">
<h4 id="orga0a7d9b"><span class="section-number-4">10.3.1.</span> Reading, Writing, and Buffering</h4>
<div class="outline-text-4" id="text-10-3-1">
<ul class="org-ul">
<li>使用&lt;-来和channel进行交互:
<ul class="org-ul">
<li><p>
如果从channel读取,那么就把 &lt;- 放在channel的左边
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">a</span> := &lt;-ch <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">read a value from ch an assigns it to a</span>
</pre>
</div></li>
<li><p>
如果向channel写入,那么就把 &lt;- 放在channel的右边
</p>
<div class="org-src-container">
<pre class="src src-go">ch &lt;- b   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">write the value in b to ch</span>
</pre>
</div></li>
</ul></li>
<li>和变量不同的是,写入到channel的值,只能被读取一次,如果有多个goroutine同时从一个channel读取这个value,
那么只会有一个goroutine成功</li>
<li>一个goroutine同时读取和写入到一个channel的情况,非常少见.为了让代码更不容易出错,我们可以定义只读或者只写的channel:
<ul class="org-ul">
<li><p>
只读channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">readonly</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #268bd2;">(</span>&lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">in</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
只写channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">writeonly</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">chan</span>&lt;- <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
</ul></li>
<li>定义只读或者只写的channel好像也没有意义,一个channel只读了,那么谁给他写入呢?</li>
<li><p>
所以只读,只写的channel要配合go语言的另外一个特性:可以通过赋值(或者显示转换)来把可读可写的channel
转换成只读channel(或者只写channel)
</p>
<pre class="example" id="org7412a51">
A channel may be constrained only to send or only to receive by assignment or explicit conversion.
</pre></li>
<li><p>
这样一来,我们就可以创建函数的时候,使用只读或者只写的类型,但是把一个可读可写的channel赋值给函数,
来保证在函数里面是只读或者只写的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">globalCh</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                globalCh &lt;- <span style="color: #2aa198;">"hello world"</span>
        <span style="color: #d33682;">}()</span>

        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #b58900;">takesReadonly</span><span style="color: #859900;">(</span>globalCh<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>

        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">takesReadonly</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">ch</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">msg</span> := &lt;-ch
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>msg<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">hello world</span>
</pre>
</div></li>
<li>默认情况下,channel都是unbuffered的,所谓unbuffered是指:
<ul class="org-ul">
<li>每一个对于unbuffered channel的write,都会让writing channel 停滞,直到有另外的goroutine从这个channel
里面读取走这个数据</li>
<li>每一个对于unbuffered channel的read,都会让reading channel停滞,直到有另外的goroutine向这个channel
里面写入数据</li>
</ul></li>
<li>换句话说,一旦创建了unbuffered的channel,那么你至少需要同时有两个运行的goroutine</li>
<li>Go里面同时也有buffered channel,和unbuffered channel不同的地方在于:
<ul class="org-ul">
<li>对于unbuffered channel,如果没有人读取,那么第一个写入就会block</li>
<li>对于buffered channel,如果没有人读取,可以写入N次,然后第N+1次写入才会block</li>
<li>N就是buffered的buffer大小</li>
</ul></li>
<li>我们可以使用如下代码来创建buffered channel
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, 10<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>我们使用len()返回buffered里面有几个值</li>
<li>我们使用cap()返回创建buffered channel的时候设计的buffer的大小</li>
<li><p>
巨大部分情况下,你都应该使用unbuffered channel
</p>
<pre class="example" id="org37b09e5">
Most of the time, you should use unbuffered channels.
</pre></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org65751f8" class="outline-4">
<h4 id="org65751f8"><span class="section-number-4">10.3.2.</span> for-range and Channels</h4>
<div class="outline-text-4" id="text-10-3-2">
<ul class="org-ul">
<li><p>
在go语言里面,for-range还能用在读取channel,不同的是,读取channel的时候,只有一个变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> ch <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>上面的loop停止的情况有:
<ul class="org-ul">
<li>channel被关闭(通常在其他goroutine中关闭这个channel)</li>
<li>break或者return中断</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9fd86bd" class="outline-4">
<h4 id="org9fd86bd"><span class="section-number-4">10.3.3.</span> Closing a Channel</h4>
<div class="outline-text-4" id="text-10-3-3">
<ul class="org-ul">
<li><p>
当你不再想要写入这个channel的时候,你只用close来关闭它,注意只是不想写入,close了之后还是可以读取
的.代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #d33682; font-style: italic;">close</span><span style="color: #268bd2;">(</span>ch<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>一个channel一旦被close,那么如下操作就不允许出现在这个channel上面了,否则会出现panic
<ul class="org-ul">
<li>write to the channel</li>
<li>close the channel again</li>
</ul></li>
<li>与此对应的是,读取一个closed channel却总是成功的:
<ul class="org-ul">
<li>如果channel是buffered的,那么读取会把buffered的value给按照顺序读取出来</li>
<li><p>
如果channel是unbuffered的(或者buffered channel里面没有value了),那么读取也会成功,但是会返回zero
值.这里当然会出现如果本来channel里面就是zero值的情况,为了区分这种情况,我们使用第二个返回值来
判断channel是否被关闭了(ok为true表示channel还open,否则channel被关闭了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">v</span>, <span style="color: #268bd2;">ok</span> := &lt;-ch
</pre>
</div></li>
</ul></li>
<li>关闭channel的责任在于写入channel的goroutine</li>
<li>注意,只有如下的情况下才会去close一个channel: 有其他goroutine等待channel被关闭(其他goroutine使用
for-range loop在等待channel关闭)</li>
<li>如果没有其他goroutine等待channel被关闭,那么我们不需要显式关闭channel,因为GC会去清理channel</li>
<li>channel是GO并发模型最重要的概念之一(另外一个是select), channel会指导我们认清代码的dependency,
从而更好的进行并发设计</li>
<li>其他语言使用全局的共享state来沟通不同的thread,而这个全局的变化的shared state会使得如下两件事变得困难:
<ul class="org-ul">
<li>理解数据如何流转</li>
<li>理解两个thread是否真的independent</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd9a5e71" class="outline-4">
<h4 id="orgd9a5e71"><span class="section-number-4">10.3.4.</span> How Channels Behave</h4>
<div class="outline-text-4" id="text-10-3-4">
<ul class="org-ul">
<li>channel有很多不同的state,在读,写,关闭的时候,都有不同的behavior,我们下面来总结一下
<ul class="org-ul">
<li><p>
图10-1
</p>

<div id="orgcc37267" class="figure">
<p><img src="https://raw.githubusercontent.com/harrifeng/image/master/lg/10-1.png" alt="10-1.png" />
</p>
<p><span class="figure-number">Figure 11: </span>lg/10-1.png</p>
</div></li>
</ul></li>
<li>涉及到close的情况,谁来关闭,怎么关闭有时候很难处理
<ul class="org-ul">
<li>标准的pattern要求,让writing goroutine来负责关闭channel(当没有什么东西要写的时候),但是如果有多
个goroutine同时写的话,问题就很难办,因为:
<ol class="org-ol">
<li>关闭channel超过一次就会panic</li>
<li>某个goroutine关闭channel之后,另外的goroutine再写入,也会panic</li>
</ol></li>
<li>后面我们知道这种问题会用sync.WaitGroup来解决</li>
</ul></li>
<li>nil channel也很危险,但是nil channel是有其特殊用处的,我们会在后面看到</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgec47c03" class="outline-3">
<h3 id="orgec47c03"><span class="section-number-3">10.4.</span> select</h3>
<div class="outline-text-3" id="text-10-4">
<ul class="org-ul">
<li>select是Go语言里面用来control的语句,它主要解决了如下的一个问题:
<ul class="org-ul">
<li>如果你进行了一个并发操作,那么哪一个会先运行</li>
<li>这个问题在普通代码里面不是问题,但是在并发代码里面是问题,如果你每次都偏向某一种情况,那么另外
一种情况可能永远无法运行(也就是所谓的starvation)</li>
<li>select 可以做到,让goroutine随机的从(并发的)多种情况中选择,不至于出现starvation</li>
</ul></li>
<li>我们来看一个select的例子:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">select</span> <span style="color: #268bd2;">{</span>
<span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">v</span> := &lt;- ch:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v<span style="color: #d33682;">)</span>
<span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">v</span> := &lt;- ch2:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v<span style="color: #d33682;">)</span>
<span style="color: #859900; font-weight: bold;">case</span> ch3 &lt;- x:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"wrote"</span>, x<span style="color: #d33682;">)</span>
<span style="color: #859900; font-weight: bold;">case</span> &lt;- ch4:
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"got value on ch4, but ignore it"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>select的每个case都是一个读取或者写入channel的操作,如果操作可行,那么就运行case的body</li>
<li>注意每个case都会创建子的block(和switch一样)</li>
<li>如果如果多个case同时满足,那么select就会随机选择一个运行.所以说,select的顺序是不重要的,并不是
放在前面的就一定先运行(这个和switch不一样)</li>
<li>前面说到了因为pick的随机性,select可以避免starvation.其实pick的随机性还能够避免deadlock的一种
最常见原因:不同goroutine中以不同顺序获取lock</li>
</ul></li>
<li>我们来看一个不同goroutine以不同顺序获取lock(这里是channel),从而导致deadlock的例子:
<ul class="org-ul">
<li><p>
代码
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-06 23:22:51</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch1</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ch2</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">v</span> := 1
                ch1 &lt;- v
                <span style="color: #268bd2;">v2</span> := &lt;-ch2
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>v, v2<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>

        <span style="color: #268bd2;">v</span> := 2
        ch2 &lt;- v
        <span style="color: #268bd2;">v2</span> := &lt;-ch1
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, v2<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

</pre>
</div></li>
<li><p>
输出
</p>
<pre class="example" id="org9a5dbb7">
fatal error: all goroutines are asleep - deadlock!
</pre></li>
<li>上面例子的问题是:
<ol class="org-ol">
<li>main goroutine直到ch2被读取才能进行: 先写入ch1, 再读取ch2</li>
<li>子 goroutine直到ch1被读取才能运行: 先写入ch2, 再读取ch1</li>
<li>上面两个获取channel的顺序是相反的</li>
</ol></li>
<li><p>
修改的主要办法,就是在main goroutine里面使用select,这样就能避免deadlock了(因为select能够判断
哪个channel先可用,而不会使用固定的顺序),代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch1</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ch2</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">v</span> := 1
                ch1 &lt;- v
                <span style="color: #268bd2;">v2</span> := &lt;-ch2
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>v, v2<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>

        <span style="color: #268bd2;">v</span> := 2
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">v2</span> <span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> ch2 &lt;- v:
        <span style="color: #859900; font-weight: bold;">case</span> v2 = &lt;-ch1:
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>v, v2<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
输出
</p>
<pre class="example" id="orgdf306d3">
2 1
</pre></li>
</ul></li>
<li><p>
由于select主要用来和多个channel联系,而每次其实只可能有一个case成功,为了尽可能的让所有case成功,
需要让select和for组合起来,如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> &lt;- done:
                <span style="color: #859900; font-weight: bold;">return</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">v</span> := &lt;- ch:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>这种用法非常普遍,以至于有个特殊的名字,叫做for-select loop.而且这种loop还得设计一种专门的方法来
退出for,就是上面的例子中的done channel, 我们后面会介绍</li>
<li>和switch类似,select也会有一个default语句,当select中所有的都没有命中的时候,整个语句不是pause而是
直接命中default语句,如下</li>
<li><p>
select中使用default通常只有一种使用场景: 对一个channel实施非阻塞的读取或者写入
</p>
<pre class="example" id="orgc6df1b6">
Implement a nonblocking read or write on a channel
</pre></li>
<li>其他场景中select和default配合通常都是不对的,特别是在for-select loop中使用default,因为这会导致
for-loop不停的运行default语句,即便没有channel准备好,这会极大的浪费CPU</li>
</ul>
</div>
</div>
<div id="outline-container-org05787d3" class="outline-3">
<h3 id="org05787d3"><span class="section-number-3">10.5.</span> Concurrency Practices and Patterns</h3>
<div class="outline-text-3" id="text-10-5">
</div>
<div id="outline-container-org553e8e7" class="outline-4">
<h4 id="org553e8e7"><span class="section-number-4">10.5.1.</span> Keep Your APIs Concurrency-Free</h4>
<div class="outline-text-4" id="text-10-5-1">
<ul class="org-ul">
<li>Concurrency是一种实现细节,好的API设计需要尽量隐藏这种细节,隐藏这种细节的好处是:
<ul class="org-ul">
<li>保证调用方式不变的情况下,可以在后面改变代码如何工作</li>
</ul></li>
<li>实践当中,这就要求,你永远不能在API里面暴露channel或者mutex:
<ul class="org-ul">
<li>比如,一旦你暴露了channel,那么你就把channel管理的责任丢给了你的使用者.你的使用者开始担心channel
是否buffered,closed或者是nil</li>
<li>同时,由于用户对于内部实现机制的不了解,他们可能会以错误的顺序调用channel或者mutex,从而引起deadlock</li>
</ul></li>
<li>注意,所谓的暴露,不是永远不能使用channel作为function的参数(或者作为struct的一个field),而是说不
能把channel给暴露出去(比如作为返回值传递给调用方)</li>
<li>当然也有例外,在库代码中,有些API是concurrency helper function(比如time.After), 他们确实会暴露channel</li>
</ul>
</div>
</div>
<div id="outline-container-orgb8098b1" class="outline-4">
<h4 id="orgb8098b1"><span class="section-number-4">10.5.2.</span> Goroutines, for Loops, and Varying Variables</h4>
<div class="outline-text-4" id="text-10-5-2">
<ul class="org-ul">
<li><p>
绝大部分情况下, 用来启动goroutine的closure(go后面都是匿名函数,匿名函数定义在另外的函数里面,所
以必然是closure)都是没有参数的,而是使用closure所在的scope里面的参数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-17 15:35:58</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">v</span> := 1
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in goroutine, v is:"</span>, v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in main, all finished"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in goroutine, v is: 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in main, all finished</span>
</pre>
</div></li>
<li>但是使用外部的变量有一个问题,那就是closure取的是这个变量的地址,那么当我们的goroutine真正运行的
时候,到底变量是一个什么值,我们是不知道的:
<ul class="org-ul">
<li><p>
在goroutine被调度前值改变了:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-17 15:52:04</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">v</span> := 1
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in goroutine, v is:"</span>, v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>

        v += 10
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in main, all finished"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in goroutine, v is: 11</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in main, all finished</span>
</pre>
</div></li>
<li><p>
在goroutine给调度前值没有改变(main goutine sleep而让出了cpu):
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-17 15:55:45</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">v</span> := 1
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"in goroutine, v is:"</span>, v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>
        v += 10
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"in main, all finished"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in goroutine, v is: 1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">in main, all finished</span>
</pre>
</div></li>
</ul></li>
<li><p>
我们知道,如果go语言的for循环使用了reference的话,会导致所有的值都是最后一个index的值,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-09 11:16:50</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Name <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">persons</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">Person</span><span style="color: #d33682;">{</span>
                <span style="color: #b58900; font-style: italic;">Person</span><span style="color: #859900;">{</span><span style="color: #6c71c4; font-weight: bold;">Name</span>: <span style="color: #2aa198;">"Alice"</span><span style="color: #859900;">}</span>,
                <span style="color: #b58900; font-style: italic;">Person</span><span style="color: #859900;">{</span><span style="color: #6c71c4; font-weight: bold;">Name</span>: <span style="color: #2aa198;">"Bob"</span><span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>persons<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">alicePerson</span> *<span style="color: #b58900; font-style: italic;">Person</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">person</span> := <span style="color: #859900; font-weight: bold;">range</span> persons <span style="color: #d33682;">{</span>
                <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">i&#21644;person&#36825;&#20004;&#20010;&#21464;&#37327;,&#34987;&#21453;&#22797;&#21033;&#29992;,&#25152;&#20197;&#27599;&#27425;&#24490;&#29615;&#20013;,&#20004;&#32773;&#22320;&#22336;&#37117;&#19981;&#21464;</span>
                fmt.<span style="color: #b58900;">Printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"%p,%p\n"</span>, &amp;i, &amp;person<span style="color: #859900;">)</span>

                <span style="color: #859900; font-weight: bold;">if</span> person.Name == <span style="color: #2aa198;">"Alice"</span> <span style="color: #859900;">{</span>
                        alicePerson = &amp;person
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>alicePerson<span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[{Alice} {Bob}]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0xc0000ac020,0xc000096250</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0xc0000ac020,0xc000096250</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&amp;{Bob}</span>
</pre>
</div></li>
<li><p>
我们的closure其实也是使用的reference,所以,在和for-loop配合的时候也容易出现值都是最后一个index的情况
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-17 19:29:18</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Person</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Name <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">getPersons</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">[]</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">persons</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">Person</span><span style="color: #d33682;">{</span>
                <span style="color: #b58900; font-style: italic;">Person</span><span style="color: #859900;">{</span><span style="color: #6c71c4; font-weight: bold;">Name</span>: <span style="color: #2aa198;">"Alice"</span><span style="color: #859900;">}</span>,
                <span style="color: #b58900; font-style: italic;">Person</span><span style="color: #859900;">{</span><span style="color: #6c71c4; font-weight: bold;">Name</span>: <span style="color: #2aa198;">"Bob"</span><span style="color: #859900;">}</span>,
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">funcs</span> := <span style="color: #d33682;">[]</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(){}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">person</span> := <span style="color: #859900; font-weight: bold;">range</span> persons <span style="color: #d33682;">{</span>

                funcs = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #859900;">(</span>funcs,
                        <span style="color: #859900; font-weight: bold;">func</span><span style="color: #6c71c4;">()</span> <span style="color: #6c71c4;">{</span>
                                fmt.<span style="color: #b58900;">Println</span><span style="color: #35a69c;">(</span>person.Name<span style="color: #35a69c;">)</span>
                        <span style="color: #6c71c4;">}</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">return</span> funcs

<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">twoFuncs</span> := <span style="color: #b58900;">getPersons</span><span style="color: #d33682;">()</span>
        twoFuncs<span style="color: #d33682;">[</span>0<span style="color: #d33682;">]()</span>
        twoFuncs<span style="color: #d33682;">[</span>1<span style="color: #d33682;">]()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Bob</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Bob</span>
</pre>
</div></li>
<li><p>
go 后面跟的也是closure,在for循环里面来不及调度(轮不到子goroutine运行,注意这个很重要,轮得到子
goroutine运行的话,就不会只是最后一个index的value了),等到for循环之后轮到子goroutine运行的时候,
因为是ref到之前的变量的,所以和上面的例子一样,每个子goroutine都是打印的最后一个index值
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-17 19:48:06</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">a</span> := <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{</span>2, 4, 6, 8, 10<span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> a <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">()</span> <span style="color: #859900;">{</span>
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>v * 2<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}()</span>
        <span style="color: #d33682;">}</span>

        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">20</span>
</pre>
</div></li>
<li>我们有两种方法避免上面的错误:
<ul class="org-ul">
<li><p>
在loop中shadow 变量
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> a <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">v</span> := v
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                ch &lt;- v * 2
        <span style="color: #d33682;">}()</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
传递value作为goroutine的参数(这样就是拷贝而不是referenc了)
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> a <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">val</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                ch &lt;- val * 2
        <span style="color: #d33682;">}(</span>v<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org338c125" class="outline-4">
<h4 id="org338c125"><span class="section-number-4">10.5.3.</span> Always Clean Up Your Goroutines</h4>
<div class="outline-text-4" id="text-10-5-3">
<ul class="org-ul">
<li>如果你启动了一个goroutine,那么你要保证这个goroutine最终exit,否则就会发生goroutine leak</li>
<li>所谓goroutine,是因为scheduler是无法回收goroutine的.如果goroutine不exit,那么scheduler就会一直不
断的给goroutine运行时间.这会拖累整个系统的效率</li>
<li><p>
正常的保证所有goroutine都exit的代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-18 09:57:30</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">max</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; max; i++ <span style="color: #859900;">{</span>
                        ch &lt;- i
                <span style="color: #859900;">}</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>ch<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">return</span> ch
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> <span style="color: #b58900;">countTo</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">6</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">7</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">9</span>
</pre>
</div></li>
<li><p>
不正常的,如下:后面五个goutine都block住,等待数据从channel里面被取走.
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-18 09:59:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">max</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; max; i++ <span style="color: #859900;">{</span>
                        ch &lt;- i
                <span style="color: #859900;">}</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>ch<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">return</span> ch
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> <span style="color: #b58900;">countTo</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> i &gt; 5 <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">break</span>
                <span style="color: #859900;">}</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgd2d5bb1" class="outline-4">
<h4 id="orgd2d5bb1"><span class="section-number-4">10.5.4.</span> The Done Channel Pattern</h4>
<div class="outline-text-4" id="text-10-5-4">
<ul class="org-ul">
<li>Go里面存在一种pattern用来提供一种通知goroutine:你该stop啦. 这种pattern叫做done channel pattern</li>
<li>done channel pattern的原理是使用一个channel来告诉goroutine该退出了,而该goroutine使用select来监
控这个channel(当然可能可以同时监控其他channel),下面就是这样一个例子:
<ul class="org-ul">
<li>数据传递给多个function,并且每个function都启动一个goroutine,最快的goroutine返回后,就关闭所有
其他的goroutine</li>
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">searchData</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">s</span> <span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #268bd2;">searchers</span> <span style="color: #d33682;">[]</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">done</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">result</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">searcher</span> := <span style="color: #859900; font-weight: bold;">range</span> searchers <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">searcher</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #6c71c4;">(</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #6c71c4;">{</span>
                        <span style="color: #859900; font-weight: bold;">case</span> result &lt;- <span style="color: #b58900;">searcher</span><span style="color: #35a69c;">(</span>s<span style="color: #35a69c;">)</span>:
                        <span style="color: #859900; font-weight: bold;">case</span> &lt;-done:
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}(</span>searcher<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">r</span> := &lt;-result
        <span style="color: #d33682; font-style: italic;">close</span><span style="color: #d33682;">(</span>done<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> r
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>我们可以看到,实现的原理是所有的goroutine(每个goroutine都控制一个function),都去监控done channel,一旦done channel
close了,就可以结束自己的工作(select关注的其他channel在做自己的工作)了</li>
<li>done channel的类型默认 struct{},因为我们不会去用这个channel,不会传数据给它,我们只会close它</li>
<li>每个goroutine自己的工作完成后都会写到一个公共的channel result,而在main goroutine里面pasue on
这个result channel,一旦有数据来了就:
<ol class="org-ol">
<li>先关闭done channel,以便让其他goroutine关闭</li>
<li>返回result channel带回来的值</li>
</ol></li>
</ul></li>
<li>有些时候你可能会因为call stack上面的其他function的要求,而关闭自身.这种情况下需要使用contex里面
的Cancellation功能,我们后面会看到</li>
</ul>
</div>
</div>
<div id="outline-container-org3a63209" class="outline-4">
<h4 id="org3a63209"><span class="section-number-4">10.5.5.</span> Using aa Cancel Function to Terminate a Goroutine</h4>
<div class="outline-text-4" id="text-10-5-5">
<ul class="org-ul">
<li>我们再来解决一下 <b>Always clean up your goroutine</b> 那一节的问题</li>
<li>那个问题是使用了一个函数(内部的goroutine)来生成index, 如果要让函数功能不变,又能中断function,那
么我们必须创建done channel,同时把done channel返回回来.</li>
<li>下面的例子更近一步,直接返回了一个closure,让这个closure来调用done channel.其实还可以做其他操作,
这里就略过了:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-18 18:45:06</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countTo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">max</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>&lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">func</span><span style="color: #d33682;">()</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">done</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">cancel</span> := <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>done<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; max; i++ <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #6c71c4;">{</span>
                        <span style="color: #859900; font-weight: bold;">case</span> &lt;-done:
                                <span style="color: #859900; font-weight: bold;">return</span>
                        <span style="color: #859900; font-weight: bold;">case</span> ch &lt;- i:
                        <span style="color: #6c71c4;">}</span>

                <span style="color: #859900;">}</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>ch<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">return</span> ch, cancel
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">ch</span>, <span style="color: #268bd2;">cancel</span> := <span style="color: #b58900;">countTo</span><span style="color: #d33682;">(</span>10<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := <span style="color: #859900; font-weight: bold;">range</span> ch <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">if</span> i &gt; 5 <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">break</span>
                <span style="color: #859900;">}</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #b58900;">cancel</span><span style="color: #d33682;">()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5</span>
</pre>
</div></li>
<li>countTo 创建了两个channel,一个负责返回数据(ch),一个负责通知完成(done),注意ch channel不会被关
闭,因为select命中done之后,会直接return. 但是channel不关闭没事,GC会找到并且释放他们</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2ae11a4" class="outline-4">
<h4 id="org2ae11a4"><span class="section-number-4">10.5.6.</span> When to Use Buffered and Unbuffered Channels</h4>
<div class="outline-text-4" id="text-10-5-6">
<ul class="org-ul">
<li>Go并发里面最难以掌握的,就是如何使用buffered channel</li>
<li>默认情况,channel是unbuffered的,这种情况下的channel就像是接力赛上面的接力棒一样:一个goroutine写
入了之后,等待下一个goroutine读取</li>
<li>buffered channel 的使用则更加的复杂,但是可以用一句话来总结:
<ul class="org-ul">
<li><p>
只有在你知道自己要启动多少个goroutine的情景下,你才会使用到buffered channel,比如:你想限制goroutine
启动的数目,或者限制队列中等待的工作数量
</p>
<pre class="example" id="orga677410">
Buffered channels are useful when you know how many goroutines you have launched,
want to limit the number of goroutines you will launch, or want to limit the amount
of work that is queued up
</pre></li>
</ul></li>
<li>下面就是一个使用buffered channel的例子:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-18 19:04:15</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">input</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; 100; i++ <span style="color: #d33682;">{</span>

                <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">index</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                        input &lt;- index
                <span style="color: #859900;">}(</span>i<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">processChannel</span><span style="color: #859900;">(</span>input<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">processChannel</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">ch</span> <span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #6c71c4; font-weight: bold;">conc</span> = 10
        <span style="color: #268bd2;">results</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, conc<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; conc; i++ <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">()</span> <span style="color: #859900;">{</span>
                        <span style="color: #268bd2;">v</span> := &lt;-ch
                        results &lt;- v
                <span style="color: #859900;">}()</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">out</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; conc; i++ <span style="color: #d33682;">{</span>
                out = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #859900;">(</span>out, &lt;-results<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> out
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">[0 1 3 2 5 4 6 11 8 7]</span>
</pre>
</div></li>
<li>我们可以看到,上面的例子中,我们限制读取channel的数目是10</li>
<li>我们的results channel是不block的,不同goroutine可以开心的写入(直到buffer数目10)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9d053dc" class="outline-4">
<h4 id="org9d053dc"><span class="section-number-4">10.5.7.</span> Backpressure</h4>
<div class="outline-text-4" id="text-10-5-7">
<ul class="org-ul">
<li>buffered channel还有一个用处是实现backpressure(限制压力)</li>
<li>虽然有些反直觉,但是系统的整体性能,在压力控制在一个数量上的时候,会最好</li>
<li>我们使用buffered channel(还有select),实现了一个限流代码:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-19 17:10:12</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"errors"</span>
        <span style="color: #2aa198;">"net/http"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">PressureGauge</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        ch <span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #d33682;">{}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">New</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">limit</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> *<span style="color: #b58900; font-style: italic;">PressureGauge</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}</span>, limit<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; limit; i++ <span style="color: #d33682;">{</span>
                ch &lt;- <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}{}</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> &amp;<span style="color: #b58900; font-style: italic;">PressureGauge</span><span style="color: #d33682;">{</span>
                <span style="color: #6c71c4; font-weight: bold;">ch</span>: ch,
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">pg</span> *<span style="color: #b58900; font-style: italic;">PressureGauge</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Process</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">f</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> &lt;-pg.ch:
                <span style="color: #b58900;">f</span><span style="color: #859900;">()</span>
                pg.ch &lt;- <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}{}</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>
        <span style="color: #859900; font-weight: bold;">default</span>:
                <span style="color: #859900; font-weight: bold;">return</span> errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"no more capacity"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">doThingThatShouldBeLimited</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>20 * time.Second<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">"done"</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">pg</span> := <span style="color: #b58900;">New</span><span style="color: #d33682;">(</span>3<span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">HandleFunc</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"/request"</span>, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">(</span><span style="color: #268bd2;">w</span> <span style="color: #b58900; font-style: italic;">http.ResponseWriter</span>, <span style="color: #268bd2;">r</span> *<span style="color: #b58900; font-style: italic;">http.Request</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                <span style="color: #268bd2;">err</span> := pg.<span style="color: #b58900;">Process</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #35a69c;">()</span> <span style="color: #35a69c;">{</span>
                        w.<span style="color: #b58900;">Write</span><span style="color: #268bd2;">(</span><span style="color: #d33682;">[]</span><span style="color: #b58900;">byte</span><span style="color: #d33682;">(</span><span style="color: #b58900;">doThingThatShouldBeLimited</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
                <span style="color: #35a69c;">}</span><span style="color: #6c71c4;">)</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #6c71c4;">{</span>
                        w.<span style="color: #b58900;">WriteHeader</span><span style="color: #35a69c;">(</span>http.StatusTooManyRequests<span style="color: #35a69c;">)</span>
                <span style="color: #6c71c4;">}</span>
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>
        http.<span style="color: #b58900;">ListenAndServe</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">":8080"</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">////////////////////</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">First three ok //</span>
<span style="color: #96A7A9; font-style: italic;">////////////////////</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">$ http localhost:8080/request</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">HTTP/1.1 200 OK</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Content-Length: 4</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Content-Type: text/plain; charset=utf-8</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Date: Wed, 19 Oct 2022 09:20:32 GMT</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">done</span>

<span style="color: #96A7A9; font-style: italic;">/////////////////////////////</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">After 3 http status 429 //</span>
<span style="color: #96A7A9; font-style: italic;">/////////////////////////////</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">$ http localhost:8080/request</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">HTTP/1.1 429 Too Many Requests</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Content-Length: 0</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Date: Wed, 19 Oct 2022 09:20:18 GMT</span>
</pre>
</div></li>
<li>我们这里首先创建了一个结构体PressureGuage,里面只有一个成员就是channel.(其实是buffered channel,
但是因为无论buffer与否,类型都是一样的,所以在结构体里面还看不出来是否是buffered)</li>
<li>在New里面,我们来创建我们的struct的时候,会根据输入的limit来确定我们buffered channel的大小,buffer
的数目就是token的数目,token就是令牌,每次执行命令之前,得先来拿牌</li>
<li>Process函数就是这么设计的:
<ol class="org-ol">
<li>每当某个goroutine想要使用函数f,它不能自己调用,需要通过Process来调用</li>
<li>而每次Process调用f之前,需要去channel里面抢token,抢得到就调用,抢不到就是429.通过select抢的
过程实现了流量控制</li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc7f8abe" class="outline-4">
<h4 id="orgc7f8abe"><span class="section-number-4">10.5.8.</span> Turning Off a case in a select</h4>
<div class="outline-text-4" id="text-10-5-8">
<ul class="org-ul">
<li>select处理来自多个channel的情况非常得心应手.但是,有一种情况可能会降低select的效率,那就是:某个
channel已经被close了:
<ul class="org-ul">
<li>我们知道,一旦一个channel被close,那么这个channel肯定能被select read成功.</li>
<li>一旦select read成功这些close的channel,那么它势必要读取到zero value和ok去判断,这会极大影响性能</li>
</ul></li>
<li>面对这个问题,我们的处理办法是:将已经close的channel赋值为nil,这是基于如下的原理:
<ul class="org-ul">
<li><p>
读取或者写入一个nil channel会让你的代码一直hang(当然select也就不会去选择这种hang的代码啦)
</p>
<pre class="example" id="org4fd4c27">
Reading from or writing to a nil channel causes your code to hang forever
</pre></li>
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">v</span>, <span style="color: #268bd2;">ok</span> := &lt;-in:
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #859900;">{</span>
                        in = <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">the case will never succeed again!</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">v</span>, <span style="color: #268bd2;">ok</span> := &lt;-in2:
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2; font-weight: bold;">!</span>ok <span style="color: #859900;">{</span>
                        in2 = <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">the case will never succeed again!</span>
                        <span style="color: #859900; font-weight: bold;">continue</span>
                <span style="color: #859900;">}</span>
        <span style="color: #859900; font-weight: bold;">case</span> &lt;-done:
                <span style="color: #859900; font-weight: bold;">return</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga11b951" class="outline-4">
<h4 id="orga11b951"><span class="section-number-4">10.5.9.</span> How to Time Out Code</h4>
<div class="outline-text-4" id="text-10-5-9">
<ul class="org-ul">
<li>大部分的响应式程序都要求在某个时间内完成response,否则用户体验很不好</li>
<li>Go的并发可以做的一件事情就是控制一个requst在某个时间内必须返回</li>
<li>其他的语言都是引入了新的特性来解决这个问题,而Go则是在已有的特性的基础上完成这个功能的.下面就是
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">timeLimit</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">result</span> <span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span>

        <span style="color: #268bd2;">done</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #859900; font-weight: bold;">struct</span><span style="color: #859900;">{}</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                result, err = <span style="color: #b58900;">doSomeWork</span><span style="color: #859900;">()</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>done<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> &lt;-done:
                <span style="color: #859900; font-weight: bold;">return</span> result, err
        <span style="color: #859900; font-weight: bold;">case</span> &lt;-time.<span style="color: #b58900;">After</span><span style="color: #859900;">(</span>2 * time.Second<span style="color: #859900;">)</span>:
                <span style="color: #859900; font-weight: bold;">return</span> 0, errors.<span style="color: #b58900;">New</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"work timed out"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>我们的例子中主要就是select,它处理了两个case:
<ol class="org-ol">
<li>done channel, 这是其他goroutine通知当前goroutine某个工作完成了. 如果done channel先完成了,
那么我们就把数据返回给用户</li>
<li><p>
第二个channel就是我们这个pattern需要用到的了:time package里面的After会返回一个channel,在
固定时间后,会有数据写入这个channel
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">After waits for the duration to elapse and then sends the current time</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">on the returned channel.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">It is equivalent to NewTimer(d).C.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The underlying Timer is not recovered by the garbage collector</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">until the timer fires. If efficiency is a concern, use NewTimer</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">instead and call Timer.Stop if the timer is no longer needed.</span>
<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">After</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">d</span> <span style="color: #b58900; font-style: italic;">Duration</span><span style="color: #268bd2;">)</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">Time</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900;">NewTimer</span><span style="color: #d33682;">(</span>d<span style="color: #d33682;">)</span>.C
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga92b4cf" class="outline-4">
<h4 id="orga92b4cf"><span class="section-number-4">10.5.10.</span> Using WaitGroup</h4>
<div class="outline-text-4" id="text-10-5-10">
<ul class="org-ul">
<li>如果某个goroutine等待另外一个goroutine结束,那么它可以使用done channel</li>
<li>如果某个goroutine等待另外多个goroutine来完成他们的工作,那么就要使用sync.WaitGroup
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-21 09:58:06</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"sync"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>

        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">wg</span> <span style="color: #b58900; font-style: italic;">sync.WaitGroup</span>
        wg.<span style="color: #b58900;">Add</span><span style="color: #d33682;">(</span>3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">defer</span> wg.<span style="color: #b58900;">Done</span><span style="color: #859900;">()</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"goroutine1"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">defer</span> wg.<span style="color: #b58900;">Done</span><span style="color: #859900;">()</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"goroutine2"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">defer</span> wg.<span style="color: #b58900;">Done</span><span style="color: #859900;">()</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"goroutine3"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        wg.<span style="color: #b58900;">Wait</span><span style="color: #d33682;">()</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">goroutine3</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">goroutine1</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">goroutine2</span>
</pre>
</div></li>
<li>sync.WaitGroup不需要初始化,其zero value就可以使用</li>
<li>sync.WaitGroup有三个函数:
<ol class="org-ol">
<li>Add 提升需要等待的goroutine数目,counter加1.</li>
<li>Done 减少需要等待的goroutine数目,counter减1.为了保证Done被调用(即便是panic的情况),一般Done
使用defer调用</li>
<li>Wait 使得当前的goroutine pause以等待counter为0</li>
</ol></li>
<li>可以注意到,我们没有显式的把sync.WaitGroup传递给goroutine,原因有两点:
<ol class="org-ol">
<li>必须保证所有使用sync.WaitGroup的地方,都是使用的同一个instance,closure(也就是这里的goroutine
调用)是使用reference的. 如果我们传递(但是忘了使用pointer),那么由于Go是值传递,就会copy一份
WaitGroup instance</li>
<li><p>
第二个原因是设计原因: 我们要把concurrency排除在我们的API之外.我们一直pattern都是这么做的:
启动一个goroutine(肯定带着closure),其中closure处理并发,函数内部处理算法
</p>
<pre class="example" id="org02baeda">
The closure manages issues around concurrency and the function provides the algorithm
</pre></li>
</ol></li>
</ul></li>
<li>虽然WaitGroup非常的好用,但是却不是我们的第一选择,只有在如下情况才会去使用WaitGroup: 当你的worker
goroutine退出的时候,你需要清理一些东西,比如如下的例子,在等待N个goroutine完成写入后,我们去close
channel, channel只能被关闭一次,所以使用WaitGroup非常必要:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">processAndGather</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">in</span> &lt;-<span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">processor</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">num</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">[]</span><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">out</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span>, num<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">wg</span> <span style="color: #b58900; font-style: italic;">sync.WaitGroup</span>
        wg.<span style="color: #b58900;">Add</span><span style="color: #d33682;">(</span>num<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">i</span> := 0; i &lt; num; i++ <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">()</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">defer</span> wg.<span style="color: #b58900;">Done</span><span style="color: #6c71c4;">()</span>
                        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> in <span style="color: #6c71c4;">{</span>
                                out &lt;- <span style="color: #b58900;">processor</span><span style="color: #35a69c;">(</span>v<span style="color: #35a69c;">)</span>
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}()</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">go</span> <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                wg.<span style="color: #b58900;">Wait</span><span style="color: #859900;">()</span>
                <span style="color: #d33682; font-style: italic;">close</span><span style="color: #859900;">(</span>out<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}()</span>
        <span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">result</span> <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">int</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">v</span> := <span style="color: #859900; font-weight: bold;">range</span> out <span style="color: #d33682;">{</span>
                result = <span style="color: #d33682; font-style: italic;">append</span><span style="color: #859900;">(</span>result, v<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">return</span> result
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>例子中,我们启动了一个monitor goroutine来等待,直到所有的worker goroutine退出</li>
<li>一旦其他所有的worker goroutine退出,那么monitor goroutine就会调用close在output channel上</li>
<li>main goroutine里面的for-range也会在out channel被关闭的情况下退出循环</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org56471c3" class="outline-4">
<h4 id="org56471c3"><span class="section-number-4">10.5.11.</span> Running Code Exactly Once</h4>
<div class="outline-text-4" id="text-10-5-11">
<ul class="org-ul">
<li>前面我们讲过, init只能用于初始化package-level的, immutable的state</li>
<li>但是有很多情况下,在运行了一段时间以后,我们也希望初始化一些代码,并且初始化一次(因为初始化过程浪
费时间,所以尽量只初始化一次)</li>
<li>通常是用到的时候才初始化,如果用不到, 因为创建时间长,可能永远不会初始化,学名叫做lazy load</li>
<li>sync里面包含了一个叫做Once的type,用来在go里面做lazy load
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2022-10-21 17:24:11</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Remove the snippet completely with its dir and all files M-x `go-playground-rm`</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"sync"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">SlowComplicatedParser</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">)</span> <span style="color: #b58900; font-style: italic;">string</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">DailyParser</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">d</span> <span style="color: #b58900; font-style: italic;">DailyParser</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Parse</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">input</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> fmt.<span style="color: #b58900;">Sprintf</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"%v is Done"</span>, input<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">parser</span> <span style="color: #b58900; font-style: italic;">SlowComplicatedParser</span>
<span style="color: #859900; font-weight: bold;">var</span> <span style="color: #268bd2;">once</span> <span style="color: #b58900; font-style: italic;">sync.Once</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Parse</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">dataToParse</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #268bd2;">{</span>
        once.<span style="color: #b58900;">Do</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">()</span> <span style="color: #859900;">{</span>
                parser = <span style="color: #b58900;">initParser</span><span style="color: #6c71c4;">()</span>
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">return</span> parser.<span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span>dataToParse<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">initParser</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">SlowComplicatedParser</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">DailyParser</span><span style="color: #d33682;">{}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #b58900;">Parse</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Some Task"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        time.<span style="color: #b58900;">Sleep</span><span style="color: #d33682;">(</span>2 * time.Second<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Some Task is Done</span>
</pre>
</div></li>
<li>例子中创建了两个package level的变量:
<ul class="org-ul">
<li>parser,是SlowComplicatedParser类型的,用来面向接口编程</li>
<li>once,是sync.Once类型的:
<ol class="org-ol">
<li>和sync.WaitGroup一样,我们不需要初始化这个instance,它的zero value就很有用.</li>
<li>同时我们也要确保不要copy sync.Once的instance,所以我们的代码都是使用的全局变量申请once.</li>
<li>在函数内部申请once通常都是错误的,因为每个function里面都有一个instance的话,无法记忆之前
是否曾经调用过</li>
</ol></li>
</ul></li>
<li>例子中确保parser只被初始化一次的方法是把closure传递给once.Do函数,同时在这个closure里面初始化
parser. 函数Parser()可能被调用多次,但是Parser()里面的once.Do只会执行exactly一次这个closure</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2768bea" class="outline-4">
<h4 id="org2768bea"><span class="section-number-4">10.5.12.</span> Putting Our Concurrent Tools Together</h4>
<div class="outline-text-4" id="text-10-5-12">
<ul class="org-ul">
<li>TODO</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd654f84" class="outline-3">
<h3 id="orgd654f84"><span class="section-number-3">10.6.</span> When to Use Mutexes Instead of Channels</h3>
<div class="outline-text-3" id="text-10-6">
<ul class="org-ul">
<li>如果你有其他语言处理并发的经验,那么你肯定使用过mutex(mutual exclusion的简称)</li>
<li>mutex的任务是限制对某段代码的并发访问,这段被包含的代码叫做critical section</li>
<li>Go的设计者使用channel和select来管理并发是有足够的原因的:
<ul class="org-ul">
<li>主要原因是mutex会模糊程序里面的data flow:
<ol class="org-ol">
<li>当使用mutex来保护value的时候,没有办法来确定哪个thread(goroutine)来占有这个数据,因为数据是
被所有的thread(goroutine)所共有的</li>
<li>而使用channel的时候,data flow是清晰的</li>
</ol></li>
</ul></li>
<li><p>
还是有些场景下使用mutex会更清晰,最常见的一个情景是当你的goroutine读取或者写入一个共享数据,但是
不处理这个数据
</p>
<pre class="example" id="org3f66525">
The most common case is when your goroutines read or write a shared value,
but don't process the value
</pre></li>
<li>我们先看看这种情况下使用goroutine和channel是什么样子的
<ul class="org-ul">
<li>TODO</li>
</ul></li>
<li>我们总结一下什么时候使用channel,什么时候使用mutex:
<ul class="org-ul">
<li>如果你的value会被多个goroutine进行改装,那么使用channel</li>
<li>如果你分享一个struct的field的acess,那么使用mutex</li>
<li>如果你使用channel发现了巨大的性能问题,而且找不到解决办法,那么使用mutex</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org805dda4" class="outline-3">
<h3 id="org805dda4"><span class="section-number-3">10.7.</span> Atomics-Your Probably Don't Need These</h3>
<div class="outline-text-3" id="text-10-7">
<ul class="org-ul">
<li>除了mutex以外,go还提供了其他的保证在多个thread之间consistent的方法,那就是sync/atomic package</li>
<li>sync/atomic package 提供了访问atomic variable 操作的方法,这些方法是基于现代CPU的,能够在寄存器级
别操作value.</li>
<li>这些只适用于超级专家,我们普通人使用goroutine和mutex就完全够了</li>
</ul>
</div>
</div>
<div id="outline-container-org5dffbd5" class="outline-3">
<h3 id="org5dffbd5"><span class="section-number-3">10.8.</span> Where to Learn More About Concurrency</h3>
<div class="outline-text-3" id="text-10-8">
<ul class="org-ul">
<li>学习书籍: Concurrency in Go</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org24169f8" class="outline-2">
<h2 id="org24169f8"><span class="section-number-2">11.</span> The Standard Library</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li>本章主要介绍和如下相关的标准库:
<ul class="org-ul">
<li>I/O</li>
<li>time</li>
<li>JSON</li>
<li>HTTP</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org4cd6b6e" class="outline-3">
<h3 id="org4cd6b6e"><span class="section-number-3">11.1.</span> io and Friends</h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>Go处理输入输出的精华都在io package里面,io package最常用的两个intrface为:
<ul class="org-ul">
<li><p>
io.Reader
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Reader</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Read</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">p</span> <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #268bd2;">n</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
io.Writer
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Writer</span> <span style="color: #b58900; font-style: italic;">interfac</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Write</span><span style="color: #d33682;">(</span>p <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #268bd2;">n</span> <span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>io.Writer的参数选择是很容易理解的,我传入一个slice的byte,试图写入到interface的implementation里面
如果成功了,那么err为nil,并且在n里面返回成功写入了多少,注意n不一定等于len(p)</li>
<li><p>
io.Reader和io.Writer使用的是同样的函数声明,这看起来就显得有点奇怪,因为显然如下的接口样式是更符合
大家的期待的
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">NotHowReaderIsDefined</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Read</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">(</span><span style="color: #268bd2;">p</span> <span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, <span style="color: #268bd2;">err</span> <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>之所以不采用上面的接口,还是要传入slice,传出n,有一些原因是为了和c语言的read保持一致性,更主要的原
因要看下面的例子:
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countLetters</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">buf</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, 2048<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">out</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">n</span>, <span style="color: #268bd2;">err</span> := r.<span style="color: #b58900;">Read</span><span style="color: #859900;">(</span>buf<span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">b</span> := <span style="color: #859900; font-weight: bold;">range</span> buf<span style="color: #859900;">[</span>:n<span style="color: #859900;">]</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'A'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'Z'</span><span style="color: #6c71c4;">)</span> || <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'a'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'z'</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                                out<span style="color: #35a69c;">[</span><span style="color: #b58900;">string</span><span style="color: #268bd2;">(</span>b<span style="color: #268bd2;">)</span><span style="color: #35a69c;">]</span>++
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err == io.EOF <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> out, <span style="color: #6c71c4; font-weight: bold;">nil</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>通过上面这段使用io.Read的代码,我们可以看到,使用slice做参数这种使用方法的一个好处是我们创建了
一个buffer(buf),可以重复使用. 这种做法允许我们使用一个memory allocation来读取大数据量的数据,
如果使用NotHowReaderIsDefined那种方式,那么一个function调用可能就会申请很大的内存来存储数据源,
这些数据源都在heap上,极大的增加了gc的压力</li>
<li>由于可以输入slice作为buffer,我们甚至可以有一个buffer pool,提前申请出来,需要使用的时候,取一个用
用完再还回去(这是c语言常用的做法),这样连GC都省了,能更大程度的提高性能.</li>
<li>传出n是让用户知道多少byte已经被读入了buffer,换句话说就是buffer的前多少个byte是有效的</li>
<li>我们还看到了我们是如何判断文件读取完的:使用了error,名字叫做io.EOF(注意,不是Err开头的都不是真
正的错误)</li>
<li>最后我们可以看到io.Read函数一个异样的地方:
<ol class="org-ol">
<li>几乎所有的函数都是先处理错误,一旦有error,那么其他返回值都没有意义了</li>
<li>但是我们在io.Reader这里,是先处理buffer返回的内容,再去处理error. 因为有可能error是io.EOF,即
便是其他error,那么buffer里面已经有的数据也是valid的</li>
</ol></li>
</ul></li>
<li><p>
由于io.Reader和io.Writer都是简单的接口,实现起来也就比较方便,比如我们可以从一个字符串来创建一个
io.Reader
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-07 17:21:00</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"io"</span>
        <span style="color: #2aa198;">"strings"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countLetters</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">buf</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, 2048<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">out</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">n</span>, <span style="color: #268bd2;">err</span> := r.<span style="color: #b58900;">Read</span><span style="color: #859900;">(</span>buf<span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">b</span> := <span style="color: #859900; font-weight: bold;">range</span> buf<span style="color: #859900;">[</span>:n<span style="color: #859900;">]</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'A'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'Z'</span><span style="color: #6c71c4;">)</span> || <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'a'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'z'</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                                out<span style="color: #35a69c;">[</span><span style="color: #b58900;">string</span><span style="color: #268bd2;">(</span>b<span style="color: #268bd2;">)</span><span style="color: #35a69c;">]</span>++
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err == io.EOF <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> out, <span style="color: #6c71c4; font-weight: bold;">nil</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">"Hello,world"</span>

        <span style="color: #268bd2;">sr</span> := strings.<span style="color: #b58900;">NewReader</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">counts</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">countLetters</span><span style="color: #d33682;">(</span>sr<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>counts<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[H:1 d:1 e:1 l:3 o:2 r:1 w:1]</span>
</pre>
</div></li>
<li>前面讲接口的时候,我们讲过,go里面通常会把一个满足某接口的instance给包装成另外一个也满足这个接口
的instanceB, 然后instanceA能使用的函数也可以给instanceB使用,下面就是这样一个例子,读取一个zip文件
里面的文字,并且计算每个字母出现了几遍
<ul class="org-ul">
<li><p>
代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-07 17:21:00</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"compress/gzip"</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"io"</span>
        <span style="color: #2aa198;">"os"</span>
        <span style="color: #2aa198;">"strings"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">countLetters</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">buf</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900; font-style: italic;">byte</span>, 2048<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">out</span> := <span style="color: #859900; font-weight: bold;">map</span><span style="color: #d33682;">[</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">]</span><span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">{}</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                <span style="color: #268bd2;">n</span>, <span style="color: #268bd2;">err</span> := r.<span style="color: #b58900;">Read</span><span style="color: #859900;">(</span>buf<span style="color: #859900;">)</span>
                <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">_</span>, <span style="color: #268bd2;">b</span> := <span style="color: #859900; font-weight: bold;">range</span> buf<span style="color: #859900;">[</span>:n<span style="color: #859900;">]</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'A'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'Z'</span><span style="color: #6c71c4;">)</span> || <span style="color: #6c71c4;">(</span>b &gt;= <span style="color: #2aa198;">'a'</span> &amp;&amp; b &lt;= <span style="color: #2aa198;">'z'</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                                out<span style="color: #35a69c;">[</span><span style="color: #b58900;">string</span><span style="color: #268bd2;">(</span>b<span style="color: #268bd2;">)</span><span style="color: #35a69c;">]</span>++
                        <span style="color: #6c71c4;">}</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err == io.EOF <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> out, <span style="color: #6c71c4; font-weight: bold;">nil</span>
                <span style="color: #859900;">}</span>
                <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #859900;">{</span>
                        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">buildGzipReader</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">fileName</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>*<span style="color: #b58900; font-style: italic;">gzip.Reader</span>, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #268bd2;">r</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #d33682;">(</span>fileName<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
        <span style="color: #d33682;">}</span>
        <span style="color: #268bd2;">gr</span>, <span style="color: #268bd2;">err</span> := gzip.<span style="color: #b58900;">NewReader</span><span style="color: #d33682;">(</span>r<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
        <span style="color: #d33682;">}</span>

        <span style="color: #859900; font-weight: bold;">return</span> gr, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #d33682;">()</span> <span style="color: #d33682;">{</span>
                gr.<span style="color: #b58900;">Close</span><span style="color: #859900;">()</span>
                r.<span style="color: #b58900;">Close</span><span style="color: #859900;">()</span>
        <span style="color: #d33682;">}</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">s</span> := <span style="color: #2aa198;">"Hello,world"</span>

        <span style="color: #268bd2;">sr</span> := strings.<span style="color: #b58900;">NewReader</span><span style="color: #d33682;">(</span>s<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">counts</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">countLetters</span><span style="color: #d33682;">(</span>sr<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>counts<span style="color: #d33682;">)</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"----------read zip file----------------"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">r</span>, <span style="color: #268bd2;">closer</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">buildGzipReader</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"helloworld.txt.gz"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        <span style="color: #859900; font-weight: bold;">defer</span> <span style="color: #b58900;">closer</span><span style="color: #d33682;">()</span>
        <span style="color: #268bd2;">counts2</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">countLetters</span><span style="color: #d33682;">(</span>r<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>counts2<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">$ go run snippet.go</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[H:1 d:1 e:1 l:3 o:2 r:1 w:1]</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">----------read zip file----------------</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">map[d:1 e:1 h:1 l:3 o:2 r:1 w:1]</span>
</pre>
</div></li>
</ul></li>
<li>io.Closer也是常用的one-method interface
<ul class="org-ul">
<li><p>
函数声明如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Closer</span> <span style="color: #859900; font-weight: bold;">interface</span><span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Close</span><span style="color: #d33682;">()</span> <span style="color: #b58900; font-style: italic;">error</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
io.Closer接口是用来在读取和写入结束后进行cleanup操作的,通常和defer一起合作,比如
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">f</span>, <span style="color: #268bd2;">err</span> := os.<span style="color: #b58900;">Open</span><span style="color: #268bd2;">(</span>fileName<span style="color: #268bd2;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span>, err
<span style="color: #268bd2;">}</span>
<span style="color: #859900; font-weight: bold;">defer</span> f.<span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">use f</span>
</pre>
</div></li>
</ul></li>
<li>io.Seeker也是常用的one-method interface
<ul class="org-ul">
<li><p>
函数声明如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Seeker</span> <span style="color: #859900; font-weight: bold;">interface</span> <span style="color: #268bd2;">{</span>
        <span style="color: #b58900;">Seek</span><span style="color: #d33682;">(</span><span style="color: #268bd2;">offset</span> <span style="color: #b58900; font-style: italic;">int64</span>, <span style="color: #268bd2;">whence</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #b58900; font-style: italic;">int64</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>io.Seeker接口是用来随机访问资源用的, offset就是相对于whence的寻址距离,whence必须是如下的几种值:
<ol class="org-ol">
<li>io.SeekStart</li>
<li>io.SeekCurrent</li>
<li>io.SeekEnd</li>
</ol></li>
</ul></li>
<li>io package 还把各种one-method 接口给合起来形成新接口,这些接口有:
<ul class="org-ul">
<li>io.ReadCloser</li>
<li>io.ReadSeeker</li>
<li>io.ReadWriteCloser</li>
<li>io.ReadWriteSeeker</li>
<li>io.ReadWriter</li>
<li>io.WriteCloser</li>
<li>io.WriteSeeker</li>
</ul></li>
<li>io package还有一个帮助package叫做ioutil package, 里面提供了一些有用的util函数,比如下面的函数是
处理比较小的data的良好选择(他们没有使用buffer,直接把源数据转化为slice):
<ul class="org-ul">
<li>ioutil.ReadAll</li>
<li>ioutil.ReadFile</li>
<li>ioutil.WriteFile</li>
</ul></li>
<li><p>
ioutil还有一些聪明的帮助函数,比如ioutil.NopCloser, 它传入一个实现了io.Reader的类型,传回一个实现
了io.ReadCloser的类型,其实现代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">nopCloser</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        io.Reader
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">nopCloser</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Close</span><span style="color: #268bd2;">()</span> <span style="color: #b58900; font-style: italic;">error</span> <span style="color: #268bd2;">{</span> <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">NopCloser</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">r</span> <span style="color: #b58900; font-style: italic;">io.Reader</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">io.ReadCloser</span> <span style="color: #268bd2;">{</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #b58900; font-style: italic;">nopCloser</span><span style="color: #d33682;">{</span>r<span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org5f904b2" class="outline-3">
<h3 id="org5f904b2"><span class="section-number-3">11.2.</span> time</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>go存在一个time package里面有两类的代表时间的类型:
<ul class="org-ul">
<li>time.Duration</li>
<li>time.Time</li>
</ul></li>
<li><p>
time.Duration其实是代表period的时间,这个类型的本质是int64,也就是两个时间之间的nano second时间数目,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">A Duration represents the elapsed time between two instants</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">as an int64 nanosecond count. The representation limits the</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">largest representable duration to approximately 290 years.</span>
<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Duration</span> <span style="color: #b58900; font-style: italic;">int64</span>
</pre>
</div></li>
<li>直接使用int64的nano second来表达间隔时间显然非常的麻烦, go的做法是创建不同的const, 让duration的
做法既直观又方便:
<ul class="org-ul">
<li><p>
定义了很多直观的const
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">(</span>
        <span style="color: #6c71c4; font-weight: bold;">Nanosecond</span>  <span style="color: #b58900; font-style: italic;">Duration</span> = 1
        <span style="color: #6c71c4; font-weight: bold;">Microsecond</span>          = 1000 * Nanosecond
        <span style="color: #6c71c4; font-weight: bold;">Millisecond</span>          = 1000 * Microsecond
        <span style="color: #6c71c4; font-weight: bold;">Second</span>               = 1000 * Millisecond
        <span style="color: #6c71c4; font-weight: bold;">Minute</span>               = 60 * Second
        <span style="color: #6c71c4; font-weight: bold;">Hour</span>                 = 60 * Minute
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
使用方法如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-08 10:10:28</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">d</span> := 2*time.Hour + 30*time.Minute

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>d<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2h30m0s</span>
</pre>
</div></li>
<li><p>
上面的fmt.Println直接把time.Duration打印成了"2h30ms"这种字符串,go同时提供了把字符串转换为time.Duration
的函数time.ParseDuration
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">d</span>, <span style="color: #268bd2;">err</span> := time.<span style="color: #b58900;">ParseDuration</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"2h30m"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>d<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2h30m0s</span>
</pre>
</div></li>
</ul></li>
<li>聊完了period的代表类型Duration,我们再来看看当前moment的代表类型time.Time,和time.Duration只是一个
int64的设定不同的是time.Time是一个复杂的结构,它还包含时区的信息
<ul class="org-ul">
<li><p>
源代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Time</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        wall <span style="color: #b58900; font-style: italic;">uint64</span>
        ext  <span style="color: #b58900; font-style: italic;">int64</span>
        loc *<span style="color: #b58900; font-style: italic;">Location</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>注意由于time.Time包含时区信息,所以我们不能使用==来比较两个time.Time instance,而必须使用time.Equal
函数</li>
</ul></li>
<li>对于时间总是和字符串相关,两者的相互转换的函数必然是重点:
<ul class="org-ul">
<li><p>
string到time.Time的转换函数是time.Parse, 声明如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">Parse</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">layout</span>, <span style="color: #268bd2;">value</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">Time</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
time.Time到string,当然可以用fmt.Println,但是想格式输出,则是要靠t.Format,其声明如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">t</span> <span style="color: #b58900; font-style: italic;">Time</span><span style="color: #268bd2;">)</span> <span style="color: #b58900;">Format</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">layout</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #b58900; font-style: italic;">string</span>
</pre>
</div></li>
</ul></li>
<li>两个最重要的函数,都涉及到一个参数layout,这个layout参数的设计是非常精妙的,其代表年月日时分秒和时
区的值都是互斥不相等的,比如:
<ul class="org-ul">
<li>年: 短年份使用06, 长年份使用2006</li>
<li>月: 使用01, Jan, January</li>
<li>日: 使用02, 2, _2</li>
<li>时: 使用03, 3, 15</li>
<li>分: 使用04, 4</li>
<li>秒: 使用05, 5</li>
<li>timezone: 使用07, 7</li>
</ul></li>
<li><p>
使用互斥不相等的数字,会有良好的效果,就是我们可以把年月日等时间顺序变化的字符串也能转换成time.Time,
比如这个时间"2023-13-02 00:00:00 +0000",显然是错误的,因为年后面一般跟着月份,但是这里把月份和日期
搞反了. 不过由于layout设计的巧妙,我们可以把layout的月份和日期也写反(由于01,02分别代表月份,日期,
go runtime知道layout故意写反了), 代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">t</span>, <span style="color: #268bd2;">err</span> := time.<span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"2006-02-01 15:04:05 -0700"</span>, <span style="color: #2aa198;">"2023-13-02 00:00:00 +0000"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-02-13 00:00:00 +0000 +0000</span>
</pre>
</div></li>
<li><p>
这个layout的写法很容易弄错,为了不容易写错,go源代码把常见的layout写成了const
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">(</span>
        <span style="color: #6c71c4; font-weight: bold;">Layout</span>      = <span style="color: #2aa198;">"01/02 03:04:05PM '06 -0700"</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The reference time, in numerical order.</span>
        <span style="color: #6c71c4; font-weight: bold;">ANSIC</span>       = <span style="color: #2aa198;">"Mon Jan _2 15:04:05 2006"</span>
        <span style="color: #6c71c4; font-weight: bold;">UnixDate</span>    = <span style="color: #2aa198;">"Mon Jan _2 15:04:05 MST 2006"</span>
        <span style="color: #6c71c4; font-weight: bold;">RubyDate</span>    = <span style="color: #2aa198;">"Mon Jan 02 15:04:05 -0700 2006"</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC822</span>      = <span style="color: #2aa198;">"02 Jan 06 15:04 MST"</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC822Z</span>     = <span style="color: #2aa198;">"02 Jan 06 15:04 -0700"</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">RFC822 with numeric zone</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC850</span>      = <span style="color: #2aa198;">"Monday, 02-Jan-06 15:04:05 MST"</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC1123</span>     = <span style="color: #2aa198;">"Mon, 02 Jan 2006 15:04:05 MST"</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC1123Z</span>    = <span style="color: #2aa198;">"Mon, 02 Jan 2006 15:04:05 -0700"</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">RFC1123 with numeric zone</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC3339</span>     = <span style="color: #2aa198;">"2006-01-02T15:04:05Z07:00"</span>
        <span style="color: #6c71c4; font-weight: bold;">RFC3339Nano</span> = <span style="color: #2aa198;">"2006-01-02T15:04:05.999999999Z07:00"</span>
        <span style="color: #6c71c4; font-weight: bold;">Kitchen</span>     = <span style="color: #2aa198;">"3:04PM"</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Handy time stamps.</span>
        <span style="color: #6c71c4; font-weight: bold;">Stamp</span>      = <span style="color: #2aa198;">"Jan _2 15:04:05"</span>
        <span style="color: #6c71c4; font-weight: bold;">StampMilli</span> = <span style="color: #2aa198;">"Jan _2 15:04:05.000"</span>
        <span style="color: #6c71c4; font-weight: bold;">StampMicro</span> = <span style="color: #2aa198;">"Jan _2 15:04:05.000000"</span>
        <span style="color: #6c71c4; font-weight: bold;">StampNano</span>  = <span style="color: #2aa198;">"Jan _2 15:04:05.000000000"</span>
<span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li><p>
我们可以很容易的通过函数获取具体的年月日等信息,如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">t</span>, <span style="color: #268bd2;">err</span> := time.<span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"2006-02-01 15:04:05 -0700"</span>, <span style="color: #2aa198;">"2023-13-02 11:32:56 +0000"</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Year</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Month</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Day</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Hour</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Minute</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Second</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Clock</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>t.<span style="color: #b58900;">Date</span><span style="color: #859900;">()</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-02-13 11:32:56 +0000 +0000</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">February</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">13</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">11</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">32</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">56</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">11 32 56</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023 February 13</span>
</pre>
</div></li>
<li>可以通过如下函数比较两个time.Time的前后时间:
<ul class="org-ul">
<li>time.After</li>
<li>time.Before</li>
<li>time.Equal</li>
</ul></li>
<li>还有一些time.Time和time.Duration配合的函数:
<ul class="org-ul">
<li><p>
time.Sub是比较两个time.Time, 返回time.Duration
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">o</span>, <span style="color: #268bd2;">err</span> := time.<span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span>time.RFC1123, <span style="color: #2aa198;">"Tue, 31 Jan 2023 15:04:05 CST"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">n</span> := time.<span style="color: #b58900;">Now</span><span style="color: #d33682;">()</span>

        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>n.<span style="color: #b58900;">Sub</span><span style="color: #859900;">(</span>o<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>o.<span style="color: #b58900;">Sub</span><span style="color: #859900;">(</span>n<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">866h51m55.116324s</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-866h51m55.116324s</span>
</pre>
</div></li>
<li><p>
time.Add是在某个time.Time上面增加一个新的Duration获取新的time.Time
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">o</span>, <span style="color: #268bd2;">err</span> := time.<span style="color: #b58900;">Parse</span><span style="color: #d33682;">(</span>time.RFC1123, <span style="color: #2aa198;">"Tue, 31 Jan 2023 15:04:05 CST"</span><span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">n</span> := time.<span style="color: #b58900;">Now</span><span style="color: #d33682;">()</span>

        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>

        <span style="color: #268bd2;">du</span> := n.<span style="color: #b58900;">Sub</span><span style="color: #d33682;">(</span>o<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>n<span style="color: #d33682;">)</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span>o.<span style="color: #b58900;">Add</span><span style="color: #859900;">(</span>du<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 17:55:08.294821 +0800 CST m=+0.000203540</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 17:55:08.294821 +0800 CST</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
<div id="outline-container-org7d2542f" class="outline-4">
<h4 id="org7d2542f"><span class="section-number-4">11.2.1.</span> Monotonic Time</h4>
<div class="outline-text-4" id="text-11-2-1">
<ul class="org-ul">
<li>大多数的操作系统都会track两种时间:
<ul class="org-ul">
<li>wall clock: 也就是current time</li>
<li>monotonic clock: 也就是从计算机启动到现在的时间</li>
</ul></li>
<li>之所以要记录两种时间,原因在于wall clock不总是增长的,如下情况可能会导致wall clock时间减少:
<ul class="org-ul">
<li>润秒</li>
<li>NTP(Network Time Protocol)</li>
</ul></li>
<li>由于wall clock的问题,所以Go会优先选择monotonic clock来计算elapsed time一类
的问题,只有在monotonic clock没有设置的情况下,才会使用wall clock</li>
</ul>
</div>
</div>
<div id="outline-container-org65c96be" class="outline-4">
<h4 id="org65c96be"><span class="section-number-4">11.2.2.</span> Timers and Timeouts</h4>
<div class="outline-text-4" id="text-11-2-2">
<ul class="org-ul">
<li>前面讲到过, time package包含一些函数会返回一些channel,在过了一定时间之后输出:
<ul class="org-ul">
<li><p>
time.After: 经过一段时间后,返回一个类型为time.Time的channel,并且写入一次时间
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-08 19:25:47</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">channel</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">string</span>, 2<span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #d33682;">{</span>
        <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">output</span> := &lt;-channel:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>output<span style="color: #859900;">)</span>
        <span style="color: #859900; font-weight: bold;">case</span> &lt;-time.<span style="color: #b58900;">After</span><span style="color: #859900;">(</span>5 * time.Second<span style="color: #859900;">)</span>:
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"Timeout"</span><span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Timeout</span>
</pre>
</div></li>
<li><p>
time.Tick: 每经过一个duration,都会向time.Time的channel里面写一个时间.不能停止,所以除了demo不
要使用time.Tick,而应该使用time.NewTicker
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-08 19:31:29</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">tick</span> := <span style="color: #859900; font-weight: bold;">range</span> time.<span style="color: #b58900;">Tick</span><span style="color: #d33682;">(</span>1 * time.Second<span style="color: #d33682;">)</span> <span style="color: #d33682;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #859900;">(</span>tick<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:49.984588 +0800 CST m=+1.000232688</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:50.984797 +0800 CST m=+2.000371007</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:51.985662 +0800 CST m=+3.001169198</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:52.984916 +0800 CST m=+4.000360485</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:53.985565 +0800 CST m=+5.000949442</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">2023-03-08 19:31:54.984899 +0800 CST m=+6.000228302</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">...</span>
</pre>
</div></li>
<li><p>
time.AfterFunc: 经过一个duration之后,调用某个函数
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-08 19:47:21</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"time"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">ch</span> := <span style="color: #d33682; font-style: italic;">make</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">chan</span> <span style="color: #b58900; font-style: italic;">int</span><span style="color: #d33682;">)</span>
        time.<span style="color: #b58900;">AfterFunc</span><span style="color: #d33682;">(</span>5*time.Second, <span style="color: #859900; font-weight: bold;">func</span><span style="color: #859900;">()</span> <span style="color: #859900;">{</span>
                fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"5 seconds passed"</span><span style="color: #6c71c4;">)</span>
                ch &lt;- 10
        <span style="color: #859900;">}</span><span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #d33682;">{</span>
                <span style="color: #859900; font-weight: bold;">select</span> <span style="color: #859900;">{</span>
                <span style="color: #859900; font-weight: bold;">case</span> <span style="color: #268bd2;">i</span> := &lt;-ch:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span>i, <span style="color: #2aa198;">" is coming, end."</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #859900; font-weight: bold;">return</span>
                <span style="color: #859900; font-weight: bold;">default</span>:
                        fmt.<span style="color: #b58900;">Println</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"wait"</span><span style="color: #6c71c4;">)</span>
                        time.<span style="color: #b58900;">Sleep</span><span style="color: #6c71c4;">(</span>1 * time.Second<span style="color: #6c71c4;">)</span>
                <span style="color: #859900;">}</span>
        <span style="color: #d33682;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">wait</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">wait</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">wait</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">wait</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">wait</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">5 seconds passed</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">10  is coming, end.</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7a0b290" class="outline-3">
<h3 id="org7a0b290"><span class="section-number-3">11.3.</span> encoding/json</h3>
<div class="outline-text-3" id="text-11-3">
<ul class="org-ul">
<li>REST API把JSON作为自己默认的沟通标准,所以go标准库也对JSON进行了支持.注意两个名词的意义:
<ul class="org-ul">
<li>marshaling: 是把Go data type转换为bytes字符串</li>
<li>unmarshaling: 是把bytes字符串转换会Go data</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgbc149d9" class="outline-4">
<h4 id="orgbc149d9"><span class="section-number-4">11.3.1.</span> Use Struct to Add Metadata</h4>
<div class="outline-text-4" id="text-11-3-1">
<ul class="org-ul">
<li>下面我们看个读写JSON的例子:
<ul class="org-ul">
<li><p>
JSON字符串如下
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #268bd2;">{</span>
  <span style="color: #2aa198;">"id"</span>:<span style="color: #2aa198;">"12345"</span>,
  <span style="color: #2aa198;">"date_ordered"</span>:<span style="color: #2aa198;">"2020-05-01T13:01:02Z"</span>,
  <span style="color: #2aa198;">"customer_id"</span>:<span style="color: #2aa198;">"3"</span>,
  <span style="color: #2aa198;">"items"</span>:<span style="color: #d33682;">[</span><span style="color: #859900;">{</span><span style="color: #2aa198;">"id"</span>:<span style="color: #2aa198;">"xyz123"</span>,<span style="color: #2aa198;">"name"</span>:<span style="color: #2aa198;">"Thing 1"</span><span style="color: #859900;">}</span>,<span style="color: #859900;">{</span><span style="color: #2aa198;">"id"</span>:<span style="color: #2aa198;">"abc789"</span>,<span style="color: #2aa198;">"name"</span>:<span style="color: #2aa198;">"Thing 2"</span><span style="color: #859900;">}</span><span style="color: #d33682;">]</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
对应的type如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Order</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        ID <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"id"`</span>
        DateOrdered <span style="color: #b58900; font-style: italic;">time.Time</span> <span style="color: #2aa198;">`json:"date_ordered"`</span>
        CustomerID <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"date_ordered"`</span>
        Items <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">Item</span> <span style="color: #2aa198;">`json:"items"`</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Item</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        ID <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"id"`</span>
        Name <span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"name"`</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>处理JSON的规则,主要是看struct tag. 所谓struct tag是指:
<ul class="org-ul">
<li>在type后面的一个字符串</li>
<li>字符串一backtick(`)包裹,但是不能跨行</li>
<li>struct tag由多个tag/value组成(写作 tagName:"tagValue"),相互之间以空格隔开</li>
<li>由于只有strng,所以struct tag是无法被编译器做校正的,实在需要校正,可以使用go vet</li>
</ul></li>
<li>这个例子里面的struct tag只有一个tag/value,tag为json, value为一个字符串,意思是转化为json之后字
段的名字,如果没有设置json:"name", 那么会默认转换成type的名字,默认是大写(比如Name)</li>
<li>除了常规的展示,还有些比较常见的问题,总结如下:
<ul class="org-ul">
<li><p>
代码如下:
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">-*- mode:go;mode:go-playground -*-</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">snippet of code @ 2023-03-10 14:59:22</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">=== Go Playground ===</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Execute the snippet with:                 Ctl-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Provide custom arguments to compile with: Alt-Return</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Other useful commands:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- remove the snippet completely with its dir and all files: (go-playground-rm)</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">- upload the current buffer to playground.golang.org:       (go-playground-upload)</span>

<span style="color: #859900; font-weight: bold;">package</span> main

<span style="color: #859900; font-weight: bold;">import</span> <span style="color: #268bd2;">(</span>
        <span style="color: #2aa198;">"encoding/json"</span>
        <span style="color: #2aa198;">"fmt"</span>
<span style="color: #268bd2;">)</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">Item</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Number <span style="color: #b58900; font-style: italic;">int</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">response</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Index  <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"index"`</span>
        Page   <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"page"`</span>
        Item   <span style="color: #b58900; font-style: italic;">Item</span>     <span style="color: #2aa198;">`json:"item"`</span>
        Fruits <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"fruits"`</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">response2</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Index  <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"-"`</span>
        Page   <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"page"`</span>
        Item   <span style="color: #b58900; font-style: italic;">Item</span>     <span style="color: #2aa198;">`json:"item"`</span>
        Fruits <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"fruits"`</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">response3</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Index  <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"index"`</span>
        Page   <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"page,omitempty"`</span>
        Item   <span style="color: #b58900; font-style: italic;">Item</span>     <span style="color: #2aa198;">`json:"item,omitempty"`</span>
        Fruits <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"fruits,omitempty"`</span>
<span style="color: #268bd2;">}</span>

<span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"Results:"</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">str</span> := <span style="color: #2aa198;">`{"index": 1, "page": 0, "fruits": ["apple", "peach"], "item": {"Number": 12}}`</span>
        <span style="color: #268bd2;">res</span> := <span style="color: #b58900; font-style: italic;">response</span><span style="color: #d33682;">{}</span>
        <span style="color: #268bd2;">err</span> := json.<span style="color: #b58900;">Unmarshal</span><span style="color: #d33682;">(</span><span style="color: #859900;">[]</span><span style="color: #b58900;">byte</span><span style="color: #859900;">(</span>str<span style="color: #859900;">)</span>, &amp;res<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"res:"</span>, str<span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">res2</span> := <span style="color: #b58900;">response2</span><span style="color: #d33682;">(</span>res<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">b2</span>, <span style="color: #268bd2;">err</span> := json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res2<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"res2:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b2<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        <span style="color: #268bd2;">res3</span> := <span style="color: #b58900;">response3</span><span style="color: #d33682;">(</span>res<span style="color: #d33682;">)</span>
        <span style="color: #268bd2;">b3</span>, <span style="color: #268bd2;">err</span> := json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"res3:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b3<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        res3.Page = 3

        b3, err = json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after set page to 3, res3:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b3<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        res3.Fruits = <span style="color: #6c71c4; font-weight: bold;">nil</span>
        b3, err = json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after set fruit to nil, res3:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b3<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        res3.Fruits = <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span><span style="color: #d33682;">{}</span>
        b3, err = json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after set fruit to empty slice, res3:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b3<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

        res3.Item = <span style="color: #b58900; font-style: italic;">Item</span><span style="color: #d33682;">{}</span>

        b3, err = json.<span style="color: #b58900;">Marshal</span><span style="color: #d33682;">(</span>res3<span style="color: #d33682;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> err != <span style="color: #6c71c4; font-weight: bold;">nil</span> <span style="color: #d33682;">{</span>
                <span style="color: #d33682; font-style: italic;">panic</span><span style="color: #859900;">(</span>err<span style="color: #859900;">)</span>
        <span style="color: #d33682;">}</span>
        fmt.<span style="color: #b58900;">Println</span><span style="color: #d33682;">(</span><span style="color: #2aa198;">"after set item to zero value, res3:"</span>, <span style="color: #b58900;">string</span><span style="color: #859900;">(</span>b3<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">}</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&lt;====================OUTPUT====================&gt;</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Results:</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">res: {"index": 1, "page": 0, "fruits": ["apple", "peach"], "item": {"Number": 12}}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">res2: {"page":0,"item":{"Number":12},"fruits":["apple","peach"]}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">res3: {"index":1,"item":{"Number":12},"fruits":["apple","peach"]}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after set page to 3, res3: {"index":1,"page":3,"item":{"Number":12},"fruits":["apple","peach"]}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after set fruit to nil, res3: {"index":1,"page":3,"item":{"Number":12}}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after set fruit to empty slice, res3: {"index":1,"page":3,"item":{"Number":12}}</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">after set item to zero value, res3: {"index":1,"page":3,"item":{"Number":0}}</span>
</pre>
</div></li>
<li><p>
如果数值无论是多少,都不想显示,那么就设置"tagValue"为"-",比如respone2,无论何时都不会显示index
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">response2</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Index  <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"-"`</span>
        Page   <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"page"`</span>
        Item   <span style="color: #b58900; font-style: italic;">Item</span>     <span style="color: #2aa198;">`json:"item"`</span>
        Fruits <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"fruits"`</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
如果数值为空的情况下,不想显示,那么就在"tagValue"的最后,加上一个",omitempty"
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">type</span> <span style="color: #b58900; font-style: italic;">response3</span> <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
        Index  <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"index"`</span>
        Page   <span style="color: #b58900; font-style: italic;">int</span>      <span style="color: #2aa198;">`json:"page,omitempty"`</span>
        Item   <span style="color: #b58900; font-style: italic;">Item</span>     <span style="color: #2aa198;">`json:"item,omitempty"`</span>
        Fruits <span style="color: #d33682;">[]</span><span style="color: #b58900; font-style: italic;">string</span> <span style="color: #2aa198;">`json:"fruits,omitempty"`</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>上面说的"数值为空"不是简单对应zero value,比如:
<ol class="org-ol">
<li><p>
zero value的struct不被认为是"数值为空",会打印出来,比如上面例子的最后一行Item的Number就被
设置为了如下值,而不是直接不打印
</p>
<pre class="example" id="org160e538">
"item":{"Number":0}
</pre></li>
<li>zero value的slice(还有map)会被认为是"数值为空",比如上面fruit设置为空数组,返回就不再打印了</li>
</ol></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgba85a48" class="outline-4">
<h4 id="orgba85a48"><span class="section-number-4">11.3.2.</span> Unmarshaling and Marshaling</h4>
</div>
<div id="outline-container-orgab31214" class="outline-4">
<h4 id="orgab31214"><span class="section-number-4">11.3.3.</span> JSON, Readers, and Writers</h4>
</div>
<div id="outline-container-orgca449fa" class="outline-4">
<h4 id="orgca449fa"><span class="section-number-4">11.3.4.</span> Enoding and Decoding JSON Streams</h4>
</div>
<div id="outline-container-org66f242a" class="outline-4">
<h4 id="org66f242a"><span class="section-number-4">11.3.5.</span> Custom JSON Parsing</h4>
</div>
</div>
<div id="outline-container-orgceb9141" class="outline-3">
<h3 id="orgceb9141"><span class="section-number-3">11.4.</span> net/http</h3>
<div class="outline-text-3" id="text-11-4">
</div>
<div id="outline-container-org61217b8" class="outline-4">
<h4 id="org61217b8"><span class="section-number-4">11.4.1.</span> The Client</h4>
</div>
<div id="outline-container-org72aa07e" class="outline-4">
<h4 id="org72aa07e"><span class="section-number-4">11.4.2.</span> The Server</h4>
</div>
</div>
</div>
<div id="outline-container-org2731952" class="outline-2">
<h2 id="org2731952"><span class="section-number-2">12.</span> The Context</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li>服务器需要一种方法来处理每个请求的metadata</li>
<li>这些metadata分为两个大类:
<ul class="org-ul">
<li>为了正确的处理request所需要的metadata.比如,一个http server可能想要一个tracking ID来跟踪请求,因
为这个请求会经过一系列microservice,其实是一个请求</li>
<li>什么时候需要停止request的metadata.比如,在请求某个微服务的时候时间太久,我们可能想关闭这个请求</li>
</ul></li>
<li>其他语言会使用threadlocal variable来存储这些metadata,方法是把这些data和操作系统中的某个thread绑
定.</li>
<li>但是在go语言里面,由于goroutine没有唯一标识符,所以不能使用这种方法</li>
<li>同时,threadlocal也有缺点,它的缺点是看起来像黑魔法,数据从一个地方写入,从另外的地方冒出来</li>
<li>Go使用context技术来存储server需要的这些metadata</li>
</ul>
</div>
<div id="outline-container-org3ccd348" class="outline-3">
<h3 id="org3ccd348"><span class="section-number-3">12.1.</span> What Is the Context?</h3>
<div class="outline-text-3" id="text-12-1">
<ul class="org-ul">
<li>context不是一个语言特性,它只不过是满足Context interface(定义在context package)的instance</li>
<li>go语言不太喜欢threadlocal那种比较magic的用法,喜欢explicit的函数参数传递.</li>
<li>context也就是这样,只不过context默认作为函数的第一个参数传递,这算一个convention, go语言另外一个经
典的convention是返回值的最后一个数据是error</li>
<li><p>
就像error变量经常被写成err一样,context变量默认写成ctx,作为第一个参数,传递给函数,下面就是是一个例子
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900; font-weight: bold;">func</span> <span style="color: #b58900;">logic</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">ctx</span> <span style="color: #b58900; font-style: italic;">context.Context</span>, <span style="color: #268bd2;">info</span> <span style="color: #b58900; font-style: italic;">string</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #b58900; font-style: italic;">string</span>, <span style="color: #b58900; font-style: italic;">error</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
        <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">do some interesting stuff here</span>
        <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">""</span>, <span style="color: #6c71c4; font-weight: bold;">nil</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>除了定义了Contex interface, contex package还包含了很多工厂函数用来:
<ul class="org-ul">
<li>create context</li>
<li>wrap context</li>
</ul></li>
<li><p>
通常情况下,我们都是使用别人传过来的contex,如果你是一个command-line程序的开发者,那么你大概率要自
己创建一个empty的初始context,代码如下
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2;">ctx</span> := context.<span style="color: #b58900;">Background</span><span style="color: #268bd2;">()</span>
<span style="color: #268bd2;">result</span>, <span style="color: #268bd2;">err</span> := <span style="color: #b58900;">logic</span><span style="color: #268bd2;">(</span>ctx, <span style="color: #2aa198;">"a string"</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>
<li>上面的例子是一个empty context,这是context的一个起始点.以后每次向这个context加东西的时候,你就要
通过 wrap context的工厂函数了(因为context是readonly的,所以只能wrap新的内容进去,不能更改)</li>
<li>在context package里面,还有另外一个工厂函数,功能和Background一样,也是产生一个empty的contex,叫做
context.TODO.但是不要在production代码里面使用这个context.TODO,因为:
<ul class="org-ul">
<li>context.TODO创建是因为写代码的时候,不知道context从哪里来(可能是自己初始化,也可能别人传给你),
所以占位.后面发布的时候必须改掉</li>
<li>如果明确的知道context是从我这里初始化(比如command-line tool的代码),那么就用context.Background</li>
</ul></li>
<li>由于context诞生于net/http package之后,我们不能在http.Handler interface里面添加context.Context参数
所以,在http.Handler相关的操作中,我们的context使用的pattern会有所不同</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: harrifeng@outlook.com</p>
<p class="date">Created: 2023-03-12 Sun 19:35</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
